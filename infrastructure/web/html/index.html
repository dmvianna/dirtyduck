<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2018-03-04 Sun 23:15 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dirty duck: A triage's guided tour</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Center of Data Science for Public Policy" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="http://gongzhitaao.org/orgcss/org.css"/>

<script type="text/javascript" src="http://thomasf.github.io/solarized-css/org-info.min.js">
/**
 *
 * @source: http://thomasf.github.io/solarized-css/org-info.min.js
 *
 * @licstart  The following is the entire license notice for the
 *  JavaScript code in http://thomasf.github.io/solarized-css/org-info.min.js.
 *
 * Copyright (C) 2012-2018 Free Software Foundation, Inc.
 *
 *
 * The JavaScript code in this tag is free software: you can
 * redistribute it and/or modify it under the terms of the GNU
 * General Public License (GNU GPL) as published by the Free Software
 * Foundation, either version 3 of the License, or (at your option)
 * any later version.  The code is distributed WITHOUT ANY WARRANTY;
 * without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.
 *
 * As additional permission under GNU GPL version 3 section 7, you
 * may distribute non-source (e.g., minimized or compacted) forms of
 * that code without the copy of the GNU GPL normally required by
 * section 4, provided you include this license notice and a URL
 * through which recipients can access the Corresponding Source.
 *
 * @licend  The above is the entire license notice
 * for the JavaScript code in http://thomasf.github.io/solarized-css/org-info.min.js.
 *
 */
</script>

<script type="text/javascript">

/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2018 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/

<!--/*--><![CDATA[/*><!--*/
org_html_manager.set("TOC_DEPTH", "4");
org_html_manager.set("LINK_HOME", "");
org_html_manager.set("LINK_UP", "");
org_html_manager.set("LOCAL_TOC", "1");
org_html_manager.set("VIEW_BUTTONS", "0");
org_html_manager.set("MOUSE_HINT", "underline");
org_html_manager.set("FIXED_TOC", "0");
org_html_manager.set("TOC", "1");
org_html_manager.set("VIEW", "1");
org_html_manager.setup();  // activate after the parameters are set
/*]]>*///-->
</script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2018 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<h1 class="title">Dirty duck: A triage's guided tour</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org1569409">1. Description of the problem to solve</a></li>
<li><a href="#org03940b4">2. Infrastructure</a></li>
<li><a href="#org0e24f50">3. Data preparation</a>
<ul>
<li><a href="#org2aab6f6">3.1. Downloading the data</a></li>
<li><a href="#orgfc5680d">3.2. Loading data to the database</a></li>
<li><a href="#orgd3e597e">3.3. Transforming (and cleaning) the data</a>
<ul>
<li><a href="#org02fcd27">3.3.1. Rationale</a></li>
<li><a href="#org55e8011">3.3.2. Dataset documentation</a></li>
<li><a href="#org72e5af7">3.3.3. Reality check</a></li>
<li><a href="#org86e5cdd">3.3.4. Cleaning</a></li>
</ul>
</li>
<li><a href="#orgbb66575">3.4. Semantic tables</a>
<ul>
<li><a href="#orgf4aca67">3.4.1. Entities table</a></li>
</ul>
</li>
<li><a href="#orgfee7f71">3.5. Events table</a></li>
</ul>
</li>
<li><a href="#org657dba3">4. Triage</a>
<ul>
<li><a href="#org9276566">4.1. Triage interface</a>
<ul>
<li><a href="#orgf08156f">4.1.1. A tale of two tables</a></li>
<li><a href="#orgc093937">4.1.2. Experiment's configuration file</a>
<ul>
<li><a href="#orgec69435">4.1.2.1. Temporal crossvalidation</a></li>
<li><a href="#org5c65790">4.1.2.2. <span class="todo TODO">TODO</span> Feature engineering</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org1b42435">4.2. Machine learning governance: The <code>RESULTS</code> schema</a>
<ul>
<li><a href="#org9655927">4.2.1. What are all the results tables about?</a>
<ul>
<li><a href="#org44057c8">4.2.1.1. <code>results.experiments</code></a></li>
<li><a href="#org831312b">4.2.1.2. <code>results.model_groups</code></a></li>
<li><a href="#org36860ef">4.2.1.3. <code>results.models</code></a></li>
<li><a href="#org9392a6c">4.2.1.4. <code>results.evaluations</code></a></li>
<li><a href="#org8e78b04">4.2.1.5. <code>results.predictions</code></a></li>
<li><a href="#orge192278">4.2.1.6. <span class="todo TODO">TODO</span> : <code>results.feature_importances</code></a></li>
<li><a href="#orge37d084">4.2.1.7. <span class="todo TODO">TODO</span> : <code>results.individual_importances</code></a></li>
<li><a href="#orgb9a1f9f">4.2.1.8. <span class="todo TODO">TODO</span> : <code>results.list_predictions</code></a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orge6326fa">4.3. Audition</a></li>
<li><a href="#orga46e262">4.4. Post-modeling</a></li>
<li><a href="#org16c67cf">4.5. What's next?</a></li>
</ul>
</li>
<li><a href="#org9d2bf3e">5. Inpections prioritization</a>
<ul>
<li><a href="#org6cd69c7">5.1. Problem description</a></li>
<li><a href="#org675b5f2">5.2. Creating the labels</a></li>
<li><a href="#org5b7de2b">5.3. Modeling using Machine Learning</a>
<ul>
<li><a href="#org59c420c">5.3.1. Creating a simple experiment</a></li>
<li><a href="#orge61a76a">5.3.2. Defining a baseline</a></li>
<li><a href="#org3b15d9d">5.3.3. A more advanced experiment</a></li>
</ul>
</li>
<li><a href="#org2bdae37">5.4. What's next?</a></li>
</ul>
</li>
<li><a href="#org36f5e3f">6. An Early Intervention System</a>
<ul>
<li><a href="#org406bdec">6.1. Problem description</a></li>
<li><a href="#org021d44e">6.2. Creating the labels</a></li>
<li><a href="#org09db14b">6.3. Modeling using Machine Learning</a>
<ul>
<li><a href="#org7ce97fc">6.3.1. Creating a simple Experiment</a>
<ul>
<li><a href="#orgf1477c4">6.3.1.1. Temporal configuration</a></li>
<li><a href="#org94da4e7">6.3.1.2. Features</a></li>
<li><a href="#orge3da7ec">6.3.1.3. Algorithm and hyperparameters</a></li>
<li><a href="#orgc8d378c">6.3.1.4. Feature Importances</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orge2d64c7">6.4. Postmodeling</a>
<ul>
<li><a href="#org95dee7f">6.4.1. How can I pick the best one?</a></li>
<li><a href="#orge9e98ba">6.4.2. What's next?</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org578136f">7. Appendix: A more technical view to <code>collate</code></a>
<ul>
<li><a href="#org6975f3a">7.1. Add number of violations by severity</a></li>
<li><a href="#org65c6b14">7.2. Add number of facilities by type in a radius: 1km</a></li>
<li><a href="#org84fd818">7.3. Add number of inspections by type in a radius and in an interval</a></li>
<li><a href="#orgcc2352b">7.4. The <code>Experiment</code> object</a></li>
</ul>
</li>
<li><a href="#org0867a49">8. Appendix: For the impatient</a></li>
</ul>
</div>
</div>

<div id="outline-container-org1569409" class="outline-2">
<h2 id="org1569409"><span class="section-number-2">1</span> Description of the problem to solve</h2>
<div class="outline-text-2" id="text-1">
<p>
The main goal of this tutorial is introduce the reader to the use of <a href="https://github.com/dssg/triage">triage</a>.
We will use the well know <a href="https://data.cityofchicago.org/Health-Human-Services/Food-Inspections/4ijn-s7e5">Chicago's Food Inspections dataset</a> <sup><a id="fnr.1" class="footref" href="#fn.1">1</a></sup>
as the data source. We will present the two problems that <code>triage</code> helps to Model :
</p>

<ol class="org-ol">
<li>Resource prioritization (internally know as the <i>inspections
problem</i>) <sup><a id="fnr.2" class="footref" href="#fn.2">2</a></sup>.</li>

<li>Creation of <b>Early  Intervention Systems</b><sup><a id="fnr.3" class="footref" href="#fn.3">3</a></sup> or <b>EIS</b>, and</li>
</ol>

<p>
In the <b>inspections prioritization</b>, we want to generate a list of
facilities<sup><a id="fnr.4" class="footref" href="#fn.4">4</a></sup> to inspect in the following \(X\) period of time
which are <i>likely</i> to have some <b>critical</b> o <b>serious</b>
violation <i>given that</i> they are inspected.
</p>

<blockquote>
<p>
Which \(n\) facilities are likely to violate some rule in the
following \(X\) period of time?
</p>
</blockquote>

<p>
  This problem is important because you need
to prioritize your resources (i.e. your inspection workforce), since
they are limited (let's say that you could make \(n\) inspections in
the \(X\) period of Time.  
</p>

<p>
You could refine the definition and include only the more grave: 
</p>

<blockquote>
<p>
Which \(n\) facilities are likely have a critical o serious violation in the
following \(X\) period of time?
</p>
</blockquote>

<p>
In the <b>EIS</b>, as a facility owner or manager, we want to predict if
the facility under our control is at <i>risk</i> of been inspected in the
following \(X\) period of Time:
</p>

<blockquote>
<p>
Will my restaurant be inspected in thenext \(X\) period of time?
</p>
</blockquote>

<p>
Knowing the answer to this question, allows you (as the restaurant's
owner) to be prepared and take the pertinent actions.
</p>

<p>
In the previous definitions \(X\) could be 1 month, 1 week, 1 year,
etc. The election of \(X\) depends in your internal process (e.g.  <i>We plan for inspections every 3 months, so you need a list every 3 months, before the meeting for planning</i> ).
</p>

<p>
Without going in technical intricallities, both problems have (or
should have) the following data structure: The data describes
<b>events</b> in which an <b>entity</b> was involved, and that event have an 
specific <b>outcome</b> or result.
</p>

<p>
The <b>entity</b>, in our tutorial, for both cases, is a
<i>facility</i>. The <b>event</b> is an inspection, The definition of the
<b>outcome</b> is what differ between those two problems: for <b>EIS</b>, the
outcome is <i>inspected</i>, for <b>inspections</b>, the outcome is, for
example <i>major violation found</i> or <i>inspection failed</i>.
</p>
</div>
</div>


<div id="outline-container-org03940b4" class="outline-2">
<h2 id="org03940b4"><span class="section-number-2">2</span> Infrastructure</h2>
<div class="outline-text-2" id="text-2">
<p>
In every data science project you will need several tools which
will help you to analyze the data in an efficient<sup><a id="fnr.5" class="footref" href="#fn.5">5</a></sup> manner.
Examples of this tools are: a place to store the data (a database
management system or <b>DBMS</b>), a way
for putting your model to work, i.e. one way that allows to model
to ingest new data and predict on it (an <b>API</b>) and a interface for
looking the performace of your trained models (a governance tool). 
</p>

<p>
We are proving a little script for managing all the infrastructure<sup><a id="fnr.6" class="footref" href="#fn.6">6</a></sup> in
a (hopefully) transparent way.
</p>

<p>
The provided environment is composed by <i>four</i> Pieces:
</p>
<ul class="org-ul">
<li>a <code>postgresql</code> database called <code>food_db</code>,</li>
<li>a container that executes <code>triage</code> experiments,</li>
<li>a <i>web server</i> that shows this tutorial,</li>
<li>and finally <code>bastion</code>, which includes a <code>postgresql</code> client</li>
</ul>
<p>
(so you can interact with the database)<sup><a id="fnr.7" class="footref" href="#fn.7">7</a></sup> and a full <code>python</code>
environment (so you can code or modify the things that we will
discuss in this Tutorial). 
</p>

<p>
The idea is that you don't need to install anything in your laptop.
</p>

<p>
Run the following
</p>

<div class="org-src-container">
<pre class="src src-sh">    ./tutorial.sh
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">  Usage: ./tutorial.sh {start|stop|build|rebuild|run|logs|status|destroy|all|}

  OPTIONS:
     -h|help             Show this message
     start
     stop
     rebuild
     status
     destroy
     -t|triage
     -a|all

  INFRASTRUCTURE:
     All the infrastructure needed is turned on!
          $ ./tutorial.sh start

     Check the status of the containers:
          $ ./tutorial.sh status

     Stop the tutorial's infrastructure:
          $ ./tutorial.sh stop

     Destroy all the resources related to the tutorial:
          $ ./tutorial.sh destroy

     Infrastructure logs:
          $ ./tutorial.sh -l

  EXPERIMENTS:
     NOTE:
        The following commands assume that "sample<span style="color: #0000ff; background-color: #ffffff;">experiment</span>config.yaml"
        is located inside triage/experiment<span style="color: #0000ff; background-color: #ffffff;">config</span>  directory

     Run one experiment:
          $ ./tutorial.sh -t --config<span style="color: #0000ff; background-color: #ffffff;">file</span> sample<span style="color: #0000ff; background-color: #ffffff;">experiment</span>config.yaml run

     Run one experiment, without replacing matrices or models if already exist and with debug enabled:
          $ ./tutorial.sh -t --config<span style="color: #0000ff; background-color: #ffffff;">file</span> sample<span style="color: #0000ff; background-color: #ffffff;">experiment</span>config.yaml --no-replace --debug run

     Validate experiment configuration file:
          $ ./tutorial.sh triage --config<span style="color: #0000ff; background-color: #ffffff;">file</span> sample<span style="color: #0000ff; background-color: #ffffff;">experiment</span>config.yaml validate

     Show experiment's temporal cross-validation blocks:
          $ ./tutorial.sh -t --config<span style="color: #0000ff; background-color: #ffffff;">file</span> sample<span style="color: #0000ff; background-color: #ffffff;">experiment</span>config.yaml show<span style="color: #0000ff; background-color: #ffffff;">temporal</span>blocks

     Plot the model number 4 (if it is a Decision Tree or a Random Forest):
          $ ./tutorial.sh -t --config<span style="color: #0000ff; background-color: #ffffff;">file</span> sample<span style="color: #0000ff; background-color: #ffffff;">experiment</span>config.yaml show<span style="color: #0000ff; background-color: #ffffff;">model</span>plot --model 4

     Triage help:
          $ ./tutorial.sh triage --help

</pre>
</div>

<p>
Following the printed instructuons in the screen, we can start the
infrastructure with:
</p>

<pre class="example">
    ./tutorial.sh start
</pre>

<p>
You can check that everything is running smoothly with <code>status</code>
</p>

<div class="org-src-container">
<pre class="src src-sh">    ./tutorial.sh status
    :
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">       Name                    Command              State           Ports         
  --------------------------------------------------------------------------------
  food<span style="color: #0000ff; background-color: #ffffff;">db</span>           docker-entrypoint.sh postgres   Up      0.0.0.0:5434-&gt;5432/tcp
  tutorial<span style="color: #0000ff; background-color: #ffffff;">server</span>   nginx -g daemon off;            Up      0.0.0.0:80-&gt;80/tcp    
</pre>
</div>

<p>
For accessing to the <code>postgresql</code> client type:
</p>

<pre class="example">
  ./tutorial.sh bastion
</pre>

<p>
Your prompt should change to something like:
</p>

<pre class="example">
  root@485373fb3c64:/$
</pre>

<p>
<b>NOTE</b>: The number surely will be different (i.e. not <code>485373fb3c64</code>).
</p>

<p>
Type the next command to connect to the database
</p>

<pre class="example">
  psql ${FOOD_DB_URL}
</pre>

<p>
The prompt will change again to
</p>

<pre class="example">
   psql (9.6.7, server 10.2 (Debian 10.2-1.pgdg90+1))
   WARNING: psql major version 9.6, server major version 10.
         Some psql features might not work.
   Type "help" for help.

   food=# 
</pre>

<p>
The previous command is using <code>psql</code> a powerful command line client for the Postgresql database. 
If you want to use this client fully check the <a href="https://www.postgresql.org/docs/10/static/app-psql.html">psql's documentation</a>.
</p>

<p>
The database is running and its named <code>food</code>. It should contain a
single table named <code>inspections</code>  in the <code>schema</code> <code>Raw</code>. 
Let's check the <code>inspections</code> table, type the following command:
</p>

<div class="org-src-container">
<pre class="src src-sql">    \d raw.inspections
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Table "raw.inspections"</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Column</td>
<td class="org-left">Type</td>
<td class="org-left">Modifiers</td>
</tr>

<tr>
<td class="org-left">inspection</td>
<td class="org-left">character varying</td>
<td class="org-left">not null</td>
</tr>

<tr>
<td class="org-left">dba_name</td>
<td class="org-left">character varying</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">aka_name</td>
<td class="org-left">character varying</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">license_num</td>
<td class="org-left">numeric</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">facility_type</td>
<td class="org-left">character varying</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">risk</td>
<td class="org-left">character varying</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">address</td>
<td class="org-left">character varying</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">city</td>
<td class="org-left">character varying</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">state</td>
<td class="org-left">character varying</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">zip</td>
<td class="org-left">character varying</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">date</td>
<td class="org-left">date</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">type</td>
<td class="org-left">character varying</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">results</td>
<td class="org-left">character varying</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">violations</td>
<td class="org-left">character varying</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">latitude</td>
<td class="org-left">numeric</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">longitude</td>
<td class="org-left">numeric</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">location</td>
<td class="org-left">character varying</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>

<p>
That is it. This is our "raw" data. We will work from here.
</p>

<p>
You can disconnect from the database typing <code>\q</code>. But don't leave
<code>bastion</code> yet. You should return to the same weird prompt:
</p>

<pre class="example">
  root@485373fb3c64:/$
</pre>
</div>
</div>


<div id="outline-container-org0e24f50" class="outline-2">
<h2 id="org0e24f50"><span class="section-number-2">3</span> Data preparation</h2>
<div class="outline-text-2" id="text-3">
<p>
We need get the data and then transform it into a shape that is suitable for the analysis.
</p>

<p>
<b>NOTE</b> At least is explicity said the contrary, you should run all the following commands inside <code>bastion</code>.
</p>
</div>

<div id="outline-container-org2aab6f6" class="outline-3">
<h3 id="org2aab6f6"><span class="section-number-3">3.1</span> Downloading the data</h3>
<div class="outline-text-3" id="text-3-1">
<p>
The data could be downloaded from the Chicago's public data website. The following command takes care of that and store the data as a <code>csv</code> file in <code>data/inspections</code> 
</p>

<div class="org-src-container">
<pre class="src src-sh">     curl <span style="color: #008000;">"https://data.cityofchicago.org/api/views/4ijn-s7e5/rows.csv?accessType=DOWNLOAD"</span> &gt; data/inspections.csv
</pre>
</div>

<p>
We can check the size of the data set<sup><a id="fnr.8" class="footref" href="#fn.8">8</a></sup>,
</p>

<div class="org-src-container">
<pre class="src src-sh">     ls -lh /data
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">   total 189M
   -rw-rw-r-- 1 1000 1000 189M Mar  3 21:39 inspections.csv
</pre>
</div>

<p>
And the (apparent) total number of rows<sup><a id="fnr.9" class="footref" href="#fn.9">9</a></sup>
</p>

<div class="org-src-container">
<pre class="src src-sh">     wc -l /data/inspections.csv
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">   402526 /data/inspections.csv
</pre>
</div>

<p>
Remember this number, it will give you a surprise when you upload the data into the database.
</p>
</div>
</div>

<div id="outline-container-orgfc5680d" class="outline-3">
<h3 id="orgfc5680d"><span class="section-number-3">3.2</span> Loading data to the database</h3>
<div class="outline-text-3" id="text-3-2">
<p>
Before uploading the file <code>inspections.csv</code> into the database, verify that it is empty<sup><a id="fnr.10" class="footref" href="#fn.10">10</a></sup> :
</p>

<div class="org-src-container">
<pre class="src src-sh">     psql ${<span style="color: #BA36A5;">FOOD_DB_URL</span>} -c <span style="color: #008000;">'select count(*) from raw.inspections'</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">    count 
   -------
        0
   (1 row)

</pre>
</div>

<p>
We can load the file using the <code>\copy</code> command . The command's output will report how many rows where inserted
</p>

<div class="org-src-container">
<pre class="src src-sh">     psql ${<span style="color: #BA36A5;">FOOD_DB_URL</span>} -c <span style="color: #008000;">"\copy raw.inspections FROM '/data/inspections.csv' WITH HEADER CSV"</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">   COPY 165597
</pre>
</div>

<p>
This is different to the number of rows that we calculated
previously! Do we miss several thousands rows? 
</p>

<p>
The explanation for this mismatch is that the columns
<code>violations</code> contains several lines in some examples<sup><a id="fnr.11" class="footref" href="#fn.11">11</a></sup>. But don't worry,
the previous command took care about that.
</p>

<p>
Let's glimpse the data
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">select</span> * <span style="color: #0000FF;">from</span> raw.inspections <span style="color: #0000FF;">limit</span> 1
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">inspection</th>
<th scope="col" class="org-left">dba_name</th>
<th scope="col" class="org-left">aka_name</th>
<th scope="col" class="org-right">license_num</th>
<th scope="col" class="org-left">facility_type</th>
<th scope="col" class="org-left">risk</th>
<th scope="col" class="org-left">address</th>
<th scope="col" class="org-left">city</th>
<th scope="col" class="org-left">state</th>
<th scope="col" class="org-right">zip</th>
<th scope="col" class="org-right">date</th>
<th scope="col" class="org-left">type</th>
<th scope="col" class="org-left">results</th>
<th scope="col" class="org-left">violations</th>
<th scope="col" class="org-right">latitude</th>
<th scope="col" class="org-right">longitude</th>
<th scope="col" class="org-left">location</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">2145741</td>
<td class="org-left">1914 CLUB</td>
<td class="org-left">1914 CLUB</td>
<td class="org-right">2569448</td>
<td class="org-left">[NULL]</td>
<td class="org-left">Risk 1 (High)</td>
<td class="org-left">1060 W ADDISON AVE</td>
<td class="org-left">CHICAGO</td>
<td class="org-left">IL</td>
<td class="org-right">60613</td>
<td class="org-right">2018-03-01</td>
<td class="org-left">License</td>
<td class="org-left">Not Ready</td>
<td class="org-left">[NULL]</td>
<td class="org-right">41.94731748901495</td>
<td class="org-right">-87.65641794764645</td>
<td class="org-left">(41.94731748901495, -87.65641794764645)</td>
</tr>
</tbody>
</table>

<p>
Ok, now you have some data loaded! But still, we need to <i>munging it</i> to be able to use it in our Machine learning task.
</p>
</div>
</div>

<div id="outline-container-orgd3e597e" class="outline-3">
<h3 id="orgd3e597e"><span class="section-number-3">3.3</span> Transforming (and cleaning) the data</h3>
<div class="outline-text-3" id="text-3-3">
</div>
<div id="outline-container-org02fcd27" class="outline-4">
<h4 id="org02fcd27"><span class="section-number-4">3.3.1</span> Rationale</h4>
<div class="outline-text-4" id="text-3-3-1">
<p>
For tackling a Machine Learning problem you need to identify the
<b>entities</b> of your problem domain, and if your problem involves time,
how those entities change over time, i.e. which <b>events</b> happened to
that entity or which <b>events</b> where acted by the entity in question.
</p>

<p>
We will materialize that conceptualization in two different tables, one for entities and
one for events, we will name those tables as <code>entities</code> and <code>events</code> respectively.
</p>

<p>
The entity is the <b>facility</b>, and the events that happen to that entity
are the <b>inspections</b>.
</p>

<p>
The table <code>entities</code> should contain an unique identifier for the entity,
some data specific for that entity (like name, age, status). The
<code>events</code> table will include data related to the description of the
inspection, but don't forget the two most important attributes of an
event are its spatial position and its temporal location.
</p>

<p>
Before starting the cleaning, you should know one of the golden rules
-that will make your life easier:
</p>

<blockquote>
<p>
<i>You must not change your original data</i>
</p>
</blockquote>

<p>
The reason for this is the following: if you make some mistake, or if
you want to try a different transformation on your data, you could
always can go back to this <code>raw</code> data and start over.
</p>

<p>
The transformation "road" that we will take in this tutorial is as follows:
</p>

<ol class="org-ol">
<li>We put an exact copy of our inse data in the <code>raw</code> schema. (We just
did that)</li>
<li>We will apply some simple transformations that will clean our data
and we will store that version on the <code>cleaned</code> schema.</li>
<li>We will organize the data semantically in two <i>unnormalized</i><sup><a id="fnr.12" class="footref" href="#fn.12">12</a></sup> tables:
<code>events</code> and <code>entities</code> in the <code>semantic</code> schema.</li>
<li>Then We need to fulfill some <code>triage</code> idiosyncrasies, and create
some other tables and store them in the schema <code>triage</code>.</li>
<li>Finally, <code>triage</code> will take over, and it will create the schema <code>results</code>.</li>
</ol>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>Data's roadmap : from raw to triage</label><pre class="src src-ditaa" id="org8a73aa7">                                     GRO Architecture
----------------------------------------------------------------------------------------------------- 
                                       Top Modules
 /----------\                                                                                         
 |    GUI   |                                                                                         
 | cRED     |                                                                                         
 +----------+                                                                                         
---------=----------------------------------------------------------------------------------=--------
 +----------+ +-----------\/-----------------\/--------+ 
 | UCI      | |LUCI-SHARED|| SDK-LIBC-SCRIPT || DNSMASQ| 
 | c516     | | cBLU      || cBLU            ||   cBLU | 
 +----------+ +-----------/\-----------------/\--------+ 
----------------------------------------------------------------------------------------------------- 
                                       Lower Modules
 +-----------------------------------------------------------------------------------------------+
 |                                         netfilter                                             |
 |  +------------------+                                                                         |
 |  | Access Control   |                                                                         |
 |  |   c277           |                                                                         |
 |  +------------------+                                                                         |
 |                                           cA7A                                                |
 +-----------------------------------------------------------------------------------------------+
 +-----------+  +--------------+ 
 |SDK-LIBC   |  | Busybox      |
 |cBLU       |  | Driver  cPNK |
 +-----------+  +--------------+
                                

    +-----------+        +---------+
    |    PLC    |        |         |
    |  Network  +&lt;------&gt;+   PLC   +&lt;---=---------+
    |    cRED   |        |  c707   |              |
    +-----------+        +----+----+              |
                              ^                   |
                              |                   |
                              |  +----------------|-----------------+
                              |  |                |                 |
                              v  v                v                 v
      +----------+       +----+--+--+      +-------+---+      +-----+-----+       Windows clients
      |          |       |          |      |           |      |           |      +----+      +----+
      | Database +&lt;-----&gt;+  Shared  +&lt;----&gt;+ Executive +&lt;-=--&gt;+ Operator  +&lt;----&gt;|cYEL| . . .|cYEL|
      |   c707   |       |  Memory  |      |   c707    |      | Server    |      |    |      |    |
      +--+----+--+       |{d} cGRE  |      +------+----+      |   c707    |      +----+      +----+
         ^    ^          +----------+             ^           +-------+---+
         |    |                                   |
         |    +--------=--------------------------+
         v
+--------+--------+
|                 |
| Millwide System |            -------- Data ---------
| cBLU            |            --=----- Signals ---=--
+-----------------+
                                                                      
  +-------------+
  |   UCI       |
  |   c516      |
  +------+------+
         | config get
         v                   /----------------------------------------------------\
  +-------------+            | - Translate configratuion items from UCI to uci    |
  | LUCI-SHARED |............| - Provide luci script to bring up feature          |
  |    cBLU     |            | - Provide Ada scripts                              |
  +------+------+            \----------------------------------------------------/
         |
         v
 +----------------+
 | Openwrt config |
 | cGRE           |
 +-------+--------+
         |
         v
+-------------------+         +------------+
|  SDK-LIBC-SCRIPT  +--------&gt;|  DNSMASQ   |
|     cBLU          |         |   cBLU     |
+---------+---------+         +------+-----+
          |                          | (Ada configuration)
          |      /-------------------+
          |      |
          v      v
+-------------------+
|     SDK-LIBC      |
|       cBLU        |
+-------------------+

  
        

</pre>
</div>


<div class="figure">
<p><img src="img/data_road.png" alt="data_road.png" />
</p>
</div>
</div>
</div>



<div id="outline-container-org55e8011" class="outline-4">
<h4 id="org55e8011"><span class="section-number-4">3.3.2</span> Dataset documentation</h4>
<div class="outline-text-4" id="text-3-3-2">
<p>
The Chicago's food inspection  dataset has some documentation located
<a href="https://data.cityofchicago.org/api/assets/BAD5301B-681A-4202-9D25-51B2CAE672FF?download=true">here</a>. From it, we can make sense about the column's meaning, and the
process that generates the data.
</p>

<p>
The meaning of interesting columns follows<sup><a id="fnr.13" class="footref" href="#fn.13">13</a></sup>, all the other
columns should be self-explanatory
</p>

<dl class="org-dl">
<dt><b>Risk category of facility</b> (<code>risk</code>)</dt><dd></dd>
</dl>

<blockquote>
<p>
Each establishment is categorized as
to its risk of adversely affecting the public’s health, with 1
being the highest and 3 the lowest. The frequency of
inspection is tied to this risk, with risk 1 establishments
inspected most frequently and risk 3 least frequently.
</p>
</blockquote>

<dl class="org-dl">
<dt><b>Inspection type</b> (<code>type</code>)</dt><dd></dd>
</dl>

<blockquote>
<p>
An inspection can be one of the following
types: canvass, the most common type of inspection performed
at a frequency relative to the risk of the   establishment;
consultation, when the inspection is  done at the request of the
owner prior to the opening of the establishment; complaint, when
the inspection is done in    response to a complaint against the
establishment; license, when the inspection is done    as a
requirement for the establishment to receive its license to
operate; suspect food    poisoning, when the inspection is done
in response to one or more persons claiming to    have gotten ill
as a result of eating at the establishment (a specific type of
complaint-   based inspection); task-force inspection, when an
inspection of a bar or tavern is done.    Re-inspections can
occur for most types of these inspections and are indicated as
such.
</p>
</blockquote>

<dl class="org-dl">
<dt><b>Results</b> (<code>results</code>)</dt><dd></dd>
</dl>

<blockquote>
<p>
An inspection can pass, pass with conditions or
fail. Establishments receiving a ‘pass’ were found to have no
critical or serious violations (violation number 1-14 and 15-29,
respectively). Establishments receiving a ‘pass  with conditions’
were found to have critical or serious violations, but these were
corrected during the inspection. Establishments receiving a
‘fail’ were found to have critical or serious violations that
were not correctable during the inspection. An establishment
receiving a ‘fail’ does not  necessarily mean the establishment’s
licensed is suspended. Establishments found to be out of business
or not located are indicated as such.
</p>
</blockquote>

<dl class="org-dl">
<dt><b>Violations</b> (<code>violations</code>)</dt><dd></dd>
</dl>

<blockquote>
<p>
An establishment can receive <b>one or more</b> of 45
distinct violations (violation numbers 1-44 and 70). For each
violation number listed for a given establishment, <i>the
requirement the establishment must meet in order for it</i> to <b>NOT</b>
<i>receive a violation is noted, followed by a specific description
of the findings that caused the violation to be issued</i>.
</p>
</blockquote>

<p>
We added emphasis to the last one.
</p>

<p>
From this definitions, we can deduct the following claims:
</p>

<ol class="org-ol">
<li><i>risk</i> is related to the frequency of inspections of type <i>canvass</i>.</li>
<li><i>consultation</i> is a compulsory inspections <i>before</i> the facility opens
(so we can remove it from the data), the same happens with <i>license</i>.</li>
<li><i>complaint</i> and <i>suspect food poisoning</i> are types of inspections
which are  triggered by the people.</li>
<li>Inspection of type <i>consultation</i> are triggered by the owner of the
facility.</li>
<li><i>task-force</i> occurs against bar or taverns.</li>
<li><b>Critical violations</b> are coded between <code>1-14</code>, <b>serious violations</b>
between <code>15-29</code>. So, we can assume that the violations code <code>30</code> and
onward are <i>minor</i> violations.</li>
<li>The description of the violation is actually what <b>shouldn't</b> found,
the comment are the steps that the facility should take in order of
not receive the violation.</li>
<li>They are only three possible results of the inspection (plus the
fact that the facility was not located or out of business).</li>
<li>There are several <code>violations</code> per <code>inspection</code>.</li>
</ol>
</div>
</div>



<div id="outline-container-org72e5af7" class="outline-4">
<h4 id="org72e5af7"><span class="section-number-4">3.3.3</span> Reality check</h4>
<div class="outline-text-4" id="text-3-3-3">
<p>
It is important verify that the documentation is correct. Let's start
checking that the <code>risk</code> column <b>only</b> have three different classifications:
</p>

<p>
<b>NOTE</b> Execute this in <code>psql</code> inside the container <code>bastion</code>.
</p>

<div class="org-src-container">
<pre class="src src-sql">  <span style="color: #0000FF;">select</span> risk, <span style="color: #006FE0;">count</span>(*) <span style="color: #0000FF;">from</span> raw.inspections <span style="color: #0000FF;">group</span> <span style="color: #0000FF;">by</span> risk <span style="color: #0000FF;">order</span> <span style="color: #0000FF;">by</span> <span style="color: #006FE0;">count</span>(*) <span style="color: #0000FF;">desc</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">risk</th>
<th scope="col" class="org-right">count</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Risk 1 (High)</td>
<td class="org-right">116039</td>
</tr>

<tr>
<td class="org-left">Risk 2 (Medium)</td>
<td class="org-right">34012</td>
</tr>

<tr>
<td class="org-left">Risk 3 (Low)</td>
<td class="org-right">15457</td>
</tr>

<tr>
<td class="org-left">[NULL]</td>
<td class="org-right">66</td>
</tr>

<tr>
<td class="org-left">All</td>
<td class="org-right">23</td>
</tr>
</tbody>
</table>

<p>
Ok, we got two more <code>risk</code> types: <code>All</code> and <code>NULL</code> for a grand total
of <b>5</b>. 
</p>

<p>
What about <code>types</code> of inspections?
</p>

<div class="org-src-container">
<pre class="src src-sql">  <span style="color: #0000FF;">select</span> <span style="color: #006FE0;">count</span>(<span style="color: #0000FF;">distinct</span> <span style="color: #0000FF;">type</span>) <span style="color: #0000FF;">from</span> raw.inspections
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">count</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">108</td>
</tr>
</tbody>
</table>

<p>
Wow, we got <b>108</b> types of inspections instead of <b>5</b>.
</p>

<p>
Which are those types? How bad is it?
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">select</span> <span style="color: #0000FF;">type</span>, <span style="color: #006FE0;">count</span>(*) <span style="color: #0000FF;">from</span> raw.inspections <span style="color: #0000FF;">group</span> <span style="color: #0000FF;">by</span> <span style="color: #0000FF;">type</span> <span style="color: #0000FF;">order</span> <span style="color: #0000FF;">by</span> <span style="color: #006FE0;">count</span>(*) <span style="color: #0000FF;">desc</span> <span style="color: #0000FF;">limit</span> 10
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">type</th>
<th scope="col" class="org-right">count</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Canvass</td>
<td class="org-right">87871</td>
</tr>

<tr>
<td class="org-left">License</td>
<td class="org-right">21119</td>
</tr>

<tr>
<td class="org-left">Canvass Re-Inspection</td>
<td class="org-right">17010</td>
</tr>

<tr>
<td class="org-left">Complaint</td>
<td class="org-right">14979</td>
</tr>

<tr>
<td class="org-left">License Re-Inspection</td>
<td class="org-right">7598</td>
</tr>

<tr>
<td class="org-left">Complaint Re-Inspection</td>
<td class="org-right">6123</td>
</tr>

<tr>
<td class="org-left">Short Form Complaint</td>
<td class="org-right">6066</td>
</tr>

<tr>
<td class="org-left">Suspected Food Poisoning</td>
<td class="org-right">735</td>
</tr>

<tr>
<td class="org-left">Consultation</td>
<td class="org-right">667</td>
</tr>

<tr>
<td class="org-left">License-Task Force</td>
<td class="org-right">605</td>
</tr>
</tbody>
</table>

<p>
This columns will require also cleaning. Finally, let's look <code>results</code>
(should be 3)
</p>

<div class="org-src-container">
<pre class="src src-sql">  <span style="color: #0000FF;">select</span> results, <span style="color: #006FE0;">count</span>(*) <span style="color: #0000FF;">from</span> raw.inspections <span style="color: #0000FF;">group</span> <span style="color: #0000FF;">by</span> results <span style="color: #0000FF;">order</span> <span style="color: #0000FF;">by</span> <span style="color: #006FE0;">count</span>(*) <span style="color: #0000FF;">desc</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">results</th>
<th scope="col" class="org-right">count</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Pass</td>
<td class="org-right">96686</td>
</tr>

<tr>
<td class="org-left">Fail</td>
<td class="org-right">31939</td>
</tr>

<tr>
<td class="org-left">Pass w/ Conditions</td>
<td class="org-right">15625</td>
</tr>

<tr>
<td class="org-left">Out of Business</td>
<td class="org-right">14743</td>
</tr>

<tr>
<td class="org-left">No Entry</td>
<td class="org-right">4877</td>
</tr>

<tr>
<td class="org-left">Not Ready</td>
<td class="org-right">1052</td>
</tr>

<tr>
<td class="org-left">Business Not Located</td>
<td class="org-right">61</td>
</tr>
</tbody>
</table>

<p>
Ok, disheartening. But, that is the reality of <i>real</i> data. We will try to clean this mess.
</p>
</div>
</div>

<div id="outline-container-org86e5cdd" class="outline-4">
<h4 id="org86e5cdd"><span class="section-number-4">3.3.4</span> Cleaning</h4>
<div class="outline-text-4" id="text-3-3-4">
<p>
Let's see the data to figure out how we need to be transform it. We
will concentrate at first in all columns except <code>violations</code>, we will
deal with that later, since is more complex.
</p>

<p>
First, we will remove superfluous spaces and will transform the columns
<code>type, results, dba_name, aka_name, facility_type, address, city</code> to
lower case, also, we will clean <code>risk</code> keeping only the description
(e.g. <b>high</b> instead of <b>Risk 1 (High)</b>).
</p>

<p>
We still need to clean the column <code>type</code> (it contains several more
variations instead of the <b>seven</b> mentioned in the documentation:
<i>canvass</i>, <i>complaint</i>, <i>license</i>, <i>re-inspection</i>, <i>task-force</i>, <i>consultation</i>
and <i>suspect food poisoning</i>). For simplicity, we will use <i>regular
expressions</i> and we will ignore <i>re-inspection</i>.
</p>

<p>
For the column <code>risk</code> , we will impute as <code>high</code> all the <code>NULL</code> and <code>All</code>
values.
</p>

<p>
As we have seen (and we will continue see that)  through all this
tutorial, <i>data is always messy</i>, for example, in the column <code>dba_name</code>
 we have several different spellings: <code>SUBWAY</code> and
<code>Subway</code>, <code>MCDONALDS</code> and <code>MC DONALD'S</code>, <code>DUNKIN DONUTS/BASKIN ROBBINS</code> and
<code>DUNKIN DONUTS / BASKIN ROBBINS</code>, etc.
</p>

<p>
We could try a very simple cleaning strategy: convert all the
names to lowercase, remove the trailing spaces, remove the apostrophe
"<code>'"</code> and remove the spaces around "<code>/</code>". The problem with this approach
is that we will be fixing the names that we just saw, but there are
several other nuances down that list. Another approach is use <a href="https://www.postgresql.org/docs/current/static/fuzzystrmatch.html">soundex</a>,
but that will (potentially) create a lot of mismatches. The real workaround is apply
some <i>machine learning</i> to <i>deduplicate</i> the entities<sup><a id="fnr.14" class="footref" href="#fn.14">14</a></sup>.  We wont follow that
path here, we will stick with first alternative.
</p>

<p>
Let's review the status of the spatial columns (<code>state, city, zip, latitude,
longitude</code>). Beginning with the <code>state</code>, all the facilities in the
data should be located at <b>Ilinois</b>:
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">select</span> <span style="color: #0000FF;">state</span>, <span style="color: #006FE0;">count</span>(*) <span style="color: #0000FF;">from</span> raw.inspections <span style="color: #0000FF;">group</span> <span style="color: #0000FF;">by</span> <span style="color: #0000FF;">state</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">state</th>
<th scope="col" class="org-right">count</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">IL</td>
<td class="org-right">165575</td>
</tr>

<tr>
<td class="org-left">[NULL]</td>
<td class="org-right">22</td>
</tr>
</tbody>
</table>

<p>
Ok, almost correct, there are some <code>NULL</code> values. We will assume that
the <code>NULL</code> values are actually <code>IL</code> (We will impute them). Moving on
the next spatial column, We expect that all the values in the column
<code>city</code> are Chicago<sup><a id="fnr.15" class="footref" href="#fn.15">15</a></sup>: 
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">select</span> 
<span style="color: #006FE0;">lower</span>(city) <span style="color: #0000FF;">as</span> city, 
<span style="color: #006FE0;">count</span>(*) 
<span style="color: #0000FF;">from</span> raw.inspections 
<span style="color: #0000FF;">group</span> <span style="color: #0000FF;">by</span> <span style="color: #006FE0;">lower</span>(city) 
<span style="color: #0000FF;">order</span> <span style="color: #0000FF;">by</span> <span style="color: #006FE0;">count</span>(*) <span style="color: #0000FF;">desc</span> <span style="color: #0000FF;">limit</span> 10
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">city</th>
<th scope="col" class="org-right">count</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">chicago</td>
<td class="org-right">165221</td>
</tr>

<tr>
<td class="org-left">[NULL]</td>
<td class="org-right">148</td>
</tr>

<tr>
<td class="org-left">cchicago</td>
<td class="org-right">42</td>
</tr>

<tr>
<td class="org-left">schaumburg</td>
<td class="org-right">20</td>
</tr>

<tr>
<td class="org-left">maywood</td>
<td class="org-right">16</td>
</tr>

<tr>
<td class="org-left">elk grove village</td>
<td class="org-right">12</td>
</tr>

<tr>
<td class="org-left">chicagochicago</td>
<td class="org-right">9</td>
</tr>

<tr>
<td class="org-left">chestnut street</td>
<td class="org-right">8</td>
</tr>

<tr>
<td class="org-left">evanston</td>
<td class="org-right">8</td>
</tr>

<tr>
<td class="org-left">inactive</td>
<td class="org-right">8</td>
</tr>
</tbody>
</table>

<p>
Oh boy. There are 140-ish rows with <code>NULL</code> values and forty-ish rows with the
value <code>cchicago</code>, some more down the list, we got even
<code>chicagochicago</code>. The rest value are different counties, but all of
them are near to Chicago. We will ignore this column (or equivalently,
we will assume that all the records are from Chicago. 
</p>

<p>
The zip code has a similar <code>NULL</code> problem:
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">select</span> <span style="color: #006FE0;">count</span>(*) <span style="color: #0000FF;">from</span> raw.inspections <span style="color: #0000FF;">where</span> zip <span style="color: #0000FF;">is</span> <span style="color: #0000FF;">null</span> <span style="color: #0000FF;">or</span> btrim(zip) = <span style="color: #008000;">''</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">count</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">72</td>
</tr>
</tbody>
</table>

<p>
We could attempt to remove this <code>NULLs</code> using the location point or
using similar names of restaurants, but for this tutorial we will
remove them. Also, we will convert the coordinates latitude and
longitude to a <code>Point</code> <sup><a id="fnr.16" class="footref" href="#fn.16">16</a></sup> <sup>, </sup><sup><a id="fnr.17" class="footref" href="#fn.17">17</a></sup>. 
</p>

<p>
Continuing with the cleaning, we will drop the columns <code>state</code>,
<code>latitude</code>, <code>longitude</code> (since these are (now) redundant, because the
<code>Point</code> object). We will remove the column <code>city</code> since almost
everything happens in Chicago (this is the Chicago's food inspection data set anyway).
</p>

<p>
So, if you keep the counting, we are only keeping two columns related
to the spatial location of the events: the administrative one
(<code>zip_code</code>) and the exact point of the facility (<code>location</code>).
</p>

<p>
There are several violations inspected per event, for clarity we will
put the violations in their own table.
</p>

<p>
As a final step in the cleaning we will change the name of the columns
for explicit or better names(e.g <code>results -&gt; result, dba_name -&gt; facility</code>, etc).
</p>

<p>
We will create a new <code>schema</code> called <code>cleaned</code>. The objective of this
schema is twofold: keep our raw data <i>as-is</i> and store our assumptions
and cleaning decisions separated from the <i>raw</i> data in a schema that
<i>semantically</i> is transmitting the information: "this is our clean
data".
</p>

<p>
The <code>cleaned</code> schema will contain two tables: <code>cleaned.inspections</code>
and <code>cleaned.violations</code>. 
</p>


<div class="org-src-container">
<pre class="src src-sql">  <span style="color: #0000FF;">create</span> <span style="color: #0000FF;">schema</span> if <span style="color: #0000FF;">not</span> <span style="color: #0000FF;">exists</span> cleaned;
</pre>
</div>

<p>
Then, we will create our mini <b>ETL</b> with our cleaning decisions:
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">drop</span> <span style="color: #0000FF;">table</span> <span style="color: #006699;">if</span> <span style="color: #0000FF;">exists</span> cleaned.inspections <span style="color: #0000FF;">cascade</span>;

<span style="color: #0000FF;">create</span> <span style="color: #0000FF;">table</span> <span style="color: #006699;">cleaned.inspections</span> <span style="color: #0000FF;">as</span> (
<span style="color: #0000FF;">with</span> cleaned <span style="color: #0000FF;">as</span> (
<span style="color: #0000FF;">select</span>
inspection::<span style="color: #6434A3;">integer</span>,
btrim(<span style="color: #006FE0;">lower</span>(results)) <span style="color: #0000FF;">as</span> <span style="color: #0000FF;">result</span>, 
license_num::<span style="color: #6434A3;">integer</span>,
btrim(<span style="color: #006FE0;">lower</span>(dba_name)) <span style="color: #0000FF;">as</span> facility,
btrim(<span style="color: #006FE0;">lower</span>(aka_name)) <span style="color: #0000FF;">as</span> facility_aka,
<span style="color: #0000FF;">case</span> <span style="color: #0000FF;">when</span>
facility_type <span style="color: #0000FF;">is</span> <span style="color: #0000FF;">null</span> <span style="color: #0000FF;">then</span> <span style="color: #008000;">'unknown'</span>
<span style="color: #0000FF;">else</span> btrim(<span style="color: #006FE0;">lower</span>(facility_type))
<span style="color: #0000FF;">end</span> <span style="color: #0000FF;">as</span> facility_type,
<span style="color: #006FE0;">lower</span>(<span style="color: #006FE0;">substring</span>(risk <span style="color: #0000FF;">from</span> <span style="color: #008000;">'\((.+)\)'</span>)) <span style="color: #0000FF;">as</span> risk,
btrim(<span style="color: #006FE0;">lower</span>(address)) <span style="color: #0000FF;">as</span> address,
zip <span style="color: #0000FF;">as</span> zip_code,
<span style="color: #006FE0;">substring</span>(
btrim(<span style="color: #006FE0;">lower</span>(regexp_replace(<span style="color: #0000FF;">type</span>, <span style="color: #008000;">'liquor'</span>, <span style="color: #008000;">'task force'</span>, <span style="color: #008000;">'gi'</span>)))
<span style="color: #0000FF;">from</span> <span style="color: #008000;">'canvass|task force|complaint|food poisoning|consultation|license|tag removal'</span>) <span style="color: #0000FF;">as</span> <span style="color: #0000FF;">type</span>,
<span style="color: #6434A3;">date</span>,
ST_SetSRID(ST_MakePoint(longitude, latitude), 4326)::geography <span style="color: #0000FF;">as</span> location  <span style="color: #8D8D84; font-style: italic;">-- We use geography so the measurements are in meters</span>
<span style="color: #0000FF;">from</span> raw.inspections
<span style="color: #0000FF;">where</span> zip <span style="color: #0000FF;">is</span> <span style="color: #0000FF;">not</span> <span style="color: #0000FF;">null</span>  <span style="color: #8D8D84; font-style: italic;">-- removing NULL zip codes</span>
)

<span style="color: #0000FF;">select</span> * <span style="color: #0000FF;">from</span> cleaned <span style="color: #0000FF;">where</span> <span style="color: #0000FF;">type</span> <span style="color: #0000FF;">is</span> <span style="color: #0000FF;">not</span> <span style="color: #0000FF;">null</span>
);
</pre>
</div>

<p>
You could execute this code using (if you are not connected to the
database with <code>psql</code>):
</p>

<div class="org-src-container">
<pre class="src src-sh">psql ${<span style="color: #BA36A5;">FOOD_DB_URL</span>} &lt; /sql/create_cleaned_inspections_table.sql
</pre>
</div>

<p>
SELECT 164178
</p>

<p>
Or, if you are in <code>psql</code>
</p>

<pre class="example">
\i /code/create_cleaned_inspections_table.sql
</pre>

<p>
The number of inspections now is:
</p>

<div class="org-src-container">
<pre class="src src-sql"> <span style="color: #0000FF;">select</span> <span style="color: #006FE0;">count</span>(inspection) <span style="color: #0000FF;">from</span> cleaned.inspections;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">count</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">164790</td>
</tr>
</tbody>
</table>

<p>
Note that  <code class="src src-sh">psql ${<span style="color: #BA36A5;">FOOD_DB_URL</span>}  -t -P
 <span style="color: #BA36A5;">format</span>=unaligned  -c <span style="color: #008000;">'select count(inspection) from</span>
<span style="color: #008000;"> cleaned.inspections'</span></code> 164790
 is smaller than <code class="src src-sh">psql ${<span style="color: #BA36A5;">FOOD_DB_URL</span>}  -t -P
 <span style="color: #BA36A5;">format</span>=unaligned  -c <span style="color: #008000;">'select count(*) from</span>
<span style="color: #008000;"> raw.inspections'</span></code> 165597, as expected we throw away some inspections.
</p>

<p>
With the <code>cleaned.inspections</code> table created, let's look closer the
column <code>violations</code> to choose which steps we should take to clean it.
</p>

<p>
The first thing to note is that the column <code>violation</code> has a lot of information:
it mixes the official code and name of the <i>requirement to met</i> (see the
 <a href="#org55e8011">3.3.2</a>), followed by inspector's comments. The
comments are free text, that means that they can contain line breaks,
mispellings, etc. If there are more that one violation, they will be
separated using a pipe: <code>|</code>.
</p>

<p>
The following <code>sql</code> code removes line breaks and multiple spaces and
creates an array with all the violations of the inspection number <code>2145736</code>
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">select</span> 
string_to_array(regexp_replace(violations, <span style="color: #008000;">'[\n\r]+'</span>, <span style="color: #008000;">' '</span>, <span style="color: #008000;">'g'</span> ), <span style="color: #008000;">'|'</span>)  <span style="color: #0000FF;">as</span> violations_array
<span style="color: #0000FF;">from</span> raw.inspections <span style="color: #0000FF;">where</span> inspection = <span style="color: #008000;">'2145736'</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">violations_array</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">{"35. WALLS, CEILINGS, ATTACHED EQUIPMENT CONSTRUCTED PER CODE: GOOD REPAIR, SURFACES CLEAN AND DUST-LESS CLEANING METHODS - Comments: MISSING PART OF THE COVING(BASEBOARD) BY THE EXPOSED HAND SINK IN THE KITCHEN. MUST REPAIR AND MAINTAIN. WATER STAINED CEILING TILES IN THE LUNCH ROOM. MUST REPLACE CEILING TILES AND MAINTAIN. PEELING PAINT ON THE CEILING AND WALLS THROUGHOUT THE SCHOOL. HALLWAYS, INSIDE THE CLASSROOMS, INSIDE THE WASHROOMS IN ALL FLOORS. INSTRUCTED TO SCRAPE PEELING PAINT AND RE PAINT.     "," 32. FOOD AND NON-FOOD CONTACT SURFACES PROPERLY DESIGNED, CONSTRUCTED AND MAINTAINED - Comments: FIRST FLOOR GIRL'S WASHROOM,MIDDLE WASHBOWL SINK FAUCET NOT IN GOOD REPAIR, MUST REPAIR AND MAINTAIN. ONE OUT OF TWO HAND DRYER NOT WORKING IN THE FOLLOWING WASHROOM: FIRST FLOOR  BOY'S AND GIRL'S WASHROOM, AND  BOY'S AND GIRL'S WASHROOM 2ND FLOOR. MUST REPAIR AND MAINTAIN. "," 34. FLOORS: CONSTRUCTED PER CODE, CLEANED, GOOD REPAIR, COVING INSTALLED, DUST-LESS CLEANING METHODS USED - Comments: DAMAGED FLOOR INSIDE THE BOY'S AND GIRL'S WASHROOM 2ND FLOOR. MUST REPAIR, MAKE THE FLOOR SMOOTH EASILY CLEANABLE."}</td>
</tr>
</tbody>
</table>

<p>
The structure of the <code>violations</code> column is (check the previous output):
</p>

<ul class="org-ul">
<li>If there are several violations reported, those violations will
be separated by <code>'|'</code></li>
<li>Every violation begins with a code and  a description</li>
<li>Every violation could have <b>comments</b>, those comments appear after
the string <code>- Comments:</code></li>
</ul>

<p>
We will take that observations in account and create a new table
called <code>cleaned.violations</code> to store
</p>

<ul class="org-ul">
<li>inspection</li>
<li>code</li>
<li>description</li>
<li>comments</li>
</ul>

<div class="org-src-container">
<pre class="src src-sql">   <span style="color: #0000FF;">drop</span> <span style="color: #0000FF;">table</span> <span style="color: #006699;">if</span> <span style="color: #0000FF;">exists</span> cleaned.violations <span style="color: #0000FF;">cascade</span>;

   <span style="color: #0000FF;">create</span> <span style="color: #0000FF;">table</span> <span style="color: #006699;">cleaned.violations</span> <span style="color: #0000FF;">as</span> (
   <span style="color: #0000FF;">select</span>
   inspection::<span style="color: #6434A3;">integer</span>,
   license_num::<span style="color: #6434A3;">integer</span>, 
   <span style="color: #6434A3;">date</span>::<span style="color: #6434A3;">date</span>,
   btrim(tuple[1]) <span style="color: #0000FF;">as</span> code,
   btrim(tuple[2]) <span style="color: #0000FF;">as</span> description,
   btrim(tuple[3]) <span style="color: #0000FF;">as</span> comment,
   (<span style="color: #0000FF;">case</span>
     <span style="color: #0000FF;">when</span> btrim(tuple[1]) = <span style="color: #008000;">''</span> <span style="color: #0000FF;">then</span> <span style="color: #0000FF;">NULL</span> 
     <span style="color: #0000FF;">when</span> btrim(tuple[1])::<span style="color: #6434A3;">int</span> <span style="color: #0000FF;">between</span> 1 <span style="color: #0000FF;">and</span> 14 <span style="color: #0000FF;">then</span> <span style="color: #008000;">'critical'</span> <span style="color: #8D8D84; font-style: italic;">-- From the documentation</span>
     <span style="color: #0000FF;">when</span> btrim(tuple[1])::<span style="color: #6434A3;">int</span> <span style="color: #0000FF;">between</span> 15 <span style="color: #0000FF;">and</span> 29  <span style="color: #0000FF;">then</span> <span style="color: #008000;">'serious'</span>
     <span style="color: #0000FF;">else</span> <span style="color: #008000;">'minor'</span>
   <span style="color: #0000FF;">end</span>
   ) <span style="color: #0000FF;">as</span> severity <span style="color: #0000FF;">from</span>
   (
   <span style="color: #0000FF;">select</span>
   inspection,
   license_num,
   <span style="color: #6434A3;">date</span>,
   regexp_split_to_array(   <span style="color: #8D8D84; font-style: italic;">-- Create an array we will split the code, description, comment</span>
     regexp_split_to_table( <span style="color: #8D8D84; font-style: italic;">-- Create a row per each comment we split by |</span>
       <span style="color: #006FE0;">coalesce</span>(            <span style="color: #8D8D84; font-style: italic;">-- If there isn't a violation add '- Comments:'</span>
         regexp_replace(violations, <span style="color: #008000;">'[\n\r]+'</span>, <span style="color: #008000;">''</span>, <span style="color: #008000;">'g'</span> )  <span style="color: #8D8D84; font-style: italic;">-- Remove line breaks</span>
       , <span style="color: #008000;">'- Comments:'</span>)
     , <span style="color: #008000;">'\|'</span>)  <span style="color: #8D8D84; font-style: italic;">-- Split the violations</span>
   , <span style="color: #008000;">'(?&lt;=\d+)\.\s*|\s*-\s*Comments:'</span>)  <span style="color: #8D8D84; font-style: italic;">-- Split each violation in three </span>
    <span style="color: #0000FF;">as</span> tuple
   <span style="color: #0000FF;">from</span> raw.inspections
   <span style="color: #0000FF;">where</span> results <span style="color: #0000FF;">in</span> (<span style="color: #008000;">'Fail'</span>, <span style="color: #008000;">'Pass'</span>, <span style="color: #008000;">'Pass w/ Conditions'</span>) <span style="color: #0000FF;">and</span> license_num <span style="color: #0000FF;">is</span> <span style="color: #0000FF;">not</span> <span style="color: #0000FF;">null</span>
   ) <span style="color: #0000FF;">as</span> t
   );
</pre>
</div>

<p>
This code is in <code>/sql/create_violations_table.sql</code>, you can Execute
 it as before.
</p>

<p>
We can verify the result of the previous Script
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">select</span> * <span style="color: #0000FF;">from</span> cleaned.violations 
<span style="color: #0000FF;">where</span> inspection = 2145736
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">inspection</th>
<th scope="col" class="org-right">license_num</th>
<th scope="col" class="org-right">date</th>
<th scope="col" class="org-right">code</th>
<th scope="col" class="org-left">description</th>
<th scope="col" class="org-left">comment</th>
<th scope="col" class="org-left">severity</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">2145736</td>
<td class="org-right">23591</td>
<td class="org-right">2018-03-01</td>
<td class="org-right">35</td>
<td class="org-left">WALLS, CEILINGS, ATTACHED EQUIPMENT CONSTRUCTED PER CODE: GOOD REPAIR, SURFACES CLEAN AND DUST-LESS CLEANING METHODS</td>
<td class="org-left">MISSING PART OF THE COVING(BASEBOARD) BY THE EXPOSED HAND SINK IN THE KITCHEN. MUST REPAIR AND MAINTAIN.WATER STAINED CEILING TILES IN THE LUNCH ROOM. MUST REPLACE CEILING TILES AND MAINTAIN.PEELING PAINT ON THE CEILING AND WALLS THROUGHOUT THE SCHOOL. HALLWAYS, INSIDE THE CLASSROOMS, INSIDE THE WASHROOMS IN ALL FLOORS. INSTRUCTED TO SCRAPE PEELING PAINT AND RE PAINT.</td>
<td class="org-left">minor</td>
</tr>

<tr>
<td class="org-right">2145736</td>
<td class="org-right">23591</td>
<td class="org-right">2018-03-01</td>
<td class="org-right">32</td>
<td class="org-left">FOOD AND NON-FOOD CONTACT SURFACES PROPERLY DESIGNED, CONSTRUCTED AND MAINTAINED</td>
<td class="org-left">FIRST FLOOR GIRL'S WASHROOM,MIDDLE WASHBOWL SINK FAUCET NOT IN GOOD REPAIR, MUST REPAIR AND MAINTAIN.ONE OUT OF TWO HAND DRYER NOT WORKING IN THE FOLLOWING WASHROOM:FIRST FLOOR  BOY'S AND GIRL'S WASHROOM, AND  BOY'S AND GIRL'S WASHROOM 2ND FLOOR. MUST REPAIR AND MAINTAIN.</td>
<td class="org-left">minor</td>
</tr>

<tr>
<td class="org-right">2145736</td>
<td class="org-right">23591</td>
<td class="org-right">2018-03-01</td>
<td class="org-right">34</td>
<td class="org-left">FLOORS: CONSTRUCTED PER CODE, CLEANED, GOOD REPAIR, COVING INSTALLED, DUST-LESS CLEANING METHODS USED</td>
<td class="org-left">DAMAGED FLOOR INSIDE THE BOY'S AND GIRL'S WASHROOM 2ND FLOOR. MUST REPAIR, MAKE THE FLOOR SMOOTH EASILY CLEANABLE.</td>
<td class="org-left">minor</td>
</tr>
</tbody>
</table>


<p>
If everything worked correctly you should be able to run the following code:
</p>

<div class="org-src-container">
<pre class="src src-sql">  <span style="color: #0000FF;">select</span>
  <span style="color: #0000FF;">case</span> <span style="color: #0000FF;">when</span> <span style="color: #0000FF;">grouping</span>(severity) = 1 <span style="color: #0000FF;">then</span> <span style="color: #008000;">'TOTAL'</span> <span style="color: #0000FF;">else</span> severity <span style="color: #0000FF;">end</span> <span style="color: #0000FF;">as</span> severity,
  <span style="color: #006FE0;">count</span>(*) <span style="color: #0000FF;">from</span> cleaned.violations
  <span style="color: #0000FF;">group</span> <span style="color: #0000FF;">by</span> <span style="color: #0000FF;">rollup</span> (severity)
  <span style="color: #0000FF;">order</span> <span style="color: #0000FF;">by</span> severity nulls <span style="color: #0000FF;">first</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">severity</th>
<th scope="col" class="org-right">count</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">[NULL]</td>
<td class="org-right">12952</td>
</tr>

<tr>
<td class="org-left">critical</td>
<td class="org-right">39120</td>
</tr>

<tr>
<td class="org-left">minor</td>
<td class="org-right">488954</td>
</tr>

<tr>
<td class="org-left">serious</td>
<td class="org-right">79242</td>
</tr>

<tr>
<td class="org-left">TOTAL</td>
<td class="org-right">620268</td>
</tr>
</tbody>
</table>

<p>
As a last step, we should create from the cleaned tables the <code>entities</code>
and <code>events</code> table.
</p>
</div>
</div>
</div>

<div id="outline-container-orgbb66575" class="outline-3">
<h3 id="orgbb66575"><span class="section-number-3">3.4</span> Semantic tables</h3>
<div class="outline-text-3" id="text-3-4">
</div>
<div id="outline-container-orgf4aca67" class="outline-4">
<h4 id="orgf4aca67"><span class="section-number-4">3.4.1</span> Entities table</h4>
<div class="outline-text-4" id="text-3-4-1">
<p>
The <code>entities</code> table should uniquely identify each one of the facilities and contain
the attributes that describes each one of them. First, we should
investigate how we can identify uniquely a facility. Let's hope that
this is easy.
</p>

<p>
We could expect that <code>license_num</code> is the way to go for uniquely
identify the facility, let's confirm this with some queries.
</p>

<p>
We will beging with the following query: <i>What are the top 5 licenses with more inspections?</i>
</p>

<div class="org-src-container">
<pre class="src src-sql">    <span style="color: #0000FF;">select</span>
    license_num, 
    <span style="color: #006FE0;">count</span>(*) <span style="color: #0000FF;">as</span> total_inspections,
    <span style="color: #006FE0;">coalesce</span>(<span style="color: #006FE0;">count</span>(*) filter (<span style="color: #0000FF;">where</span> <span style="color: #0000FF;">result</span> = <span style="color: #008000;">'fail'</span>), 0)
    <span style="color: #0000FF;">as</span> total_failures
    <span style="color: #0000FF;">from</span> cleaned.inspections
    <span style="color: #0000FF;">group</span> <span style="color: #0000FF;">by</span> license_num
    <span style="color: #0000FF;">order</span> <span style="color: #0000FF;">by</span> total_inspections <span style="color: #0000FF;">desc</span>
    <span style="color: #0000FF;">limit</span> 5;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">license_num</th>
<th scope="col" class="org-right">total_inspections</th>
<th scope="col" class="org-right">total_failures</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">0</td>
<td class="org-right">420</td>
<td class="org-right">111</td>
</tr>

<tr>
<td class="org-right">1354323</td>
<td class="org-right">192</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-right">14616</td>
<td class="org-right">172</td>
<td class="org-right">30</td>
</tr>

<tr>
<td class="org-right">1574001</td>
<td class="org-right">80</td>
<td class="org-right">4</td>
</tr>

<tr>
<td class="org-right">1974745</td>
<td class="org-right">59</td>
<td class="org-right">3</td>
</tr>
</tbody>
</table>


<p>
This looks weird, there are three license  numbers than concentrates
 most of the inspections (in particular license number <code>0</code>) Let's
 investigate a little about the <code>license_num</code> = <code>0</code>. 
</p>

<div class="org-src-container">
<pre class="src src-sql">  <span style="color: #0000FF;">select</span>
  facility_type, <span style="color: #006FE0;">count</span>(*) <span style="color: #0000FF;">as</span> total_inspections,
  <span style="color: #006FE0;">coalesce</span>(<span style="color: #006FE0;">count</span>(*) filter (<span style="color: #0000FF;">where</span> <span style="color: #0000FF;">result</span> = <span style="color: #008000;">'fail'</span>), 0)
  <span style="color: #0000FF;">as</span> total_failures
  <span style="color: #0000FF;">from</span> cleaned.inspections
  <span style="color: #0000FF;">where</span> license_num=0
  <span style="color: #0000FF;">group</span> <span style="color: #0000FF;">by</span>  facility_type
  <span style="color: #0000FF;">order</span> <span style="color: #0000FF;">by</span> total_inspections <span style="color: #0000FF;">desc</span>
  <span style="color: #0000FF;">limit</span> 10
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">facility_type</th>
<th scope="col" class="org-right">total_inspections</th>
<th scope="col" class="org-right">total_failures</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">restaurant</td>
<td class="org-right">101</td>
<td class="org-right">43</td>
</tr>

<tr>
<td class="org-left">special event</td>
<td class="org-right">61</td>
<td class="org-right">8</td>
</tr>

<tr>
<td class="org-left">unknown</td>
<td class="org-right">43</td>
<td class="org-right">10</td>
</tr>

<tr>
<td class="org-left">shelter</td>
<td class="org-right">31</td>
<td class="org-right">6</td>
</tr>

<tr>
<td class="org-left">navy pier kiosk</td>
<td class="org-right">30</td>
<td class="org-right">4</td>
</tr>

<tr>
<td class="org-left">church</td>
<td class="org-right">28</td>
<td class="org-right">3</td>
</tr>

<tr>
<td class="org-left">grocery store</td>
<td class="org-right">16</td>
<td class="org-right">7</td>
</tr>

<tr>
<td class="org-left">church kitchen</td>
<td class="org-right">14</td>
<td class="org-right">6</td>
</tr>

<tr>
<td class="org-left">private school</td>
<td class="org-right">11</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-left">long term care</td>
<td class="org-right">9</td>
<td class="org-right">1</td>
</tr>
</tbody>
</table>

<p>
It seems that <code>license_number</code> <code>0</code> is a generic Placeholder:
Most of these are related to <i>special events</i>, <i>churchs</i>, <i>festivals</i>
etc. But, What about  the <code>restaurants</code> which have <code>license_num</code> =
<code>0</code>? Are those the same restaurant?
</p>


<div class="org-src-container">
<pre class="src src-sql">  <span style="color: #0000FF;">select</span>
  license_num, facility, address, <span style="color: #006FE0;">count</span>(*) <span style="color: #0000FF;">as</span> total_inspections,
  <span style="color: #006FE0;">coalesce</span>(<span style="color: #006FE0;">count</span>(*) filter (<span style="color: #0000FF;">where</span> <span style="color: #0000FF;">result</span> = <span style="color: #008000;">'fail'</span>), 0)
  <span style="color: #0000FF;">as</span> total_failures
  <span style="color: #0000FF;">from</span> cleaned.inspections
  <span style="color: #0000FF;">where</span> license_num = 0
  <span style="color: #0000FF;">and</span> facility_type = <span style="color: #008000;">'restaurant'</span>
  <span style="color: #0000FF;">group</span> <span style="color: #0000FF;">by</span>  license_num, facility, address
  <span style="color: #0000FF;">order</span> <span style="color: #0000FF;">by</span> total_inspections <span style="color: #0000FF;">desc</span>
  <span style="color: #0000FF;">limit</span> 10
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">license_num</th>
<th scope="col" class="org-left">facility</th>
<th scope="col" class="org-left">address</th>
<th scope="col" class="org-right">total_inspections</th>
<th scope="col" class="org-right">total_failures</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">0</td>
<td class="org-left">british airways</td>
<td class="org-left">11601 w touhy ave</td>
<td class="org-right">5</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-right">0</td>
<td class="org-left">rib lady 2</td>
<td class="org-left">4203 w cermak rd</td>
<td class="org-right">4</td>
<td class="org-right">3</td>
</tr>

<tr>
<td class="org-right">0</td>
<td class="org-left">unlicensed</td>
<td class="org-left">7559 n ridge blvd</td>
<td class="org-right">3</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-right">0</td>
<td class="org-left">nutricion familiar</td>
<td class="org-left">3000 w 59th st</td>
<td class="org-right">3</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-right">0</td>
<td class="org-left">taqueria la capital</td>
<td class="org-left">3508 w 63rd st</td>
<td class="org-right">3</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-right">0</td>
<td class="org-left">herbalife</td>
<td class="org-left">6214 w diversey ave</td>
<td class="org-right">3</td>
<td class="org-right">2</td>
</tr>

<tr>
<td class="org-right">0</td>
<td class="org-left">las quecas</td>
<td class="org-left">2500 s christiana ave</td>
<td class="org-right">3</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-right">0</td>
<td class="org-left">la michoacana</td>
<td class="org-left">4346 s california ave</td>
<td class="org-right">3</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-right">0</td>
<td class="org-left">mrs. t's southern fried chicken</td>
<td class="org-left">3343 n broadway</td>
<td class="org-right">3</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-right">0</td>
<td class="org-left">vinces pizzeria &amp; taqueria, inc</td>
<td class="org-left">1527 w devon ave</td>
<td class="org-right">3</td>
<td class="org-right">1</td>
</tr>
</tbody>
</table>

<p>
Nope. We conclude that we can't use the <code>license_num</code> as the unique
identifier.
</p>

<p>
If we go back to the columns of the table, we could try with the
column <code>license_num</code>  (assume that one license represents one
establishment) and the column <code>address</code> (assume that one restaurant is
in one place).
</p>

<div class="org-src-container">
<pre class="src src-sql">  <span style="color: #0000FF;">select</span>
  <span style="color: #006FE0;">count</span>(<span style="color: #0000FF;">distinct</span> license_num) <span style="color: #0000FF;">as</span> total_licenses,
  <span style="color: #006FE0;">count</span>(<span style="color: #0000FF;">distinct</span> facility) <span style="color: #0000FF;">as</span> total_facilities,
  <span style="color: #006FE0;">count</span>(<span style="color: #0000FF;">distinct</span> address) <span style="color: #0000FF;">as</span> total_addresses
  <span style="color: #0000FF;">from</span> cleaned.inspections
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">total_licenses</th>
<th scope="col" class="org-right">total_facilities</th>
<th scope="col" class="org-right">total_addresses</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">33666</td>
<td class="org-right">24937</td>
<td class="org-right">17120</td>
</tr>
</tbody>
</table>

<p>
We were expecting (naively) that we should get one <code>license_num</code> per
<code>facility</code> per <code>address</code>, but it isn't the case. This could be mean that
several facilities share the name (e.g. "Subway" or "Mc Donalds")  or the
license; another explanation is that several facilities share the same
address, as the facilities at the stadium or the airport.
</p>

<p>
We will try to use the combination of <code>license_num</code>, <code>facility</code>, <code>facility_aka</code>,
<code>facility_type</code> and <code>address</code> to identify a facility:
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">select</span>
license_num, facility, facility_type, facility_aka, address , <span style="color: #006FE0;">count</span>(*)
<span style="color: #0000FF;">from</span> cleaned.inspections
<span style="color: #0000FF;">group</span> <span style="color: #0000FF;">by</span> license_num, facility, facility_type, facility_aka, address
<span style="color: #0000FF;">order</span> <span style="color: #0000FF;">by</span> <span style="color: #006FE0;">count</span>(*) <span style="color: #0000FF;">desc</span>, facility, facility_aka, address, license_num, facility_type
<span style="color: #0000FF;">limit</span> 10
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">license_num</th>
<th scope="col" class="org-left">facility</th>
<th scope="col" class="org-left">facility_type</th>
<th scope="col" class="org-left">facility_aka</th>
<th scope="col" class="org-left">address</th>
<th scope="col" class="org-right">count</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">1490035</td>
<td class="org-left">mcdonald's</td>
<td class="org-left">restaurant</td>
<td class="org-left">mcdonald's</td>
<td class="org-left">6900 s lafayette ave</td>
<td class="org-right">46</td>
</tr>

<tr>
<td class="org-right">1596210</td>
<td class="org-left">food 4 less midwest #552</td>
<td class="org-left">grocery store</td>
<td class="org-left">food 4 less</td>
<td class="org-left">7030 s ashland ave</td>
<td class="org-right">44</td>
</tr>

<tr>
<td class="org-right">1142451</td>
<td class="org-left">jewel food  store # 3345</td>
<td class="org-left">grocery store</td>
<td class="org-left">jewel food  store # 3345</td>
<td class="org-left">1224 s wabash ave</td>
<td class="org-right">41</td>
</tr>

<tr>
<td class="org-right">1302136</td>
<td class="org-left">mcdonald's</td>
<td class="org-left">restaurant</td>
<td class="org-left">mcdonald's</td>
<td class="org-left">70 e garfield blvd</td>
<td class="org-right">40</td>
</tr>

<tr>
<td class="org-right">1476553</td>
<td class="org-left">pete's produce</td>
<td class="org-left">grocery store</td>
<td class="org-left">pete's produce</td>
<td class="org-left">1543 e 87th st</td>
<td class="org-right">40</td>
</tr>

<tr>
<td class="org-right">2083833</td>
<td class="org-left">mariano's fresh market #8503</td>
<td class="org-left">grocery store</td>
<td class="org-left">mariano's fresh market</td>
<td class="org-left">333 e benton pl</td>
<td class="org-right">39</td>
</tr>

<tr>
<td class="org-right">1000572</td>
<td class="org-left">jewel food store #3030</td>
<td class="org-left">grocery store</td>
<td class="org-left">jewel food store #3030</td>
<td class="org-left">7530 s stony island ave</td>
<td class="org-right">37</td>
</tr>

<tr>
<td class="org-right">1094</td>
<td class="org-left">one stop food &amp; liquor store</td>
<td class="org-left">grocery store</td>
<td class="org-left">one stop food &amp; liquor store</td>
<td class="org-left">4301-4323 s lake park ave</td>
<td class="org-right">37</td>
</tr>

<tr>
<td class="org-right">60184</td>
<td class="org-left">taqueria el ranchito</td>
<td class="org-left">restaurant</td>
<td class="org-left">taqueria el ranchito</td>
<td class="org-left">2829 n milwaukee ave</td>
<td class="org-right">37</td>
</tr>

<tr>
<td class="org-right">1884255</td>
<td class="org-left">food 4 less</td>
<td class="org-left">grocery store</td>
<td class="org-left">food 4 less</td>
<td class="org-left">4821 w north ave</td>
<td class="org-right">36</td>
</tr>
</tbody>
</table>

<p>
Which attributes should we add to the <code>entities</code> table? All the
attributes that describe the entity and doesn't depend on the
event and are atemporal. Therefore we will add <code>zip_code</code> and
<code>location</code>. We also will add <code>start_time, end_time</code> . These columns
describe the interval in which the facility is on business or <i>active</i>.
</p>

<p>
These columns will be important because we won't make predictions on
entities that aren't active.  
</p>

<p>
We don't have this type of date directly in our data source, so we
will use as an interval between the earliest date in the data source
and the latest date <b>or</b> the greater data in which  the <b>result</b> of the
inspection was <code>out of business</code> or <code>business not located</code>.
</p>

<div class="org-src-container">
<pre class="src src-sql">
<span style="color: #0000FF;">create</span> <span style="color: #0000FF;">schema</span> if <span style="color: #0000FF;">not</span> <span style="color: #0000FF;">exists</span> semantic;

<span style="color: #0000FF;">drop</span> <span style="color: #0000FF;">table</span> <span style="color: #006699;">if</span> <span style="color: #0000FF;">exists</span> semantic.entities <span style="color: #0000FF;">cascade</span>;

<span style="color: #0000FF;">create</span> <span style="color: #0000FF;">table</span> <span style="color: #006699;">semantic.entities</span> <span style="color: #0000FF;">as</span> (

<span style="color: #0000FF;">with</span> entities_date <span style="color: #0000FF;">as</span> (

  <span style="color: #0000FF;">select</span>
  license_num,
  facility,
  facility_aka,
  facility_type,
  address,
  zip_code,
  location,
  <span style="color: #006FE0;">min</span>(<span style="color: #6434A3;">date</span>) over (partition <span style="color: #0000FF;">by</span> license_num, facility, facility_aka, address) <span style="color: #0000FF;">as</span> start_time,
  <span style="color: #006FE0;">max</span>(<span style="color: #0000FF;">case</span> <span style="color: #0000FF;">when</span>
  <span style="color: #0000FF;">result</span> <span style="color: #0000FF;">in</span> (<span style="color: #008000;">'out of business'</span>, <span style="color: #008000;">'business not located'</span>)
  <span style="color: #0000FF;">then</span>
  <span style="color: #6434A3;">date</span>
  <span style="color: #0000FF;">else</span>
  <span style="color: #0000FF;">NULL</span>
  <span style="color: #0000FF;">end</span>) over (partition <span style="color: #0000FF;">by</span> license_num, facility, facility_aka, address) <span style="color: #0000FF;">as</span> end_time
  <span style="color: #0000FF;">from</span> cleaned.inspections

)

<span style="color: #0000FF;">select</span> <span style="color: #0000FF;">distinct</span>
   dense_rank() over (w) <span style="color: #0000FF;">as</span> entity_id,
   license_num,
   facility,
   facility_aka,
   facility_type,
   address,
   zip_code,
   location,
   start_time,
   end_time
<span style="color: #0000FF;">from</span> entities_date
   window w <span style="color: #0000FF;">as</span> (<span style="color: #0000FF;">order</span> <span style="color: #0000FF;">by</span> license_num, facility, facility_aka, facility_type, address)
);


<span style="color: #8D8D84; font-style: italic;">-- Adding some indices</span>
<span style="color: #0000FF;">create</span> index entities_ix <span style="color: #0000FF;">on</span> semantic.entities (entity_id);

<span style="color: #0000FF;">create</span> index entities_license_num_ix <span style="color: #0000FF;">on</span> semantic.entities (license_num);
<span style="color: #0000FF;">create</span> index entities_facility_ix <span style="color: #0000FF;">on</span> semantic.entities (facility);
<span style="color: #0000FF;">create</span> index entities_facility_type_ix <span style="color: #0000FF;">on</span> semantic.entities (facility_type);
<span style="color: #0000FF;">create</span> index entities_zip_code_ix <span style="color: #0000FF;">on</span> semantic.entities (zip_code);

<span style="color: #8D8D84; font-style: italic;">-- Spatial index</span>
<span style="color: #0000FF;">create</span> index entities_location_gix <span style="color: #0000FF;">on</span> semantic.entities <span style="color: #0000FF;">using</span> gist (location);

<span style="color: #0000FF;">create</span> index entities_full_key_ix <span style="color: #0000FF;">on</span> semantic.entities (license_num, facility, facility_aka, facility_type, address);

</pre>
</div>

<p>
Note that we add a <i>unique</i> identifier (<code>entity_id</code>) to this table
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">select</span> <span style="color: #006FE0;">count</span>(entity_id) <span style="color: #0000FF;">from</span> semantic.entities
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">count</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">34917</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>


<div id="outline-container-orgfee7f71" class="outline-3">
<h3 id="orgfee7f71"><span class="section-number-3">3.5</span> Events table</h3>
<div class="outline-text-3" id="text-3-5">
<p>
We are ready for creating our events table. This table will describe
the data related to the inspection, like <i>where</i> and <i>when</i> the
inspection happened, some attributes of the inspection as <i>type</i> and
<i>result</i>, and we will add the violations as a <code>JSONB</code>
column<sup><a id="fnr.18" class="footref" href="#fn.18">18</a></sup>. As a final detail we will rename the <code>inspection</code>
number to <code>event_id</code><sup><a id="fnr.19" class="footref" href="#fn.19">19</a></sup>  
</p>


<div class="org-src-container">
<pre class="src src-sql">
<span style="color: #0000FF;">drop</span> <span style="color: #0000FF;">table</span> <span style="color: #006699;">if</span> <span style="color: #0000FF;">exists</span> semantic.events <span style="color: #0000FF;">cascade</span>;

<span style="color: #0000FF;">create</span> <span style="color: #0000FF;">table</span> <span style="color: #006699;">semantic.events</span> <span style="color: #0000FF;">as</span> (

<span style="color: #0000FF;">with</span> entities <span style="color: #0000FF;">as</span> (
  <span style="color: #0000FF;">select</span> * <span style="color: #0000FF;">from</span> semantic.entities
),

inspections <span style="color: #0000FF;">as</span> (
<span style="color: #0000FF;">select</span>
i.inspection, i.<span style="color: #0000FF;">type</span>, i.<span style="color: #6434A3;">date</span>, i.risk, i.<span style="color: #0000FF;">result</span>,
i.license_num, i.facility, i.facility_aka, i.facility_type, i.address, i.zip_code, i.location,
jsonb_agg(
    jsonb_build_object(
        <span style="color: #008000;">'code'</span>, v.code,
        <span style="color: #008000;">'severity'</span>, v.severity,
        <span style="color: #008000;">'description'</span>, v.description,
        <span style="color: #008000;">'comment'</span>, v.comment
        )
<span style="color: #0000FF;">order</span>  <span style="color: #0000FF;">by</span> code
) <span style="color: #0000FF;">as</span> violations
<span style="color: #0000FF;">from</span> cleaned.inspections <span style="color: #0000FF;">as</span> i
<span style="color: #0000FF;">inner</span> <span style="color: #0000FF;">join</span>
cleaned.violations <span style="color: #0000FF;">as</span> v
<span style="color: #0000FF;">on</span> i.inspection = v.inspection
<span style="color: #0000FF;">group</span> <span style="color: #0000FF;">by</span>
i.inspection, i.<span style="color: #0000FF;">type</span>, i.license_num, i.facility, i.facility_aka, i.facility_type, i.address, i.zip_code, i.location,
i.<span style="color: #6434A3;">date</span>, i.risk, i.<span style="color: #0000FF;">result</span>
)

<span style="color: #0000FF;">select</span>
i.inspection <span style="color: #0000FF;">as</span> event_id, 
e.entity_id, i.<span style="color: #0000FF;">type</span>, i.<span style="color: #6434A3;">date</span>, i.risk, i.<span style="color: #0000FF;">result</span>,
e.facility_type, e.zip_code, e.location,
i.violations
<span style="color: #0000FF;">from</span> entities <span style="color: #0000FF;">as</span> e
<span style="color: #0000FF;">inner</span> <span style="color: #0000FF;">join</span>
inspections <span style="color: #0000FF;">as</span> i
<span style="color: #0000FF;">using</span> (license_num, facility, facility_aka, facility_type, address, zip_code)

);

<span style="color: #8D8D84; font-style: italic;">-- Add some indices</span>
<span style="color: #0000FF;">create</span> index events_entity_ix <span style="color: #0000FF;">on</span> semantic.events (entity_id);
<span style="color: #0000FF;">create</span> index events_event_ix <span style="color: #0000FF;">on</span> semantic.events (event_id);
<span style="color: #0000FF;">create</span> index events_type_ix <span style="color: #0000FF;">on</span> semantic.events (<span style="color: #0000FF;">type</span>);
<span style="color: #0000FF;">create</span> index events_date_ix <span style="color: #0000FF;">on</span> semantic.events(<span style="color: #6434A3;">date</span> <span style="color: #0000FF;">desc</span> nulls <span style="color: #0000FF;">last</span>);
<span style="color: #0000FF;">create</span> index events_facility_type_ix <span style="color: #0000FF;">on</span> semantic.events  (facility_type);
<span style="color: #0000FF;">create</span> index events_zip_code_ix <span style="color: #0000FF;">on</span> semantic.events  (zip_code);

<span style="color: #8D8D84; font-style: italic;">-- Spatial index</span>
<span style="color: #0000FF;">create</span> index events_location_gix <span style="color: #0000FF;">on</span> semantic.events <span style="color: #0000FF;">using</span> gist (location);

<span style="color: #8D8D84; font-style: italic;">-- JSONB indices</span>
<span style="color: #0000FF;">create</span> index events_violations <span style="color: #0000FF;">on</span> semantic.events <span style="color: #0000FF;">using</span> gin(violations);
<span style="color: #0000FF;">create</span> index events_violations_json_path <span style="color: #0000FF;">on</span> semantic.events <span style="color: #0000FF;">using</span> gin(violations jsonb_path_ops);

<span style="color: #0000FF;">create</span> index events_event_entity_zip_code_date <span style="color: #0000FF;">on</span> semantic.events (event_id <span style="color: #0000FF;">desc</span> nulls <span style="color: #0000FF;">last</span>, entity_id, zip_code, <span style="color: #6434A3;">date</span> <span style="color: #0000FF;">desc</span> nulls <span style="color: #0000FF;">last</span>);

</pre>
</div>

<p>
We accomplished to have one row per event<sup><a id="fnr.20" class="footref" href="#fn.20">20</a></sup>. Our semantic data looks like:
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">select</span> event_id, entity_id, <span style="color: #0000FF;">type</span>, <span style="color: #6434A3;">date</span>, risk, <span style="color: #0000FF;">result</span>, facility_type, zip_code <span style="color: #0000FF;">from</span> semantic.events <span style="color: #0000FF;">limit</span> 1
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">event_id</th>
<th scope="col" class="org-right">entity_id</th>
<th scope="col" class="org-left">type</th>
<th scope="col" class="org-right">date</th>
<th scope="col" class="org-left">risk</th>
<th scope="col" class="org-left">result</th>
<th scope="col" class="org-left">facility_type</th>
<th scope="col" class="org-right">zip_code</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">1343315</td>
<td class="org-right">1</td>
<td class="org-left">canvass</td>
<td class="org-right">2013-06-06</td>
<td class="org-left">low</td>
<td class="org-left">fail</td>
<td class="org-left">newsstand</td>
<td class="org-right">60623</td>
</tr>
</tbody>
</table>

<p>
We omitted <code>violations</code> and <code>location</code> for brevity. The total number of inspections is
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">select</span> <span style="color: #006FE0;">count</span>(event_id) <span style="color: #0000FF;">from</span> semantic.events
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">count</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">142248</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>


<div id="outline-container-org657dba3" class="outline-2">
<h2 id="org657dba3"><span class="section-number-2">4</span> Triage</h2>
<div class="outline-text-2" id="text-4">
<p>
Predictive analytics projects require the coordination of many
different tasks, such as feature generation, classifier training,
evaluation, and list generation. These tasks are complicated in their
own right, but in addition have to be combined in different ways
throughout the course of the project.
</p>

<p>
<code>triage</code> aims to provide interfaces to these different phases of a
project, such as an Experiment. Each phase is defined by configuration
specific to the needs of the project, and an arrangement of core data
science components that work together to produce the output of that
phase.
</p>

<p>
The domain  problems that <code>triage</code> had in mind are (1) early warning systems
/ early intervention systems and (2) prioritization of resources for
inspections.
</p>

<p>
<code>triage</code> was created to facilitate the creation of supervised learning
models, in particular classification models with an strong temporal
component in the data.
</p>

<p>
The temporal component in the data set affects the modeling mainly in
two ways, first, you need to be very careful and avoid <i>leakage</i> of
information in the data, and second, in the possible temporal drifting of the
data. <code>triage</code> solves the first splitting the data in temporal blocks to be
used in the temporal crossvalidation and using those blocks for the
feature generation.
</p>

<p>
<code>triage</code> uses the concept of <i>experiment</i>. An <i>experiment</i> consists in a
series of steps which aim to generate a good model for predicting the
<i>label</i> of an new instance of the data set. The steps are <i>feature generation</i>,
<i>label generation</i>, <i>model training</i> and <i>model scoring</i>. In each of all
this steps, <code>triage</code> will take care of the temporal nuances of the data.
</p>

<p>
You need to specify (via a configuration file) how you want to time
split your data, which combination of machine learning algorithms and
their hyperparameters, which kind of features you want to generate and which
subset of those features you want to try in each model. So, the
experiment consists in try every combination of algorithm,
hyperparameters and feature subset, and evaluate their performance
using a set of metrics (also specified in the config file).
</p>

<p>
<code>triage</code> will train one model for each block generated, so when the
experiment finishes you will have several models for each algorithm
and selection of hyperparameters. <code>triage</code> calls this a <code>model_group</code>.
</p>
</div>

<div id="outline-container-org9276566" class="outline-3">
<h3 id="org9276566"><span class="section-number-3">4.1</span> Triage interface</h3>
<div class="outline-text-3" id="text-4-1">
<p>
<code>triage</code> is very simple to use, but it contains a lot of complex
concepts that we will try to clarify in this section of the tutorial.
</p>

<p>
For running a <code>triage</code> experiment you need the following:
</p>

<ul class="org-ul">
<li><code>triage</code> installed in your environment. You can verify that <code>triage</code> is installed (and check
its version) typying the following inside an <code>ipython</code> session <b>in <code>bastion</code></b>:</li>
</ul>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #0000FF;">import</span> triage

triage.__version__
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">
'2.2.0'
</pre>
</div>

<ul class="org-ul">
<li>A database with (obviously) and two tables (at minimum): one that
describes the <i>outcome</i> of each event on the database and a table
that contains the state of each entity.</li>

<li>An <i>experiment config file</i>, this is where the magic happen. We will
discuss this file at length in this section of the tutorial.</li>
</ul>

<p>
With this three components you can create your <code>experiment</code> object and
<code>run</code> it. In this tutorial we are providing a <code>docker</code> container that
executes <code>triage</code> experiments. 
</p>

<p>
You can run the container from your laptop (i.e. outside <code>bastion</code>) as follows:
</p>

<div class="org-src-container">
<pre class="src src-sh">./tutorial.sh triage --help
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">Usage: triage<span style="color: #0000ff; background-color: #ffffff;">experiment</span> [OPTIONS] COMMAND [ARGS]...

Options:
  --config<span style="color: #0000ff; background-color: #ffffff;">file</span> PATH        Triage's experiment congiguration file name 
                            NOTE:
                            It's assumed that the file is located inside
                            triage/experiment<span style="color: #0000ff; background-color: #ffffff;">config</span>)  [required]
  --triage<span style="color: #0000ff; background-color: #ffffff;">db</span> TEXT          DB URL, in the form of
                            'postgresql://user:password@host<span style="color: #0000ff; background-color: #ffffff;">db</span>:host<span style="color: #0000ff; background-color: #ffffff;">port</span>/db',
                            by default it gets this from the environment
                            (TRIAGE<span style="color: #0000ff; background-color: #ffffff;">DB</span>URL)  [required]
  --replace / --no-replace  Triage will (or won't) replace all the matrices
                            and models
  --debug                   Activate to get a lot of information in your
                            screen
  --help                    Show this message and exit.

Commands:
  audit<span style="color: #0000ff; background-color: #ffffff;">models</span>
  run
  show<span style="color: #0000ff; background-color: #ffffff;">feature</span>generators
  show<span style="color: #0000ff; background-color: #ffffff;">model</span>plot
  show<span style="color: #0000ff; background-color: #ffffff;">temporal</span>blocks
  validate
</pre>
</div>

<p>
You already had the database (you were working on it the last two
sections of the tutorial) and the tutorial provide a recent container
with <code>triage</code> installed. So, here, like in a real project you just
need to worry about the <i>experiment's configuration file</i>. But before,
we need to setup two more tables.
</p>
</div>

<div id="outline-container-orgf08156f" class="outline-4">
<h4 id="orgf08156f"><span class="section-number-4">4.1.1</span> A tale of two tables</h4>
<div class="outline-text-4" id="text-4-1-1">
<p>
The first thing that <code>triage</code> will do is split the time that the data
covers in blocks considering the time horizon for the <i>label</i>
(i.e. the thing that we want to predict: <i>Which facilities will fail an inspection in the following 3 months?</i>
In the case of <b>inspection prioritization</b> or <i>Would be my restaurant inspected in the following month?</i> 
If you are working in a <b>early warning system</b> problem.) This time
horizon is calculated from a set of specific dates (<code>as_of_date</code> in
triage parlance) that divide the blocks in past (for training the
model) and future (for testing the model).
</p>

<p>
<code>triage</code> will create those <i>labels</i> using information about the <i>outcome</i> of
the event, taking in account the temporal structure of the data. 
As an example of an <i>outcome</i> consider this  if a inspection is
realized (the event) and the facility fails the inspection (outcome
<i>true</i>) or not (outcome <i>false</i>). 
</p>

<p>
So, for a given <i>as of date</i>, in our data, for each entity, <code>triage</code>
will ask: Are positive outcomes in
the future time horizon? If so, <code>triage</code> will generate a positive
<i>label</i> for that specific entity on that <i>as of date</i>. Henceforth, we
need to create an outcomes table.
</p>

<p>
The table that is needed describe the <i>states</i> of each entity. 
The table  should have columns <code>entity_id</code>, <code>start__time, end_time</code> and <code>state</code>.
The states table allows us to only include rows in your matrices in a
specific state. The rationale of this comes from the need of only
predict for entities in a particular state: Do the restaurant still
open? Do the restaurant is new? etc.
</p>

<p>
In order of exemplify and explain the working of <code>triage</code>, we will
create a subset of the <code>semantic.events</code> : two facilities (<code>entity_id=s =9582</code> and <code>10854</code>),
two variables (<code>inspection_type, risk</code>), and spatial and temporal dimensions for aggregation (<code>location</code>,
<code>zip_code</code> and <code>date</code>).
</p>

<p>
Create a new <code>schema</code> called <code>testing_triage</code>
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">create</span> <span style="color: #0000FF;">schema</span> if <span style="color: #0000FF;">not</span> <span style="color: #0000FF;">exists</span> testing_triage;
</pre>
</div>

<p>
Almost all the components of <code>triage</code> works with <code>SQL</code> tables stored  in
<code>PostgreSQL</code> (this is very important to remember), so, let's create our
test table with the entities <code>9582</code> and <code>10854</code>
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">drop</span> <span style="color: #0000FF;">table</span> <span style="color: #006699;">if</span> <span style="color: #0000FF;">exists</span> testing_triage.events;

<span style="color: #0000FF;">create</span> <span style="color: #0000FF;">table</span> <span style="color: #006699;">testing_triage.events</span> <span style="color: #0000FF;">as</span> (
<span style="color: #0000FF;">select</span>
event_id, 
entity_id,
facility_type,
<span style="color: #0000FF;">result</span>,
<span style="color: #0000FF;">type</span> <span style="color: #0000FF;">as</span> inspection_type, risk, <span style="color: #8D8D84; font-style: italic;">-- variables</span>
violations, <span style="color: #8D8D84; font-style: italic;">-- json array of variables</span>
<span style="color: #6434A3;">date</span>, location, zip_code <span style="color: #8D8D84; font-style: italic;">-- spatio temporal dimensions</span>
<span style="color: #0000FF;">from</span> semantic.events
<span style="color: #0000FF;">where</span> entity_id <span style="color: #0000FF;">in</span> (9582, 10854)
)
</pre>
</div>

<p>
<code>testing_triage.events</code> contains three categorical variables (<code>inspection_type,risk, result</code>),
two differnent groups for aggregation (<code>location, zip_code</code>), and the date
when the inspection happened (<code>date</code>).
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">select</span> 
entity_id, 
inspection_type, risk, <span style="color: #0000FF;">result</span>,
<span style="color: #6434A3;">date</span>, 
zip_code 
<span style="color: #0000FF;">from</span> testing_triage.events
<span style="color: #0000FF;">order</span> <span style="color: #0000FF;">by</span> <span style="color: #6434A3;">date</span> <span style="color: #0000FF;">desc</span>
<span style="color: #0000FF;">limit</span> 5
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">entity_id</th>
<th scope="col" class="org-left">inspection_type</th>
<th scope="col" class="org-left">risk</th>
<th scope="col" class="org-left">result</th>
<th scope="col" class="org-right">date</th>
<th scope="col" class="org-right">zip_code</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">10854</td>
<td class="org-left">complaint</td>
<td class="org-left">high</td>
<td class="org-left">pass</td>
<td class="org-right">2017-10-04</td>
<td class="org-right">60636</td>
</tr>

<tr>
<td class="org-right">10854</td>
<td class="org-left">complaint</td>
<td class="org-left">high</td>
<td class="org-left">fail</td>
<td class="org-right">2017-09-26</td>
<td class="org-right">60636</td>
</tr>

<tr>
<td class="org-right">10854</td>
<td class="org-left">canvass</td>
<td class="org-left">high</td>
<td class="org-left">pass</td>
<td class="org-right">2017-06-20</td>
<td class="org-right">60636</td>
</tr>

<tr>
<td class="org-right">9582</td>
<td class="org-left">complaint</td>
<td class="org-left">medium</td>
<td class="org-left">pass</td>
<td class="org-right">2017-02-21</td>
<td class="org-right">60621</td>
</tr>

<tr>
<td class="org-right">9582</td>
<td class="org-left">complaint</td>
<td class="org-left">medium</td>
<td class="org-left">fail</td>
<td class="org-right">2017-02-10</td>
<td class="org-right">60621</td>
</tr>
</tbody>
</table>

<p>
For this test, we will keep things simple and define the <i>outcome</i> as
<code>TRUE</code> if the inspection got a result adverse and <code>FALSE</code> Otherwise.
</p>

<p>
<code>triage</code> requires that the table <code>outcomes</code> has the column names
<code>entity_id</code>, <code>outcome_date</code> and <code>outcome</code>:  
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">drop</span> <span style="color: #0000FF;">table</span> <span style="color: #006699;">if</span> <span style="color: #0000FF;">exists</span> testing_triage.outcomes;

<span style="color: #0000FF;">create</span> <span style="color: #0000FF;">table</span> <span style="color: #006699;">testing_triage.outcomes</span> <span style="color: #0000FF;">as</span> (
<span style="color: #0000FF;">select</span> 
entity_id, 
<span style="color: #6434A3;">date</span> <span style="color: #0000FF;">as</span> outcome_date, 
(<span style="color: #0000FF;">result</span> = <span style="color: #008000;">'fail'</span>) <span style="color: #0000FF;">as</span> outcome
<span style="color: #0000FF;">from</span> testing_triage.events
);

</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">select</span> * <span style="color: #0000FF;">from</span> testing_triage.outcomes <span style="color: #0000FF;">limit</span> 5;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">entity_id</th>
<th scope="col" class="org-right">outcome_date</th>
<th scope="col" class="org-left">outcome</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">9582</td>
<td class="org-right">2016-02-17</td>
<td class="org-left">f</td>
</tr>

<tr>
<td class="org-right">9582</td>
<td class="org-right">2016-02-25</td>
<td class="org-left">f</td>
</tr>

<tr>
<td class="org-right">9582</td>
<td class="org-right">2011-04-22</td>
<td class="org-left">f</td>
</tr>

<tr>
<td class="org-right">9582</td>
<td class="org-right">2012-02-29</td>
<td class="org-left">t</td>
</tr>

<tr>
<td class="org-right">9582</td>
<td class="org-right">2012-02-21</td>
<td class="org-left">t</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">select</span> 
outcome, <span style="color: #006FE0;">count</span>(*) 
<span style="color: #0000FF;">from</span> testing_triage.outcomes
<span style="color: #0000FF;">group</span> <span style="color: #0000FF;">by</span> outcome;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">outcome</th>
<th scope="col" class="org-right">count</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">f</td>
<td class="org-right">70</td>
</tr>

<tr>
<td class="org-left">t</td>
<td class="org-right">19</td>
</tr>
</tbody>
</table>

<p>
We will only consider only one <i>state</i>: Is the
facility "active" or not?<sup><a id="fnr.21" class="footref" href="#fn.21">21</a></sup>. <code>triage</code> also impose some constraints
to the table that  represents the state: it must include columns Named
<code>entity_id</code>, <code>start_time</code>, <code>end_time</code> ans <code>state</code>
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">drop</span> <span style="color: #0000FF;">table</span> <span style="color: #006699;">if</span> <span style="color: #0000FF;">exists</span> testing_triage.active_facilities <span style="color: #0000FF;">cascade</span>;

<span style="color: #0000FF;">create</span> <span style="color: #0000FF;">table</span> <span style="color: #006699;">testing_triage.active_facilities</span> <span style="color: #0000FF;">as</span> (
    <span style="color: #0000FF;">select</span> 
    entity_id, facility_type, location, 
    start_time, 
    <span style="color: #0000FF;">case</span>
    <span style="color: #0000FF;">when</span> end_time <span style="color: #0000FF;">is</span> <span style="color: #0000FF;">NULL</span>
    <span style="color: #0000FF;">then</span> <span style="color: #008000;">'2020-01-01'</span>
    <span style="color: #0000FF;">else</span> end_time
    <span style="color: #0000FF;">end</span> <span style="color: #0000FF;">as</span> end_time,
    <span style="color: #008000;">'active'</span> <span style="color: #0000FF;">as</span> <span style="color: #0000FF;">state</span> 
    <span style="color: #0000FF;">from</span> semantic.entities
    <span style="color: #0000FF;">where</span> entity_id <span style="color: #0000FF;">in</span> (9582, 10854)
);

</pre>
</div>

<p>
<code>triage</code> doesn't support open date intervals, so we had to impute
<code>end_time</code> with the date '2020-01-01'
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">select</span> entity_id, start_time, end_time, <span style="color: #0000FF;">state</span>
 <span style="color: #0000FF;">from</span> testing_triage.active_facilities ;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">entity_id</th>
<th scope="col" class="org-right">start_time</th>
<th scope="col" class="org-right">end_time</th>
<th scope="col" class="org-left">state</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">9582</td>
<td class="org-right">2010-02-24</td>
<td class="org-right">2017-09-15</td>
<td class="org-left">active</td>
</tr>

<tr>
<td class="org-right">10854</td>
<td class="org-right">2010-01-08</td>
<td class="org-right">2020-01-01</td>
<td class="org-left">active</td>
</tr>
</tbody>
</table>

<p>
Note that the entity <code>10854</code> is still active and <code>9582</code> is not active
after <code>2017-09-15</code>.
</p>
</div>
</div>

<div id="outline-container-orgc093937" class="outline-4">
<h4 id="orgc093937"><span class="section-number-4">4.1.2</span> Experiment's configuration file</h4>
<div class="outline-text-4" id="text-4-1-2">
<p>
The <i>experiment configuration file</i> is used to create the <code>experiment</code>
object. Here, you will specify the temporal configuration, the
features to be generated, the labels to learn and the models that you
want to train in your data.
</p>

<p>
The configuration file is a <code>yaml</code> file with the following main sections:
</p>

<dl class="org-dl">
<dt><a href="#orgec69435">temporal_config</a></dt><dd>Temporal specification of the data, used for
creating the blocks for temporal crossvalidation.</dd>

<dt><code>events_table</code></dt><dd>Table that contains the information about the labels
to be predicted. This is the <code>outcomes</code> table that
we describe earlier.</dd>

<dt><a href="#org5c65790">feature_generation</a></dt><dd>Which spatio-temporal aggregations of the
columns in the data set do you want to generate as features for
the models?</dd>

<dt><code>state_config</code> </dt><dd>Specify which objects are in a given state in a
particular interval of time, you can use this for filter which
objects should be included in the training and prediction. This
is the <code>states</code> table described above.</dd>

<dt><code>model_group_keys</code></dt><dd>How do you want to identify the <code>model_group</code> in
the database (so you can run analysis on them)</dd>

<dt><code>grid_config</code></dt><dd>Which combination of hyperparameters and algorithms
will be trained and evaluated in the data set?</dd>

<dt><code>scoring</code></dt><dd>Which metrics will be calculated?</dd>
</dl>


<p>
Two of the more important sections (and the more confusing too) are
<code>temporal_config</code> and <code>feature_generation</code>. We will explain them at
detail in the next sections.
</p>
</div>

<div id="outline-container-orgec69435" class="outline-5">
<h5 id="orgec69435"><span class="section-number-5">4.1.2.1</span> Temporal crossvalidation</h5>
<div class="outline-text-5" id="text-4-1-2-1">
<p>
Cross validation is a common technique to reduce overfitting and model and
 hyperparameter. Standard cross validation randomly splits the
 training data into subsets, fits models on all except one of them,
 and calculates the metric of interest (e.g. precision/recall) on the
 remaining, rotating through the subsets and leaving each out
 once. You then select the model that performed best on the test sets,
 and then retrain them.  
</p>

<p>
Unfortunately, standard cross validation is usually inappropriate for
real-world data science problems like the ones that we are facing. If
you are testing your model on temporally 
correlated data, standard cross validation lets  you peek ahead into
the future, due to the random split, using time points both before and
after the target date. To avoid this problem, you should design  your training and
testing to mimic how your model will be used, making predictions with
only the data that would be available at  that time (i.e. from the past). 
</p>

<p>
In temporal crossvalidation, rather than randomly splitting the
dataset into training and test splits, temporal cross validation
splits the data by time. For example, we can fit models on training
sets up to  1/1/2010 and see how well those models would have
predicted 2010; fit more models on
training sets up to 1/1/2011 and see how  well those models would have
predicted 2011; and so on. That way, we choose models that have
historically performed best at our task,  forecasting. It’s why this
approach is sometimes called “evaluation on a rolling forecast
origin.”  
</p>

<p>
The most acute problem is avoiding leakaging information
in a temporal setting. Note that this spliting will affect the
generation of features, because you don't want to have leakage on the
generation. 
</p>


<p>
<code>triage</code> uses the handy <code>timechop</code> library for this purpose. <code>Timechop</code>
will build ("chop") the data set in several temporal blocks. These
blocks will be used for creating the features and matrices for
the training and evaluation of the machine learning models.
</p>

<p>
Timechop has several parameters, first, you need to specify The 
 limits of your data:
</p>

<dl class="org-dl">
<dt><code>feature_start_time</code></dt><dd>data aggregated into features begins at this
point (earliest date included in features)</dd>
<dt><code>feature_end_time</code></dt><dd>data aggregated into features is from before this
point (latest date included in features)</dd>
<dt><code>label_start_time</code></dt><dd>data aggregated into labels begins at this
point (earliest event date included in any label (event date &gt;= label_start_time)</dd>
<dt><code>label_end_time</code></dt><dd>data aggregated is from before this point (event
date &lt; label_end_time to be included in any label)</dd>
</dl>

<p>
Other parameters controls the <i>labels</i>' time horizon, you have two
'knobs', one for training and one for testing.
</p>

<dl class="org-dl">
<dt><code>training_label_timespans</code></dt><dd>how much time is covered by training
labels (e.g., outcomes in the next 1 year? 3 days? 2 months?)
(training prediction span)</dd>

<dt><code>test_label_timespans</code></dt><dd>how much time is covered by test
prediction (e.g., outcomes in the next 1 year? 3 days? 2 months?)
(test prediction span)</dd>
</dl>

<p>
These parameters will be used, together with the <i>outcomes</i> table to
generate the <i>labels</i>. In an <b>EIS</b> setting regularly both will have
the same value. For <b>inspections prioritization</b> this value is most of
the time equal to <code>test_durations</code> and to <code>model_update_frequency</code>.
</p>

<dl class="org-dl">
<dt><code>model_update_frequency</code></dt><dd>amount of time between train/test splits
(how frequently to retrain models)</dd>

<dt><code>test_durations</code></dt><dd>how far into the future should a model be used
to make predictions (test span)
<b>NOTE</b>: in the typical case of wanting a single
prediction set immediately after model training, this should be
set to 0 days</dd>
</dl>

<p>
This last parameter is other that differes if the problem is an <b>EIS</b>
or an <b>inspections prioritization</b>. In the former is recommended to be
equal to <code>model_update_frequency</code>,  in the latter is determined by the
organizational process: <i>how far out are you scheduling for?</i>.
</p>

<p>
The equivalent of <code>test_durations</code> for the training matrices is <code>max_training_histories</code>
</p>

<dl class="org-dl">
<dt><code>max_training_histories</code></dt><dd>the maximum amount of history for each
entity to train on (early matrices may contain less than this time
if it goes past label/feature start times)</dd>
</dl>

<p>
Finally, we should specify how many rows per <code>entity_id</code> in the train
 and test matrix
</p>

<dl class="org-dl">
<dt><code>training_as_of_date_frequencies</code></dt><dd>how much time between rows for a
single entity in a training matrix (list time between rows for
same entity in train matrix)</dd>

<dt><code>test_as_of_date_frequencies</code></dt><dd>how much time between rows for a
single entity in a test matrix (time between rows for same entity in test matrix)</dd>
</dl>


<p>
The following images (We will show you how to generate them later)
shows the time blocks of several configurations. We will change one
parameter at the time so you could see how that affects the blocks.
</p>
</div>

<ol class="org-ol">
<li><a id="org3d41c89"></a><code>{feature, label}_{end, start}_Time</code><br />
<div class="outline-text-6" id="text-4-1-2-1-1">
<p>
The image below shows these <code>{feature, label}_start_time</code> equal, and the same for the
<code>{feature, label}_end_time</code> ones. These parameters show in the image
as dashed vertical black lines. This setup would be our <b>base</b>
example.
</p>

<p>
The plot is divided in two horizontal lines ("Block 0" and "Block
1"). Each line is divided by vertical dashed lines, the grey ones are
the boundaries of the data for features and data for labels, and in
this image they coincide. The black dash lines represents the
beginning and the end of the test set. In the "Block 0" those lines
are <code>2017</code> and <code>2018</code>, in "Block 1" they are <code>2016</code> and <code>2017</code>.
</p>

<p>
The shaded areas (in this image there is just one per block, but you
will see another examples below) represents the span of all the <i>as of dates</i>
They start with the oldest <i>as of date</i> and end in the latest. Each
line inside that area represents the span for the label
calculation. Those lines begin at the <i>as of date</i>. In each <i>as of
date</i> all the entities will get calculated their features (to the
past) and the labels (to the future). So in the image, we will have
two sets of train/test, in the "Block 0" our entity <code>9587</code> will have
13 rows of features,  and 12 on "Block 1". The trainned models will
predict the label using the features calculated in that <i>as of date</i>
in the  test data set, the solitary line represents the label's time
horizon in testing.
</p>



<div id="orgae90b1e" class="figure">
<p><object type="image/svg+xml" data="./images/timechop_1.svg" class="org-svg" width="600" height="400">
Sorry, your browser does not support SVG.</object>
</p>
<p><span class="figure-number">Figure 2: </span>feature and label start, end time equal</p>
</div>

<pre class="example">
temporal_config:
    feature_start_time: '2014-01-01'
    feature_end_time: '2018-01-01'
    label_start_time: '2014-01-02'
    label_end_time: '2018-01-01'

    model_update_frequency: '1y' 
    training_label_timespans: ['1y']
    training_as_of_date_frequencies: '1month'

    test_durations: '0d'
    test_label_timespans: ['1y'] 
    test_as_of_date_frequencies: '1month'

    max_training_histories: '1y'  
</pre>

<p>
But they can be different (maybe you have more data for features that
data for labels)
</p>


<div id="org9a23006" class="figure">
<p><object type="image/svg+xml" data="./images/timechop_2.svg" class="org-svg" width="600" height="400">
Sorry, your browser does not support SVG.</object>
</p>
<p><span class="figure-number">Figure 3: </span>feature_start_time different different that label_start_time.</p>
</div>


<pre class="example">
temporal_config:
    feature_start_time: '2010-01-01'   # &lt;------- The change happened here!
    feature_end_time: '2018-01-01'
    label_start_time: '2014-01-02'
    label_end_time: '2018-01-01'

    model_update_frequency: '1y' 
    training_label_timespans: ['1y']
    training_as_of_date_frequencies: '1month'

    test_durations: '0d'
    test_label_timespans: ['1y'] 
    test_as_of_date_frequencies: '1month'

    max_training_histories: '1y'  
</pre>
</div>
</li>

<li><a id="orgd7051d8"></a><code>model_update_frequency</code><br />
<div class="outline-text-6" id="text-4-1-2-1-2">
<p>
From our <b>base</b> <code>temporal_config</code> example (<a href="#orgae90b1e">2</a>), we will
change how often we want a new model, so we need more train/test sets:
</p>

<pre class="example">
temporal_config:
    feature_start_time: '2014-01-01'
    feature_end_time: '2018-01-01'
    label_start_time: '2014-01-02'
    label_end_time: '2018-01-01'

    model_update_frequency: '6month' # &lt;------- The change happened here!
    training_label_timespans: ['1y']
    training_as_of_date_frequencies: '1month'

    test_durations: '0d'
    test_label_timespans: ['1y'] 
    test_as_of_date_frequencies: '1month'

    max_training_histories: '1y'  
</pre>


<div id="org01fff0e" class="figure">
<p><object type="image/svg+xml" data="./images/timechop_3.svg" class="org-svg" width="600" height="400">
Sorry, your browser does not support SVG.</object>
</p>
<p><span class="figure-number">Figure 4: </span>A smaller model_update_frequency (from 1y to 6month) (The number of blocks grew)</p>
</div>
</div>
</li>


<li><a id="orgee5c0d6"></a><code>max_training_histories</code><br />
<div class="outline-text-6" id="text-4-1-2-1-3">
<p>
With this parameter you could get a <i>growing window</i> for training
(depicted in <a href="#org9790cdd">5</a>) or as in all the other examples,  
<i>fixed training windows</i>.
</p>

<pre class="example">
temporal_config:
    feature_start_time: '2014-01-01'
    feature_end_time: '2018-01-01'
    label_start_time: '2014-01-02'
    label_end_time: '2018-01-01'

    model_update_frequency: '1y' 
    training_label_timespans: ['1y']
    training_as_of_date_frequencies: '1month'

    test_durations: '0d'
    test_label_timespans: ['1y'] 
    test_as_of_date_frequencies: '1month'

    max_training_histories: '10y'  # &lt;------- The change happened here!
</pre>



<div id="org9790cdd" class="figure">
<p><object type="image/svg+xml" data="./images/timechop_4.svg" class="org-svg" width="600" height="400">
Sorry, your browser does not support SVG.</object>
</p>
<p><span class="figure-number">Figure 5: </span>The size of the block is bigger now</p>
</div>
</div>
</li>

<li><a id="org3160707"></a><code>_as_of_date_frequencies</code> and <code>test_durations</code><br />
<div class="outline-text-6" id="text-4-1-2-1-4">
<pre class="example">
temporal_config:
    feature_start_time: '2014-01-01'
    feature_end_time: '2018-01-01'
    label_start_time: '2014-01-02'
    label_end_time: '2018-01-01'

    model_update_frequency: '1y' 
    training_label_timespans: ['1y']
    training_as_of_date_frequencies: '3month' # &lt;------- The change happened here!

    test_durations: '0d'
    test_label_timespans: ['1y'] 
    test_as_of_date_frequencies: '1month'

    max_training_histories: '10y'  
</pre>



<div id="org8d36bb9" class="figure">
<p><object type="image/svg+xml" data="./images/timechop_5.svg" class="org-svg" width="600" height="400">
Sorry, your browser does not support SVG.</object>
</p>
<p><span class="figure-number">Figure 6: </span>More rows per entity in the training block</p>
</div>

<p>
Now, change <code>test_as_of_date_frequencies</code>
</p>

<pre class="example">
temporal_config:
    feature_start_time: '2014-01-01'
    feature_end_time: '2018-01-01'
    label_start_time: '2014-01-02'
    label_end_time: '2018-01-01'

    model_update_frequency: '1y' 
    training_label_timespans: ['1y']
    training_as_of_date_frequencies: '1month' 

    test_durations: '0d'
    test_label_timespans: ['1y'] 
    test_as_of_date_frequencies: '3month'&lt;------- The change happened here!

    max_training_histories: '10y'  
</pre>



<div id="org3a25f9e" class="figure">
<p><object type="image/svg+xml" data="./images/timechop_6.svg" class="org-svg" width="600" height="400">
Sorry, your browser does not support SVG.</object>
</p>
<p><span class="figure-number">Figure 7: </span>We should get more rows per entity in the test matrix, but that didn't happen. Why?</p>
</div>

<p>
Nothing change, that's because the test set doesn't have "space", that
is controlled by <code>test_durations</code>, let's move that to to <code>6month</code>
</p>

<pre class="example">
temporal_config:
    feature_start_time: '2014-01-01'
    feature_end_time: '2018-01-01'
    label_start_time: '2014-01-02'
    label_end_time: '2018-01-01'

    model_update_frequency: '1y' 
    training_label_timespans: ['1y']
    training_as_of_date_frequencies: '1month' 

    test_durations: '6month' &lt;------- The change happened here!
    test_label_timespans: ['1y'] 
    test_as_of_date_frequencies: '1month'

    max_training_histories: '10y'  
</pre>



<div id="org1a04f76" class="figure">
<p><object type="image/svg+xml" data="./images/timechop_7.svg" class="org-svg" width="600" height="400">
Sorry, your browser does not support SVG.</object>
</p>
<p><span class="figure-number">Figure 8: </span>The test duration is bigger now, so we got 6 rows (since the "base" frequency is 1 month)</p>
</div>

<p>
So, now we will move both parameters: <code>test_durations</code>, <code>test_as_of_date_frequencies</code>
</p>

<pre class="example">
temporal_config:
    feature_start_time: '2014-01-01'
    feature_end_time: '2018-01-01'
    label_start_time: '2014-01-02'
    label_end_time: '2018-01-01'

    model_update_frequency: '1y' 
    training_label_timespans: ['1y']
    training_as_of_date_frequencies: '1month' 

    test_durations: '6month' &lt;------- The change happened here!
    test_label_timespans: ['1y'] 
    test_as_of_date_frequencies: '3month' &lt;------- and also here!

    max_training_histories: '10y'  
</pre>



<div id="org5c3e840" class="figure">
<p><object type="image/svg+xml" data="./images/timechop_8.svg" class="org-svg" width="600" height="400">
Sorry, your browser does not support SVG.</object>
</p>
<p><span class="figure-number">Figure 9: </span>With more room in testing, now test_as_of_date_frequencies has some effect.</p>
</div>
</div>
</li>

<li><a id="orgc841f0a"></a><code>-label_timespans</code><br />
<div class="outline-text-6" id="text-4-1-2-1-5">
<pre class="example">
temporal_config:
    feature_start_time: '2014-01-01'
    feature_end_time: '2018-01-01'
    label_start_time: '2014-01-02'
    label_end_time: '2018-01-01'

    model_update_frequency: '1y' 
    training_label_timespans: ['1y']
    training_as_of_date_frequencies: '1month' 

    test_durations: '0d' 
    test_label_timespans: ['3month']  &lt;------- The change happened here!
    test_as_of_date_frequencies: '1month'

    max_training_histories: '10y'  
</pre>



<div id="orga7514b7" class="figure">
<p><object type="image/svg+xml" data="./images/timechop_9.svg" class="org-svg" width="600" height="400">
Sorry, your browser does not support SVG.</object>
</p>
<p><span class="figure-number">Figure 10: </span>The label time horizon in testing is smaller</p>
</div>

<pre class="example">
temporal_config:
    feature_start_time: '2014-01-01'
    feature_end_time: '2018-01-01'
    label_start_time: '2014-01-02'
    label_end_time: '2018-01-01'

    model_update_frequency: '1y' 
    training_label_timespans: ['3month'] &lt;------- The change happened here!
    training_as_of_date_frequencies: '1month' 

    test_durations: '0d' 
    test_label_timespans: ['1y']  
    test_as_of_date_frequencies: '1month'

    max_training_histories: '10y'  
</pre>



<div id="org4848491" class="figure">
<p><object type="image/svg+xml" data="./images/timechop_10.svg" class="org-svg" width="600" height="400">
Sorry, your browser does not support SVG.</object>
</p>
<p><span class="figure-number">Figure 11: </span>The label time horizon is smaller in trainning, also, now we have more room for more rows per entity.</p>
</div>
</div>
</li>
</ol>
</div>


<div id="outline-container-org5c65790" class="outline-5">
<h5 id="org5c65790"><span class="section-number-5">4.1.2.2</span> <span class="todo TODO">TODO</span> Feature engineering</h5>
<div class="outline-text-5" id="text-4-1-2-2">
<p>
We will show how to create features using the <i>experiments config
file</i>. <code>triage</code> for this end, uses <code>collate</code>. <code>Collate</code> is the python
library that controls the generation of features (including the imputation rules
for each feature generated). <code>Collate</code> helps the modeler to
create features based on <i>spatio-temporal aggregations</i> (which is what
we need in our modeling strategy based on <b>events</b>)
</p>

<p>
As a first feature we want to know in a given interval of time, in
a given specific date (remember <i>as of date</i>), <i>how many Inspections
 do each facility had?</i> and <i>how many flags resulted in "high risk"
after the last inspection?</i> (the <code>risk</code> column), 
happened to that facility and the same questions but aggregated in the
zip code in which the facility operates. 
</p>

<p>
Let's try to construct that in <code>SQL</code>:
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">select</span> entity_id, zip_code,
<span style="color: #006FE0;">count</span>(*) <span style="color: #0000FF;">as</span> inspections,
<span style="color: #006FE0;">count</span>(*) filter (<span style="color: #0000FF;">where</span> risk=<span style="color: #008000;">'high'</span>) <span style="color: #0000FF;">as</span> flagged_as_high_risk
<span style="color: #0000FF;">from</span> testing_triage.events
<span style="color: #0000FF;">group</span> <span style="color: #0000FF;">by</span> <span style="color: #0000FF;">grouping</span> <span style="color: #0000FF;">sets</span>(entity_id, zip_code)
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">entity_id</th>
<th scope="col" class="org-left">zip_code</th>
<th scope="col" class="org-right">inspections</th>
<th scope="col" class="org-right">flagged_as_high_risk</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">9581</td>
<td class="org-left">[NULL]</td>
<td class="org-right">45</td>
<td class="org-right">0</td>
</tr>

<tr>
<td class="org-left">[NULL]</td>
<td class="org-left">60621</td>
<td class="org-right">45</td>
<td class="org-right">0</td>
</tr>
</tbody>
</table>

<p>
This query is making an <i>aggregation</i>.Note that the previous <code>SQL</code>
query is composed by four parts: 
</p>
<ul class="org-ul">
<li>The filter ((<code>risk = 'high')::int</code>)</li>
<li>The aggregation function (<code>count()</code>)</li>
<li>The name of the resulting transformation (<code>flagged_as_high_risk</code>)</li>
<li>The context in which it is aggregated (by <code>entity_id</code> and <code>zip_code</code>).</li>
</ul>

<p>
What about if we want to add the proportion of all the inspections
that resulted in be flagged as "high risk"?
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">select</span> entity_id, zip_code,
<span style="color: #006FE0;">count</span>(*) <span style="color: #0000FF;">as</span> inspections,
<span style="color: #006FE0;">count</span>(*) filter (<span style="color: #0000FF;">where</span> risk=<span style="color: #008000;">'high'</span>) <span style="color: #0000FF;">as</span> flagged_as_high_risk,
<span style="color: #006FE0;">avg</span>((risk=<span style="color: #008000;">'high'</span>)::<span style="color: #6434A3;">int</span>) <span style="color: #0000FF;">as</span> proportion_of_flags_as_high_risk
<span style="color: #0000FF;">from</span> testing_triage.events
<span style="color: #0000FF;">group</span> <span style="color: #0000FF;">by</span> <span style="color: #0000FF;">grouping</span> <span style="color: #0000FF;">sets</span>(entity_id, zip_code)
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">entity_id</th>
<th scope="col" class="org-left">zip_code</th>
<th scope="col" class="org-right">inspections</th>
<th scope="col" class="org-right">flagged_as_high_risk</th>
<th scope="col" class="org-right">proportion_of_flags_as_high_risk</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">9581</td>
<td class="org-left">[NULL]</td>
<td class="org-right">45</td>
<td class="org-right">0</td>
<td class="org-right">0.00000000000000000000</td>
</tr>

<tr>
<td class="org-left">[NULL]</td>
<td class="org-left">60621</td>
<td class="org-right">45</td>
<td class="org-right">0</td>
<td class="org-right">0.00000000000000000000</td>
</tr>
</tbody>
</table>

<p>
But, what if we want to add also "medium" and "low" risk? And note
that we didn't add the temporal interval neither. You can see that the
event this simple set of features will require a very complex <code>SQL</code> to
be constructed.
</p>
</div>
</div>
</div>
</div>




<div id="outline-container-org1b42435" class="outline-3">
<h3 id="org1b42435"><span class="section-number-3">4.2</span> Machine learning governance: The <code>RESULTS</code> schema</h3>
<div class="outline-text-3" id="text-4-2">
<p>
While <code>triage</code> is executing the experiment, it will create a new schema,
called <code>results</code>. This schema has the goal of storing the output of the
models and describing the features, parameters and hyperparameters
used in their training.
</p>

<p>
The tables contained in <code>results</code> are:
</p>

<div class="org-src-container">
<pre class="src src-sql">\dt results.*
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">List of relations</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Schema</td>
<td class="org-left">Name</td>
<td class="org-left">Type</td>
<td class="org-left">Owner</td>
</tr>

<tr>
<td class="org-left">results</td>
<td class="org-left">evaluations</td>
<td class="org-left">table</td>
<td class="org-left">food_user</td>
</tr>

<tr>
<td class="org-left">results</td>
<td class="org-left">experiments</td>
<td class="org-left">table</td>
<td class="org-left">food_user</td>
</tr>

<tr>
<td class="org-left">results</td>
<td class="org-left">feature_importances</td>
<td class="org-left">table</td>
<td class="org-left">food_user</td>
</tr>

<tr>
<td class="org-left">results</td>
<td class="org-left">individual_importances</td>
<td class="org-left">table</td>
<td class="org-left">food_user</td>
</tr>

<tr>
<td class="org-left">results</td>
<td class="org-left">list_predictions</td>
<td class="org-left">table</td>
<td class="org-left">food_user</td>
</tr>

<tr>
<td class="org-left">results</td>
<td class="org-left">model_groups</td>
<td class="org-left">table</td>
<td class="org-left">food_user</td>
</tr>

<tr>
<td class="org-left">results</td>
<td class="org-left">models</td>
<td class="org-left">table</td>
<td class="org-left">food_user</td>
</tr>

<tr>
<td class="org-left">results</td>
<td class="org-left">predictions</td>
<td class="org-left">table</td>
<td class="org-left">food_user</td>
</tr>
</tbody>
</table>
</div>

<div id="outline-container-org9655927" class="outline-4">
<h4 id="org9655927"><span class="section-number-4">4.2.1</span> What are all the results tables about?</h4>
<div class="outline-text-4" id="text-4-2-1">
<p>
<code>model_groups</code> stores the algorithm (<code>model_type</code>), the
hyperparameters (<code>model_parameters</code>) and the features shared by a
particular set of models. <code>models</code> contains data specific to a model of
the <code>model_group</code> (you can use <code>model_group_id</code> for linking the model to a
model group) this table also includes temporal information (like
<code>train_end_time</code>) and a reference to the  train matrix
(<code>train_matrix_uuid</code>). This <b>UUID</b> is important
since that is the name of the file in which the matrix is stored.
</p>

<p>
Lastly, <code>results.predictions</code> contains all the <i>scores</i> generated by every
model for every entity. <code>results.evaluation</code> stores the value of all the
<b>metrics</b> for every model. These metrics were specified in the <code>scoring</code>
section in the config file.
</p>
</div>

<div id="outline-container-org44057c8" class="outline-5">
<h5 id="org44057c8"><span class="section-number-5">4.2.1.1</span> <code>results.experiments</code></h5>
<div class="outline-text-5" id="text-4-2-1-1">
<p>
This table has the two columns: <code>experiment_hash</code> and <code>config</code>
</p>

<div class="org-src-container">
<pre class="src src-sql">\d results.experiments
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Table "results.experiments"</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Column</td>
<td class="org-left">Type</td>
<td class="org-left">Modifiers</td>
</tr>

<tr>
<td class="org-left">experiment_hash</td>
<td class="org-left">character varying</td>
<td class="org-left">not null</td>
</tr>

<tr>
<td class="org-left">config</td>
<td class="org-left">jsonb</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Indexes:</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">"experiments_pkey" PRIMARY KEY, btree (experiment_hash)</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Referenced by:</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">TABLE "results.models" CONSTRAINT "models_experiment_hash_fkey" FOREIGN KEY (experiment_hash) REFERENCES results.experiments(experiment_hash)</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>

<p>
<code>experiment_hash</code> contains the hash of the config that we used for our
<code>triage</code> run. <code>config</code> that  contains the 
configuration experiment file  that we used for our Triage run, stored
as <code>jsonb</code> 
</p>

<p>
We can note for our future selfs: If we are interested in all models 
that resulted from a certain config, we could  lookup that config In
<code>results.experiments</code> and then use its <code>experiment_hash</code>  on other tables
to find all the models that resulted from that configuration.
</p>
</div>
</div>

<div id="outline-container-org831312b" class="outline-5">
<h5 id="org831312b"><span class="section-number-5">4.2.1.2</span> <code>results.model_groups</code></h5>
<div class="outline-text-5" id="text-4-2-1-2">
<p>
Do you remember how we defined in <code>grid_config</code> the different
classifiers that we want <code>triage</code> to train? For example, we  said:
</p>

<pre class="example">
    'sklearn.tree.DecisionTreeClassifier':
        criterion: ['entropy']
        max_depth: [1, 2, 5, 10]
        random_state: [2193]
</pre>

<p>
By doing so, we are saying that we want to train 4 decision trees
(<code>max_depth</code> is one of <code>1, 2, 5, 10</code>). However, remember that  we are using
temporal cross-validation to build our models. That  means that we are
going to have different slices of time that we  are training our
models on, e.g., 2010-2011, 2011-2012, etc. 
</p>

<p>
Therefore, we are going to train our four configurations of the
decision trees on each time slice. Therefore, the  trained model (or
the instance of that model) will change across time  splits, but the
configuration will remain the same. This table lets  us keep track of
the different configurations (<code>model_groups</code>) and gives  us an <code>id</code> for
each configuration (<code>model_group_id</code>). We can leverage the <code>model_group_id</code>
to find all the models that were trained by using the  same config,
but across different slices of time. 
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">select</span> 
model_group_id, model_type, model_parameters, model_config
<span style="color: #0000FF;">from</span> 
results.model_groups
<span style="color: #0000FF;">limit</span> 1
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">model_group_id</th>
<th scope="col" class="org-left">model_type</th>
<th scope="col" class="org-left">model_parameters</th>
<th scope="col" class="org-left">model_config</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">1</td>
<td class="org-left">sklearn.tree.DecisionTreeClassifier</td>
<td class="org-left">{"max_depth": 1, "max_features": 1}</td>
<td class="org-left">{"experiment_type": "test", "label_definition": "failed"}</td>
</tr>
</tbody>
</table>

<p>
You can see that a model group is defined by the classifier
(<code>model_type</code>), its parameters (<code>model_parameters</code>), the features
(<code>feature_list</code>) (not shown), and the <code>model_config</code>. The <code>model_config</code> follows
from the <code>model_group_keys</code> we had defined in the configuration file:
</p>

<ul class="org-ul">
<li>'train_duration'</li>
<li>'label_window'</li>
<li>'example_Frequency'</li>
</ul>

<p>
<i>What can we learn from that?</i> For example, if we add a new feature and
rerun <code>triage</code>, <code>triage</code> will create a new <code>model_group</code> even if the
classifier and the <code>model_parameters</code> are the same as before. 
</p>
</div>
</div>

<div id="outline-container-org36860ef" class="outline-5">
<h5 id="org36860ef"><span class="section-number-5">4.2.1.3</span> <code>results.models</code></h5>
<div class="outline-text-5" id="text-4-2-1-3">
<p>
This table stores the information about our actual <i>models</i>, i.e.,
instances of our classifiers trained on specific time Slices. 
</p>
<div class="org-src-container">
<pre class="src src-sql">\d results.models
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Table "results.models"</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Column</td>
<td class="org-left">Type</td>
<td class="org-left">Modifiers</td>
</tr>

<tr>
<td class="org-left">model_id</td>
<td class="org-left">integer</td>
<td class="org-left">not null default nextval('results.models_model_id_seq'::regclass)</td>
</tr>

<tr>
<td class="org-left">model_group_id</td>
<td class="org-left">integer</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">model_hash</td>
<td class="org-left">character varying</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">run_time</td>
<td class="org-left">timestamp without time zone</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">batch_run_time</td>
<td class="org-left">timestamp without time zone</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">model_type</td>
<td class="org-left">character varying</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">model_parameters</td>
<td class="org-left">jsonb</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">model_comment</td>
<td class="org-left">text</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">batch_comment</td>
<td class="org-left">text</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">config</td>
<td class="org-left">json</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">experiment_hash</td>
<td class="org-left">character varying</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">train_end_time</td>
<td class="org-left">timestamp without time zone</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">test</td>
<td class="org-left">boolean</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">train_matrix_uuid</td>
<td class="org-left">text</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">training_label_timespan</td>
<td class="org-left">interval</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Indexes:</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">"models_pkey" PRIMARY KEY, btree (model_id)</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">"ix_results_models_model_hash" UNIQUE, btree (model_hash)</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Foreign-key constraints:</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">"models_experiment_hash_fkey" FOREIGN KEY (experiment_hash) REFERENCES results.experiments(experiment_hash)</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">"models_model_group_id_fkey" FOREIGN KEY (model_group_id) REFERENCES results.model_groups(model_group_id)</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Referenced by:</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">TABLE "results.evaluations" CONSTRAINT "evaluations_model_id_fkey" FOREIGN KEY (model_id) REFERENCES results.models(model_id)</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">TABLE "results.feature_importances" CONSTRAINT "feature_importances_model_id_fkey" FOREIGN KEY (model_id) REFERENCES results.models(model_id)</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">TABLE "results.individual_importances" CONSTRAINT "individual_importances_model_id_fkey" FOREIGN KEY (model_id) REFERENCES results.models(model_id)</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">TABLE "results.list_predictions" CONSTRAINT "list_predictions_model_id_fkey" FOREIGN KEY (model_id) REFERENCES results.models(model_id)</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">TABLE "results.predictions" CONSTRAINT "predictions_model_id_fkey" FOREIGN KEY (model_id) REFERENCES results.models(model_id)</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>

<p>
Noteworthy columns are:
</p>

<dl class="org-dl">
<dt><code>model_id</code></dt><dd>The id of the model (i.e., instance&#x2026;). We will
use this ID to trace back a model's performance
evaluation to a <code>model_group</code> and vice versa.</dd>
<dt><code>model_group_id</code></dt><dd>The id of the models model_group we encountered above.</dd>
<dt><code>model_hash</code></dt><dd>The <i>hash</i> of our model. We can use the hash to
load the actual model. It gets stored under
<code>TRIAGE_OUTPUT_PATH/trained_models/{model_hash}</code>. We
are going to this later to look at a trained
decision tree.</dd>
<dt><code>run_time</code></dt><dd>Time when the model was trained.</dd>
<dt><code>model_type</code></dt><dd>The algorithm used for trainning</dd>
<dt><code>model_parameters</code></dt><dd>Hyperparameters used for the model configuration.</dd>
<dt><code>experiment_hash</code></dt><dd>The hash of our experiment. We encountered this value in the <code>results.experiments</code> table before.</dd>
<dt><code>train_end_time</code></dt><dd>When building the training matrix, we included training samples up until this date.</dd>
<dt><code>train_matrix_uuid</code></dt><dd>The <i>hash</i> of the matrix that we used to
 train this model. The matrix gets stored as <code>csv</code> under 
<code>TRIAGE_OUTPUT_PATH/matrices/{train_matrix_uuid}.csv</code>. This is very helpful
when trying to inspect the matrix and features that were used
for training.</dd>
<dt><code>train_label_window</code></dt><dd>How big was our window to get the labels for our training
matrix? For example, a <code>train_label_window</code> of 1 year would
mean that we look one year from a given date in the training
matrix into the future to find the label for that training
sample.</dd>
</dl>
</div>
</div>

<div id="outline-container-org9392a6c" class="outline-5">
<h5 id="org9392a6c"><span class="section-number-5">4.2.1.4</span> <code>results.evaluations</code></h5>
<div class="outline-text-5" id="text-4-2-1-4">
<p>
This table lets us analyze how well our models are doing. Based on the
config that we used for our <code>triage</code> run, <code>triage</code> is calculating metrics
and storing them in this table, e.g., our model's precision at top 10%. 
</p>

<div class="org-src-container">
<pre class="src src-sql">\d results.evaluations
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Table "results.evaluations"</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Column</td>
<td class="org-left">Type</td>
<td class="org-left">Modifiers</td>
</tr>

<tr>
<td class="org-left">model_id</td>
<td class="org-left">integer</td>
<td class="org-left">not null</td>
</tr>

<tr>
<td class="org-left">evaluation_start_time</td>
<td class="org-left">timestamp without time zone</td>
<td class="org-left">not null</td>
</tr>

<tr>
<td class="org-left">evaluation_end_time</td>
<td class="org-left">timestamp without time zone</td>
<td class="org-left">not null</td>
</tr>

<tr>
<td class="org-left">as_of_date_frequency</td>
<td class="org-left">interval</td>
<td class="org-left">not null</td>
</tr>

<tr>
<td class="org-left">metric</td>
<td class="org-left">character varying</td>
<td class="org-left">not null</td>
</tr>

<tr>
<td class="org-left">parameter</td>
<td class="org-left">character varying</td>
<td class="org-left">not null</td>
</tr>

<tr>
<td class="org-left">value</td>
<td class="org-left">numeric</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">num_labeled_examples</td>
<td class="org-left">integer</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">num_labeled_above_threshold</td>
<td class="org-left">integer</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">num_positive_labels</td>
<td class="org-left">integer</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">sort_seed</td>
<td class="org-left">integer</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Indexes:</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">"evaluations_pkey" PRIMARY KEY, btree (model_id, evaluation_start_time, evaluation_end_time, as_of_date_frequency, metric, parameter)</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Foreign-key constraints:</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">"evaluations_model_id_fkey" FOREIGN KEY (model_id) REFERENCES results.models(model_id)</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>

<p>
Its columns are:
</p>

<dl class="org-dl">
<dt><code>model_id</code></dt><dd>Our beloved <code>model_id</code> that we have encountered before.</dd>
<dt><code>evaluation_start_time</code></dt><dd>After training the model, we evaluate
it on a test matrix. This column tells us the earliest time
that an example in our test matrix could have.</dd>
<dt><code>evaluation_end_time</code></dt><dd>After training the model, we evaluate
it on a test matrix. This column tells us the latest time that
an example in our test matrix could have.</dd>
<dt><code>metric</code></dt><dd>Indicates which metric we are evaluating, e.g., <code>precision@</code>.</dd>
<dt>(no term)</dt><dd><code>parameter</code> ::Indicates at which parameter we are evaluating our
metric, e.g., a metric of precision@ and a parameter of
<code>100.0_pct</code> shows us the <code>precision@100pct</code></dd>
<dt><code>value</code></dt><dd>The value observed for our metric@parameter.</dd>
<dt><code>num_labeled_examples</code></dt><dd>The number of labeled examples in our
test matrix. Why does it matter? It could be the case that we
have entities that we did not observe a label for during our
test timeframe (for example in the <a href="inspections.html">inspections prioritization</a>
problem) . We still want to make predictions for these 
entities, but can't include them when calculating performance
metrics.</dd>
<dt><code>num_labeled_above_threshold</code></dt><dd>How many examples were labeled as above our treshold?</dd>
<dt><code>num_positive_labels</code></dt><dd>The number of rows that had a true positive labels.</dd>
</dl>

<p>
A look at the table shows that we have multiple rows for each model to
show the different performance metrics.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">select</span> * <span style="color: #0000FF;">from</span>
results.evaluations
<span style="color: #0000FF;">limit</span> 5
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">model_id</th>
<th scope="col" class="org-left">evaluation_start_time</th>
<th scope="col" class="org-left">evaluation_end_time</th>
<th scope="col" class="org-left">as_of_date_frequency</th>
<th scope="col" class="org-left">metric</th>
<th scope="col" class="org-left">parameter</th>
<th scope="col" class="org-right">value</th>
<th scope="col" class="org-right">num_labeled_examples</th>
<th scope="col" class="org-right">num_labeled_above_threshold</th>
<th scope="col" class="org-right">num_positive_labels</th>
<th scope="col" class="org-right">sort_seed</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">1</td>
<td class="org-left">2016-01-01 00:00:00</td>
<td class="org-left">2016-01-01 00:00:00</td>
<td class="org-left">1 mon</td>
<td class="org-left">precision@</td>
<td class="org-left">5.0_pct</td>
<td class="org-right">0.2653061224489796</td>
<td class="org-right">1034</td>
<td class="org-right">49</td>
<td class="org-right">247</td>
<td class="org-right">5</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-left">2016-01-01 00:00:00</td>
<td class="org-left">2016-01-01 00:00:00</td>
<td class="org-left">1 mon</td>
<td class="org-left">recall@</td>
<td class="org-left">5.0_pct</td>
<td class="org-right">0.05263157894736842</td>
<td class="org-right">1034</td>
<td class="org-right">49</td>
<td class="org-right">247</td>
<td class="org-right">5</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-left">2016-01-01 00:00:00</td>
<td class="org-left">2016-01-01 00:00:00</td>
<td class="org-left">1 mon</td>
<td class="org-left">precision@</td>
<td class="org-left">10.0_pct</td>
<td class="org-right">0.2641509433962264</td>
<td class="org-right">1034</td>
<td class="org-right">106</td>
<td class="org-right">247</td>
<td class="org-right">5</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-left">2016-01-01 00:00:00</td>
<td class="org-left">2016-01-01 00:00:00</td>
<td class="org-left">1 mon</td>
<td class="org-left">recall@</td>
<td class="org-left">10.0_pct</td>
<td class="org-right">0.11336032388663968</td>
<td class="org-right">1034</td>
<td class="org-right">106</td>
<td class="org-right">247</td>
<td class="org-right">5</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-left">2016-01-01 00:00:00</td>
<td class="org-left">2016-01-01 00:00:00</td>
<td class="org-left">1 mon</td>
<td class="org-left">precision@</td>
<td class="org-left">5_abs</td>
<td class="org-right">0.0</td>
<td class="org-right">1034</td>
<td class="org-right">0</td>
<td class="org-right">247</td>
<td class="org-right">5</td>
</tr>
</tbody>
</table>

<p>
This table lets us answer: <i>how a model_group is performing across the different time slices?</i>:
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">select</span>
model_id, 
evaluation_start_time, 
evaluation_end_time,
metric,
<span style="color: #0000FF;">parameter</span>,
<span style="color: #0000FF;">value</span>
<span style="color: #0000FF;">from</span> results.evaluations
<span style="color: #0000FF;">where</span> model_id <span style="color: #0000FF;">in</span> (
      <span style="color: #0000FF;">select</span> model_id <span style="color: #0000FF;">from</span> results.models <span style="color: #0000FF;">where</span> model_group_id=1
      )
<span style="color: #0000FF;">and</span> metric=<span style="color: #008000;">'precision@'</span> <span style="color: #0000FF;">and</span> <span style="color: #0000FF;">parameter</span> <span style="color: #0000FF;">in</span> (<span style="color: #008000;">'100.0_pct'</span>, <span style="color: #008000;">'5.0_pct'</span>)
<span style="color: #0000FF;">order</span> <span style="color: #0000FF;">by</span> model_id, evaluation_start_time, <span style="color: #0000FF;">parameter</span>;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">model_id</th>
<th scope="col" class="org-left">evaluation_start_time</th>
<th scope="col" class="org-left">evaluation_end_time</th>
<th scope="col" class="org-left">metric</th>
<th scope="col" class="org-left">parameter</th>
<th scope="col" class="org-right">value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">1</td>
<td class="org-left">2016-01-01 00:00:00</td>
<td class="org-left">2016-01-01 00:00:00</td>
<td class="org-left">precision@</td>
<td class="org-left">5.0_pct</td>
<td class="org-right">0.2653061224489796</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-left">2017-01-01 00:00:00</td>
<td class="org-left">2017-01-01 00:00:00</td>
<td class="org-left">precision@</td>
<td class="org-left">5.0_pct</td>
<td class="org-right">0.29333333333333333</td>
</tr>
</tbody>
</table>

<p>
<i>What does this query tell us?</i>
</p>

<p>
We can now see how the different instances (trained on different time
slices, but with same model params) of one of our models perform over
time. We are including the <code>precision@5.0_pct</code> to see what the <b>baseline</b>
is. As you can see above, our model is beating the baseline in every
year. Note how we only included the <i>models</i> that belong to Our
<i>model group</i> <code>1</code>. 
</p>
</div>
</div>

<div id="outline-container-org8e78b04" class="outline-5">
<h5 id="org8e78b04"><span class="section-number-5">4.2.1.5</span> <code>results.predictions</code></h5>
<div class="outline-text-5" id="text-4-2-1-5">
<p>
You can think of the previous table <code>results.evaluations</code> as a summary
of individuals predictions that our model is making. But where can you
find the individual predictions that our model is making? (So you can
generate a list from here). And where can we find the test matrix that
the  predictions are based on? Let us introduce you to The
<code>results.predictions</code> table.  
</p>

<p>
Here is what its first row looks Like:
</p>

<div class="org-src-container">
<pre class="src src-sql" id="org636f6aa"><span style="color: #0000FF;">select</span> *
<span style="color: #0000FF;">from</span> results.predictions
<span style="color: #0000FF;">limit</span> 1
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">model_id</th>
<th scope="col" class="org-right">entity_id</th>
<th scope="col" class="org-left">as_of_date</th>
<th scope="col" class="org-right">score</th>
<th scope="col" class="org-left">label_value</th>
<th scope="col" class="org-left">rank_abs</th>
<th scope="col" class="org-left">rank_pct</th>
<th scope="col" class="org-left">matrix_uuid</th>
<th scope="col" class="org-left">test_label_timespan</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-left">2016-01-01 00:00:00</td>
<td class="org-right">0.21631588415182587</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">f5ba9602cf9da2cc2fa74eede6ef6d17</td>
<td class="org-left">1 mon</td>
</tr>
</tbody>
</table>



<p>
As you can see, the table contains our models' predictions for a given
entity and date. In the case above, our <i>model</i> (<code>model_id   1</code>)
predicted a score of <code class="src src-emacs-lisp">d</code>
<code>0.21631588415182587</code> . The true label was
<code class="src src-emacs-lisp">d</code>
<code>[NULL]</code>. 
</p>

<p>
And do you notice the field <code>matrix_uuid</code>? Doesn't it look similar to
the fields from above that gave us the names of our training matrices?
In fact, it is the same. You can find the test matrix that was used to
make this prediction under  <code>TRIAGE_OUTPUT_PATH/matrices/{matrix_uuid}.csv</code>
</p>
</div>
</div>

<div id="outline-container-orge192278" class="outline-5">
<h5 id="orge192278"><span class="section-number-5">4.2.1.6</span> <span class="todo TODO">TODO</span> : <code>results.feature_importances</code></h5>
</div>

<div id="outline-container-orge37d084" class="outline-5">
<h5 id="orge37d084"><span class="section-number-5">4.2.1.7</span> <span class="todo TODO">TODO</span> : <code>results.individual_importances</code></h5>
</div>

<div id="outline-container-orgb9a1f9f" class="outline-5">
<h5 id="orgb9a1f9f"><span class="section-number-5">4.2.1.8</span> <span class="todo TODO">TODO</span> : <code>results.list_predictions</code></h5>
</div>
</div>
</div>



<div id="outline-container-orge6326fa" class="outline-3">
<h3 id="orge6326fa"><span class="section-number-3">4.3</span> Audition</h3>
<div class="outline-text-3" id="text-4-3">
<p>
<b>Audition</b> is a tool for helping you to select a subset of trained
classifiers from a triage experiment. Often, production-scale experiments
will come up with thousands of trained models, and sifting through all
of those results can be time-consuming even after calculating the
usual basic metrics like precision and recall.
</p>

<p>
You will be facing questions as:
</p>

<ul class="org-ul">
<li>Which metrics matter most?</li>
<li>Should you prioritize the best metric value over time or treat
recent data as most important?</li>
<li>Is low metric variance important?</li>
</ul>

<p>
The answers to questions like these may not be obvious up front. <b>Audition</b>
introduces a structured, semi-automated way of filtering models based
on what you consider important
</p>
</div>
</div>

<div id="outline-container-orga46e262" class="outline-3">
<h3 id="orga46e262"><span class="section-number-3">4.4</span> Post-modeling</h3>
<div class="outline-text-3" id="text-4-4">
<p>
As the name indicates, <b>postmodeling</b> occurs <b>after</b> you have modeled
(potentially) thousands of models (different hyperparameters, different
time windows, different algorithms, etc), and using <code>audition</code> you <i>pre</i>
selected a small number of models.
</p>

<p>
Now, with the <b>postmodeling</b> tools you will be able to select your final
model for using it in <i>production</i>.
</p>

<p>
Triage's postmodeling capabilities include:
</p>

<ul class="org-ul">
<li>Show the score distribution</li>
<li>Compare the list generated by a set of models</li>
<li>Compare the feature importance between a set of models</li>
<li>Diplay the probability calibration curves</li>
<li>Error analysis using a decision treee trained in the errors of the model.</li>
<li>Cross-tab analysis</li>
<li>Bias analysis</li>
</ul>

<p>
If you want to see <b>Audition</b> and <b>Postmodeling</b> in action please refer
<a href="inspections.html">Inspections modeling</a> or to <a href="eis.html">EIS modeling</a> for practical examples.
</p>
</div>
</div>


<div id="outline-container-org16c67cf" class="outline-3">
<h3 id="org16c67cf"><span class="section-number-3">4.5</span> What's next?</h3>
<div class="outline-text-3" id="text-4-5">
<p>
We will begin with <a href="inspections.html">Inspections problem</a>, let's go for It
</p>
</div>
</div>
</div>

<div id="outline-container-org9d2bf3e" class="outline-2">
<h2 id="org9d2bf3e"><span class="section-number-2">5</span> Inpections prioritization</h2>
<div class="outline-text-2" id="text-5">
</div>
<div id="outline-container-org6cd69c7" class="outline-3">
<h3 id="org6cd69c7"><span class="section-number-3">5.1</span> Problem description</h3>
<div class="outline-text-3" id="text-5-1">
<p>
We will begin with the the <b>inspections prioritization</b> problem: we want to generate a list of
  facilities which are <i>likely</i> to have some <b>critical</b> o <b>serious</b>
  violation <i>given that</i> they are inspected.
</p>

<p>
The scenario, is the following:  you work for the City of Chicago and you try
  to prioritize your resources (i.e. your inspection workforce), since
  they are limited. So, you will use the data for answering the next question:
</p>

<blockquote>
<p>
Which X facilities are likely to violate some code in the
  following Y period of time?
</p>
</blockquote>

<p>
In this case maybe you are interested not
in all the violations but in the more severe ones.
</p>
</div>
</div>

<div id="outline-container-org675b5f2" class="outline-3">
<h3 id="org675b5f2"><span class="section-number-3">5.2</span> Creating the labels</h3>
<div class="outline-text-3" id="text-5-2">
<p>
We will define two different labels:
</p>

<ul class="org-ul">
<li><b>Which facilities are likely to fail an inspection?</b></li>
</ul>

<p>
Facilities who failed an inspection (i.e. <code>result</code> = <code>'fail'</code>)
</p>

<ul class="org-ul">
<li><b>Which facilities are likely  to fail an inspection with a major  violation?</b></li>
</ul>

<p>
Rremember that critical violations are coded between <code>1-14</code>, serious violations between
<code>15-29</code>, everything above <code>30</code> is assumed to be a minor violation.
</p>

<p>
Facilities who failed an inspection (i.e. <code>result</code> = <code>'fail'</code>) and the
<code>severity in ('critical', 'serious')</code>
</p>

<p>
We could extract the severity of the violation inspected using the
following code:
</p>


<div class="org-src-container">
<pre class="src src-sql">
<span style="color: #0000FF;">select</span> inspection, 
<span style="color: #6434A3;">date</span>,
<span style="color: #0000FF;">result</span>, 
array_agg(obj -&gt;&gt;<span style="color: #008000;">'severity'</span>) <span style="color: #0000FF;">as</span> violations_severity,
(<span style="color: #0000FF;">result</span> = <span style="color: #008000;">'fail'</span>) <span style="color: #0000FF;">as</span> failed,
(<span style="color: #0000FF;">result</span> = <span style="color: #008000;">'fail'</span> <span style="color: #0000FF;">and</span>
(<span style="color: #008000;">'serious'</span> = <span style="color: #0000FF;">ANY</span>(array_agg(obj -&gt;&gt; <span style="color: #008000;">'severity'</span>)) <span style="color: #0000FF;">or</span> <span style="color: #008000;">'critical'</span> = <span style="color: #0000FF;">ANY</span>(array_agg(obj -&gt;&gt; <span style="color: #008000;">'severity'</span>)))
) <span style="color: #0000FF;">as</span> failed_major_violation
<span style="color: #0000FF;">from</span>
(<span style="color: #0000FF;">select</span> inspection,<span style="color: #6434A3;">date</span>, <span style="color: #0000FF;">result</span>, jsonb_array_elements(violations::jsonb) <span style="color: #0000FF;">as</span> obj <span style="color: #0000FF;">from</span> semantic.events <span style="color: #0000FF;">limit</span> 20)
<span style="color: #0000FF;">as</span> t1
<span style="color: #0000FF;">group</span> <span style="color: #0000FF;">by</span> inspection, <span style="color: #6434A3;">date</span>, <span style="color: #0000FF;">result</span>
<span style="color: #0000FF;">order</span> <span style="color: #0000FF;">by</span> <span style="color: #6434A3;">date</span> <span style="color: #0000FF;">desc</span>

</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">inspection</th>
<th scope="col" class="org-right">date</th>
<th scope="col" class="org-left">result</th>
<th scope="col" class="org-left">violations_severity</th>
<th scope="col" class="org-left">failed</th>
<th scope="col" class="org-left">failed_major_violation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">1770568</td>
<td class="org-right">2016-05-11</td>
<td class="org-left">pass</td>
<td class="org-left">{critical,minor,minor,serious,serious}</td>
<td class="org-left">f</td>
<td class="org-left">f</td>
</tr>

<tr>
<td class="org-right">1763967</td>
<td class="org-right">2016-05-03</td>
<td class="org-left">fail</td>
<td class="org-left">{minor,critical,serious,serious,minor,minor,minor,minor}</td>
<td class="org-left">t</td>
<td class="org-left">t</td>
</tr>

<tr>
<td class="org-right">1343315</td>
<td class="org-right">2013-06-06</td>
<td class="org-left">fail</td>
<td class="org-left">{minor,serious,serious,serious,serious,minor}</td>
<td class="org-left">t</td>
<td class="org-left">t</td>
</tr>

<tr>
<td class="org-right">537439</td>
<td class="org-right">2011-06-10</td>
<td class="org-left">fail</td>
<td class="org-left">{NULL}</td>
<td class="org-left">t</td>
<td class="org-left">[NULL]</td>
</tr>
</tbody>
</table>


<p>
Let's use the previous query to generate our outcomes in a new
<code>inspections</code> Schema.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">create</span> <span style="color: #0000FF;">schema</span> if <span style="color: #0000FF;">not</span> <span style="color: #0000FF;">exists</span> inspections;
</pre>
</div>

<p>
<code>Triage</code> has some restrictions (at the current version) about how to
name (some) columns, in specific, our columns should include:
</p>

<dl class="org-dl">
<dt><code>entity_id</code>    </dt><dd>The entity affected / causing the event (In our
case the facility)</dd>
<dt><code>outcome_date</code> </dt><dd>The date in which the event happen / The date in
which we discover the result (The inpection's date)</dd>
<dt><code>outcome</code>      </dt><dd>The result (label) of the event (One of the labels
speecified before)</dd>
</dl>

<p>
<code>entity_id</code> an identifier for which the labels are applied to,
<code>outcome_date</code> the date at which some outcome was known, <code>outcome</code> a
boolean outcome.
</p>

<p>
Since we defined two labels, we will create two tables one per each outcome.
</p>

<div class="org-src-container">
<pre class="src src-sql">
<span style="color: #0000FF;">create</span> temp <span style="color: #0000FF;">table</span> <span style="color: #006699;">inspections_outcomes</span> <span style="color: #0000FF;">as</span> (
<span style="color: #0000FF;">select</span> inspection, entity_id, <span style="color: #6434A3;">date</span>,
   (<span style="color: #0000FF;">result</span> = <span style="color: #008000;">'fail'</span>) <span style="color: #0000FF;">as</span> failed,
   (<span style="color: #0000FF;">result</span> = <span style="color: #008000;">'fail'</span> <span style="color: #0000FF;">and</span>
       (<span style="color: #008000;">'serious'</span> = <span style="color: #0000FF;">ANY</span>(array_agg(obj -&gt;&gt; <span style="color: #008000;">'severity'</span>)) <span style="color: #0000FF;">or</span> <span style="color: #008000;">'critical'</span> = <span style="color: #0000FF;">ANY</span>(array_agg(obj -&gt;&gt; <span style="color: #008000;">'severity'</span>)))
   ) <span style="color: #0000FF;">as</span> failed_major_violation
<span style="color: #0000FF;">from</span>
   (<span style="color: #0000FF;">select</span> inspection, entity_id, <span style="color: #6434A3;">date</span>, <span style="color: #0000FF;">result</span>, jsonb_array_elements(violations::jsonb) <span style="color: #0000FF;">as</span> obj <span style="color: #0000FF;">from</span> semantic.events)
<span style="color: #0000FF;">as</span> t1
<span style="color: #0000FF;">group</span> <span style="color: #0000FF;">by</span> inspection, entity_id, <span style="color: #6434A3;">date</span>, <span style="color: #0000FF;">result</span>
);


<span style="color: #0000FF;">drop</span> <span style="color: #0000FF;">table</span> <span style="color: #006699;">if</span> <span style="color: #0000FF;">exists</span> inspections.failed;

<span style="color: #0000FF;">create</span> <span style="color: #0000FF;">table</span> <span style="color: #006699;">inspections.failed</span> <span style="color: #0000FF;">as</span> (
<span style="color: #0000FF;">select</span>
entity_id,
<span style="color: #6434A3;">date</span> <span style="color: #0000FF;">as</span> outcome_date,
failed <span style="color: #0000FF;">as</span> outcome
<span style="color: #0000FF;">from</span> inspections_outcomes
);


<span style="color: #0000FF;">drop</span> <span style="color: #0000FF;">table</span> <span style="color: #006699;">if</span> <span style="color: #0000FF;">exists</span> inspections.failed_major_violation;

<span style="color: #0000FF;">create</span> <span style="color: #0000FF;">table</span> <span style="color: #006699;">inspections.failed_major_violation</span> <span style="color: #0000FF;">as</span> (
<span style="color: #0000FF;">select</span>
entity_id,
<span style="color: #6434A3;">date</span> <span style="color: #0000FF;">as</span> outcome_date,
failed_major_violation <span style="color: #0000FF;">as</span> outcome
<span style="color: #0000FF;">from</span> inspections_outcomes
);

</pre>
</div>

<p>
Also, We need to create a new version of the <code>semantic.entities</code>
table. <code>Triage</code> refers to this new table as the <b>states</b> table. It should
have columns <code>entity_id</code>, <code>start__time, end_time</code> and <code>state</code>.
The states table allows us to only
include rows in your matrices in a specific state. In our case we only want
to inspect <b>active</b> facilities. We will replace all the <code>NULL</code> values in
the <code>end_time</code> column for a date in the future, in particular <code>2020-12-31</code>.
</p>

<div class="org-src-container">
<pre class="src src-sql">
<span style="color: #0000FF;">drop</span> <span style="color: #0000FF;">table</span> <span style="color: #006699;">if</span> <span style="color: #0000FF;">exists</span> inspections.active_facilities;

<span style="color: #0000FF;">create</span> <span style="color: #0000FF;">table</span> <span style="color: #006699;">inspections.active_facilities</span> <span style="color: #0000FF;">as</span> (
<span style="color: #0000FF;">select</span>
<span style="color: #0000FF;">distinct</span>
entity_id, <span style="color: #008000;">'active'</span>::<span style="color: #6434A3;">VARCHAR</span>  <span style="color: #0000FF;">as</span> <span style="color: #0000FF;">state</span>, start_time, <span style="color: #006FE0;">coalesce</span>(end_time, <span style="color: #008000;">'2020-12-31'</span>::<span style="color: #6434A3;">date</span>) <span style="color: #0000FF;">as</span> end_time
<span style="color: #0000FF;">from</span> semantic.entities
);
</pre>
</div>
</div>
</div>


<div id="outline-container-org5b7de2b" class="outline-3">
<h3 id="org5b7de2b"><span class="section-number-3">5.3</span> Modeling using Machine Learning</h3>
<div class="outline-text-3" id="text-5-3">
<p>
It is time of getting all the previous steps and put them
together. Don't worry, actually we are done with coding. <code>Triage</code> provides
you with a configuration file for specifying the experiment that we
want to run.
</p>
</div>

<div id="outline-container-org59c420c" class="outline-4">
<h4 id="org59c420c"><span class="section-number-4">5.3.1</span> Creating a simple experiment</h4>
<div class="outline-text-4" id="text-5-3-1">
<p>
For this first experiment we will try one of the simplest
machine learning algorithms: a <b>Decision Tree Classifier</b>. We need to
write the experiment config file for that, let's break it down and
explain all the sections.
</p>

<p>
The config file for this first experiment is located in
<a href="triage/experiment_config/inspections_test.yaml">triage/experiment_config/inspections_test.yaml</a>
</p>


<p>
The first lines of the experiment config file are related to the
version config file (<code>v3</code> at the moment of writing this tutorial), a
comment (<code>model_comment</code>), this will end up as
a value in the <code>results.models</code> table, and a list of user defined
metadata (<code>user_metadata</code>) that could be used for identifying the
resulting model groups. In our test example, if you run experiments that share
a temporal configuration but that use different label definitions
(say, labeling building inspections with <b>any</b> violation as positive or
labeling only building inspections with major violations as positive),
you can use the user metadata keys to indicate that the matrices
from these experiments have different labeling criteria. The matrices from the
two experiments will have different filenames (and not be overwritten or
inappropriately reused), and if you add the <code>label_definition</code> key to
the <code>model_group_keys</code>, models made on different label definition will
have different groups.
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #BA36A5;">config_version</span>: <span style="color: #008000;">'v3'</span>

<span style="color: #BA36A5;">model_comment</span>: <span style="color: #008000;">'inspections_test'</span>

<span style="color: #BA36A5;">user_metadata</span>:
  <span style="color: #BA36A5;">label_definition</span>: <span style="color: #008000;">'failed'</span>
  <span style="color: #BA36A5;">experiment_type</span>: <span style="color: #008000;">'inspections prioritization'</span>
  <span style="color: #BA36A5;">purpose</span>: <span style="color: #008000;">'test'</span>
  <span style="color: #BA36A5;">org</span>: <span style="color: #008000;">'DSaPP'</span>
  <span style="color: #BA36A5;">team</span>: <span style="color: #008000;">'Tutorial'</span>
  <span style="color: #BA36A5;">author</span>: <span style="color: #008000;">'Your name here'</span>
</pre>
</div>

<p>
Next, the <b>temporal configuration</b>  section. The first four parameters
are related to the availability of data: How much data you have for
feature creation? How much data you have for label generation? For
simplicity we will assume that we can use the full <code>semantic.events</code> time
span for both.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">select</span> <span style="color: #006FE0;">min</span>(<span style="color: #6434A3;">date</span>), <span style="color: #006FE0;">max</span>(<span style="color: #6434A3;">date</span>) <span style="color: #0000FF;">from</span> semantic.events
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">min</th>
<th scope="col" class="org-right">max</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">2010-01-04</td>
<td class="org-right">2018-02-13</td>
</tr>
</tbody>
</table>

<p>
The next parameters are related to the training intervals:
</p>
<ul class="org-ul">
<li>How frequently to retrain models? (<code>model_update_frequency</code>)</li>
<li>How many rows per entity in the train matrices?
(<code>training_as_of_date_frequencies</code>)</li>
<li>How much time is covered by labels in the training matrices? (<code>training_label_timespans</code>)</li>
</ul>

<p>
The remaining elements are related to the <b>testing</b> matrices, in the
particular case of <b>inspections</b>, you can choose them as follows:
</p>

<ul class="org-ul">
<li><code>test_as_of_date_frequencies</code> is planning/scheduling frequency</li>
<li><code>test_durations</code> is how far out are you scheduling for?</li>
<li><code>test_label_timespan</code> is equal to <code>test_durations</code></li>
</ul>

<p>
Let's assume that we need to do rounds of inspections every month
(<code>test_as_of_date_frequencies = 1month</code>) and we need to complete that
round in exactly one month (<code>test_durations = test_label_timespan =
1month</code>)
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #BA36A5;">temporal_config</span>:
    <span style="color: #BA36A5;">feature_start_time</span>: <span style="color: #008000;">'2010-01-04'</span>
    <span style="color: #BA36A5;">feature_end_time</span>: <span style="color: #008000;">'2017-02-13'</span>
    <span style="color: #BA36A5;">label_start_time</span>: <span style="color: #008000;">'2015-02-01'</span>
    <span style="color: #BA36A5;">label_end_time</span>: <span style="color: #008000;">'2017-02-13'</span>

    <span style="color: #BA36A5;">model_update_frequency</span>: <span style="color: #008000;">'1y'</span>
    <span style="color: #BA36A5;">training_label_timespans</span>: [<span style="color: #008000;">'1month'</span>]
    <span style="color: #BA36A5;">training_as_of_date_frequencies</span>: <span style="color: #008000;">'1month'</span>

    <span style="color: #BA36A5;">test_durations</span>: <span style="color: #008000;">'1month'</span>
    <span style="color: #BA36A5;">test_label_timespans</span>: [<span style="color: #008000;">'1month'</span>]
    <span style="color: #BA36A5;">test_as_of_date_frequencies</span>: <span style="color: #008000;">'1month'</span>

    <span style="color: #BA36A5;">max_training_histories</span>: <span style="color: #008000;">'5y'</span>
</pre>
</div>

<p>
We can visualize the splitting using the function <code>show_timechop</code>
introduced in <a href="triage_intro.html">Introduction to triage</a>.
</p>

<div class="org-src-container">
<pre class="src src-sh">./tutorial.sh triage --config_file inspections_test.yaml show_temporal_blocks
</pre>
</div>

<p>
Using the config file /triage/experiment_config/inspections_test.yaml
The output (matrices and models) of this experiment will be stored in triage/output
The experiment will utilize any preexisting matrix or model: False
Creating experiment object
Experiment loaded
Generating temporal blocks image
Image stored in:
/triage/inspections_test.svg
</p>


<div class="figure">
<p><object type="image/svg+xml" data="./triage/inspections_test.svg" class="org-svg">
Sorry, your browser does not support SVG.</object>
</p>
</div>


<p>
We need to specify the table that keeps our labels, for this first
experiment we will use the label <code>failed</code>, stored in <code>inspections.labels</code>.
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #BA36A5;">events_table</span>: inspections.failed
</pre>
</div>

<p>
<code>Triage</code> will generate the features for us, we need to tell which ones
in the section <code>feature_aggregations</code>. Here, each entry describes a
<code>collate.SpacetimeAggregation</code> object, and the
arguments needed to create it. For this experiment we will try the following
features:
</p>

<ul class="org-ul">
<li>Number of different types of inspections  that happened in the
facility in the last year from a particular day</li>
<li></li>

<li>Number of different types of inspections  that happened in the
zip code in the last year from a particular day</li>
</ul>

<p>
If we observe the image generated from the <code>temporal_config</code> section,
each particular date is the beginning of the rectangles that describes
the rows in the matrix. In that date (<code>as_of_date</code> in <code>timechop</code> parlance)
we will calculate both features, and we will repeat that for every
other rectangle in that image.
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #BA36A5;">feature_aggregations</span>:
    <span style="color: #BA36A5;">-</span>
<span style="color: #BA36A5;">        prefix</span>: <span style="color: #008000;">'inspections'</span>
        <span style="color: #BA36A5;">from_obj</span>: <span style="color: #008000;">'semantic.events'</span>
        <span style="color: #BA36A5;">knowledge_date_column</span>: <span style="color: #008000;">'date'</span>

        <span style="color: #BA36A5;">categoricals_imputation</span>:
            <span style="color: #BA36A5;">all</span>:
                <span style="color: #BA36A5;">type</span>: <span style="color: #008000;">'zero'</span>

        <span style="color: #BA36A5;">categoricals</span>:
            <span style="color: #BA36A5;">-</span>
<span style="color: #BA36A5;">                column</span>: <span style="color: #008000;">'type'</span>
                <span style="color: #BA36A5;">choice_query</span>: <span style="color: #008000;">'select distinct type from semantic.events where type is not null'</span>
                <span style="color: #BA36A5;">metrics</span>:
                    - <span style="color: #008000;">'sum'</span>

        <span style="color: #BA36A5;">intervals</span>:
            - <span style="color: #008000;">'3month'</span>

        <span style="color: #BA36A5;">groups</span>:
            - <span style="color: #008000;">'entity_id'</span>
            - <span style="color: #008000;">'zip_code'</span>
</pre>
</div>

<p>
We just want to include <b>active</b> facilities in our matrices, so we tell
<code>triage</code> to take that in account:
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #BA36A5;">state_config</span>:
    <span style="color: #BA36A5;">table_name</span>: <span style="color: #008000;">'inspections.active_facilities'</span>
    <span style="color: #BA36A5;">state_filters</span>:
       - <span style="color: #008000;">'active'</span>
</pre>
</div>

<p>
Now, lets discuss how we will define the different models to try in
the data (Remember that the model is specified by the algorithm, the
hyperparameters, and the subset of features to use). In <code>triage</code> you
need to specify in the <code>grid_config</code> section, a list of machine learning
algorithms that you want to train, and a set of list of
hyperparameters. You can use any algorithm that you want, the only
requirement is that respects the <code>sklearn</code> API.
</p>


<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #BA36A5;">grid_config</span>:
    <span style="color: #008000;">'sklearn.tree.DecisionTreeClassifier'</span>:
        <span style="color: #BA36A5;">max_depth</span>: [1,null]
        <span style="color: #BA36A5;">max_features</span>: [1, sqrt, null]
</pre>
</div>

<p>
Some of the parameters in <code>sklearn</code> are <code>None</code>, if you want to try those
you need to indicate that with the <code>yaml</code> 's <code>null</code> keyword.
</p>

<p>
Besides the algorithm and the hyperparameters, you should specify
which subset of features use. First, in the section
<code>feature_group_definition</code> you specify how to group the features (you
can use the <code>table name</code> or the <code>prefix</code> from the section
<code>feature_aggregation</code>) and then choose one <i>strategy</i> for choosing the
subsets: <code>all</code> (all the subsets at once), <code>leave-one-out</code> (try all the
subsets except one, do that for all the combinations) or <code>leave-one-in</code>
(just try subset at the time).
</p>


<div class="org-src-container">
<pre class="src src-yaml">
<span style="color: #BA36A5;">feature_group_definition</span>:
   <span style="color: #BA36A5;">prefix</span>: [<span style="color: #008000;">'inspections'</span>]

<span style="color: #BA36A5;">feature_group_strategies</span>: [<span style="color: #008000;">'all'</span>]
</pre>
</div>

<p>
In this experiment we will end with <b>6</b> model groups (\(algorithms (1) \times
hyperparameters combinations (2 \times 3)  \times feature groups (1) \times temporal
combinations (1)\)). Also, we will create <b>12</b> different models (2 per
each model group) given that we have 2 temporal blocks (one model per
temporal group).
</p>

<p>
<code>model_group_keys</code> defines a list of <b>additional</b> matrix metadata keys that
should be considered when creating a model group. For example, if the models are
built on matrices with different history lengths, different
labeling windows (e.g., inspection violations in the next month, next year, or
next two years), the frequency of rows for each
entity, or the definition of a positive label (<code>label_definition</code>, from
<code>user_metadata</code>).
</p>

<p>
The valid <code>model_group_keys</code> are
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #BA36A5;">model_group_keys</span>:
    - <span style="color: #008000;">'label_definition'</span>
    - <span style="color: #008000;">'experiment_type'</span>
    - <span style="color: #008000;">'purpose'</span>
</pre>
</div>

<p>
Finally, we should define wich metrics we care for evaluating our
model. Here we will concentrate only in <code>precision</code> and <code>recall</code>.
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #BA36A5;">scoring</span>:
    <span style="color: #BA36A5;">sort_seed</span>: 5
    <span style="color: #BA36A5;">metric_groups</span>:
        <span style="color: #BA36A5;">-</span>
<span style="color: #BA36A5;">            metrics</span>: [precision@, recall@]
            <span style="color: #BA36A5;">thresholds</span>:
                <span style="color: #BA36A5;">percentiles</span>: [5.0, 10.0]
                <span style="color: #BA36A5;">top_n</span>: [5, 10, 25]
</pre>
</div>

<p>
You should be warned that precision and recall at \(k\) in this setting
is kind of ill-defined (because you will end with a lot of <code>NULL</code>
labels, remember, only a few of facilities are inspected in each
period) &#x2026;
</p>

<p>
We will want as a result of our experiments, a <b>list</b> of facilities to
be inspected. The length of our list is contrained by our inspection
resources, i.e. the answer to the question How many facilities can I
inpect in a month?. In this experiment we are assuming that the
maximum capacity is <b>25</b> but we are testing also for a list of length
<b>5</b>, and <b>10</b> (see <code>top_n</code> Above).
</p>

<p>
The execution of the experiments could take a long time, so, it is a
good practice to  <i>validate</i> the configuration file, <i>before</i> running
the model. You don't want to wait for hours (or days) and then
discover that there was something wrong
</p>

<div class="org-src-container">
<pre class="src src-sh">./tutorial.sh triage --config_file inspections_test.yaml validate
</pre>
</div>

<p>
Using the config file /triage/experiment_config/inspections_test.yaml
The output (matrices and models) of this experiment will be stored in triage/output
The experiment will utilize any preexisting matrix or model: False
Creating experiment object
Experiment loaded
Validating experiment's configuration
Experiment validation ran to completion with no errors
</p>

<p>
-&#x2014;TIME SPLIT SUMMARY-&#x2014;
</p>

<p>
Number of time splits: 2
Split index 0:
            Training as_of_time_range: 2015-02-13 00:00:00 to 2015-11-13 00:00:00 (10 total)
            Testing as_of_time range: 2015-12-13 00:00:00 to 2015-12-13 00:00:00 (1 total)
</p>


<p>
Split index 1:
            Training as_of_time_range: 2015-02-13 00:00:00 to 2016-11-13 00:00:00 (22 total)
            Testing as_of_time range: 2016-12-13 00:00:00 to 2016-12-13 00:00:00 (1 total)
</p>


<p>
For more detailed information on your time splits, inspect the experiment `split_definitions` property
</p>

<p>
The experiment configuration doesn't contain any obvious errors.
Any error that occurs from now on, possibly will be related to hit the maximum 
number of columns allowed or collision in
the column names, both due to PostgreSQL limitations.
</p>

<p>
The experiment looks in good shape. May the force be with you
</p>

<p>
You can execute the experiment as
</p>

<div class="org-src-container">
<pre class="src src-sh">./tutorial.sh triage --config_file inspections_test.yaml run
</pre>
</div>

<p>
Using the config file /triage/experiment_config/inspections_test.yaml
The output (matrices and models) of this experiment will be stored in triage/output
The experiment will utilize any preexisting matrix or model: False
Creating experiment object
Experiment loaded
Executing experiment
Done
Experiment completed in 0:01:41.427599 seconds
</p>

<p>
This will print a lot of output, and if everything is correct it will create 4 matrices (2 for 
training, 2 for testing) in <code>triage/matrices</code>, every matrix will be
represented by two files, one with the metadata  of the matrix (a
<code>yaml</code> file) and the actual matrix (the <code>csv</code> file). 
</p>

<div class="org-src-container">
<pre class="src src-sh">ls /triage/output/matrices | awk -F . <span style="color: #008000;">'{print $NF}'</span> | sort | uniq -c
</pre>
</div>

<p>
4 csv
4 yaml
</p>

<p>
<code>Triage</code> also will store 12 trained models in <code>triage/trained_models</code>:
</p>

<div class="org-src-container">
<pre class="src src-sh">ls /triage/output/trained_models | wc -l
</pre>
</div>

<p>
12
</p>

<p>
And it will populate the <code>results</code> schema in the database, as
commented above, we will get <code>6</code> <i>model groups</i>:
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">select</span> model_group_id, model_type, model_parameters <span style="color: #0000FF;">from</span> results.model_groups;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">model_group_id</th>
<th scope="col" class="org-left">model_type</th>
<th scope="col" class="org-left">model_parameters</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">1</td>
<td class="org-left">sklearn.tree.DecisionTreeClassifier</td>
<td class="org-left">{"max_depth": 1, "max_features": 1}</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-left">sklearn.tree.DecisionTreeClassifier</td>
<td class="org-left">{"max_depth": 1, "max_features": "sqrt"}</td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-left">sklearn.tree.DecisionTreeClassifier</td>
<td class="org-left">{"max_depth": 1, "max_features": null}</td>
</tr>

<tr>
<td class="org-right">4</td>
<td class="org-left">sklearn.tree.DecisionTreeClassifier</td>
<td class="org-left">{"max_depth": null, "max_features": 1}</td>
</tr>

<tr>
<td class="org-right">5</td>
<td class="org-left">sklearn.tree.DecisionTreeClassifier</td>
<td class="org-left">{"max_depth": null, "max_features": "sqrt"}</td>
</tr>

<tr>
<td class="org-right">6</td>
<td class="org-left">sklearn.tree.DecisionTreeClassifier</td>
<td class="org-left">{"max_depth": null, "max_features": null}</td>
</tr>
</tbody>
</table>

<p>
And <code>12</code> <i>Models</i>:
</p>


<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">select</span>
model_group_id, model_id, train_end_time
<span style="color: #0000FF;">from</span> results.models
<span style="color: #0000FF;">order</span> <span style="color: #0000FF;">by</span> model_group_id, train_end_time <span style="color: #0000FF;">asc</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">model_group_id</th>
<th scope="col" class="org-right">model_id</th>
<th scope="col" class="org-left">train_end_time</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-left">2016-01-01 00:00:00</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-right">7</td>
<td class="org-left">2017-01-01 00:00:00</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-right">2</td>
<td class="org-left">2016-01-01 00:00:00</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-right">8</td>
<td class="org-left">2017-01-01 00:00:00</td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-right">3</td>
<td class="org-left">2016-01-01 00:00:00</td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-right">9</td>
<td class="org-left">2017-01-01 00:00:00</td>
</tr>

<tr>
<td class="org-right">4</td>
<td class="org-right">4</td>
<td class="org-left">2016-01-01 00:00:00</td>
</tr>

<tr>
<td class="org-right">4</td>
<td class="org-right">10</td>
<td class="org-left">2017-01-01 00:00:00</td>
</tr>

<tr>
<td class="org-right">5</td>
<td class="org-right">5</td>
<td class="org-left">2016-01-01 00:00:00</td>
</tr>

<tr>
<td class="org-right">5</td>
<td class="org-right">11</td>
<td class="org-left">2017-01-01 00:00:00</td>
</tr>

<tr>
<td class="org-right">6</td>
<td class="org-right">6</td>
<td class="org-left">2016-01-01 00:00:00</td>
</tr>

<tr>
<td class="org-right">6</td>
<td class="org-right">12</td>
<td class="org-left">2017-01-01 00:00:00</td>
</tr>
</tbody>
</table>

<p>
From that last query, you should note that the order in which <code>triage</code> train
the models is by block (<code>train_end_time</code>) from oldest to recent, and
from <code>model_group</code>, also in ascending order. It will not go to the
next block, until all the <i>models groups</i> were trained.
</p>

<p>
You can check with which matrix the models where trained
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">select</span>
model_id, model_group_id, train_end_time, 
model_hash,train_matrix_uuid
<span style="color: #0000FF;">from</span> results.models
<span style="color: #0000FF;">order</span> <span style="color: #0000FF;">by</span> model_group_id, train_end_time <span style="color: #0000FF;">asc</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">model_id</th>
<th scope="col" class="org-right">model_group_id</th>
<th scope="col" class="org-left">train_end_time</th>
<th scope="col" class="org-left">model_hash</th>
<th scope="col" class="org-left">train_matrix_uuid</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-left">2016-01-01 00:00:00</td>
<td class="org-left">5062bb64aecdbf0f6875de579c4b4845</td>
<td class="org-left">c834bd5ba5b9c3ebdf8d6e9ac37abee9</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-right">1</td>
<td class="org-left">2017-01-01 00:00:00</td>
<td class="org-left">6bb1c66e613fc9f19f3992ec36d743ab</td>
<td class="org-left">53ccca25d2096ad453831883e1e50e1d</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-right">2</td>
<td class="org-left">2016-01-01 00:00:00</td>
<td class="org-left">fd96142f002bdbdfe518dff477048bb9</td>
<td class="org-left">c834bd5ba5b9c3ebdf8d6e9ac37abee9</td>
</tr>

<tr>
<td class="org-right">8</td>
<td class="org-right">2</td>
<td class="org-left">2017-01-01 00:00:00</td>
<td class="org-left">4473c1076e1479bb1aec875913b354c7</td>
<td class="org-left">53ccca25d2096ad453831883e1e50e1d</td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-right">3</td>
<td class="org-left">2016-01-01 00:00:00</td>
<td class="org-left">d140cd9a9de944ab8587efbba8692c99</td>
<td class="org-left">c834bd5ba5b9c3ebdf8d6e9ac37abee9</td>
</tr>

<tr>
<td class="org-right">9</td>
<td class="org-right">3</td>
<td class="org-left">2017-01-01 00:00:00</td>
<td class="org-left">3f33a1dd1d1047fd4cc7a28695a83514</td>
<td class="org-left">53ccca25d2096ad453831883e1e50e1d</td>
</tr>

<tr>
<td class="org-right">4</td>
<td class="org-right">4</td>
<td class="org-left">2016-01-01 00:00:00</td>
<td class="org-left">a1b6ea17f74ea1877212ea740d1d46d7</td>
<td class="org-left">c834bd5ba5b9c3ebdf8d6e9ac37abee9</td>
</tr>

<tr>
<td class="org-right">10</td>
<td class="org-right">4</td>
<td class="org-left">2017-01-01 00:00:00</td>
<td class="org-left">bbea50a714622b612e6da12722c34ec3</td>
<td class="org-left">53ccca25d2096ad453831883e1e50e1d</td>
</tr>

<tr>
<td class="org-right">5</td>
<td class="org-right">5</td>
<td class="org-left">2016-01-01 00:00:00</td>
<td class="org-left">a85d9be461e9c41d21aee29cbcf421f3</td>
<td class="org-left">c834bd5ba5b9c3ebdf8d6e9ac37abee9</td>
</tr>

<tr>
<td class="org-right">11</td>
<td class="org-right">5</td>
<td class="org-left">2017-01-01 00:00:00</td>
<td class="org-left">000a39b2678469280132e5b7b791ad42</td>
<td class="org-left">53ccca25d2096ad453831883e1e50e1d</td>
</tr>

<tr>
<td class="org-right">6</td>
<td class="org-right">6</td>
<td class="org-left">2016-01-01 00:00:00</td>
<td class="org-left">48204ce78ec79c479090c332fab73e26</td>
<td class="org-left">c834bd5ba5b9c3ebdf8d6e9ac37abee9</td>
</tr>

<tr>
<td class="org-right">12</td>
<td class="org-right">6</td>
<td class="org-left">2017-01-01 00:00:00</td>
<td class="org-left">8cc1037025ef7c97295381434b24977e</td>
<td class="org-left">53ccca25d2096ad453831883e1e50e1d</td>
</tr>
</tbody>
</table>

<p>
As expected, we have two models per model group. Each model was trained
with the matrix indicated in the column <code>train_matrix_uuid</code>. This <code>uuid</code>
also is the file name of the stored matrix. The model itself was
stored under the file named with the <code>model_hash</code>.
</p>

<p>
For example, the model <code>7</code> was stored as
<code>/triage/trained_models/</code> <code class="src src-sql"><span style="color: #0000FF;">select</span> train_matrix_uuid <span style="color: #0000FF;">from</span>
results.models <span style="color: #0000FF;">where</span> model_id = 7</code>
using the standard serialization of sklearn models. This model was
trained with the matrix <code class="src src-sql"><span style="color: #0000FF;">select</span> train_matrix_uuid <span style="color: #0000FF;">from</span>
results.models <span style="color: #0000FF;">where</span> model_id = 7</code> stored in the directory
<code>/triage/Matrices</code>.
</p>



<p>
The model <code>7</code> used the following hyperparameters:
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">select</span> 
model_parameters 
<span style="color: #0000FF;">from</span> results.models 
<span style="color: #0000FF;">where</span> model_id = 7
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">model_parameters</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">{"max_depth": 1, "max_features": 1}</td>
</tr>
</tbody>
</table>


<p>
We can visualize the model 
</p>

<div class="org-src-container">
<pre class="src src-sh">./tutorial.sh triage --config_file inspections_baseline.yaml show_model_plot --model 7
</pre>
</div>

<p>
Using the config file /triage/experiment_config/inspections_baseline.yaml
The output (matrices and models) of this experiment will be stored in triage/output
Using data stored in postgresql://food_user:some_password@food_db/food
The experiment will utilize any preexisting matrix or model: False
Creating experiment object
Experiment loaded
Generating model image
postgresql://food_user:some_password@food_db/food
Plotting tree number 0
Image stored in: 
['/triage/output/images/model_7_tree_0.svg']
</p>


<div class="figure">
<p><object type="image/svg+xml" data="./triage/output/images/model_7_tree_0.svg" class="org-svg">
Sorry, your browser does not support SVG.</object>
</p>
</div>

<p>
This tree makes kind of sense, if the facility had more than 1.5
inspections related to food poisoning then it will fail the
inspection.
</p>

<p>
The same model <code>7</code> is part of the model group <code class="src src-sql"><span style="color: #0000FF;">select</span> model_group_id
<span style="color: #0000FF;">from</span> results.models <span style="color: #0000FF;">where</span> model_id = 7</code>. That model group
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">select</span> 
model_group_id, model_type, model_config 
<span style="color: #0000FF;">from</span> 
results.model_groups 
<span style="color: #0000FF;">where</span> model_group_id = 1
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">model_group_id</th>
<th scope="col" class="org-left">model_type</th>
<th scope="col" class="org-left">model_config</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">1</td>
<td class="org-left">sklearn.tree.DecisionTreeClassifier</td>
<td class="org-left">{"experiment_type": "test", "label_definition": "failed"}</td>
</tr>
</tbody>
</table>

<p>
The features used by that model are:
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">select</span> 
<span style="color: #0000FF;">unnest</span>(feature_list) <span style="color: #0000FF;">as</span> features 
<span style="color: #0000FF;">from</span> 
results.model_groups 
<span style="color: #0000FF;">where</span> model_group_id = 1
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">features</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">inspections_entity_id_3month_type_canvass_sum</td>
</tr>

<tr>
<td class="org-left">inspections_entity_id_3month_type_complaint_sum</td>
</tr>

<tr>
<td class="org-left">inspections_entity_id_3month_type_consultation_sum</td>
</tr>

<tr>
<td class="org-left">inspections_entity_id_3month_type_food poisoning_sum</td>
</tr>

<tr>
<td class="org-left">inspections_entity_id_3month_type_license_sum</td>
</tr>

<tr>
<td class="org-left">inspections_entity_id_3month_type__NULL_sum</td>
</tr>

<tr>
<td class="org-left">inspections_entity_id_3month_type_tag removal_sum</td>
</tr>

<tr>
<td class="org-left">inspections_entity_id_3month_type_task force_sum</td>
</tr>

<tr>
<td class="org-left">inspections_zip_code_3month_type_canvass_sum</td>
</tr>

<tr>
<td class="org-left">inspections_zip_code_3month_type_complaint_sum</td>
</tr>

<tr>
<td class="org-left">inspections_zip_code_3month_type_consultation_sum</td>
</tr>

<tr>
<td class="org-left">inspections_zip_code_3month_type_food poisoning_sum</td>
</tr>

<tr>
<td class="org-left">inspections_zip_code_3month_type_license_sum</td>
</tr>

<tr>
<td class="org-left">inspections_zip_code_3month_type__NULL_sum</td>
</tr>

<tr>
<td class="org-left">inspections_zip_code_3month_type_tag removal_sum</td>
</tr>

<tr>
<td class="org-left">inspections_zip_code_3month_type_task force_sum</td>
</tr>
</tbody>
</table>

<p>
Finally, the performance of the model <code>7</code>  are:
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">select</span>
model_id,
metric || <span style="color: #0000FF;">parameter</span> <span style="color: #0000FF;">as</span> metric,
<span style="color: #0000FF;">value</span>,
num_labeled_examples, 
num_labeled_above_threshold,
num_positive_labels
<span style="color: #0000FF;">from</span> results.evaluations <span style="color: #0000FF;">where</span> model_id = 7
<span style="color: #0000FF;">order</span> <span style="color: #0000FF;">by</span> num_labeled_above_threshold <span style="color: #0000FF;">asc</span>,
metric || <span style="color: #0000FF;">parameter</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">model_id</th>
<th scope="col" class="org-left">metric</th>
<th scope="col" class="org-right">value</th>
<th scope="col" class="org-right">num_labeled_examples</th>
<th scope="col" class="org-right">num_labeled_above_threshold</th>
<th scope="col" class="org-right">num_positive_labels</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">7</td>
<td class="org-left">precision@5_abs</td>
<td class="org-right">0.0</td>
<td class="org-right">1173</td>
<td class="org-right">0</td>
<td class="org-right">269</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-left">recall@5_abs</td>
<td class="org-right">0.0</td>
<td class="org-right">1173</td>
<td class="org-right">0</td>
<td class="org-right">269</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-left">precision@10_abs</td>
<td class="org-right">1.0</td>
<td class="org-right">1173</td>
<td class="org-right">1</td>
<td class="org-right">269</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-left">recall@10_abs</td>
<td class="org-right">0.0037174721189591076</td>
<td class="org-right">1173</td>
<td class="org-right">1</td>
<td class="org-right">269</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-left">precision@25_abs</td>
<td class="org-right">0.6</td>
<td class="org-right">1173</td>
<td class="org-right">5</td>
<td class="org-right">269</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-left">recall@25_abs</td>
<td class="org-right">0.011152416356877323</td>
<td class="org-right">1173</td>
<td class="org-right">5</td>
<td class="org-right">269</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-left">precision@5.0_pct</td>
<td class="org-right">0.29333333333333333</td>
<td class="org-right">1173</td>
<td class="org-right">75</td>
<td class="org-right">269</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-left">recall@5.0_pct</td>
<td class="org-right">0.08178438661710037</td>
<td class="org-right">1173</td>
<td class="org-right">75</td>
<td class="org-right">269</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-left">precision@10.0_pct</td>
<td class="org-right">0.25190839694656486</td>
<td class="org-right">1173</td>
<td class="org-right">131</td>
<td class="org-right">269</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-left">recall@10.0_pct</td>
<td class="org-right">0.12267657992565056</td>
<td class="org-right">1173</td>
<td class="org-right">131</td>
<td class="org-right">269</td>
</tr>
</tbody>
</table>

<p>
The columns  <code>num_labeled_examples, num_labeled_above_threshold,
num_positive_labels</code> represents the number of selected entities in the
prediction date which are labeled (there are <code>1173</code> entities in the
test matrix with a label (<code>1</code> or <code>0</code>)), the
number of entities with a positive label above the threshold
(e.g. there are <code>1</code> entity with a positive label <code>1</code> in the first 10
entities ordered by score) and the number of entities with positive labels among all the
labeled entities (<code>269</code> of <code>1173</code>) respectively. We can translate this
to english: in our case <i>label</i> mean that between the <i>as of
date</i> (<code>2017-01-01</code>) and one month later (until <code>2017-02-01</code>) there
were <code>1173</code> facilities <b>inspected</b> and <code>269</code> <b>failed</b> the inspection.
</p>

<p>
We could check that the numbers make sense, the number of <i>active
facilities</i> at <code>2017-01-01</code> (the prediction date) is
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">select</span> <span style="color: #006FE0;">count</span>(*)
<span style="color: #0000FF;">from</span> inspections.active_facilities
<span style="color: #0000FF;">where</span> <span style="color: #008000;">'2017-01-01'</span>::<span style="color: #6434A3;">date</span> &lt;@ daterange(start_time, end_time)
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">count</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">19396</td>
</tr>
</tbody>
</table>

<p>
And this number matches with the predictions made by the model <code>7</code>, as expected.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">select</span> <span style="color: #006FE0;">count</span>(*) <span style="color: #0000FF;">from</span> results.predictions <span style="color: #0000FF;">where</span> model_id = 7 
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">count</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">19396</td>
</tr>
</tbody>
</table>

<p>
The number of <i>labels</i> (<code>num_labeled_examples</code> = <code>1173</code>) is different,
 because only <code>1173</code> facilities were inspected in that time span. so,
 many of the facilities weren't inspected, then their label is <code>NULL</code>.
</p>


<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">select</span> <span style="color: #006FE0;">count</span>(<span style="color: #0000FF;">distinct</span> entity_id)
<span style="color: #0000FF;">from</span> inspections.failed
<span style="color: #0000FF;">where</span> outcome_date &lt;@ <span style="color: #008000;">'[2017-01-01, 2017-02-01)'</span>::daterange
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">count</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">1316</td>
</tr>
</tbody>
</table>

<p>
Still far from the <code>1173</code>. Do you remember the <i>states</i> table? Using
it to filter we got the correct number:
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">select</span> outcome,<span style="color: #006FE0;">count</span>(<span style="color: #0000FF;">distinct</span> entity_id)
<span style="color: #0000FF;">from</span> inspections.failed
<span style="color: #0000FF;">inner</span> <span style="color: #0000FF;">join</span> (
      <span style="color: #0000FF;">select</span> entity_id
      <span style="color: #0000FF;">from</span> inspections.active_facilities
      <span style="color: #0000FF;">where</span> <span style="color: #008000;">'2017-01-01'</span>::<span style="color: #6434A3;">date</span> &lt;@ daterange(start_time, end_time)
) <span style="color: #0000FF;">as</span> t
<span style="color: #0000FF;">using</span> (entity_id)
<span style="color: #0000FF;">where</span> outcome_date &lt;@ <span style="color: #008000;">'[2017-01-01, 2017-02-01)'</span>::daterange
<span style="color: #0000FF;">group</span> <span style="color: #0000FF;">by</span> <span style="color: #0000FF;">rollup</span>(outcome)
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">outcome</th>
<th scope="col" class="org-right">count</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">f</td>
<td class="org-right">1085</td>
</tr>

<tr>
<td class="org-left">t</td>
<td class="org-right">269</td>
</tr>

<tr>
<td class="org-left">[NULL]</td>
<td class="org-right">1173</td>
</tr>
</tbody>
</table>

<p>
Let's assume that this is our best model, Which is the list of 25 facilities to inspect?
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">select</span> *
<span style="color: #0000FF;">from</span> results.predictions
<span style="color: #0000FF;">where</span> model_id = 7 
<span style="color: #0000FF;">order</span> <span style="color: #0000FF;">by</span> score <span style="color: #0000FF;">desc</span>
<span style="color: #0000FF;">limit</span> 25
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">model_id</th>
<th scope="col" class="org-right">entity_id</th>
<th scope="col" class="org-left">as_of_date</th>
<th scope="col" class="org-right">score</th>
<th scope="col" class="org-left">label_value</th>
<th scope="col" class="org-left">rank_abs</th>
<th scope="col" class="org-left">rank_pct</th>
<th scope="col" class="org-left">matrix_uuid</th>
<th scope="col" class="org-left">test_label_timespan</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">7</td>
<td class="org-right">2</td>
<td class="org-left">2017-01-01 00:00:00</td>
<td class="org-right">0.22907692307692307</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">86bad884c84b4c75ad2a127debc810b5</td>
<td class="org-left">1 mon</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-right">4</td>
<td class="org-left">2017-01-01 00:00:00</td>
<td class="org-right">0.22907692307692307</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">86bad884c84b4c75ad2a127debc810b5</td>
<td class="org-left">1 mon</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-right">5</td>
<td class="org-left">2017-01-01 00:00:00</td>
<td class="org-right">0.22907692307692307</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">86bad884c84b4c75ad2a127debc810b5</td>
<td class="org-left">1 mon</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-right">6</td>
<td class="org-left">2017-01-01 00:00:00</td>
<td class="org-right">0.22907692307692307</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">86bad884c84b4c75ad2a127debc810b5</td>
<td class="org-left">1 mon</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-right">7</td>
<td class="org-left">2017-01-01 00:00:00</td>
<td class="org-right">0.22907692307692307</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">86bad884c84b4c75ad2a127debc810b5</td>
<td class="org-left">1 mon</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-right">8</td>
<td class="org-left">2017-01-01 00:00:00</td>
<td class="org-right">0.22907692307692307</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">86bad884c84b4c75ad2a127debc810b5</td>
<td class="org-left">1 mon</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-right">9</td>
<td class="org-left">2017-01-01 00:00:00</td>
<td class="org-right">0.22907692307692307</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">86bad884c84b4c75ad2a127debc810b5</td>
<td class="org-left">1 mon</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-right">10</td>
<td class="org-left">2017-01-01 00:00:00</td>
<td class="org-right">0.22907692307692307</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">86bad884c84b4c75ad2a127debc810b5</td>
<td class="org-left">1 mon</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-right">11</td>
<td class="org-left">2017-01-01 00:00:00</td>
<td class="org-right">0.22907692307692307</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">86bad884c84b4c75ad2a127debc810b5</td>
<td class="org-left">1 mon</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-right">13</td>
<td class="org-left">2017-01-01 00:00:00</td>
<td class="org-right">0.22907692307692307</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">86bad884c84b4c75ad2a127debc810b5</td>
<td class="org-left">1 mon</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-right">14</td>
<td class="org-left">2017-01-01 00:00:00</td>
<td class="org-right">0.22907692307692307</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">86bad884c84b4c75ad2a127debc810b5</td>
<td class="org-left">1 mon</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-right">15</td>
<td class="org-left">2017-01-01 00:00:00</td>
<td class="org-right">0.22907692307692307</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">86bad884c84b4c75ad2a127debc810b5</td>
<td class="org-left">1 mon</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-right">16</td>
<td class="org-left">2017-01-01 00:00:00</td>
<td class="org-right">0.22907692307692307</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">86bad884c84b4c75ad2a127debc810b5</td>
<td class="org-left">1 mon</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-right">19</td>
<td class="org-left">2017-01-01 00:00:00</td>
<td class="org-right">0.22907692307692307</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">86bad884c84b4c75ad2a127debc810b5</td>
<td class="org-left">1 mon</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-right">20</td>
<td class="org-left">2017-01-01 00:00:00</td>
<td class="org-right">0.22907692307692307</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">86bad884c84b4c75ad2a127debc810b5</td>
<td class="org-left">1 mon</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-right">21</td>
<td class="org-left">2017-01-01 00:00:00</td>
<td class="org-right">0.22907692307692307</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">86bad884c84b4c75ad2a127debc810b5</td>
<td class="org-left">1 mon</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-right">22</td>
<td class="org-left">2017-01-01 00:00:00</td>
<td class="org-right">0.22907692307692307</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">86bad884c84b4c75ad2a127debc810b5</td>
<td class="org-left">1 mon</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-right">23</td>
<td class="org-left">2017-01-01 00:00:00</td>
<td class="org-right">0.22907692307692307</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">86bad884c84b4c75ad2a127debc810b5</td>
<td class="org-left">1 mon</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-right">25</td>
<td class="org-left">2017-01-01 00:00:00</td>
<td class="org-right">0.22907692307692307</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">86bad884c84b4c75ad2a127debc810b5</td>
<td class="org-left">1 mon</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-right">27</td>
<td class="org-left">2017-01-01 00:00:00</td>
<td class="org-right">0.22907692307692307</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">86bad884c84b4c75ad2a127debc810b5</td>
<td class="org-left">1 mon</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-right">28</td>
<td class="org-left">2017-01-01 00:00:00</td>
<td class="org-right">0.22907692307692307</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">86bad884c84b4c75ad2a127debc810b5</td>
<td class="org-left">1 mon</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-right">29</td>
<td class="org-left">2017-01-01 00:00:00</td>
<td class="org-right">0.22907692307692307</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">86bad884c84b4c75ad2a127debc810b5</td>
<td class="org-left">1 mon</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-right">30</td>
<td class="org-left">2017-01-01 00:00:00</td>
<td class="org-right">0.22907692307692307</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">86bad884c84b4c75ad2a127debc810b5</td>
<td class="org-left">1 mon</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-right">31</td>
<td class="org-left">2017-01-01 00:00:00</td>
<td class="org-right">0.22907692307692307</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">86bad884c84b4c75ad2a127debc810b5</td>
<td class="org-left">1 mon</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-right">1</td>
<td class="org-left">2017-01-01 00:00:00</td>
<td class="org-right">0.22907692307692307</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">86bad884c84b4c75ad2a127debc810b5</td>
<td class="org-left">1 mon</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-orge61a76a" class="outline-4">
<h4 id="orge61a76a"><span class="section-number-4">5.3.2</span> Defining a baseline</h4>
<div class="outline-text-4" id="text-5-3-2">
<p>
As a second step, lets do a new experiment that defines our
<i>baseline</i>. In order to achive this, we will use a similar experiment
config file with the following changes:
</p>

<pre class="example">
model_comment: 'inspections_baseline'

user_metadata:
  label_definition: 'failed'
  experiment_type: 'inspections prioritization'
  purpose: 'baseline'
  org: 'DSaPP'
  team: 'Tutorial'
  author: 'Your name here'

grid_config:
    'sklearn.dummy.DummyClassifier':
        strategy: [prior,uniform, most_frequent]

model_group_keys:
    - 'label_definition'
    - 'experiment_type'
    - 'purpose'
</pre>

<p>
The complete file is in <a href="./triage/experiment_config/inspections_baseline.yaml">triage/experiment_config/inspections_baseline.yaml</a>
</p>

<p>
If we execute this experiment, we will get 3 more model groups (one
for each strategy), and the corresponding 6 new models (2 per each
model group).
</p>

<div class="org-src-container">
<pre class="src src-sh">./tutorial.sh triage --config_file inspections_baseline.yaml validate
</pre>
</div>

<p>
Using the config file /triage/experiment_config/inspections_baseline.yaml
The output (matrices and models) of this experiment will be stored in triage/output
The experiment will utilize any preexisting matrix or model: False
Creating experiment object
Experiment loaded
Validating experiment's configuration
Experiment validation ran to completion with no errors
</p>

<p>
-&#x2014;TIME SPLIT SUMMARY-&#x2014;
</p>

<p>
Number of time splits: 2
Split index 0:
            Training as_of_time_range: 2015-02-13 00:00:00 to 2015-11-13 00:00:00 (10 total)
            Testing as_of_time range: 2015-12-13 00:00:00 to 2015-12-13 00:00:00 (1 total)
</p>


<p>
Split index 1:
            Training as_of_time_range: 2015-02-13 00:00:00 to 2016-11-13 00:00:00 (22 total)
            Testing as_of_time range: 2016-12-13 00:00:00 to 2016-12-13 00:00:00 (1 total)
</p>


<p>
For more detailed information on your time splits, inspect the experiment `split_definitions` property
</p>

<p>
The experiment configuration doesn't contain any obvious errors.
Any error that occurs from now on, possibly will be related to hit the maximum 
number of columns allowed or collision in
the column names, both due to PostgreSQL limitations.
</p>

<p>
The experiment looks in good shape. May the force be with you
</p>

<p>
You can execute the experiment as
</p>

<div class="org-src-container">
<pre class="src src-sh">./tutorial.sh triage --config_file inspections_baseline.yaml run
</pre>
</div>

<p>
Using the config file /triage/experiment_config/inspections_baseline.yaml
The output (matrices and models) of this experiment will be stored in triage/output
The experiment will utilize any preexisting matrix or model: False
Creating experiment object
Experiment loaded
Executing experiment
Done
Experiment completed in 0:00:28.682451 seconds
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">select</span> model_group_id, model_type, model_parameters <span style="color: #0000FF;">from</span> results.model_groups;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">model_group_id</th>
<th scope="col" class="org-left">model_type</th>
<th scope="col" class="org-left">model_parameters</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">1</td>
<td class="org-left">sklearn.tree.DecisionTreeClassifier</td>
<td class="org-left">{"max_depth": 1, "max_features": 1}</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-left">sklearn.tree.DecisionTreeClassifier</td>
<td class="org-left">{"max_depth": 1, "max_features": "sqrt"}</td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-left">sklearn.tree.DecisionTreeClassifier</td>
<td class="org-left">{"max_depth": 1, "max_features": null}</td>
</tr>

<tr>
<td class="org-right">4</td>
<td class="org-left">sklearn.tree.DecisionTreeClassifier</td>
<td class="org-left">{"max_depth": null, "max_features": 1}</td>
</tr>

<tr>
<td class="org-right">5</td>
<td class="org-left">sklearn.tree.DecisionTreeClassifier</td>
<td class="org-left">{"max_depth": null, "max_features": "sqrt"}</td>
</tr>

<tr>
<td class="org-right">6</td>
<td class="org-left">sklearn.tree.DecisionTreeClassifier</td>
<td class="org-left">{"max_depth": null, "max_features": null}</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-left">sklearn.dummy.DummyClassifier</td>
<td class="org-left">{"strategy": "prior"}</td>
</tr>

<tr>
<td class="org-right">8</td>
<td class="org-left">sklearn.dummy.DummyClassifier</td>
<td class="org-left">{"strategy": "uniform"}</td>
</tr>

<tr>
<td class="org-right">9</td>
<td class="org-left">sklearn.dummy.DummyClassifier</td>
<td class="org-left">{"strategy": "most_frequent"}</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-sql">
<span style="color: #0000FF;">with</span> baseline <span style="color: #0000FF;">as</span> (
<span style="color: #0000FF;">select</span> model_id, model_group_id
<span style="color: #0000FF;">from</span> results.models
<span style="color: #0000FF;">where</span> model_type ~ <span style="color: #008000;">'DummyClassifier'</span>
)

<span style="color: #0000FF;">select</span> 
model_group_id, model_id, metric || <span style="color: #0000FF;">parameter</span> <span style="color: #0000FF;">as</span> metric, <span style="color: #0000FF;">value</span>
<span style="color: #0000FF;">from</span> results.evaluations
<span style="color: #0000FF;">inner</span> <span style="color: #0000FF;">join</span> baseline <span style="color: #0000FF;">using</span>(model_id)
<span style="color: #0000FF;">where</span>
metric || <span style="color: #0000FF;">parameter</span> = <span style="color: #008000;">'precision@25_abs'</span>
<span style="color: #0000FF;">order</span> <span style="color: #0000FF;">by</span> metric || <span style="color: #0000FF;">parameter</span>, model_id
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">model_group_id</th>
<th scope="col" class="org-right">model_id</th>
<th scope="col" class="org-left">metric</th>
<th scope="col" class="org-right">value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">7</td>
<td class="org-right">13</td>
<td class="org-left">precision@25_abs</td>
<td class="org-right">0.0</td>
</tr>

<tr>
<td class="org-right">8</td>
<td class="org-right">14</td>
<td class="org-left">precision@25_abs</td>
<td class="org-right">0.0</td>
</tr>

<tr>
<td class="org-right">9</td>
<td class="org-right">15</td>
<td class="org-left">precision@25_abs</td>
<td class="org-right">0.0</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-right">16</td>
<td class="org-left">precision@25_abs</td>
<td class="org-right">0.6</td>
</tr>

<tr>
<td class="org-right">8</td>
<td class="org-right">17</td>
<td class="org-left">precision@25_abs</td>
<td class="org-right">0.6</td>
</tr>

<tr>
<td class="org-right">9</td>
<td class="org-right">18</td>
<td class="org-left">precision@25_abs</td>
<td class="org-right">0.6</td>
</tr>
</tbody>
</table>
</div>
</div>


<div id="outline-container-org3b15d9d" class="outline-4">
<h4 id="org3b15d9d"><span class="section-number-4">5.3.3</span> A more advanced experiment</h4>
<div class="outline-text-4" id="text-5-3-3">
<p>
Ok, let's add a more complete experiment. First the usual generalities.
Note that we change <code>experiment_type</code>
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #BA36A5;">config_version</span>: <span style="color: #008000;">'v3'</span>

<span style="color: #BA36A5;">model_comment</span>: <span style="color: #008000;">'inspections'</span>

<span style="color: #BA36A5;">user_metadata</span>:
  <span style="color: #BA36A5;">label_definition</span>: <span style="color: #008000;">'failed'</span>
  <span style="color: #BA36A5;">experiment_type</span>: <span style="color: #008000;">'inspections prioritization'</span>
  <span style="color: #BA36A5;">purpose</span>: <span style="color: #008000;">'development'</span>
  <span style="color: #BA36A5;">org</span>: <span style="color: #008000;">'DSaPP'</span>
  <span style="color: #BA36A5;">team</span>: <span style="color: #008000;">'Tutorial'</span>
  <span style="color: #BA36A5;">author</span>: <span style="color: #008000;">'Your name here'</span>
</pre>
</div>

<p>
As before, we set the <code>triage</code> special tables that specifies <i>outcomes</i> (that is call
<code>events_table</code>) and the one that specifies <i>states</i>. These are the
same, we didn't change anything.
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #BA36A5;">events_table</span>: inspections.failed

<span style="color: #BA36A5;">state_config</span>:
    <span style="color: #BA36A5;">table_name</span>: <span style="color: #008000;">'inspections.active_facilities'</span>
    <span style="color: #BA36A5;">state_filters</span>:
       - <span style="color: #008000;">'active'</span>
</pre>
</div>

<p>
Neither to the temporal configuration:
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #BA36A5;">temporal_config</span>:
    <span style="color: #BA36A5;">feature_start_time</span>: <span style="color: #008000;">'2010-02-01'</span>
    <span style="color: #BA36A5;">feature_end_time</span>: <span style="color: #008000;">'2018-02-01'</span>
    <span style="color: #BA36A5;">label_start_time</span>: <span style="color: #008000;">'2015-02-01'</span>
    <span style="color: #BA36A5;">label_end_time</span>: <span style="color: #008000;">'2018-02-01'</span>

    <span style="color: #BA36A5;">model_update_frequency</span>: <span style="color: #008000;">'1y'</span>
    <span style="color: #BA36A5;">training_label_timespans</span>: [<span style="color: #008000;">'1month'</span>]
    <span style="color: #BA36A5;">training_as_of_date_frequencies</span>: <span style="color: #008000;">'1month'</span>

    <span style="color: #BA36A5;">test_durations</span>: <span style="color: #008000;">'1month'</span>  
    <span style="color: #BA36A5;">test_label_timespans</span>: [<span style="color: #008000;">'1y'</span>] <span style="color: #8D8D84;">#</span>
    <span style="color: #BA36A5;">test_as_of_date_frequencies</span>: <span style="color: #008000;">'1month'</span>

    <span style="color: #BA36A5;">max_training_histories</span>: <span style="color: #008000;">'10y'</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">./tutorial.sh triage --config_file inspections_label_failed_01.yaml show_temporal_blocks
</pre>
</div>

<p>
Using the config file /triage/experiment_config/inspections_label_failed_01.yaml
The output (matrices and models) of this experiment will be stored in triage/output
The experiment will utilize any preexisting matrix or model: False
Creating experiment object
Experiment loaded
Generating temporal blocks image
Image stored in:
/triage/inspections.svg
</p>


<div class="figure">
<p><object type="image/svg+xml" data="./triage/inspections.svg" class="org-svg">
Sorry, your browser does not support SVG.</object>
</p>
</div>

<p>
The first big change is that we are adding 3 more <i>features groups</i>:
<code>inspections</code> (we already use this), <code>risks</code>, and <code>results</code>. Remember
that all of this referes to events in the past, i.e. <i>How many times the facility was marked with high risk in the previous 3 Months?</i>,
<i>Which is the average of failed inspections in the previous year?</i>
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #BA36A5;">feature_aggregations</span>:
    <span style="color: #BA36A5;">-</span>
<span style="color: #BA36A5;">        prefix</span>: <span style="color: #008000;">'inspections'</span>
        <span style="color: #BA36A5;">from_obj</span>: <span style="color: #008000;">'semantic.events'</span>
        <span style="color: #BA36A5;">knowledge_date_column</span>: <span style="color: #008000;">'date'</span>

        <span style="color: #BA36A5;">categoricals_imputation</span>:
            <span style="color: #BA36A5;">all</span>:
                <span style="color: #BA36A5;">type</span>: <span style="color: #008000;">'zero'</span>

        <span style="color: #BA36A5;">categoricals</span>:
            <span style="color: #BA36A5;">-</span>
<span style="color: #BA36A5;">                column</span>: <span style="color: #008000;">'type'</span>
                <span style="color: #BA36A5;">choice_query</span>: <span style="color: #008000;">'select distinct type from semantic.events'</span>
                <span style="color: #BA36A5;">metrics</span>:
                    - <span style="color: #008000;">'sum'</span>
                    - <span style="color: #008000;">'avg'</span>

        <span style="color: #BA36A5;">intervals</span>:
            - <span style="color: #008000;">'2y'</span>
            - <span style="color: #008000;">'1y'</span>
            - <span style="color: #008000;">'6month'</span>
            - <span style="color: #008000;">'3month'</span>

        <span style="color: #BA36A5;">groups</span>:
            - <span style="color: #008000;">'entity_id'</span>
            - <span style="color: #008000;">'zip_code'</span>

    <span style="color: #BA36A5;">-</span>
<span style="color: #BA36A5;">        prefix</span>: <span style="color: #008000;">'risks'</span>
        <span style="color: #BA36A5;">from_obj</span>: <span style="color: #008000;">'semantic.events'</span>
        <span style="color: #BA36A5;">knowledge_date_column</span>: <span style="color: #008000;">'date'</span>

        <span style="color: #BA36A5;">categoricals_imputation</span>:
            <span style="color: #BA36A5;">all</span>:
                <span style="color: #BA36A5;">type</span>: <span style="color: #008000;">'zero'</span>

        <span style="color: #BA36A5;">categoricals</span>:
            <span style="color: #BA36A5;">-</span>
<span style="color: #BA36A5;">                column</span>: <span style="color: #008000;">'risk'</span>
                <span style="color: #BA36A5;">choice_query</span>: <span style="color: #008000;">'select distinct risk from semantic.events'</span>
                <span style="color: #BA36A5;">metrics</span>:
                    - <span style="color: #008000;">'sum'</span>
                    - <span style="color: #008000;">'avg'</span>

        <span style="color: #BA36A5;">intervals</span>:
            - <span style="color: #008000;">'2y'</span>
            - <span style="color: #008000;">'1y'</span>
            - <span style="color: #008000;">'6month'</span>
            - <span style="color: #008000;">'3month'</span>

        <span style="color: #BA36A5;">groups</span>:
            - <span style="color: #008000;">'entity_id'</span>
            - <span style="color: #008000;">'zip_code'</span>
            - <span style="color: #008000;">'facility_type'</span>


    <span style="color: #BA36A5;">-</span>
<span style="color: #BA36A5;">        prefix</span>: <span style="color: #008000;">'results'</span>
        <span style="color: #BA36A5;">from_obj</span>: <span style="color: #008000;">'semantic.events'</span>
        <span style="color: #BA36A5;">knowledge_date_column</span>: <span style="color: #008000;">'date'</span>

        <span style="color: #BA36A5;">categoricals_imputation</span>:
            <span style="color: #BA36A5;">all</span>:
                <span style="color: #BA36A5;">type</span>: <span style="color: #008000;">'zero'</span>

        <span style="color: #BA36A5;">categoricals</span>:
            <span style="color: #BA36A5;">-</span>
<span style="color: #BA36A5;">                column</span>: <span style="color: #008000;">'result'</span>
                <span style="color: #BA36A5;">choice_query</span>: <span style="color: #008000;">'select distinct result from semantic.events'</span>
                <span style="color: #BA36A5;">metrics</span>:
                    - <span style="color: #008000;">'sum'</span>
                    - <span style="color: #008000;">'avg'</span>

        <span style="color: #BA36A5;">intervals</span>:
            - <span style="color: #008000;">'2y'</span>
            - <span style="color: #008000;">'1y'</span>
            - <span style="color: #008000;">'6month'</span>
            - <span style="color: #008000;">'3month'</span>

        <span style="color: #BA36A5;">groups</span>:
            - <span style="color: #008000;">'entity_id'</span>
            - <span style="color: #008000;">'zip_code'</span>
            - <span style="color: #008000;">'facility_type'</span>

</pre>
</div>

<p>
We want to use all the features groups
(<code>feature_group_definition</code>). The training will be made on matrices
with <code>all</code> the feature groups, then letting one feature group out, <code>leave-one-out</code>,
i.e. one model with <code>inspections</code> and <code>results</code>, another with
<code>inspections</code> and <code>risks</code> and another one with <code>results</code> and <code>risks, 
and then just trying models with =inspections</code> or <code>results</code> or <code>risks</code> exclusively.
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #BA36A5;">feature_group_definition</span>:
   <span style="color: #BA36A5;">prefix</span>: [<span style="color: #008000;">'inspections'</span>, <span style="color: #008000;">'results'</span>, <span style="color: #008000;">'risks'</span>]

<span style="color: #BA36A5;">feature_group_strategies</span>: [<span style="color: #008000;">'all'</span>, <span style="color: #008000;">'leave-one-in'</span>, <span style="color: #008000;">'leave-one-out'</span>]
</pre>
</div>

<p>
Finally, we will try a <code>RandomForestClassifier</code>
</p>


<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #BA36A5;">grid_config</span>:
    <span style="color: #008000;">'sklearn.ensemble.RandomForestClassifier'</span>:
        <span style="color: #BA36A5;">max_features</span>: [<span style="color: #008000;">'sqrt'</span>]
        <span style="color: #BA36A5;">criterion</span>: [<span style="color: #008000;">'gini'</span>]
        <span style="color: #BA36A5;">n_estimators</span>: [1000]
        <span style="color: #BA36A5;">min_samples_leaf</span>: [1]
        <span style="color: #BA36A5;">min_samples_split</span>: [50]
        <span style="color: #BA36A5;">class_weight</span>: [<span style="color: #008000;">'balanced'</span>]


<span style="color: #BA36A5;">model_group_keys</span>:
    - <span style="color: #008000;">'label_definition'</span>
    - <span style="color: #008000;">'experiment_type'</span>
    - <span style="color: #008000;">'purpose'</span>

<span style="color: #BA36A5;">scoring</span>:
    <span style="color: #BA36A5;">sort_seed</span>: 1234
    <span style="color: #BA36A5;">metric_groups</span>:
        <span style="color: #BA36A5;">-</span>
<span style="color: #BA36A5;">            metrics</span>: [<span style="color: #008000;">'precision@'</span>, <span style="color: #008000;">'recall@'</span>]
            <span style="color: #BA36A5;">thresholds</span>:
                <span style="color: #BA36A5;">percentiles</span>: [1.0, 2.0, 5.0, 10.0, 25.0, 50.0, 75.0, 95.0, 100.0]
                <span style="color: #BA36A5;">top_n</span>: [5, 10, 25, 50, 75, 100, 150, 200, 300, 500, 1000, 2000]

</pre>
</div>


<div class="org-src-container">
<pre class="src src-sh">./tutorial.sh triage --config_file inspections_label_failed_01.yaml validate
</pre>
</div>

<p>
Using the config file /triage/experiment_config/inspections_label_failed_01.yaml
The output (matrices and models) of this experiment will be stored in triage/output
The experiment will utilize any preexisting matrix or model: False
Creating experiment object
Experiment loaded
Validating experiment's configuration
Experiment validation ran to completion with no errors
</p>

<p>
-&#x2014;TIME SPLIT SUMMARY-&#x2014;
</p>

<p>
Number of time splits: 2
Split index 0:
            Training as_of_time_range: 2015-02-01 00:00:00 to 2015-12-01 00:00:00 (11 total)
            Testing as_of_time range: 2016-01-01 00:00:00 to 2016-01-01 00:00:00 (1 total)
</p>


<p>
Split index 1:
            Training as_of_time_range: 2015-02-01 00:00:00 to 2016-12-01 00:00:00 (23 total)
            Testing as_of_time range: 2017-01-01 00:00:00 to 2017-01-01 00:00:00 (1 total)
</p>


<p>
For more detailed information on your time splits, inspect the experiment `split_definitions` property
</p>

<p>
The experiment configuration doesn't contain any obvious errors.
Any error that occurs from now on, possibly will be related to hit the maximum 
number of columns allowed or collision in
the column names, both due to PostgreSQL limitations.
</p>

<p>
The experiment looks in good shape. May the force be with you
</p>

<p>
You can execute the experiment with
</p>

<div class="org-src-container">
<pre class="src src-sh">./tutorial.sh triage --config_file inspections_label_failed_01.yaml run
</pre>
</div>


<p>
Well, know we have a lot of models, How can you pick the best one for
you? We will show you that when we model the <i>Early Intervention System</i>.
</p>
</div>
</div>
</div>


<div id="outline-container-org2bdae37" class="outline-3">
<h3 id="org2bdae37"><span class="section-number-3">5.4</span> What's next?</h3>
<div class="outline-text-3" id="text-5-4">
<p>
Do you want to know why the <a href="eis.html">Early Intervention System</a> is different
from the inspections problem? If so, continue reading.
</p>
</div>
</div>
</div>

<div id="outline-container-org36f5e3f" class="outline-2">
<h2 id="org36f5e3f"><span class="section-number-2">6</span> An Early Intervention System</h2>
<div class="outline-text-2" id="text-6">
</div>
<div id="outline-container-org406bdec" class="outline-3">
<h3 id="org406bdec"><span class="section-number-3">6.1</span> Problem description</h3>
<div class="outline-text-3" id="text-6-1">
<p>
Our final stop is using <code>triage</code> to build a <i>Early Intervention (or Warning) System</i>. There are
 several differences between the the <b>EIS</b> and the <b>inspection
 prioritization</b> problem. The difference that has more impact is that
 the <i>entity</i> in <b>EIS</b> is  <i>active</i> 
 i.e. it is doing stuff, and for that stuff the the entity is doing
 some outcome will happen. In the <b>inspection prioritization</b> the
 <i>entity</i> is acted on. This will change, from starters the way that
 the <i>outcome</i> is build.
</p>

<p>
The question that we want to resolve is the following:
</p>

<blockquote>
<p>
Will my restaurant be inspected in the
<i>next X period of time?</i>
</p>
</blockquote>

<p>
Where \(X\) could be 1 month, 1 week, 1 year,
etc.
</p>

<p>
Knowing the answer to this question, allows you (as the restaurant's
owner) to be prepared and take the pertinent actions.
</p>
</div>
</div>


<div id="outline-container-org021d44e" class="outline-3">
<h3 id="org021d44e"><span class="section-number-3">6.2</span> Creating the labels</h3>
<div class="outline-text-3" id="text-6-2">
<p>
The trick to note is that every day there are two possible outcomes:
<i>the facility was inspected</i> and <i>the facility wasn't inspected</i>. So,
our <i>outcomes</i> table will be more larger, since we need for every date
in our dataset for every <i>active</i> facility an <i>outcome</i>: Does the
facility Inspected?
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">create</span> <span style="color: #0000FF;">schema</span> if <span style="color: #0000FF;">not</span> <span style="color: #0000FF;">exists</span> eis;
</pre>
</div>

<p>
For achiving that, we need to create a table (naïvely) of <i>number of
days</i> &times; <i>number of entities</i>. Lets see how many rows do we generate.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">select</span> <span style="color: #006FE0;">min</span>(<span style="color: #6434A3;">date</span>), <span style="color: #006FE0;">max</span>(<span style="color: #6434A3;">date</span>) <span style="color: #0000FF;">from</span> semantic.events
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">min</th>
<th scope="col" class="org-right">max</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">2010-01-04</td>
<td class="org-right">2018-02-13</td>
</tr>
</tbody>
</table>


<div class="org-src-container">
<pre class="src src-sql" id="orga0c0ef7"><span style="color: #0000FF;">select</span> <span style="color: #006FE0;">count</span>(days) 
<span style="color: #0000FF;">from</span> generate_series((<span style="color: #0000FF;">select</span> <span style="color: #006FE0;">min</span>(<span style="color: #6434A3;">date</span>) <span style="color: #0000FF;">from</span> semantic.events), <span style="color: #006FE0;">current_date</span>, <span style="color: #008000;">'1 day'</span>::<span style="color: #6434A3;">interval</span>) days;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">count</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">2972</td>
</tr>
</tbody>
</table>


<div class="org-src-container">
<pre class="src src-sql" id="org7b4aa73"><span style="color: #0000FF;">select</span> <span style="color: #006FE0;">count</span>(*) <span style="color: #0000FF;">from</span> semantic.entities;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">count</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">34812</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-ipython">34812*2968
</pre>
</div>

<p>

</p>

<p>
103322016
</p>

<p>
The result is <code class="src src-python"><span style="color: #0000FF;">print</span>(<span style="color: #006FE0;">int</span>(entities[0])*<span style="color: #006FE0;">int</span>(days[0]))</code>
<code>103322016</code> That's a lot of rows! 
</p>

<p>
We could improve that taking only the <i>active</i>
Entities
</p>
<div class="org-src-container">
<pre class="src src-sql" id="org422bf55"><span style="color: #0000FF;">with</span> dates <span style="color: #0000FF;">as</span> (
    <span style="color: #0000FF;">select</span> days::<span style="color: #6434A3;">date</span>
    <span style="color: #0000FF;">from</span> 
    generate_series(
       (<span style="color: #0000FF;">select</span> <span style="color: #006FE0;">min</span>(<span style="color: #6434A3;">date</span>) <span style="color: #0000FF;">from</span> semantic.events),
       <span style="color: #006FE0;">current_date</span>, <span style="color: #008000;">'1 day'</span>::<span style="color: #6434A3;">interval</span>) days
)

<span style="color: #0000FF;">select</span> <span style="color: #006FE0;">count</span>(*)
<span style="color: #0000FF;">from</span> semantic.entities
<span style="color: #0000FF;">join</span> dates d
<span style="color: #0000FF;">on</span> d.days &lt;@ daterange(start_time, end_time)
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">count</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">46772382</td>
</tr>
</tbody>
</table>


<p>
That's almost a reduction of <code class="src src-python"><span style="color: #0000FF;">print</span>(100*<span style="color: #006FE0;">float</span>(active_entities[0])/(<span style="color: #006FE0;">int</span>(entities[0])*<span style="color: #006FE0;">int</span>(days[0])))</code>
=45.2685534126628=%, but still a huge number of rows
given our infrastructure.
</p>

<p>
So we will cheat, and we will only consider <i>outcomes</i> from <code>2015</code>
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">with</span> dates <span style="color: #0000FF;">as</span> (
    <span style="color: #0000FF;">select</span> days::<span style="color: #6434A3;">date</span>
    <span style="color: #0000FF;">from</span> 
    generate_series(
       <span style="color: #008000;">'2015-01-01'</span>::<span style="color: #6434A3;">date</span>,
       <span style="color: #006FE0;">current_date</span>, <span style="color: #008000;">'1 day'</span>::<span style="color: #6434A3;">interval</span>) days
)

<span style="color: #0000FF;">select</span> <span style="color: #006FE0;">count</span>(*)
<span style="color: #0000FF;">from</span> semantic.entities
<span style="color: #0000FF;">join</span> dates d
<span style="color: #0000FF;">on</span> d.days &lt;@ daterange(start_time, end_time)
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">count</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">21952711</td>
</tr>
</tbody>
</table>


<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">drop</span> <span style="color: #0000FF;">table</span> <span style="color: #006699;">if</span> <span style="color: #0000FF;">exists</span> eis.inspected;

<span style="color: #0000FF;">create</span> <span style="color: #0000FF;">table</span> <span style="color: #006699;">eis.inspected</span> <span style="color: #0000FF;">as</span> (
 <span style="color: #0000FF;">with</span> dates <span style="color: #0000FF;">as</span> (
    <span style="color: #0000FF;">select</span> days::<span style="color: #6434A3;">date</span> <span style="color: #0000FF;">as</span> outcome_date
    <span style="color: #0000FF;">from</span>
    generate_series(
       <span style="color: #008000;">'2015-01-01'</span>::<span style="color: #6434A3;">date</span>,
       <span style="color: #006FE0;">current_date</span>, <span style="color: #008000;">'1 day'</span>::<span style="color: #6434A3;">interval</span>) days
),
active_entities <span style="color: #0000FF;">as</span> (
   <span style="color: #0000FF;">select</span> entity_id, outcome_date
   <span style="color: #0000FF;">from</span> dates d
   <span style="color: #0000FF;">left</span>  <span style="color: #0000FF;">join</span> semantic.entities
   <span style="color: #0000FF;">on</span> outcome_date &lt;@ daterange(start_time, end_time)
)

<span style="color: #0000FF;">select</span>
a.entity_id, outcome_date,
<span style="color: #0000FF;">case</span> <span style="color: #0000FF;">when</span>
inspection <span style="color: #0000FF;">is</span> <span style="color: #0000FF;">null</span> <span style="color: #0000FF;">then</span> <span style="color: #0000FF;">FALSE</span>
<span style="color: #0000FF;">else</span> <span style="color: #0000FF;">TRUE</span>
<span style="color: #0000FF;">end</span> <span style="color: #0000FF;">as</span> outcome
<span style="color: #0000FF;">from</span> active_entities <span style="color: #0000FF;">as</span> a
<span style="color: #0000FF;">left</span> <span style="color: #0000FF;">join</span> semantic.events <span style="color: #0000FF;">as</span> e 
<span style="color: #0000FF;">on</span> a.entity_id = e.entity_id <span style="color: #0000FF;">and</span> a.outcome_date = e.<span style="color: #6434A3;">date</span>
);

<span style="color: #0000FF;">create</span> index inspected_entity_ix <span style="color: #0000FF;">on</span> eis.inspected (entity_id);
<span style="color: #0000FF;">create</span> index inspected_outcome_date_ix <span style="color: #0000FF;">on</span> eis.inspected(outcome_date <span style="color: #0000FF;">desc</span> nulls <span style="color: #0000FF;">last</span>);
<span style="color: #0000FF;">create</span> index inspected_outcome_ix <span style="color: #0000FF;">on</span> eis.inspected(outcome);

<span style="color: #0000FF;">create</span> index inspected_entity_date_ix <span style="color: #0000FF;">on</span> eis.inspected(entity_id, outcome_date);
<span style="color: #0000FF;">create</span> index inspected_date_entity_ix <span style="color: #0000FF;">on</span> eis.inspected(outcome_date, entity_id);

</pre>
</div>

<p>
The <i>states</i> table is the same that in the inspection's case.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">drop</span> <span style="color: #0000FF;">table</span> <span style="color: #006699;">if</span> <span style="color: #0000FF;">exists</span> eis.active_facilities;

<span style="color: #0000FF;">create</span> <span style="color: #0000FF;">table</span> <span style="color: #006699;">eis.active_facilities</span> <span style="color: #0000FF;">as</span> (
<span style="color: #0000FF;">select</span>
<span style="color: #0000FF;">distinct</span>
entity_id, 
<span style="color: #008000;">'active'</span>::<span style="color: #6434A3;">VARCHAR</span>  <span style="color: #0000FF;">as</span> <span style="color: #0000FF;">state</span>, 
start_time, 
<span style="color: #006FE0;">coalesce</span>(end_time, <span style="color: #006FE0;">current_date</span>) <span style="color: #0000FF;">as</span> end_time
<span style="color: #0000FF;">from</span> semantic.entities
);
</pre>
</div>
</div>
</div>


<div id="outline-container-org09db14b" class="outline-3">
<h3 id="org09db14b"><span class="section-number-3">6.3</span> Modeling using Machine Learning</h3>
<div class="outline-text-3" id="text-6-3">
</div>
<div id="outline-container-org7ce97fc" class="outline-4">
<h4 id="org7ce97fc"><span class="section-number-4">6.3.1</span> Creating a simple Experiment</h4>
<div class="outline-text-4" id="text-6-3-1">
<p>
First the usual stuff. Note that we are changing <code>model_comment</code> and
<code>label_definition</code> (remember that this is used for generating the
<i>hash</i> that differentiates models and model groups)
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #BA36A5;">config_version</span>: <span style="color: #008000;">'v3'</span>

<span style="color: #BA36A5;">model_comment</span>: <span style="color: #008000;">'eis'</span>

<span style="color: #BA36A5;">user_metadata</span>:
  <span style="color: #BA36A5;">label_definition</span>: <span style="color: #008000;">'inspected'</span>
  <span style="color: #BA36A5;">experiment_type</span>: <span style="color: #008000;">'eis'</span>
  <span style="color: #BA36A5;">purpose</span>: <span style="color: #008000;">'exploring'</span>
  <span style="color: #BA36A5;">org</span>: <span style="color: #008000;">'DSaPP'</span>
  <span style="color: #BA36A5;">team</span>: <span style="color: #008000;">'Tutorial'</span>
  <span style="color: #BA36A5;">author</span>: <span style="color: #008000;">'Your name here'</span>
</pre>
</div>

<p>
We will use the <code>eis</code> tables for <i>outcomes</i> and <i>states</i> (obviously)
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #BA36A5;">events_table</span>: eis.inspected
</pre>
</div>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #BA36A5;">state_config</span>:
    <span style="color: #BA36A5;">table_name</span>: <span style="color: #008000;">'eis.active_facilities'</span>
    <span style="color: #BA36A5;">state_filters</span>:
       - <span style="color: #008000;">'active'</span>
</pre>
</div>
</div>

<div id="outline-container-orgf1477c4" class="outline-5">
<h5 id="orgf1477c4"><span class="section-number-5">6.3.1.1</span> Temporal configuration</h5>
<div class="outline-text-5" id="text-6-3-1-1">
<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #BA36A5;">temporal_config</span>:
    <span style="color: #BA36A5;">feature_start_time</span>: <span style="color: #008000;">'2010-01-04'</span>
    <span style="color: #BA36A5;">feature_end_time</span>: <span style="color: #008000;">'2017-02-13'</span>
    <span style="color: #BA36A5;">label_start_time</span>: <span style="color: #008000;">'2015-02-01'</span>
    <span style="color: #BA36A5;">label_end_time</span>: <span style="color: #008000;">'2017-02-13'</span>

    <span style="color: #BA36A5;">model_update_frequency</span>: <span style="color: #008000;">'1y'</span>
    <span style="color: #BA36A5;">training_label_timespans</span>: [<span style="color: #008000;">'1month'</span>]
    <span style="color: #BA36A5;">training_as_of_date_frequencies</span>: <span style="color: #008000;">'1month'</span>

    <span style="color: #BA36A5;">test_durations</span>: <span style="color: #008000;">'1month'</span>
    <span style="color: #BA36A5;">test_label_timespans</span>: [<span style="color: #008000;">'1month'</span>]
    <span style="color: #BA36A5;">test_as_of_date_frequencies</span>: <span style="color: #008000;">'1month'</span>

    <span style="color: #BA36A5;">max_training_histories</span>: <span style="color: #008000;">'5y'</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">./tutorial.sh triage --config_file eis_01.yaml show_temporal_blocks
</pre>
</div>

<p>
Using the config file /triage/experiment_config/eis_01.yaml
The output (matrices and models) of this experiment will be stored in triage/output
The experiment will utilize any preexisting matrix or model: False
Creating experiment object
Experiment loaded
Generating temporal blocks image
Image stored in:
/triage/eis.svg
</p>


<div class="figure">
<p><object type="image/svg+xml" data="./triage/eis.svg" class="org-svg">
Sorry, your browser does not support SVG.</object>
</p>
</div>
</div>
</div>

<div id="outline-container-org94da4e7" class="outline-5">
<h5 id="org94da4e7"><span class="section-number-5">6.3.1.2</span> Features</h5>
<div class="outline-text-5" id="text-6-3-1-2">
<p>
Regarding the features, we will use the same ones that were used in <a href="inspections.html">inspections prioritization</a>
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #BA36A5;">feature_aggregations</span>:
    <span style="color: #BA36A5;">-</span>
<span style="color: #BA36A5;">        prefix</span>: <span style="color: #008000;">'inspections'</span>
        <span style="color: #BA36A5;">from_obj</span>: <span style="color: #008000;">'semantic.events'</span>
        <span style="color: #BA36A5;">knowledge_date_column</span>: <span style="color: #008000;">'date'</span>

        <span style="color: #BA36A5;">categoricals_imputation</span>:
            <span style="color: #BA36A5;">all</span>:
                <span style="color: #BA36A5;">type</span>: <span style="color: #008000;">'zero'</span>

        <span style="color: #BA36A5;">categoricals</span>:
            -   <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">inspection type</span>
                <span style="color: #BA36A5;">column</span>: <span style="color: #008000;">'type'</span>
                <span style="color: #BA36A5;">choice_query</span>: <span style="color: #008000;">'select distinct type from semantic.events'</span>
                <span style="color: #BA36A5;">metrics</span>:
                    - <span style="color: #008000;">'sum'</span>
                    - <span style="color: #008000;">'avg'</span>

        <span style="color: #BA36A5;">intervals</span>:
            - <span style="color: #008000;">'2y'</span>
            - <span style="color: #008000;">'1y'</span>
            - <span style="color: #008000;">'6month'</span>
            - <span style="color: #008000;">'3month'</span>

        <span style="color: #BA36A5;">groups</span>:
            - <span style="color: #008000;">'entity_id'</span>
            - <span style="color: #008000;">'zip_code'</span>

    <span style="color: #BA36A5;">-</span>
<span style="color: #BA36A5;">        prefix</span>: <span style="color: #008000;">'risks'</span>
        <span style="color: #BA36A5;">from_obj</span>: <span style="color: #008000;">'semantic.events'</span>
        <span style="color: #BA36A5;">knowledge_date_column</span>: <span style="color: #008000;">'date'</span>

        <span style="color: #BA36A5;">categoricals_imputation</span>:
            <span style="color: #BA36A5;">all</span>:
                <span style="color: #BA36A5;">type</span>: <span style="color: #008000;">'zero'</span>

        <span style="color: #BA36A5;">categoricals</span>:
            -   <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Facility's Risk</span>
                <span style="color: #BA36A5;">column</span>: <span style="color: #008000;">'risk'</span>
                <span style="color: #BA36A5;">choice_query</span>: <span style="color: #008000;">'select distinct risk from semantic.events'</span>
                <span style="color: #BA36A5;">metrics</span>:
                    - <span style="color: #008000;">'sum'</span>
                    - <span style="color: #008000;">'avg'</span>

        <span style="color: #BA36A5;">intervals</span>:
            - <span style="color: #008000;">'2y'</span>
            - <span style="color: #008000;">'1y'</span>
            - <span style="color: #008000;">'6month'</span>
            - <span style="color: #008000;">'3month'</span>

        <span style="color: #BA36A5;">groups</span>:
            - <span style="color: #008000;">'entity_id'</span>
            - <span style="color: #008000;">'zip_code'</span>
            - <span style="color: #008000;">'facility_type'</span>


    -  
        <span style="color: #BA36A5;">prefix</span>: <span style="color: #008000;">'results'</span>
        <span style="color: #BA36A5;">from_obj</span>: <span style="color: #008000;">'semantic.events'</span>
        <span style="color: #BA36A5;">knowledge_date_column</span>: <span style="color: #008000;">'date'</span>

        <span style="color: #BA36A5;">categoricals_imputation</span>:
            <span style="color: #BA36A5;">all</span>:
                <span style="color: #BA36A5;">type</span>: <span style="color: #008000;">'zero'</span>

        <span style="color: #BA36A5;">categoricals</span>:
            -   <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Result of previous inspections</span>
                <span style="color: #BA36A5;">column</span>: <span style="color: #008000;">'result'</span>
                <span style="color: #BA36A5;">choice_query</span>: <span style="color: #008000;">'select distinct result from semantic.events'</span>
                <span style="color: #BA36A5;">metrics</span>:
                    - <span style="color: #008000;">'sum'</span>
                    - <span style="color: #008000;">'avg'</span>

        <span style="color: #BA36A5;">intervals</span>:
            - <span style="color: #008000;">'2y'</span>
            - <span style="color: #008000;">'1y'</span>
            - <span style="color: #008000;">'6month'</span>
            - <span style="color: #008000;">'3month'</span>

        <span style="color: #BA36A5;">groups</span>:
            - <span style="color: #008000;">'entity_id'</span>
            - <span style="color: #008000;">'zip_code'</span>
            - <span style="color: #008000;">'facility_type'</span>

</pre>
</div>

<p>
As before, we declare that we want to use all possible combinations for training:
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #BA36A5;">feature_group_definition</span>:
   <span style="color: #BA36A5;">prefix</span>: [<span style="color: #008000;">'inspections'</span>, <span style="color: #008000;">'results'</span>, <span style="color: #008000;">'risks'</span>]

<span style="color: #BA36A5;">feature_group_strategies</span>: [<span style="color: #008000;">'all'</span>, <span style="color: #008000;">'leave-one-in'</span>, <span style="color: #008000;">'leave-one-out'</span>]
</pre>
</div>
</div>
</div>



<div id="outline-container-orge3da7ec" class="outline-5">
<h5 id="orge3da7ec"><span class="section-number-5">6.3.1.3</span> Algorithm and hyperparameters</h5>
<div class="outline-text-5" id="text-6-3-1-3">
<p>
We will collapse the baseline (<code>DummyClassifier</code>)  and the exploratory configuration together:
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #BA36A5;">grid_config</span>:
    <span style="color: #008000;">'sklearn.tree.DecisionTreeClassifier'</span>:
        <span style="color: #BA36A5;">max_depth</span>: [1,null]
    <span style="color: #008000;">'sklearn.ensemble.RandomForestClassifier'</span>:
        <span style="color: #BA36A5;">max_features</span>: [<span style="color: #008000;">'sqrt'</span>]
        <span style="color: #BA36A5;">criterion</span>: [<span style="color: #008000;">'gini'</span>]
        <span style="color: #BA36A5;">n_estimators</span>: [1000]
        <span style="color: #BA36A5;">min_samples_leaf</span>: [1]
        <span style="color: #BA36A5;">min_samples_split</span>: [50]
        <span style="color: #BA36A5;">class_weight</span>: [<span style="color: #008000;">'balanced'</span>]
    <span style="color: #008000;">'sklearn.dummy.DummyClassifier'</span>:
        <span style="color: #BA36A5;">strategy</span>: [prior,uniform, most_frequent]
</pre>
</div>

<p>
The number of <i>model groups</i> to be generated are 6 algorithms and
hyperparameters (2 <code>DecisionTreeClassifier</code>, 1
<code>RandomForestClassifier</code>, 3 <code>DummyClassifier</code>) &times; 7 features groups ( 1
<code>all</code>, 3 <code>leave-one-in</code>, 3 <code>leave-one-out</code>), which give a total of
<b>42</b>.The total number of <i>models</i> is the double of that (we have 2
time blocks) i.e. <b>84</b>.
</p>

<p>
We don't want to mix different experiments together, it is very important that the <code>model_group_keys</code> distinguish between models, so use it wisely:
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #BA36A5;">model_group_keys</span>:
    - <span style="color: #008000;">'label_definition'</span>
    - <span style="color: #008000;">'experiment_type'</span>
    - <span style="color: #008000;">'purpose'</span>

<span style="color: #BA36A5;">scoring</span>:
    <span style="color: #BA36A5;">sort_seed</span>: 1234
    <span style="color: #BA36A5;">metric_groups</span>:
        <span style="color: #BA36A5;">-</span>
<span style="color: #BA36A5;">            metrics</span>: [<span style="color: #008000;">'precision@'</span>, <span style="color: #008000;">'recall@'</span>]
            <span style="color: #BA36A5;">thresholds</span>:
                <span style="color: #BA36A5;">percentiles</span>: [1.0, 2.0, 5.0, 10.0, 25.0, 50.0, 75.0, 95.0, 100.0]
                <span style="color: #BA36A5;">top_n</span>: [5, 10, 25, 50, 75, 100, 150, 200, 300, 500, 1000, 2000]
</pre>
</div>

<p>
As a last step, we validate that the configuration file is correct:
</p>

<div class="org-src-container">
<pre class="src src-sh">./tutorial.sh triage --config_file eis_01.yaml validate
</pre>
</div>

<p>
Using the config file /triage/experiment_config/eis_01.yaml
The output (matrices and models) of this experiment will be stored in triage/output
The experiment will utilize any preexisting matrix or model: False
Creating experiment object
Experiment loaded
Validating experiment's configuration
Experiment validation ran to completion with no errors
</p>

<p>
-&#x2014;TIME SPLIT SUMMARY-&#x2014;
</p>

<p>
Number of time splits: 2
Split index 0:
            Training as_of_time_range: 2015-02-13 00:00:00 to 2015-11-13 00:00:00 (10 total)
            Testing as_of_time range: 2015-12-13 00:00:00 to 2015-12-13 00:00:00 (1 total)
</p>


<p>
Split index 1:
            Training as_of_time_range: 2015-02-13 00:00:00 to 2016-11-13 00:00:00 (22 total)
            Testing as_of_time range: 2016-12-13 00:00:00 to 2016-12-13 00:00:00 (1 total)
</p>


<p>
For more detailed information on your time splits, inspect the experiment `split_definitions` property
</p>

<p>
The experiment configuration doesn't contain any obvious errors.
Any error that occurs from now on, possibly will be related to hit the maximum 
number of columns allowed or collision in
the column names, both due to PostgreSQL limitations.
</p>

<p>
The experiment looks in good shape. May the force be with you
</p>

<pre class="example">
./tutorial.sh triage --config_file eis_01.yaml --no-replace --debug run
</pre>

<p>
This will take a <b>lot</b> amount of time (on my computer took 3h 42m),
so, grab your coffee, chat with 
your coworkers or check your email (or all the above). Is taking that
amount of time for several reasons:
</p>

<ol class="org-ol">
<li>There are a lot of models, parameters, etc</li>
<li>We are running in serial mode (i.e. not in parallel)</li>
<li>Our database, is running in your laptop</li>
</ol>

<p>
You can solve 2 and 3. For the second point you could use the <code>docker</code>
container that has the multicore option enabled. For 3, I recommed you
to use a PostgreSQL database in the cloud, for example in <b>AWS</b> the
service is call <b>PostgreSQL RDS</b>.
</p>

<p>
After the experiment had finished we could create the following table
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">with</span> features_groups <span style="color: #0000FF;">as</span> (
<span style="color: #0000FF;">select</span> model_group_id, split_part(<span style="color: #0000FF;">unnest</span>(feature_list), <span style="color: #008000;">'_'</span>, 1) <span style="color: #0000FF;">as</span> feature_groups
<span style="color: #0000FF;">from</span> results.model_groups
), 

features_arrays <span style="color: #0000FF;">as</span> (
<span style="color: #0000FF;">select</span> model_group_id, array_agg(<span style="color: #0000FF;">distinct</span> feature_groups) <span style="color: #0000FF;">as</span> feature_groups
<span style="color: #0000FF;">from</span> features_groups
<span style="color: #0000FF;">group</span> <span style="color: #0000FF;">by</span> model_group_id
)

<span style="color: #0000FF;">select</span>
model_group_id,
model_type,
model_parameters,
feature_groups,
array_agg(model_id) <span style="color: #0000FF;">as</span> models
<span style="color: #0000FF;">from</span> results.models
<span style="color: #0000FF;">join</span> features_arrays <span style="color: #0000FF;">using</span>(model_group_id)
<span style="color: #0000FF;">where</span> model_comment = <span style="color: #008000;">'eis'</span>
<span style="color: #0000FF;">group</span> <span style="color: #0000FF;">by</span> model_group_id, model_type, model_parameters, feature_groups <span style="color: #0000FF;">order</span> <span style="color: #0000FF;">by</span> model_group_id 
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">model_group_id</th>
<th scope="col" class="org-left">model_type</th>
<th scope="col" class="org-left">model_parameters</th>
<th scope="col" class="org-left">feature_groups</th>
<th scope="col" class="org-left">models</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">10</td>
<td class="org-left">sklearn.tree.DecisionTreeClassifier</td>
<td class="org-left">{"max_depth": 1}</td>
<td class="org-left">{inspections,results,risks}</td>
<td class="org-left">{61,19}</td>
</tr>

<tr>
<td class="org-right">11</td>
<td class="org-left">sklearn.tree.DecisionTreeClassifier</td>
<td class="org-left">{"max_depth": null}</td>
<td class="org-left">{inspections,results,risks}</td>
<td class="org-left">{62,20}</td>
</tr>

<tr>
<td class="org-right">12</td>
<td class="org-left">sklearn.ensemble.RandomForestClassifier</td>
<td class="org-left">{"criterion": "gini", "class_weight": "balanced", "max_features": "sqrt", "n_estimators": 1000, "min_samples_leaf": 1, "min_samples_split": 50}</td>
<td class="org-left">{inspections,results,risks}</td>
<td class="org-left">{63,21}</td>
</tr>

<tr>
<td class="org-right">13</td>
<td class="org-left">sklearn.dummy.DummyClassifier</td>
<td class="org-left">{"strategy": "prior"}</td>
<td class="org-left">{inspections,results,risks}</td>
<td class="org-left">{64,22}</td>
</tr>

<tr>
<td class="org-right">14</td>
<td class="org-left">sklearn.dummy.DummyClassifier</td>
<td class="org-left">{"strategy": "uniform"}</td>
<td class="org-left">{inspections,results,risks}</td>
<td class="org-left">{65,23}</td>
</tr>

<tr>
<td class="org-right">15</td>
<td class="org-left">sklearn.dummy.DummyClassifier</td>
<td class="org-left">{"strategy": "most_frequent"}</td>
<td class="org-left">{inspections,results,risks}</td>
<td class="org-left">{66,24}</td>
</tr>

<tr>
<td class="org-right">16</td>
<td class="org-left">sklearn.tree.DecisionTreeClassifier</td>
<td class="org-left">{"max_depth": 1}</td>
<td class="org-left">{inspections}</td>
<td class="org-left">{67,25}</td>
</tr>

<tr>
<td class="org-right">17</td>
<td class="org-left">sklearn.tree.DecisionTreeClassifier</td>
<td class="org-left">{"max_depth": null}</td>
<td class="org-left">{inspections}</td>
<td class="org-left">{68,26}</td>
</tr>

<tr>
<td class="org-right">18</td>
<td class="org-left">sklearn.ensemble.RandomForestClassifier</td>
<td class="org-left">{"criterion": "gini", "class_weight": "balanced", "max_features": "sqrt", "n_estimators": 1000, "min_samples_leaf": 1, "min_samples_split": 50}</td>
<td class="org-left">{inspections}</td>
<td class="org-left">{69,27}</td>
</tr>

<tr>
<td class="org-right">19</td>
<td class="org-left">sklearn.dummy.DummyClassifier</td>
<td class="org-left">{"strategy": "prior"}</td>
<td class="org-left">{inspections}</td>
<td class="org-left">{70,28}</td>
</tr>

<tr>
<td class="org-right">20</td>
<td class="org-left">sklearn.dummy.DummyClassifier</td>
<td class="org-left">{"strategy": "uniform"}</td>
<td class="org-left">{inspections}</td>
<td class="org-left">{71,29}</td>
</tr>

<tr>
<td class="org-right">21</td>
<td class="org-left">sklearn.dummy.DummyClassifier</td>
<td class="org-left">{"strategy": "most_frequent"}</td>
<td class="org-left">{inspections}</td>
<td class="org-left">{72,30}</td>
</tr>

<tr>
<td class="org-right">22</td>
<td class="org-left">sklearn.tree.DecisionTreeClassifier</td>
<td class="org-left">{"max_depth": 1}</td>
<td class="org-left">{results}</td>
<td class="org-left">{73,31}</td>
</tr>

<tr>
<td class="org-right">23</td>
<td class="org-left">sklearn.tree.DecisionTreeClassifier</td>
<td class="org-left">{"max_depth": null}</td>
<td class="org-left">{results}</td>
<td class="org-left">{74,32}</td>
</tr>

<tr>
<td class="org-right">24</td>
<td class="org-left">sklearn.ensemble.RandomForestClassifier</td>
<td class="org-left">{"criterion": "gini", "class_weight": "balanced", "max_features": "sqrt", "n_estimators": 1000, "min_samples_leaf": 1, "min_samples_split": 50}</td>
<td class="org-left">{results}</td>
<td class="org-left">{75,33}</td>
</tr>

<tr>
<td class="org-right">25</td>
<td class="org-left">sklearn.dummy.DummyClassifier</td>
<td class="org-left">{"strategy": "prior"}</td>
<td class="org-left">{results}</td>
<td class="org-left">{76,34}</td>
</tr>

<tr>
<td class="org-right">26</td>
<td class="org-left">sklearn.dummy.DummyClassifier</td>
<td class="org-left">{"strategy": "uniform"}</td>
<td class="org-left">{results}</td>
<td class="org-left">{77,35}</td>
</tr>

<tr>
<td class="org-right">27</td>
<td class="org-left">sklearn.dummy.DummyClassifier</td>
<td class="org-left">{"strategy": "most_frequent"}</td>
<td class="org-left">{results}</td>
<td class="org-left">{78,36}</td>
</tr>

<tr>
<td class="org-right">28</td>
<td class="org-left">sklearn.tree.DecisionTreeClassifier</td>
<td class="org-left">{"max_depth": 1}</td>
<td class="org-left">{risks}</td>
<td class="org-left">{79,37}</td>
</tr>

<tr>
<td class="org-right">29</td>
<td class="org-left">sklearn.tree.DecisionTreeClassifier</td>
<td class="org-left">{"max_depth": null}</td>
<td class="org-left">{risks}</td>
<td class="org-left">{80,38}</td>
</tr>

<tr>
<td class="org-right">30</td>
<td class="org-left">sklearn.ensemble.RandomForestClassifier</td>
<td class="org-left">{"criterion": "gini", "class_weight": "balanced", "max_features": "sqrt", "n_estimators": 1000, "min_samples_leaf": 1, "min_samples_split": 50}</td>
<td class="org-left">{risks}</td>
<td class="org-left">{81,39}</td>
</tr>

<tr>
<td class="org-right">31</td>
<td class="org-left">sklearn.dummy.DummyClassifier</td>
<td class="org-left">{"strategy": "prior"}</td>
<td class="org-left">{risks}</td>
<td class="org-left">{82,40}</td>
</tr>

<tr>
<td class="org-right">32</td>
<td class="org-left">sklearn.dummy.DummyClassifier</td>
<td class="org-left">{"strategy": "uniform"}</td>
<td class="org-left">{risks}</td>
<td class="org-left">{83,41}</td>
</tr>

<tr>
<td class="org-right">33</td>
<td class="org-left">sklearn.dummy.DummyClassifier</td>
<td class="org-left">{"strategy": "most_frequent"}</td>
<td class="org-left">{risks}</td>
<td class="org-left">{84,42}</td>
</tr>

<tr>
<td class="org-right">34</td>
<td class="org-left">sklearn.tree.DecisionTreeClassifier</td>
<td class="org-left">{"max_depth": 1}</td>
<td class="org-left">{results,risks}</td>
<td class="org-left">{85,43}</td>
</tr>

<tr>
<td class="org-right">35</td>
<td class="org-left">sklearn.tree.DecisionTreeClassifier</td>
<td class="org-left">{"max_depth": null}</td>
<td class="org-left">{results,risks}</td>
<td class="org-left">{86,44}</td>
</tr>

<tr>
<td class="org-right">36</td>
<td class="org-left">sklearn.ensemble.RandomForestClassifier</td>
<td class="org-left">{"criterion": "gini", "class_weight": "balanced", "max_features": "sqrt", "n_estimators": 1000, "min_samples_leaf": 1, "min_samples_split": 50}</td>
<td class="org-left">{results,risks}</td>
<td class="org-left">{87,45}</td>
</tr>

<tr>
<td class="org-right">37</td>
<td class="org-left">sklearn.dummy.DummyClassifier</td>
<td class="org-left">{"strategy": "prior"}</td>
<td class="org-left">{results,risks}</td>
<td class="org-left">{88,46}</td>
</tr>

<tr>
<td class="org-right">38</td>
<td class="org-left">sklearn.dummy.DummyClassifier</td>
<td class="org-left">{"strategy": "uniform"}</td>
<td class="org-left">{results,risks}</td>
<td class="org-left">{89,47}</td>
</tr>

<tr>
<td class="org-right">39</td>
<td class="org-left">sklearn.dummy.DummyClassifier</td>
<td class="org-left">{"strategy": "most_frequent"}</td>
<td class="org-left">{results,risks}</td>
<td class="org-left">{90,48}</td>
</tr>

<tr>
<td class="org-right">40</td>
<td class="org-left">sklearn.tree.DecisionTreeClassifier</td>
<td class="org-left">{"max_depth": 1}</td>
<td class="org-left">{inspections,risks}</td>
<td class="org-left">{91,49}</td>
</tr>

<tr>
<td class="org-right">41</td>
<td class="org-left">sklearn.tree.DecisionTreeClassifier</td>
<td class="org-left">{"max_depth": null}</td>
<td class="org-left">{inspections,risks}</td>
<td class="org-left">{92,50}</td>
</tr>

<tr>
<td class="org-right">42</td>
<td class="org-left">sklearn.ensemble.RandomForestClassifier</td>
<td class="org-left">{"criterion": "gini", "class_weight": "balanced", "max_features": "sqrt", "n_estimators": 1000, "min_samples_leaf": 1, "min_samples_split": 50}</td>
<td class="org-left">{inspections,risks}</td>
<td class="org-left">{93,51}</td>
</tr>

<tr>
<td class="org-right">43</td>
<td class="org-left">sklearn.dummy.DummyClassifier</td>
<td class="org-left">{"strategy": "prior"}</td>
<td class="org-left">{inspections,risks}</td>
<td class="org-left">{94,52}</td>
</tr>

<tr>
<td class="org-right">44</td>
<td class="org-left">sklearn.dummy.DummyClassifier</td>
<td class="org-left">{"strategy": "uniform"}</td>
<td class="org-left">{inspections,risks}</td>
<td class="org-left">{95,53}</td>
</tr>

<tr>
<td class="org-right">45</td>
<td class="org-left">sklearn.dummy.DummyClassifier</td>
<td class="org-left">{"strategy": "most_frequent"}</td>
<td class="org-left">{inspections,risks}</td>
<td class="org-left">{96,54}</td>
</tr>

<tr>
<td class="org-right">46</td>
<td class="org-left">sklearn.tree.DecisionTreeClassifier</td>
<td class="org-left">{"max_depth": 1}</td>
<td class="org-left">{inspections,results}</td>
<td class="org-left">{97,55}</td>
</tr>

<tr>
<td class="org-right">47</td>
<td class="org-left">sklearn.tree.DecisionTreeClassifier</td>
<td class="org-left">{"max_depth": null}</td>
<td class="org-left">{inspections,results}</td>
<td class="org-left">{98,56}</td>
</tr>

<tr>
<td class="org-right">48</td>
<td class="org-left">sklearn.ensemble.RandomForestClassifier</td>
<td class="org-left">{"criterion": "gini", "class_weight": "balanced", "max_features": "sqrt", "n_estimators": 1000, "min_samples_leaf": 1, "min_samples_split": 50}</td>
<td class="org-left">{inspections,results}</td>
<td class="org-left">{99,57}</td>
</tr>

<tr>
<td class="org-right">49</td>
<td class="org-left">sklearn.dummy.DummyClassifier</td>
<td class="org-left">{"strategy": "prior"}</td>
<td class="org-left">{inspections,results}</td>
<td class="org-left">{100,58}</td>
</tr>

<tr>
<td class="org-right">50</td>
<td class="org-left">sklearn.dummy.DummyClassifier</td>
<td class="org-left">{"strategy": "uniform"}</td>
<td class="org-left">{inspections,results}</td>
<td class="org-left">{101,59}</td>
</tr>

<tr>
<td class="org-right">51</td>
<td class="org-left">sklearn.dummy.DummyClassifier</td>
<td class="org-left">{"strategy": "most_frequent"}</td>
<td class="org-left">{inspections,results}</td>
<td class="org-left">{102,60}</td>
</tr>
</tbody>
</table>


<p>
Let's check the performance of the <i>model group</i> 12 (a Random Forest
with all the features)
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">select</span>
model_id, evaluation_start_time,
metric || <span style="color: #0000FF;">parameter</span> <span style="color: #0000FF;">as</span> metric,
<span style="color: #0000FF;">value</span>,
num_labeled_examples, 
num_labeled_above_threshold,
num_positive_labels
<span style="color: #0000FF;">from</span> results.evaluations 
<span style="color: #0000FF;">where</span> model_id <span style="color: #0000FF;">in</span> (21, 63)
<span style="color: #0000FF;">and</span> metric || <span style="color: #0000FF;">parameter</span> = <span style="color: #008000;">'precision@25_abs'</span>
<span style="color: #0000FF;">order</span> <span style="color: #0000FF;">by</span> num_labeled_above_threshold <span style="color: #0000FF;">asc</span>,
metric || <span style="color: #0000FF;">parameter</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">model_id</th>
<th scope="col" class="org-left">evaluation_start_time</th>
<th scope="col" class="org-left">metric</th>
<th scope="col" class="org-right">value</th>
<th scope="col" class="org-right">num_labeled_examples</th>
<th scope="col" class="org-right">num_labeled_above_threshold</th>
<th scope="col" class="org-right">num_positive_labels</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">21</td>
<td class="org-left">2015-12-13 00:00:00</td>
<td class="org-left">precision@25_abs</td>
<td class="org-right">0.84</td>
<td class="org-right">18668</td>
<td class="org-right">25</td>
<td class="org-right">790</td>
</tr>

<tr>
<td class="org-right">63</td>
<td class="org-left">2016-12-13 00:00:00</td>
<td class="org-left">precision@25_abs</td>
<td class="org-right">0.88</td>
<td class="org-right">19358</td>
<td class="org-right">25</td>
<td class="org-right">958</td>
</tr>
</tbody>
</table>



<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">select</span> *
<span style="color: #0000FF;">from</span> results.predictions
<span style="color: #0000FF;">where</span> model_id = 21
<span style="color: #0000FF;">order</span> <span style="color: #0000FF;">by</span> score <span style="color: #0000FF;">desc</span>
<span style="color: #0000FF;">limit</span> 25
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">model_id</th>
<th scope="col" class="org-right">entity_id</th>
<th scope="col" class="org-left">as_of_date</th>
<th scope="col" class="org-right">score</th>
<th scope="col" class="org-right">label_value</th>
<th scope="col" class="org-left">rank_abs</th>
<th scope="col" class="org-left">rank_pct</th>
<th scope="col" class="org-left">matrix_uuid</th>
<th scope="col" class="org-left">test_label_timespan</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">21</td>
<td class="org-right">25854</td>
<td class="org-left">2015-12-13 00:00:00</td>
<td class="org-right">0.9484136677797923</td>
<td class="org-right">1</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">2e85917732c60eb208f2d052a9e4fe60</td>
<td class="org-left">1 mon</td>
</tr>

<tr>
<td class="org-right">21</td>
<td class="org-right">3019</td>
<td class="org-left">2015-12-13 00:00:00</td>
<td class="org-right">0.9436469079812785</td>
<td class="org-right">1</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">2e85917732c60eb208f2d052a9e4fe60</td>
<td class="org-left">1 mon</td>
</tr>

<tr>
<td class="org-right">21</td>
<td class="org-right">13792</td>
<td class="org-left">2015-12-13 00:00:00</td>
<td class="org-right">0.9419947954600382</td>
<td class="org-right">1</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">2e85917732c60eb208f2d052a9e4fe60</td>
<td class="org-left">1 mon</td>
</tr>

<tr>
<td class="org-right">21</td>
<td class="org-right">17502</td>
<td class="org-left">2015-12-13 00:00:00</td>
<td class="org-right">0.9312907285784298</td>
<td class="org-right">1</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">2e85917732c60eb208f2d052a9e4fe60</td>
<td class="org-left">1 mon</td>
</tr>

<tr>
<td class="org-right">21</td>
<td class="org-right">2466</td>
<td class="org-left">2015-12-13 00:00:00</td>
<td class="org-right">0.9243102785460537</td>
<td class="org-right">1</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">2e85917732c60eb208f2d052a9e4fe60</td>
<td class="org-left">1 mon</td>
</tr>

<tr>
<td class="org-right">21</td>
<td class="org-right">10382</td>
<td class="org-left">2015-12-13 00:00:00</td>
<td class="org-right">0.9206737935216891</td>
<td class="org-right">1</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">2e85917732c60eb208f2d052a9e4fe60</td>
<td class="org-left">1 mon</td>
</tr>

<tr>
<td class="org-right">21</td>
<td class="org-right">24297</td>
<td class="org-left">2015-12-13 00:00:00</td>
<td class="org-right">0.9200144700893553</td>
<td class="org-right">0</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">2e85917732c60eb208f2d052a9e4fe60</td>
<td class="org-left">1 mon</td>
</tr>

<tr>
<td class="org-right">21</td>
<td class="org-right">143</td>
<td class="org-left">2015-12-13 00:00:00</td>
<td class="org-right">0.9199824040634403</td>
<td class="org-right">0</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">2e85917732c60eb208f2d052a9e4fe60</td>
<td class="org-left">1 mon</td>
</tr>

<tr>
<td class="org-right">21</td>
<td class="org-right">29174</td>
<td class="org-left">2015-12-13 00:00:00</td>
<td class="org-right">0.9141830973245461</td>
<td class="org-right">1</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">2e85917732c60eb208f2d052a9e4fe60</td>
<td class="org-left">1 mon</td>
</tr>

<tr>
<td class="org-right">21</td>
<td class="org-right">1816</td>
<td class="org-left">2015-12-13 00:00:00</td>
<td class="org-right">0.9116947701339125</td>
<td class="org-right">1</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">2e85917732c60eb208f2d052a9e4fe60</td>
<td class="org-left">1 mon</td>
</tr>

<tr>
<td class="org-right">21</td>
<td class="org-right">15936</td>
<td class="org-left">2015-12-13 00:00:00</td>
<td class="org-right">0.910420304141231</td>
<td class="org-right">1</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">2e85917732c60eb208f2d052a9e4fe60</td>
<td class="org-left">1 mon</td>
</tr>

<tr>
<td class="org-right">21</td>
<td class="org-right">4019</td>
<td class="org-left">2015-12-13 00:00:00</td>
<td class="org-right">0.9101049552562018</td>
<td class="org-right">1</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">2e85917732c60eb208f2d052a9e4fe60</td>
<td class="org-left">1 mon</td>
</tr>

<tr>
<td class="org-right">21</td>
<td class="org-right">8835</td>
<td class="org-left">2015-12-13 00:00:00</td>
<td class="org-right">0.909611746159294</td>
<td class="org-right">1</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">2e85917732c60eb208f2d052a9e4fe60</td>
<td class="org-left">1 mon</td>
</tr>

<tr>
<td class="org-right">21</td>
<td class="org-right">30294</td>
<td class="org-left">2015-12-13 00:00:00</td>
<td class="org-right">0.9053675764327609</td>
<td class="org-right">0</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">2e85917732c60eb208f2d052a9e4fe60</td>
<td class="org-left">1 mon</td>
</tr>

<tr>
<td class="org-right">21</td>
<td class="org-right">27955</td>
<td class="org-left">2015-12-13 00:00:00</td>
<td class="org-right">0.9046749372346382</td>
<td class="org-right">1</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">2e85917732c60eb208f2d052a9e4fe60</td>
<td class="org-left">1 mon</td>
</tr>

<tr>
<td class="org-right">21</td>
<td class="org-right">27956</td>
<td class="org-left">2015-12-13 00:00:00</td>
<td class="org-right">0.9046749372346382</td>
<td class="org-right">1</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">2e85917732c60eb208f2d052a9e4fe60</td>
<td class="org-left">1 mon</td>
</tr>

<tr>
<td class="org-right">21</td>
<td class="org-right">13783</td>
<td class="org-left">2015-12-13 00:00:00</td>
<td class="org-right">0.9015988243973061</td>
<td class="org-right">1</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">2e85917732c60eb208f2d052a9e4fe60</td>
<td class="org-left">1 mon</td>
</tr>

<tr>
<td class="org-right">21</td>
<td class="org-right">8760</td>
<td class="org-left">2015-12-13 00:00:00</td>
<td class="org-right">0.8936300434147297</td>
<td class="org-right">1</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">2e85917732c60eb208f2d052a9e4fe60</td>
<td class="org-left">1 mon</td>
</tr>

<tr>
<td class="org-right">21</td>
<td class="org-right">27071</td>
<td class="org-left">2015-12-13 00:00:00</td>
<td class="org-right">0.8889020831400419</td>
<td class="org-right">1</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">2e85917732c60eb208f2d052a9e4fe60</td>
<td class="org-left">1 mon</td>
</tr>

<tr>
<td class="org-right">21</td>
<td class="org-right">27073</td>
<td class="org-left">2015-12-13 00:00:00</td>
<td class="org-right">0.8889020831400419</td>
<td class="org-right">1</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">2e85917732c60eb208f2d052a9e4fe60</td>
<td class="org-left">1 mon</td>
</tr>

<tr>
<td class="org-right">21</td>
<td class="org-right">1381</td>
<td class="org-left">2015-12-13 00:00:00</td>
<td class="org-right">0.8856752816172949</td>
<td class="org-right">0</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">2e85917732c60eb208f2d052a9e4fe60</td>
<td class="org-left">1 mon</td>
</tr>

<tr>
<td class="org-right">21</td>
<td class="org-right">23063</td>
<td class="org-left">2015-12-13 00:00:00</td>
<td class="org-right">0.8838436286127278</td>
<td class="org-right">1</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">2e85917732c60eb208f2d052a9e4fe60</td>
<td class="org-left">1 mon</td>
</tr>

<tr>
<td class="org-right">21</td>
<td class="org-right">1355</td>
<td class="org-left">2015-12-13 00:00:00</td>
<td class="org-right">0.8828514873911587</td>
<td class="org-right">1</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">2e85917732c60eb208f2d052a9e4fe60</td>
<td class="org-left">1 mon</td>
</tr>

<tr>
<td class="org-right">21</td>
<td class="org-right">19735</td>
<td class="org-left">2015-12-13 00:00:00</td>
<td class="org-right">0.8806239565602527</td>
<td class="org-right">1</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">2e85917732c60eb208f2d052a9e4fe60</td>
<td class="org-left">1 mon</td>
</tr>

<tr>
<td class="org-right">21</td>
<td class="org-right">6959</td>
<td class="org-left">2015-12-13 00:00:00</td>
<td class="org-right">0.8736905232325605</td>
<td class="org-right">1</td>
<td class="org-left">[NULL]</td>
<td class="org-left">[NULL]</td>
<td class="org-left">2e85917732c60eb208f2d052a9e4fe60</td>
<td class="org-left">1 mon</td>
</tr>
</tbody>
</table>
</div>
</div>


<div id="outline-container-orgc8d378c" class="outline-5">
<h5 id="orgc8d378c"><span class="section-number-5">6.3.1.4</span> Feature Importances</h5>
<div class="outline-text-5" id="text-6-3-1-4">
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">select</span> * <span style="color: #0000FF;">from</span> results.feature_importances 
<span style="color: #0000FF;">where</span> model_id = 21 
<span style="color: #0000FF;">order</span> <span style="color: #0000FF;">by</span> feature_importance <span style="color: #0000FF;">desc</span>
<span style="color: #0000FF;">limit</span> 25
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">model_id</th>
<th scope="col" class="org-left">feature</th>
<th scope="col" class="org-right">feature_importance</th>
<th scope="col" class="org-right">rank_abs</th>
<th scope="col" class="org-right">rank_pct</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">21</td>
<td class="org-left">risks_facility_type_2y_risk_high_avg</td>
<td class="org-right">0.0174800538</td>
<td class="org-right">1</td>
<td class="org-right">0.003125</td>
</tr>

<tr>
<td class="org-right">21</td>
<td class="org-left">results_entity_id_3month_result_fail_avg</td>
<td class="org-right">0.0133257966</td>
<td class="org-right">2</td>
<td class="org-right">0.00625</td>
</tr>

<tr>
<td class="org-right">21</td>
<td class="org-left">risks_facility_type_1y_risk_high_avg</td>
<td class="org-right">0.0131853305</td>
<td class="org-right">3</td>
<td class="org-right">0.009375</td>
</tr>

<tr>
<td class="org-right">21</td>
<td class="org-left">risks_facility_type_2y_risk_high_sum</td>
<td class="org-right">0.0131239412</td>
<td class="org-right">4</td>
<td class="org-right">0.0125</td>
</tr>

<tr>
<td class="org-right">21</td>
<td class="org-left">results_entity_id_6month_result_pass_avg</td>
<td class="org-right">0.0129326733</td>
<td class="org-right">5</td>
<td class="org-right">0.015625</td>
</tr>

<tr>
<td class="org-right">21</td>
<td class="org-left">risks_facility_type_6month_risk_high_avg</td>
<td class="org-right">0.0124089975</td>
<td class="org-right">6</td>
<td class="org-right">0.01875</td>
</tr>

<tr>
<td class="org-right">21</td>
<td class="org-left">results_facility_type_2y_result_pass_avg</td>
<td class="org-right">0.0119138182</td>
<td class="org-right">7</td>
<td class="org-right">0.021875</td>
</tr>

<tr>
<td class="org-right">21</td>
<td class="org-left">risks_entity_id_2y_risk_high_sum</td>
<td class="org-right">0.011606308</td>
<td class="org-right">8</td>
<td class="org-right">0.025</td>
</tr>

<tr>
<td class="org-right">21</td>
<td class="org-left">results_entity_id_6month_result_pass_sum</td>
<td class="org-right">0.0115504677</td>
<td class="org-right">9</td>
<td class="org-right">0.028125</td>
</tr>

<tr>
<td class="org-right">21</td>
<td class="org-left">risks_facility_type_1y_risk_high_sum</td>
<td class="org-right">0.0106386415</td>
<td class="org-right">10</td>
<td class="org-right">0.03125</td>
</tr>

<tr>
<td class="org-right">21</td>
<td class="org-left">results_zip_code_1y_result_pass w/ conditions_avg</td>
<td class="org-right">0.009624423</td>
<td class="org-right">11</td>
<td class="org-right">0.034375</td>
</tr>

<tr>
<td class="org-right">21</td>
<td class="org-left">risks_zip_code_1y_risk_medium_sum</td>
<td class="org-right">0.0094457436</td>
<td class="org-right">12</td>
<td class="org-right">0.0375</td>
</tr>

<tr>
<td class="org-right">21</td>
<td class="org-left">results_entity_id_3month_result_pass_sum</td>
<td class="org-right">0.009225408</td>
<td class="org-right">13</td>
<td class="org-right">0.040625</td>
</tr>

<tr>
<td class="org-right">21</td>
<td class="org-left">results_entity_id_6month_result_fail_avg</td>
<td class="org-right">0.0091078199</td>
<td class="org-right">14</td>
<td class="org-right">0.04375</td>
</tr>

<tr>
<td class="org-right">21</td>
<td class="org-left">results_entity_id_3month_result_pass_avg</td>
<td class="org-right">0.0088542878</td>
<td class="org-right">15</td>
<td class="org-right">0.046875</td>
</tr>

<tr>
<td class="org-right">21</td>
<td class="org-left">inspections_zip_code_3month_type_canvass_avg</td>
<td class="org-right">0.0087851068</td>
<td class="org-right">16</td>
<td class="org-right">0.05</td>
</tr>

<tr>
<td class="org-right">21</td>
<td class="org-left">risks_entity_id_2y_risk_low_sum</td>
<td class="org-right">0.0085351</td>
<td class="org-right">17</td>
<td class="org-right">0.053125</td>
</tr>

<tr>
<td class="org-right">21</td>
<td class="org-left">risks_entity_id_2y_risk_low_avg</td>
<td class="org-right">0.0080073084</td>
<td class="org-right">18</td>
<td class="org-right">0.05625</td>
</tr>

<tr>
<td class="org-right">21</td>
<td class="org-left">results_zip_code_1y_result_fail_sum</td>
<td class="org-right">0.0079038494</td>
<td class="org-right">19</td>
<td class="org-right">0.059375</td>
</tr>

<tr>
<td class="org-right">21</td>
<td class="org-left">results_zip_code_2y_result_fail_avg</td>
<td class="org-right">0.0078180121</td>
<td class="org-right">20</td>
<td class="org-right">0.0625</td>
</tr>

<tr>
<td class="org-right">21</td>
<td class="org-left">results_zip_code_2y_result_pass_sum</td>
<td class="org-right">0.0077150654</td>
<td class="org-right">21</td>
<td class="org-right">0.065625</td>
</tr>

<tr>
<td class="org-right">21</td>
<td class="org-left">inspections_zip_code_2y_type_license_sum</td>
<td class="org-right">0.0076692378</td>
<td class="org-right">22</td>
<td class="org-right">0.06875</td>
</tr>

<tr>
<td class="org-right">21</td>
<td class="org-left">risks_facility_type_3month_risk_high_avg</td>
<td class="org-right">0.0076609972</td>
<td class="org-right">23</td>
<td class="org-right">0.071875</td>
</tr>

<tr>
<td class="org-right">21</td>
<td class="org-left">risks_zip_code_1y_risk_medium_avg</td>
<td class="org-right">0.0075045563</td>
<td class="org-right">24</td>
<td class="org-right">0.075</td>
</tr>

<tr>
<td class="org-right">21</td>
<td class="org-left">results_zip_code_2y_result_pass w/ conditions_sum</td>
<td class="org-right">0.0074907219</td>
<td class="org-right">25</td>
<td class="org-right">0.078125</td>
</tr>
</tbody>
</table>

<p>
This set of features identifies as important looks reasonable, so the results seem solid.
</p>
</div>
</div>
</div>
</div>


<div id="outline-container-orge2d64c7" class="outline-3">
<h3 id="orge2d64c7"><span class="section-number-3">6.4</span> Postmodeling</h3>
<div class="outline-text-3" id="text-6-4">
</div>
<div id="outline-container-org95dee7f" class="outline-4">
<h4 id="org95dee7f"><span class="section-number-4">6.4.1</span> How can I pick the best one?</h4>
<div class="outline-text-4" id="text-6-4-1">
<p>
Well now you have <b>42</b> <i>model groups</i> Which one must you select to
use? Which one is the best one? This is not as easy as it sounds, due
several Factors:
</p>

<ul class="org-ul">
<li>You could try to pick the best one using just one of the metrics
that we establish in the config file (<code>precision@</code> and <code>recall@</code>)
but at what point of time? Maybe different model groups are the best
at different prediction times.</li>
<li>You could just use the one that perfom better in the last temporal point</li>
<li>Or you could value that the model is stable across time? Maybe is
not the best but is consistent.</li>
<li>Also, even if there are several model groups that perform similar,
the lists generated are more or less similar, so, it doesn't really
matter which one do you Pick.</li>
</ul>

<p>
<code>triage</code> provides that functionality in <code>audition</code> and in
<code>postmodel</code>. At the moment of this writing this two modules require
more interaction (they aren't integrated to the <i>configuration
File</i>). 
</p>

<p>
<code>Audition</code> formalizes this idea through <i>selection rules</i> that take in
the data up to a given point in time, apply some rule to choose a
model group, and evaluate the performance of that chosen model in the
subsequent time window, the <b>regret</b>. 
</p>

<p>
<code>Audition</code> predefines 7 Rules:
</p>

<ol class="org-ol">
<li><code>best_current_value</code> :: Pick the model group with the best current metric Value.</li>
<li><code>best_average_value</code> :: Pick the model with the highest average metric value so far.</li>
<li><code>lowest_metric_variance</code> :: Pick the model with the lowest metric variance so far.</li>
<li><code>most_frequent_best_dist</code> :: Pick the model that is most frequently
within <code>dist_from_best_case</code> from the best-performing model group
across test sets so far.</li>
<li><code>best_average_two_metrics</code> :: Pick the model with the highest
average combined value to date of two metrics weighted together
using <code>metric1_weight</code>.</li>
<li><code>best_avg_var_penalized</code> :: Pick the model with the highest average
metric value so far, penalized for relative variance ss:  
<code>avg_value - (stdev_penalty) * (stdev - min_stdev)</code> where
<code>min_stdev</code> is the minimum standard deviation of the metric
across all model groups</li>
<li><code>best_avg_recency_weight</code> :: Pick the model with the highest
average metric value so far, penalized for relative variance as:
<code>avg_value - (stdev_penalty) * (stdev - min_stdev)</code> where
<code>min_stdev</code> is the minimum standard deviation of the metric
across all  model groups</li>
</ol>

<p>
We included a simple configuration file with some rules:
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #BA36A5;">-</span>
<span style="color: #BA36A5;">  shared_parameters</span>:
    <span style="color: #BA36A5;">-</span>
<span style="color: #BA36A5;">      metric</span>: <span style="color: #008000;">'precision@'</span>
      <span style="color: #BA36A5;">parameter</span>: <span style="color: #008000;">'50_abs'</span>
  <span style="color: #BA36A5;">selection_rules</span>:
    <span style="color: #BA36A5;">-</span>
<span style="color: #BA36A5;">      name</span>: best_current_value
      <span style="color: #BA36A5;">n</span>: 1
    <span style="color: #BA36A5;">-</span>
<span style="color: #BA36A5;">      name</span>: best_average_value
      <span style="color: #BA36A5;">n</span>: 1
    <span style="color: #BA36A5;">-</span>
<span style="color: #BA36A5;">      name</span>: lowest_metric_variance
      <span style="color: #BA36A5;">n</span>: 1
    <span style="color: #BA36A5;">-</span>
<span style="color: #BA36A5;">      name</span>: most_frequent_best_dist
      <span style="color: #BA36A5;">dist_from_best_case</span>: [0.05]
      <span style="color: #BA36A5;">n</span>: 1
</pre>
</div>

<p>
The result will have each rule give you the best \(n\) model groups ids
based on the metric and parameter following that rule for the most
recent time period (in all the rules shown \(n\) = 1).
</p>

<p>
We can run the simulation of the rules againts the experiment as:
</p>

<div class="org-src-container">
<pre class="src src-sh">./tutorial.sh triage --config_file eis_01.yaml audit_models --metric precision@50_abs --rules rules.yaml
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">Using the config file /triage/experiment<span style="color: #0000ff; background-color: #ffffff;">config</span>/eis<span style="color: #0000ff; background-color: #ffffff;">01.yaml</span>
The output (matrices and models) of this experiment will be stored in triage/output
Using data stored in postgresql://food<span style="color: #0000ff; background-color: #ffffff;">user</span>:some<span style="color: #0000ff; background-color: #ffffff;">password</span>@food<span style="color: #0000ff; background-color: #ffffff;">db</span>/food
The experiment will utilize any preexisting matrix or model: False
Creating experiment object
Experiment loaded
Auditing experiment

          ++++++++++++++++++++++++++++++++++++++++++++++++++++
          +                                                  +
          +          Results of the simulation               +
          +                                                  +
          ++++++++++++++++++++++++++++++++++++++++++++++++++++
    
{'best<span style="color: #0000ff; background-color: #ffffff;">average</span>value<span style="color: #0000ff; background-color: #ffffff;">precision</span>@<span style="color: #0000ff; background-color: #ffffff;">50</span>abs': [24],
 'best<span style="color: #0000ff; background-color: #ffffff;">current</span>value<span style="color: #0000ff; background-color: #ffffff;">precision</span>@<span style="color: #0000ff; background-color: #ffffff;">50</span>abs': [48, 24],
 'lowest<span style="color: #0000ff; background-color: #ffffff;">metric</span>variance<span style="color: #0000ff; background-color: #ffffff;">precision</span>@<span style="color: #0000ff; background-color: #ffffff;">50</span>abs': [24],
 'most<span style="color: #0000ff; background-color: #ffffff;">frequent</span>best<span style="color: #0000ff; background-color: #ffffff;">dist</span>precision@<span style="color: #0000ff; background-color: #ffffff;">50</span>abs<span style="color: #0000ff; background-color: #ffffff;">0.05</span>': [48]}

          ++++++++++++++++++++++++++++++++++++++++++++++++++++
          +                                                  +
          +          Average regret per rule                 +
          +                                                  +
          ++++++++++++++++++++++++++++++++++++++++++++++++++++
    
{'precision@50<span style="color: #0000ff; background-color: #ffffff;">abs</span>': {'best<span style="color: #0000ff; background-color: #ffffff;">average</span>value<span style="color: #0000ff; background-color: #ffffff;">precision</span>@<span style="color: #0000ff; background-color: #ffffff;">50</span>abs': 0.0,
                      'best<span style="color: #0000ff; background-color: #ffffff;">current</span>value<span style="color: #0000ff; background-color: #ffffff;">precision</span>@<span style="color: #0000ff; background-color: #ffffff;">50</span>abs': 0.0,
                      'lowest<span style="color: #0000ff; background-color: #ffffff;">metric</span>variance<span style="color: #0000ff; background-color: #ffffff;">precision</span>@<span style="color: #0000ff; background-color: #ffffff;">50</span>abs': 0.08,
                      'most<span style="color: #0000ff; background-color: #ffffff;">frequent</span>best<span style="color: #0000ff; background-color: #ffffff;">dist</span>precision@<span style="color: #0000ff; background-color: #ffffff;">50</span>abs<span style="color: #0000ff; background-color: #ffffff;">0.05</span>': 0.02}}

</pre>
</div>
</div>
</div>




<div id="outline-container-orge9e98ba" class="outline-4">
<h4 id="orge9e98ba"><span class="section-number-4">6.4.2</span> What's next?</h4>
<div class="outline-text-4" id="text-6-4-2">
<ul class="org-ul">
<li>Add the shape file
<a href="https://data.cityofchicago.org/api/geospatial/gdcf-axmw?method=export&amp;format=Shapefile">https://data.cityofchicago.org/api/geospatial/gdcf-axmw?method=export&amp;format=Shapefile</a>
and generate geospatial variables using <code>location</code></li>
<li>Text analysis on the <i>violations</i>' <code>comments</code> column and generate
new <i>outcomes</i> or <i>features</i>?</li>
<li>Run <code>pgdedup</code> and had a better <code>semantic.entities</code>?</li>
<li>Routing based on the inspection list?</li>
<li>Add more data sources (Census, Schools, bus stops, ACS data, Yelp!)?</li>
</ul>
</div>
</div>
</div>
</div>


<div id="outline-container-org578136f" class="outline-2">
<h2 id="org578136f"><span class="section-number-2">7</span> Appendix: A more technical view to <code>collate</code></h2>
<div class="outline-text-2" id="text-7">
<p>
<code>collate</code> helps you with the building of these kind of features. The
previous query is splitted in two parts in <code>collate</code>: First, the
column, the filter and the aggregate operation to be Applied
 are part of a <code>Categorical</code> object. 
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #0000FF;">from</span>  triage.component.collate <span style="color: #0000FF;">import</span> Categorical

<span style="color: #BA36A5;">risks</span> = Categorical(<span style="color: #008000;">"risk"</span>, <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">the column</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   [<span style="color: #008000;">"high"</span>, <span style="color: #008000;">"medium"</span>, <span style="color: #008000;">"low"</span>], <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">compare to, i.e. 'risk = high', 'risk=low', etc</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #008000;">"avg"</span>, <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">aggregation function</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   {<span style="color: #008000;">'coltype'</span>:<span style="color: #008000;">'categorical'</span>, <span style="color: #008000;">'all'</span>: {<span style="color: #008000;">'type'</span>: <span style="color: #008000;">'zero'</span>}} <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">imputation rules</span>
)


</pre>
</div>

<p>

</p>


<p>
Note also that <code>collate</code> handles the imputation: we specified the
imputation strategy for how to handle 
the null values in the resulting fields, in this example we use the
<code>zero</code> value (if the aggregation is <code>NULL</code> impute with <code>0</code>).
</p>

<p>
The second part is the actual aggregator, called
<code>SparcetimeAggregation</code>, this object handles the <i>context</i> of the aggregation.
</p>


<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #0000FF;">import</span> sqlalchemy
<span style="color: #0000FF;">from</span> triage.component.collate <span style="color: #0000FF;">import</span>  SpacetimeAggregation

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">We need a connection to the data base</span>
<span style="color: #BA36A5;">db_url</span> = f<span style="color: #008000;">"postgresql://food_user:some_password@0.0.0.0:5434/food"</span>
<span style="color: #BA36A5;">engine</span> = sqlalchemy.create_engine(db_url, client_encoding=<span style="color: #008000;">'utf8'</span>)

<span style="color: #BA36A5;">db_connection</span> = engine.connect()

<span style="color: #BA36A5;">st</span> = SpacetimeAggregation([risks], <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">The Categorical object</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> from_obj=<span style="color: #008000;">'triage.test'</span>, <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">FROM</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> groups=[<span style="color: #008000;">'entity_id'</span>,<span style="color: #008000;">'zip_code'</span>],  <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">GROUP BY</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> dates=[<span style="color: #008000;">"2014-10-06"</span>,
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;">"2014-10-08"</span>,
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;">"2015-01-12"</span>,
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;">"2015-10-20"</span>,
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;">"2016-10-17"</span>], <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">AS OF DATES, This comes from Timechop, are used as 'WHERE date = ...'</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> intervals={<span style="color: #008000;">"entity_id"</span>: [<span style="color: #008000;">"1 year"</span>], <span style="color: #008000;">"zip_code"</span>: [<span style="color: #008000;">"1 year"</span>]}, <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">This will be used as the intervals in the past of the AS OF DATE</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> date_column=<span style="color: #008000;">"date"</span>, <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Which is the name of the date column?</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> state_table=<span style="color: #008000;">'triage.active_facilities_9581'</span>, <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">State table name</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> state_group=<span style="color: #008000;">'entity_id'</span>, <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Which is the column that identifies the entity</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> output_date_column=<span style="color: #008000;">'date'</span>,
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> schema=<span style="color: #008000;">'triage'</span>, <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">In which schema do you want to store the results?</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> prefix=<span style="color: #008000;">'risks'</span>
)

</pre>
</div>

<p>

</p>

<p>
The <code>SpacetimeAggregation</code> object is in charge of create the
agregations, another way of see it, is that it encapsulates the <code>From</code>
 part of the query (<code>from_obj</code>) as well as the <code>GROUP BY</code> columns (<code>groups</code>).
</p>

<p>
In the example above it will create features based on individual
restaurants (using <code>entity_id</code>) but also <i>contextual</i> features related
to information about the zip code (<code>zip_code</code>) in which the facility is
operating.
</p>

<p>
The state table (<code>state_table</code>) specified here should contain the
comprehensive set of facilities and dates for which output should be
generated for them, regardless if they exist in the <code>from_obj</code>.
</p>

<p>
The attribute <code>intervals</code> specifies the date range partitioning for the
feature: it will create the aggregation over the past <code>1 year</code> for the
grouping given by the <code>entity_id</code> nad for the <code>zip_code</code>, and
additionally  will give an extra grouping statistic of two months for
the <code>zip_code</code>.
</p>

<p>
Before execute the queries, you could actually look them using the following
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #0000FF;">import</span> utils

utils.show_features_queries(st)
</pre>
</div>


<p>
This will execute queries as the following for the group tables (like <code>test_risks_zip_code</code>):
</p>

<pre class="example">
...

SELECT zip_code, '2014-10-08'::date AS date,
avg((risk = 'high')::INT) FILTER (WHERE date &gt;= '2014-10-08'::date - interval '1 year') AS "test_risks_zip_code_1 year_risk_high_avg",
avg((risk = 'medium')::INT) FILTER (WHERE date &gt;= '2014-10-08'::date - interval '1 year') AS "test_risks_zip_code_1 year_risk_medium_avg",
avg((risk = 'low')::INT) FILTER (WHERE date &gt;= '2014-10-08'::date - interval '1 year') AS "test_risks_zip_code_1 year_risk_low_avg"
FROM triage.test
WHERE date &lt; '2014-10-08'AND date &gt;= '2014-10-08'::date - greatest(interval '1 year') GROUP BY zip_code

...
</pre>

<p>
and the next query for the <code>risks_aggregation</code> table:
</p>

<pre class="example">
CREATE TABLE "triage"."risks_aggregation" AS (
SELECT * FROM (
SELECT entity_id, zip_code, '2014-10-06'::date AS date
FROM triage.test
WHERE date &lt; '2014-10-06'AND date &gt;= '2014-10-06'::date - greatest(interval '1 year') GROUP BY entity_id, zip_code
UNION ALL
SELECT entity_id, zip_code, '2014-10-08'::date AS date
FROM triage.test
WHERE date &lt; '2014-10-08'AND date &gt;= '2014-10-08'::date - greatest(interval '1 year') GROUP BY entity_id, zip_code
UNION ALL
SELECT entity_id, zip_code, '2015-01-12'::date AS date
FROM triage.test
WHERE date &lt; '2015-01-12'AND date &gt;= '2015-01-12'::date - greatest(interval '1 year') GROUP BY entity_id, zip_code
UNION ALL
SELECT entity_id, zip_code, '2015-10-20'::date AS date
FROM triage.test
WHERE date &lt; '2015-10-20'AND date &gt;= '2015-10-20'::date - greatest(interval '1 year') GROUP BY entity_id, zip_code
UNION ALL
SELECT entity_id, zip_code, '2016-10-17'::date AS date
FROM triage.test
WHERE date &lt; '2016-10-17'AND date &gt;= '2016-10-17'::date - greatest(interval '1 year') GROUP BY entity_id, zip_code
) t1
LEFT JOIN "triage"."test_risks_entity_id" USING (entity_id, date) LEFT JOIN "triage"."test_risks_zip_code" USING (zip_code, date));
</pre>

<p>
You can create the features tables executing the following:
</p>

<div class="org-src-container">
<pre class="src src-ipython">st.execute(db_connection) <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">with a SQLAlchemy engine object</span>
</pre>
</div>


<p>
This will create 3 tables (One for the <code>entity_id</code>, one for <code>zip_code</code>
and one for the combination: <code>entity_id + zip_code</code>) and one extra
table for the imputated values.
</p>

<p>
The names of the generated tables are constructed as follows:
</p>

<pre class="example">
schema.prefix_{group, aggregation}
</pre>

<p>
Inside each of those new tables, the column name will follow this
pattern:
</p>

<pre class="example">
prefix_group_interval_categorical_operation
</pre>

<p>
For example the tables inside the triage schema are:
</p>

<div class="org-src-container">
<pre class="src src-sql">\dt triage.risks*
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">List of relations</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Schema</td>
<td class="org-left">Name</td>
<td class="org-left">Type</td>
<td class="org-left">Owner</td>
</tr>

<tr>
<td class="org-left">triage</td>
<td class="org-left">risks_aggregation</td>
<td class="org-left">table</td>
<td class="org-left">food_user</td>
</tr>

<tr>
<td class="org-left">triage</td>
<td class="org-left">risks_aggregation_imputed</td>
<td class="org-left">table</td>
<td class="org-left">food_user</td>
</tr>

<tr>
<td class="org-left">triage</td>
<td class="org-left">risks_entity_id</td>
<td class="org-left">table</td>
<td class="org-left">food_user</td>
</tr>

<tr>
<td class="org-left">triage</td>
<td class="org-left">risks_zip_code</td>
<td class="org-left">table</td>
<td class="org-left">food_user</td>
</tr>
</tbody>
</table>

<p>
And inside <code>test_risk_aggregation</code> the columns are:
</p>

<div class="org-src-container">
<pre class="src src-sql">\d triage.risks_aggregation
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Table "triage.risks_aggregation"</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Column</td>
<td class="org-left">Type</td>
<td class="org-left">Modifiers</td>
</tr>

<tr>
<td class="org-left">zip_code</td>
<td class="org-left">character varying</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">date</td>
<td class="org-left">date</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">entity_id</td>
<td class="org-left">bigint</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">risks_entity_id_1 year_risk_high_avg</td>
<td class="org-left">numeric</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">risks_entity_id_1 year_risk_medium_avg</td>
<td class="org-left">numeric</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">risks_entity_id_1 year_risk_low_avg</td>
<td class="org-left">numeric</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">risks_zip_code_1 year_risk_high_avg</td>
<td class="org-left">numeric</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">risks_zip_code_1 year_risk_medium_avg</td>
<td class="org-left">numeric</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">risks_zip_code_1 year_risk_low_avg</td>
<td class="org-left">numeric</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>


<p>
The <code>triage.risks_zip_code</code> table
have two feature columns for every zip code in our table <code>triage.test</code>,
looking at the total and average number of complaints in that
<code>zip_code</code> over the year prior and 2 months prior to the date in the <code>date</code> column.
</p>


<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">select</span> * <span style="color: #0000FF;">from</span> triage.risks_zip_code  <span style="color: #0000FF;">order</span> <span style="color: #0000FF;">by</span> <span style="color: #6434A3;">date</span> <span style="color: #0000FF;">limit</span> 5;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">zip_code</th>
<th scope="col" class="org-right">date</th>
<th scope="col" class="org-right">risks_zip_code_1 year_risk_high_avg</th>
<th scope="col" class="org-right">risks_zip_code_1 year_risk_medium_avg</th>
<th scope="col" class="org-right">risks_zip_code_1 year_risk_low_avg</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">60621</td>
<td class="org-right">2014-10-06</td>
<td class="org-right">0.00000000000000000000</td>
<td class="org-right">1.00000000000000000000</td>
<td class="org-right">0.00000000000000000000</td>
</tr>

<tr>
<td class="org-right">60621</td>
<td class="org-right">2014-10-08</td>
<td class="org-right">0.00000000000000000000</td>
<td class="org-right">1.00000000000000000000</td>
<td class="org-right">0.00000000000000000000</td>
</tr>

<tr>
<td class="org-right">60621</td>
<td class="org-right">2015-01-12</td>
<td class="org-right">0.00000000000000000000</td>
<td class="org-right">1.00000000000000000000</td>
<td class="org-right">0.00000000000000000000</td>
</tr>

<tr>
<td class="org-right">60621</td>
<td class="org-right">2015-10-20</td>
<td class="org-right">0.00000000000000000000</td>
<td class="org-right">1.00000000000000000000</td>
<td class="org-right">0.00000000000000000000</td>
</tr>

<tr>
<td class="org-right">60621</td>
<td class="org-right">2016-10-17</td>
<td class="org-right">0.00000000000000000000</td>
<td class="org-right">1.00000000000000000000</td>
<td class="org-right">0.00000000000000000000</td>
</tr>
</tbody>
</table>

<p>
The table <code>triage.risks_entity_id</code> contains two feature columns for each
license that describe the total number of complaints
the past one year.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">select</span> * <span style="color: #0000FF;">from</span> triage.risks_entity_id  <span style="color: #0000FF;">order</span> <span style="color: #0000FF;">by</span> <span style="color: #6434A3;">date</span> <span style="color: #0000FF;">limit</span> 5;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">entity_id</th>
<th scope="col" class="org-right">date</th>
<th scope="col" class="org-right">risks_entity_id_1 year_risk_high_avg</th>
<th scope="col" class="org-right">risks_entity_id_1 year_risk_medium_avg</th>
<th scope="col" class="org-right">risks_entity_id_1 year_risk_low_avg</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">9547</td>
<td class="org-right">2014-10-06</td>
<td class="org-right">0.00000000000000000000</td>
<td class="org-right">1.00000000000000000000</td>
<td class="org-right">0.00000000000000000000</td>
</tr>

<tr>
<td class="org-right">9547</td>
<td class="org-right">2014-10-08</td>
<td class="org-right">0.00000000000000000000</td>
<td class="org-right">1.00000000000000000000</td>
<td class="org-right">0.00000000000000000000</td>
</tr>

<tr>
<td class="org-right">9547</td>
<td class="org-right">2015-01-12</td>
<td class="org-right">0.00000000000000000000</td>
<td class="org-right">1.00000000000000000000</td>
<td class="org-right">0.00000000000000000000</td>
</tr>

<tr>
<td class="org-right">9547</td>
<td class="org-right">2015-10-20</td>
<td class="org-right">0.00000000000000000000</td>
<td class="org-right">1.00000000000000000000</td>
<td class="org-right">0.00000000000000000000</td>
</tr>

<tr>
<td class="org-right">9547</td>
<td class="org-right">2016-10-17</td>
<td class="org-right">0.00000000000000000000</td>
<td class="org-right">1.00000000000000000000</td>
<td class="org-right">0.00000000000000000000</td>
</tr>
</tbody>
</table>

<p>
The <code>triage.risk_aggregation</code> table joins these results together to make
it easier to look at both zip_code and facility-level effects
for any given facility.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">select</span> * <span style="color: #0000FF;">from</span> triage.risks_aggregation <span style="color: #0000FF;">order</span> <span style="color: #0000FF;">by</span> <span style="color: #6434A3;">date</span> <span style="color: #0000FF;">limit</span> 5;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">zip_code</th>
<th scope="col" class="org-right">date</th>
<th scope="col" class="org-right">entity_id</th>
<th scope="col" class="org-right">risks_entity_id_1 year_risk_high_avg</th>
<th scope="col" class="org-right">risks_entity_id_1 year_risk_medium_avg</th>
<th scope="col" class="org-right">risks_entity_id_1 year_risk_low_avg</th>
<th scope="col" class="org-right">risks_zip_code_1 year_risk_high_avg</th>
<th scope="col" class="org-right">risks_zip_code_1 year_risk_medium_avg</th>
<th scope="col" class="org-right">risks_zip_code_1 year_risk_low_avg</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">60621</td>
<td class="org-right">2014-10-06</td>
<td class="org-right">9547</td>
<td class="org-right">0.00000000000000000000</td>
<td class="org-right">1.00000000000000000000</td>
<td class="org-right">0.00000000000000000000</td>
<td class="org-right">0.00000000000000000000</td>
<td class="org-right">1.00000000000000000000</td>
<td class="org-right">0.00000000000000000000</td>
</tr>

<tr>
<td class="org-right">60621</td>
<td class="org-right">2014-10-08</td>
<td class="org-right">9547</td>
<td class="org-right">0.00000000000000000000</td>
<td class="org-right">1.00000000000000000000</td>
<td class="org-right">0.00000000000000000000</td>
<td class="org-right">0.00000000000000000000</td>
<td class="org-right">1.00000000000000000000</td>
<td class="org-right">0.00000000000000000000</td>
</tr>

<tr>
<td class="org-right">60621</td>
<td class="org-right">2015-01-12</td>
<td class="org-right">9547</td>
<td class="org-right">0.00000000000000000000</td>
<td class="org-right">1.00000000000000000000</td>
<td class="org-right">0.00000000000000000000</td>
<td class="org-right">0.00000000000000000000</td>
<td class="org-right">1.00000000000000000000</td>
<td class="org-right">0.00000000000000000000</td>
</tr>

<tr>
<td class="org-right">60621</td>
<td class="org-right">2015-10-20</td>
<td class="org-right">9547</td>
<td class="org-right">0.00000000000000000000</td>
<td class="org-right">1.00000000000000000000</td>
<td class="org-right">0.00000000000000000000</td>
<td class="org-right">0.00000000000000000000</td>
<td class="org-right">1.00000000000000000000</td>
<td class="org-right">0.00000000000000000000</td>
</tr>

<tr>
<td class="org-right">60621</td>
<td class="org-right">2016-10-17</td>
<td class="org-right">9547</td>
<td class="org-right">0.00000000000000000000</td>
<td class="org-right">1.00000000000000000000</td>
<td class="org-right">0.00000000000000000000</td>
<td class="org-right">0.00000000000000000000</td>
<td class="org-right">1.00000000000000000000</td>
<td class="org-right">0.00000000000000000000</td>
</tr>
</tbody>
</table>


<p>
Finally, the <code>triage.risks_aggregated_imputed</code> table fills in null values using the
imputation rules specified in the <code>Categorical</code> constructor.
</p>

<p>
Let's try with <code>inspection_type</code>. We want the total of <code>canvass</code> and
<code>complaint</code> inspections.
</p>

<div class="org-src-container">
<pre class="src src-python">
<span style="color: #BA36A5;">inspection_types</span> = Categorical(<span style="color: #008000;">"inspection_type"</span>, <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">the column</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   [<span style="color: #008000;">"canvass"</span>, <span style="color: #008000;">"complaint"</span>], <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">compare to, i.e. 'inspection_type = canvass', etc.</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #008000;">"sum"</span>, <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">aggregation function</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   {<span style="color: #008000;">'coltype'</span>:<span style="color: #008000;">'categorical'</span>, <span style="color: #008000;">'all'</span>: {<span style="color: #008000;">'type'</span>: <span style="color: #008000;">'zero'</span>}} <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">imputation rules</span>
)

<span style="color: #BA36A5;">st</span> = SpacetimeAggregation([inspection_types], <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">The Categorical object</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> from_obj=<span style="color: #008000;">'triage.test'</span>, <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">FROM</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> groups=[<span style="color: #008000;">'entity_id'</span>,<span style="color: #008000;">'zip_code'</span>],  <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">GROUP BY</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> dates=[<span style="color: #008000;">"2014-10-06"</span>,
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;">"2014-10-08"</span>,
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;">"2015-01-12"</span>,
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;">"2015-10-20"</span>,
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;">"2016-10-17"</span>], <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">AS OF DATES, This comes from Timechop, are used as 'WHERE date = ...'</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> intervals={<span style="color: #008000;">"entity_id"</span>: [<span style="color: #008000;">"1y"</span>], <span style="color: #008000;">"zip_code"</span>: [<span style="color: #008000;">"1y"</span>]}, <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">This will be used as the intervals in the past of the AS OF DATE</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> date_column=<span style="color: #008000;">"date"</span>, <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Which is the name of the date column?</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> state_table=<span style="color: #008000;">'triage.active_facilities'</span>, <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">State table name</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> state_group=<span style="color: #008000;">'entity_id'</span>, <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Which is the column that identifies the entity</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> output_date_column=<span style="color: #008000;">'date'</span>,
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> schema=<span style="color: #008000;">'triage'</span>, <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">In which schema do you want to store the results?</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> prefix=<span style="color: #008000;">'inspection_type'</span>
)

st.execute(db_connection)
</pre>
</div>

<p>
This will create, as you probably guessed, four new tables:
<code>inspection_type_{entity_id, zip_code, aggregation, aggregation_imputed}</code>
</p>


<p>
Or you can mix the two in one step:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #BA36A5;">st</span> = SpacetimeAggregation([risks,inspection_types], <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">The Categorical object</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> from_obj=<span style="color: #008000;">'triage.test'</span>, <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">FROM</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> groups=[<span style="color: #008000;">'entity_id'</span>,<span style="color: #008000;">'zip_code'</span>],  <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">GROUP BY</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> dates=[<span style="color: #008000;">"2014-10-06"</span>,
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;">"2014-10-08"</span>,
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;">"2015-01-12"</span>,
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;">"2015-10-20"</span>,
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;">"2016-10-17"</span>], <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">AS OF DATES, This comes from Timechop, are used as 'WHERE date = ...'</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> intervals={<span style="color: #008000;">"entity_id"</span>: [<span style="color: #008000;">"1y"</span>], <span style="color: #008000;">"zip_code"</span>: [<span style="color: #008000;">"1y"</span>]}, <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">This will be used as the intervals in the past of the AS OF DATE</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> date_column=<span style="color: #008000;">"date"</span>, <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Which is the name of the date column?</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> state_table=<span style="color: #008000;">'triage.active_facilities'</span>, <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">State table name</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> state_group=<span style="color: #008000;">'entity_id'</span>, <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Which is the column that identifies the entity</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> output_date_column=<span style="color: #008000;">'date'</span>,
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> schema=<span style="color: #008000;">'triage'</span>, <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">In which schema do you want to store the results?</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> prefix=<span style="color: #008000;">'both'</span>
)

st.execute(db_connection)
</pre>
</div>

<p>
Checking the columns inside <code>triage.both_aggregation</code> , you will note
that all the previous columns are there (except for the prefix):
</p>

<div class="org-src-container">
<pre class="src src-sql">\d triage.both_aggregation
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Table "triage.both_aggregation"</th>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">&#xa0;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Column</td>
<td class="org-left">Type</td>
<td class="org-left">Modifiers</td>
</tr>

<tr>
<td class="org-left">zip_code</td>
<td class="org-left">character varying</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">date</td>
<td class="org-left">date</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">entity_id</td>
<td class="org-left">bigint</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">both_entity_id_1y_risk_high_avg</td>
<td class="org-left">numeric</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">both_entity_id_1y_risk_medium_avg</td>
<td class="org-left">numeric</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">both_entity_id_1y_risk_low_avg</td>
<td class="org-left">numeric</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">both_entity_id_1y_inspection_type_canvass_sum</td>
<td class="org-left">bigint</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">both_entity_id_1y_inspection_type_complaint_sum</td>
<td class="org-left">bigint</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">both_zip_code_1y_risk_high_avg</td>
<td class="org-left">numeric</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">both_zip_code_1y_risk_medium_avg</td>
<td class="org-left">numeric</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">both_zip_code_1y_risk_low_avg</td>
<td class="org-left">numeric</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">both_zip_code_1y_inspection_type_canvass_sum</td>
<td class="org-left">bigint</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">both_zip_code_1y_inspection_type_complaint_sum</td>
<td class="org-left">bigint</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>


<p>
Obviously you could want to create more complicated variables, for
example, we have a <code>json</code> column in our <code>semantic.events</code> table, as well
as a geographical column: <code>location</code>. Let's do create some features
using those.
</p>
</div>


<div id="outline-container-org6975f3a" class="outline-3">
<h3 id="org6975f3a"><span class="section-number-3">7.1</span> Add number of violations by severity</h3>
<div class="outline-text-3" id="text-7-1">
<p>
Our <code>semantic.events</code> has a <code>json</code> column called <code>violations</code>. We will like
to have an idea of how many types of violations were inspected or at
least their severity. One way of do that is shown in the next <code>SQL</code> code:
</p>


<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">select</span> inspection, entity_id, zip_code, array_agg(obj -&gt;&gt; <span style="color: #008000;">'severity'</span>),
<span style="color: #006FE0;">count</span>(*) filter (<span style="color: #0000FF;">where</span> obj -&gt;&gt; <span style="color: #008000;">'severity'</span> = <span style="color: #008000;">'critical'</span>) <span style="color: #0000FF;">as</span> critical_violations,
<span style="color: #006FE0;">count</span>(*) filter (<span style="color: #0000FF;">where</span> obj -&gt;&gt; <span style="color: #008000;">'severity'</span> = <span style="color: #008000;">'serious'</span>) <span style="color: #0000FF;">as</span> serious_violations,
<span style="color: #006FE0;">count</span>(*) filter (<span style="color: #0000FF;">where</span> obj -&gt;&gt; <span style="color: #008000;">'severity'</span> = <span style="color: #008000;">'minor'</span>) <span style="color: #0000FF;">as</span> low_violations
<span style="color: #0000FF;">from</span>
(<span style="color: #0000FF;">select</span> inspection, entity_id, zip_code, jsonb_array_elements(violations::jsonb) <span style="color: #0000FF;">as</span> obj <span style="color: #0000FF;">from</span> triage.test)
<span style="color: #0000FF;">as</span> t1
<span style="color: #0000FF;">group</span> <span style="color: #0000FF;">by</span> inspection, entity_id, zip_code
<span style="color: #0000FF;">limit</span> 5
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">inspection</th>
<th scope="col" class="org-right">entity_id</th>
<th scope="col" class="org-right">zip_code</th>
<th scope="col" class="org-left">array_agg</th>
<th scope="col" class="org-right">critical_violations</th>
<th scope="col" class="org-right">serious_violations</th>
<th scope="col" class="org-right">low_violations</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">1076221</td>
<td class="org-right">9547</td>
<td class="org-right">60621</td>
<td class="org-left">{minor,minor,minor}</td>
<td class="org-right">0</td>
<td class="org-right">0</td>
<td class="org-right">3</td>
</tr>

<tr>
<td class="org-right">1150580</td>
<td class="org-right">9547</td>
<td class="org-right">60621</td>
<td class="org-left">{minor,minor,minor,minor,minor}</td>
<td class="org-right">0</td>
<td class="org-right">0</td>
<td class="org-right">5</td>
</tr>

<tr>
<td class="org-right">1150633</td>
<td class="org-right">9547</td>
<td class="org-right">60621</td>
<td class="org-left">{minor,minor,minor,minor}</td>
<td class="org-right">0</td>
<td class="org-right">0</td>
<td class="org-right">4</td>
</tr>

<tr>
<td class="org-right">1150878</td>
<td class="org-right">9547</td>
<td class="org-right">60621</td>
<td class="org-left">{minor,minor,minor,minor}</td>
<td class="org-right">0</td>
<td class="org-right">0</td>
<td class="org-right">4</td>
</tr>

<tr>
<td class="org-right">1150936</td>
<td class="org-right">9547</td>
<td class="org-right">60621</td>
<td class="org-left">{minor,minor,minor}</td>
<td class="org-right">0</td>
<td class="org-right">0</td>
<td class="org-right">3</td>
</tr>
</tbody>
</table>

<p>
Basically, this code gives us the number of violations inspected by
severity. How about to get the total and proportion of violations in a
facility in the previous year and the average and standard deviation
for the zip code zone?  Note than in this case the variable is not
<b>categorical</b>, is a numeric one, fortunately <code>collate</code> also provides
support for numerical variables: the <code>Aggregate</code> object
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #0000FF;">from</span>  triage.component.collate <span style="color: #0000FF;">import</span> Aggregate


<span style="color: #BA36A5;">violations_sql</span> = <span style="color: #008000;">"""</span>
<span style="color: #008000;">(</span>
<span style="color: #008000;">select inspection, entity_id, zip_code, date,</span>
<span style="color: #008000;">count(*) filter (where obj -&gt;&gt; 'severity' = 'critical') as critical_violations,</span>
<span style="color: #008000;">count(*) filter (where obj -&gt;&gt; 'severity' = 'serious') as serious_violations,</span>
<span style="color: #008000;">count(*) filter (where obj -&gt;&gt; 'severity' = 'minor') as low_violations</span>
<span style="color: #008000;">from</span>
<span style="color: #008000;">(select inspection, entity_id, zip_code, date, jsonb_array_elements(violations::jsonb) as obj from triage.test)</span>
<span style="color: #008000;">as t1</span>
<span style="color: #008000;">group by inspection, entity_id, zip_code, date</span>
<span style="color: #008000;">) as t</span>
<span style="color: #008000;">"""</span>

<span style="color: #BA36A5;">critical_violations</span> = Aggregate({<span style="color: #008000;">'critical'</span>: <span style="color: #008000;">'critical_violations'</span>}, [<span style="color: #008000;">'sum'</span>, <span style="color: #008000;">'avg'</span>, <span style="color: #008000;">'stddev'</span>], {<span style="color: #008000;">'coltype'</span>:<span style="color: #008000;">'aggregate'</span>, <span style="color: #008000;">'all'</span>: {<span style="color: #008000;">'type'</span>: <span style="color: #008000;">'mean'</span>}})
<span style="color: #BA36A5;">serious_violations</span> = Aggregate({<span style="color: #008000;">'serious'</span>: <span style="color: #008000;">'serious_violations'</span>}, [<span style="color: #008000;">'sum'</span>, <span style="color: #008000;">'avg'</span>, <span style="color: #008000;">'stddev'</span>], {<span style="color: #008000;">'coltype'</span>:<span style="color: #008000;">'aggregate'</span>, <span style="color: #008000;">'all'</span>: {<span style="color: #008000;">'type'</span>: <span style="color: #008000;">'mean'</span>}})
<span style="color: #BA36A5;">low_violations</span> = Aggregate({<span style="color: #008000;">'low'</span>: <span style="color: #008000;">'low_violations'</span>}, [<span style="color: #008000;">'sum'</span>, <span style="color: #008000;">'avg'</span>, <span style="color: #008000;">'stddev'</span>], {<span style="color: #008000;">'coltype'</span>:<span style="color: #008000;">'aggregate'</span>, <span style="color: #008000;">'all'</span>: {<span style="color: #008000;">'type'</span>: <span style="color: #008000;">'mean'</span>}})

<span style="color: #BA36A5;">st</span> = SpacetimeAggregation([critical_violations, serious_violations, low_violations], <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">The Categorical object</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> from_obj=violations_sql, <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">FROM</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> groups=[<span style="color: #008000;">'entity_id'</span>,<span style="color: #008000;">'zip_code'</span>, <span style="color: #008000;">'inspection'</span>],  <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">GROUP BY</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> dates=[<span style="color: #008000;">"2014-10-06"</span>,
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;">"2014-10-08"</span>,
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;">"2015-01-12"</span>,
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;">"2015-10-20"</span>,
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;">"2016-10-17"</span>], <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">AS OF DATES, This comes from Timechop, are used as 'WHERE date = ...'</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> intervals={<span style="color: #008000;">"entity_id"</span>: [<span style="color: #008000;">"1y"</span>], <span style="color: #008000;">"zip_code"</span>: [<span style="color: #008000;">"1y"</span>], <span style="color: #008000;">"inspection"</span>: [<span style="color: #008000;">"0d"</span>]}, <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">This will be used as the intervals in the past of the AS OF DATE</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> date_column=<span style="color: #008000;">"date"</span>, <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Which is the name of the date column?</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> state_table=<span style="color: #008000;">'triage.active_facilities'</span>, <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">State table name</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> state_group=<span style="color: #008000;">'entity_id'</span>, <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Which is the column that identifies the entity</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> output_date_column=<span style="color: #008000;">'date'</span>,
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> schema=<span style="color: #008000;">'triage'</span>, <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">In which schema do you want to store the results?</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> prefix=<span style="color: #008000;">'violations'</span>
)

st.execute(db_connection)

</pre>
</div>

<p>
We can inspect the generated <code>SQL</code>:
</p>


<pre class="example">
...

SELECT entity_id, '2014-10-06'::date AS date,
sum(critical_violations) FILTER (WHERE date &gt;= '2014-10-06'::date - interval '1y') AS violations_entity_id_1y_critical_sum,
avg(critical_violations) FILTER (WHERE date &gt;= '2014-10-06'::date - interval '1y') AS violations_entity_id_1y_critical_avg,
stddev(critical_violations) FILTER (WHERE date &gt;= '2014-10-06'::date - interval '1y') AS violations_entity_id_1y_critical_stddev,
sum(serious_violations) FILTER (WHERE date &gt;= '2014-10-06'::date - interval '1y') AS violations_entity_id_1y_serious_sum,
avg(serious_violations) FILTER (WHERE date &gt;= '2014-10-06'::date - interval '1y') AS violations_entity_id_1y_serious_avg,
stddev(serious_violations) FILTER (WHERE date &gt;= '2014-10-06'::date - interval '1y') AS violations_entity_id_1y_serious_stddev,
sum(low_violations) FILTER (WHERE date &gt;= '2014-10-06'::date - interval '1y') AS violations_entity_id_1y_low_sum,
 avg(low_violations) FILTER (WHERE date &gt;= '2014-10-06'::date - interval '1y') AS violations_entity_id_1y_low_avg,
stddev(low_violations) FILTER (WHERE date &gt;= '2014-10-06'::date - interval '1y') AS violations_entity_id_1y_low_stddev
FROM
(
select inspection, entity_id, zip_code, date,
count(*) filter (where obj -&gt;&gt; 'severity' = 'critical') as critical_violations,
count(*) filter (where obj -&gt;&gt; 'severity' = 'serious') as serious_violations,
count(*) filter (where obj -&gt;&gt; 'severity' = 'minor') as low_violations
from
(select inspection, entity_id, zip_code, date, jsonb_array_elements(violations::jsonb) as obj from triage.test)
as t1
group by inspection, entity_id, zip_code, date
) as t
WHERE date &lt; '2014-10-06'AND date &gt;= '2014-10-06'::date - greatest(interval '1y') GROUP BY entity_id

...

</pre>

<p>
You should learn this: it is possible to pass any PostgreSQL <code>table</code>
object to <code>collate</code> (and henceforth to <code>triage</code>), even those which result from a query.
</p>
</div>
</div>


<div id="outline-container-org65c6b14" class="outline-3">
<h3 id="org65c6b14"><span class="section-number-3">7.2</span> Add number of facilities by type in a radius: 1km</h3>
<div class="outline-text-3" id="text-7-2">
<p>
Another possible interesting feature is related to the spatial
surroundings of the facility. Is the facility near of schools or
day cares? or Is the facility located in zones with a lot of people
passing by?
</p>

<p>
In this feature the spatial aggregation is not some socio-political entity
as the zip code or the city limits, but the location
of the facility and the radius that defines the "neighborhood" of the facility.
</p>

<p>
The following query returns the number of facilities in a radius of 1
km around the facility in our example (<code>entity_id</code> 9547).
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">with</span> inspected_facilities <span style="color: #0000FF;">as</span> (
    <span style="color: #0000FF;">select</span> <span style="color: #0000FF;">distinct</span> <span style="color: #0000FF;">on</span> (entity_id, location, facility_type) *
    <span style="color: #0000FF;">from</span> triage.active_facilities
),

facilities_nearby <span style="color: #0000FF;">as</span> (
   <span style="color: #0000FF;">select</span>
   a.entity_id, a.location, a.facility_type,
   b.entity_id <span style="color: #0000FF;">as</span> other_entity_id,
   b.facility_type <span style="color: #0000FF;">as</span> other_facility_type
   <span style="color: #0000FF;">from</span> inspected_facilities <span style="color: #0000FF;">as</span> a,
   <span style="color: #0000FF;">lateral</span> (
       <span style="color: #0000FF;">select</span> entity_id, facility_type
       <span style="color: #0000FF;">from</span> semantic.entities
       <span style="color: #0000FF;">where</span> ST_DWithin(location::geography, a.location::geography, 1000)  <span style="color: #8D8D84; font-style: italic;">-- In meteres, i.e. 1000 m = 1 km</span>
       <span style="color: #0000FF;">and</span> entity_id &lt;&gt; a.entity_id
   ) <span style="color: #0000FF;">as</span> b
)

<span style="color: #0000FF;">select</span>
entity_id,
other_facility_type, <span style="color: #006FE0;">count</span>(*) <span style="color: #0000FF;">as</span> total
<span style="color: #0000FF;">from</span> facilities_nearby
<span style="color: #0000FF;">group</span> <span style="color: #0000FF;">by</span>
entity_id, other_facility_type
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">entity_id</th>
<th scope="col" class="org-left">other_facility_type</th>
<th scope="col" class="org-right">total</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">9547</td>
<td class="org-left">school</td>
<td class="org-right">11</td>
</tr>

<tr>
<td class="org-right">9547</td>
<td class="org-left">convenience store</td>
<td class="org-right">2</td>
</tr>

<tr>
<td class="org-right">9547</td>
<td class="org-left">furniture store</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-right">9547</td>
<td class="org-left">long term care</td>
<td class="org-right">6</td>
</tr>

<tr>
<td class="org-right">9547</td>
<td class="org-left">wholesale</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-right">9547</td>
<td class="org-left">daycare (2 - 6 years)</td>
<td class="org-right">3</td>
</tr>

<tr>
<td class="org-right">9547</td>
<td class="org-left">golden diner</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-right">9547</td>
<td class="org-left">private school</td>
<td class="org-right">2</td>
</tr>

<tr>
<td class="org-right">9547</td>
<td class="org-left">grocery store</td>
<td class="org-right">40</td>
</tr>

<tr>
<td class="org-right">9547</td>
<td class="org-left">restaurant</td>
<td class="org-right">37</td>
</tr>

<tr>
<td class="org-right">9547</td>
<td class="org-left">children's services facility</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-right">9547</td>
<td class="org-left">daycare above and under 2 years</td>
<td class="org-right">4</td>
</tr>

<tr>
<td class="org-right">9547</td>
<td class="org-left">gas station</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-right">9547</td>
<td class="org-left">bakery</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-right">9547</td>
<td class="org-left">unknown</td>
<td class="org-right">23</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #BA36A5;">facilities_nearby_sql</span> = <span style="color: #008000;">"""</span>
<span style="color: #008000;">(</span>
<span style="color: #008000;">with inspected_facilities as (</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;">   select distinct on (entity_id, location, facility_type) *</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;">   from triage.active_facilities</span>
<span style="color: #008000;">),</span>

<span style="color: #008000;">facilities_nearby as (</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;">  select</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;">  a.entity_id, a.location, a.facility_type,</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;">  b.entity_id as other_entity_id,</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;">  b.facility_type as other_facility_type</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;">  from inspected_facilities as a,</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;">  lateral (</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;">   </span><span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;">  select entity_id, facility_type</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;">   </span><span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;">  from semantic.entities</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;">   </span><span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;">  where ST_DWithin(location::geography, a.location::geography, 1000)  -- In meters i.e. 1000 m = 1 km</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;">   </span><span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;">  and entity_id &lt;&gt; a.entity_id</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;">  ) as b</span>
<span style="color: #008000;">)</span>

<span style="color: #008000;">select</span>
<span style="color: #008000;">entity_id,</span>
<span style="color: #008000;">other_facility_type, count(*) as total</span>
<span style="color: #008000;">from facilities_nearby</span>
<span style="color: #008000;">group by</span>
<span style="color: #008000;">entity_id, other_facility_type</span>
<span style="color: #008000;">)</span>
<span style="color: #008000;">"""</span>
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">TODO: Create the correct aggregate Do I need to pivot the table?</span>
<span style="color: #BA36A5;">facilities</span> = Aggregate({})

<span style="color: #BA36A5;">st</span> = SpacetimeAggregation([critical_violations, serious_violations, low_violations], <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">The Categorical object</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> from_obj=violations_sql, <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">FROM</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> groups=[<span style="color: #008000;">'entity_id'</span>,<span style="color: #008000;">'zip_code'</span>, <span style="color: #008000;">'inspection'</span>],  <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">GROUP BY</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> dates=[<span style="color: #008000;">"2014-10-06"</span>,
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;">"2014-10-08"</span>,
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;">"2015-01-12"</span>,
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;">"2015-10-20"</span>,
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;">"2016-10-17"</span>], <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">AS OF DATES, This comes from Timechop, are used as 'WHERE date = ...'</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> intervals={<span style="color: #008000;">"entity_id"</span>: [<span style="color: #008000;">"1y"</span>], <span style="color: #008000;">"zip_code"</span>: [<span style="color: #008000;">"1y"</span>], <span style="color: #008000;">"inspection"</span>: [<span style="color: #008000;">"0d"</span>]}, <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">This will be used as the intervals in the past of the AS OF DATE</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> date_column=<span style="color: #008000;">"date"</span>, <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Which is the name of the date column?</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> state_table=<span style="color: #008000;">'triage.all_facilities'</span>, <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">State table name</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> state_group=<span style="color: #008000;">'entity_id'</span>, <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Which is the column that identifies the entity</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> output_date_column=<span style="color: #008000;">'date'</span>,
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> schema=<span style="color: #008000;">'triage'</span>, <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">In which schema do you want to store the results?</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> prefix=<span style="color: #008000;">'violations'</span>
)

st.execute(db_connection)

</pre>
</div>
</div>
</div>


<div id="outline-container-org84fd818" class="outline-3">
<h3 id="org84fd818"><span class="section-number-3">7.3</span> Add number of inspections by type in a radius and in an interval</h3>
<div class="outline-text-3" id="text-7-3">
<p>
Based in the previous example, we can modify a little the question an
ask: How many events happened nearby?
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">with</span> inspected_facilities <span style="color: #0000FF;">as</span> (
    <span style="color: #0000FF;">select</span> <span style="color: #0000FF;">distinct</span> <span style="color: #0000FF;">on</span> (entity_id, location, facility_type) *
    <span style="color: #0000FF;">from</span> triage.active_facilities
),

inspections_nearby <span style="color: #0000FF;">as</span> (
   <span style="color: #0000FF;">select</span>
   a.entity_id,
   b.inspection, b.<span style="color: #0000FF;">type</span>, b.<span style="color: #0000FF;">result</span>, b.entity_id <span style="color: #0000FF;">as</span> other_entity_id,
   b.facility_type <span style="color: #0000FF;">as</span> other_facility_type, b.<span style="color: #6434A3;">date</span>
   <span style="color: #0000FF;">from</span> inspected_facilities <span style="color: #0000FF;">as</span> a,
   <span style="color: #0000FF;">lateral</span> (
       <span style="color: #0000FF;">select</span> inspection, <span style="color: #0000FF;">type</span>, <span style="color: #0000FF;">result</span>, entity_id, facility_type, <span style="color: #6434A3;">date</span>
       <span style="color: #0000FF;">from</span> semantic.events
       <span style="color: #0000FF;">where</span> ST_DWithin(location::geography, a.location::geography, 1000)  <span style="color: #8D8D84; font-style: italic;">-- In meteres, i.e. 1000 m = 1 km</span>
       <span style="color: #0000FF;">and</span> entity_id &lt;&gt; a.entity_id
   ) <span style="color: #0000FF;">as</span> b
)

<span style="color: #0000FF;">select</span> * <span style="color: #0000FF;">from</span> inspections_nearby <span style="color: #0000FF;">limit</span> 10;

<span style="color: #8D8D84; font-style: italic;">-- select</span>
<span style="color: #8D8D84; font-style: italic;">-- entity_id, inspection, type as inpection</span>
<span style="color: #8D8D84; font-style: italic;">-- other_facility_type, count(*) as total</span>
<span style="color: #8D8D84; font-style: italic;">-- from inspections_nearby</span>
<span style="color: #8D8D84; font-style: italic;">-- group by</span>
<span style="color: #8D8D84; font-style: italic;">-- entity_id, other_facility_type</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">entity_id</th>
<th scope="col" class="org-right">inspection</th>
<th scope="col" class="org-left">type</th>
<th scope="col" class="org-left">result</th>
<th scope="col" class="org-right">other_entity_id</th>
<th scope="col" class="org-left">other_facility_type</th>
<th scope="col" class="org-right">date</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">9547</td>
<td class="org-right">920206</td>
<td class="org-left">complaint</td>
<td class="org-left">pass</td>
<td class="org-right">1811</td>
<td class="org-left">grocery store</td>
<td class="org-right">2012-02-24</td>
</tr>

<tr>
<td class="org-right">9547</td>
<td class="org-right">545345</td>
<td class="org-left">complaint</td>
<td class="org-left">fail</td>
<td class="org-right">1811</td>
<td class="org-left">grocery store</td>
<td class="org-right">2011-05-11</td>
</tr>

<tr>
<td class="org-right">9547</td>
<td class="org-right">670596</td>
<td class="org-left">complaint</td>
<td class="org-left">fail</td>
<td class="org-right">1811</td>
<td class="org-left">grocery store</td>
<td class="org-right">2012-02-17</td>
</tr>

<tr>
<td class="org-right">9547</td>
<td class="org-right">545365</td>
<td class="org-left">complaint</td>
<td class="org-left">pass</td>
<td class="org-right">1811</td>
<td class="org-left">grocery store</td>
<td class="org-right">2011-05-19</td>
</tr>

<tr>
<td class="org-right">9547</td>
<td class="org-right">1955217</td>
<td class="org-left">canvass</td>
<td class="org-left">pass</td>
<td class="org-right">1811</td>
<td class="org-left">grocery store</td>
<td class="org-right">2016-09-08</td>
</tr>

<tr>
<td class="org-right">9547</td>
<td class="org-right">2081502</td>
<td class="org-left">complaint</td>
<td class="org-left">pass</td>
<td class="org-right">1811</td>
<td class="org-left">grocery store</td>
<td class="org-right">2017-09-05</td>
</tr>

<tr>
<td class="org-right">9547</td>
<td class="org-right">545517</td>
<td class="org-left">complaint</td>
<td class="org-left">pass</td>
<td class="org-right">1811</td>
<td class="org-left">grocery store</td>
<td class="org-right">2011-09-08</td>
</tr>

<tr>
<td class="org-right">9547</td>
<td class="org-right">1386161</td>
<td class="org-left">complaint</td>
<td class="org-left">fail</td>
<td class="org-right">1811</td>
<td class="org-left">grocery store</td>
<td class="org-right">2015-05-27</td>
</tr>

<tr>
<td class="org-right">9547</td>
<td class="org-right">1386181</td>
<td class="org-left">complaint</td>
<td class="org-left">pass w/ conditions</td>
<td class="org-right">1811</td>
<td class="org-left">grocery store</td>
<td class="org-right">2015-06-04</td>
</tr>

<tr>
<td class="org-right">9547</td>
<td class="org-right">531602</td>
<td class="org-left">canvass</td>
<td class="org-left">pass</td>
<td class="org-right">2111</td>
<td class="org-left">long term care</td>
<td class="org-right">2011-10-06</td>
</tr>
</tbody>
</table>




<p>
QUESTION: Is this the correct SQL? (at least is fast)
IDEA: We could precalculate the distances? And from that filter by date?
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #0000FF;">with</span> inspected_same_day <span style="color: #0000FF;">as</span> (
 <span style="color: #0000FF;">select</span>
   a.inspection, a.entity_id, a.location, a.facility_type, a.<span style="color: #6434A3;">date</span>,
   b.inspection <span style="color: #0000FF;">as</span> other_inspection, b.facility_type <span style="color: #0000FF;">as</span> other_facility_type, b.location <span style="color: #0000FF;">as</span> other_location
   <span style="color: #0000FF;">from</span> triage.test <span style="color: #0000FF;">as</span> a,
   <span style="color: #0000FF;">lateral</span> (
      <span style="color: #0000FF;">select</span> inspection, entity_id, location, facility_type, <span style="color: #6434A3;">date</span>
      <span style="color: #0000FF;">from</span> semantic.events
      <span style="color: #0000FF;">where</span> inspection &lt;&gt; a.inspection
      <span style="color: #0000FF;">and</span> <span style="color: #6434A3;">date</span> = a.<span style="color: #6434A3;">date</span>
   ) <span style="color: #0000FF;">as</span> b
),

inspections_nearby <span style="color: #0000FF;">as</span> (
   <span style="color: #0000FF;">select</span>
   inspection, entity_id, location, facility_type,
   other_facility_type, <span style="color: #6434A3;">date</span>
   <span style="color: #0000FF;">from</span> inspected_same_day
   <span style="color: #0000FF;">where</span>
       ST_DWithin(location::geography, other_location::geography, 1000)
)

<span style="color: #0000FF;">select</span>
inspection, entity_id, location, facility_type,
other_facility_type, <span style="color: #6434A3;">date</span>, <span style="color: #006FE0;">count</span>(*)
<span style="color: #0000FF;">from</span> inspections_nearby
<span style="color: #0000FF;">group</span> <span style="color: #0000FF;">by</span>
inspection, entity_id, location, facility_type, other_facility_type, <span style="color: #6434A3;">date</span>
<span style="color: #0000FF;">limit</span> 10
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">inspection</th>
<th scope="col" class="org-right">entity_id</th>
<th scope="col" class="org-left">location</th>
<th scope="col" class="org-left">facility_type</th>
<th scope="col" class="org-left">other_facility_type</th>
<th scope="col" class="org-right">date</th>
<th scope="col" class="org-right">count</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">1150878</td>
<td class="org-right">9547</td>
<td class="org-left">0101000020E6100000BF53EAB21DE855C0EC6799AE73E24440</td>
<td class="org-left">restaurant</td>
<td class="org-left">restaurant</td>
<td class="org-right">2012-10-26</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-right">1150878</td>
<td class="org-right">9547</td>
<td class="org-left">0101000020E6100000BF53EAB21DE855C0EC6799AE73E24440</td>
<td class="org-left">restaurant</td>
<td class="org-left">school</td>
<td class="org-right">2012-10-26</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-right">1335951</td>
<td class="org-right">9547</td>
<td class="org-left">0101000020E6100000BF53EAB21DE855C0EC6799AE73E24440</td>
<td class="org-left">restaurant</td>
<td class="org-left">restaurant</td>
<td class="org-right">2013-06-06</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-right">1335951</td>
<td class="org-right">9547</td>
<td class="org-left">0101000020E6100000BF53EAB21DE855C0EC6799AE73E24440</td>
<td class="org-left">restaurant</td>
<td class="org-left">school</td>
<td class="org-right">2013-06-06</td>
<td class="org-right">2</td>
</tr>

<tr>
<td class="org-right">1353423</td>
<td class="org-right">9547</td>
<td class="org-left">0101000020E6100000BF53EAB21DE855C0EC6799AE73E24440</td>
<td class="org-left">restaurant</td>
<td class="org-left">grocery store</td>
<td class="org-right">2013-07-01</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-right">1360667</td>
<td class="org-right">9547</td>
<td class="org-left">0101000020E6100000BF53EAB21DE855C0EC6799AE73E24440</td>
<td class="org-left">restaurant</td>
<td class="org-left">grocery store</td>
<td class="org-right">2013-09-04</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-right">1591635</td>
<td class="org-right">9547</td>
<td class="org-left">0101000020E6100000BF53EAB21DE855C0EC6799AE73E24440</td>
<td class="org-left">restaurant</td>
<td class="org-left">grocery store</td>
<td class="org-right">2015-12-14</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-right">1657238</td>
<td class="org-right">9547</td>
<td class="org-left">0101000020E6100000BF53EAB21DE855C0EC6799AE73E24440</td>
<td class="org-left">restaurant</td>
<td class="org-left">restaurant</td>
<td class="org-right">2016-02-25</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-right">401429</td>
<td class="org-right">9547</td>
<td class="org-left">0101000020E6100000BF53EAB21DE855C0EC6799AE73E24440</td>
<td class="org-left">restaurant</td>
<td class="org-left">gas station</td>
<td class="org-right">2011-01-13</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-right">401429</td>
<td class="org-right">9547</td>
<td class="org-left">0101000020E6100000BF53EAB21DE855C0EC6799AE73E24440</td>
<td class="org-left">restaurant</td>
<td class="org-left">wholesale</td>
<td class="org-right">2011-01-13</td>
<td class="org-right">1</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #BA36A5;">inspections_nearby_sql</span> = <span style="color: #008000;">"""</span>
<span style="color: #008000;">with inspections_nearby as (</span>
<span style="color: #008000;">with inspected_same_day as (</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;">select</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;">  a.inspection, a.entity_id, a.location, a.facility_type, a.date,</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;">  b.inspection as other_inspection, b.facility_type as other_facility_type, b.location as other_location</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;">  from triage.test as a,</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;">  lateral (</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;">   </span><span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;"> select inspection, entity_id, location, facility_type, date</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;">   </span><span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;"> from semantic.events</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;">   </span><span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;"> where inspection &lt;&gt; a.inspection</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;">   </span><span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;"> and date = a.date</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;">  ) as c</span>
<span style="color: #008000;">),</span>

<span style="color: #008000;">inspections_nearby as (</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;">  select</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;">  inspection, entity_id, location, facility_type,</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;">  other_facility_type, date</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;">  from inspected_same_day</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;">  where</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;">   </span><span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;">  ST_DWithin(location::geography, other_location::geography, 1000)</span>
<span style="color: #008000;">)</span>

<span style="color: #008000;">select</span>
<span style="color: #008000;">inspection, entity_id, location, facility_type,</span>
<span style="color: #008000;">other_facility_type, date, count(*)</span>
<span style="color: #008000;">from inspections_nearby</span>
<span style="color: #008000;">group by</span>
<span style="color: #008000;">inspection, entity_id, location, facility_type, other_facility_type, date</span>
<span style="color: #008000;">) as b</span>
<span style="color: #008000;">"""</span>

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">TODO: Create the correct aggregate Do I need to pivot the table?</span>
<span style="color: #BA36A5;">facilities</span> = Aggregate({})

<span style="color: #BA36A5;">st</span> = SpacetimeAggregation([critical_violations, serious_violations, low_violations], <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">The Categorical object</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> from_obj=violations_sql, <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">FROM</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> groups=[<span style="color: #008000;">'entity_id'</span>,<span style="color: #008000;">'zip_code'</span>, <span style="color: #008000;">'inspection'</span>],  <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">GROUP BY</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> dates=[<span style="color: #008000;">"2014-10-06"</span>,
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;">"2014-10-08"</span>,
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;">"2015-01-12"</span>,
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;">"2015-10-20"</span>,
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span><span style="color: #008000;">"2016-10-17"</span>], <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">AS OF DATES, This comes from Timechop, are used as 'WHERE date = ...'</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> intervals={<span style="color: #008000;">"entity_id"</span>: [<span style="color: #008000;">"1y"</span>], <span style="color: #008000;">"zip_code"</span>: [<span style="color: #008000;">"1y"</span>], <span style="color: #008000;">"inspection"</span>: [<span style="color: #008000;">"0d"</span>]}, <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">This will be used as the intervals in the past of the AS OF DATE</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> date_column=<span style="color: #008000;">"date"</span>, <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Which is the name of the date column?</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> state_table=<span style="color: #008000;">'triage.all_facilities'</span>, <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">State table name</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> state_group=<span style="color: #008000;">'entity_id'</span>, <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Which is the column that identifies the entity</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> output_date_column=<span style="color: #008000;">'date'</span>,
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> schema=<span style="color: #008000;">'triage'</span>, <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">In which schema do you want to store the results?</span>
<span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span>   <span style="color: #9B9B9B; background-color: #EDEDED;"> </span> prefix=<span style="color: #008000;">'violations'</span>
)

st.execute(db_connection)

</pre>
</div>




<p>
<code>================</code>
</p>


<p>
You can use the docker image provider for getting an image about the
temporal blocks configuration, for example <a href="src/inspections_test.yaml">inspections_test.yaml</a> has the following temporal structure:
</p>


<div class="org-src-container">
<pre class="src src-sh">./tutorial.sh triage --config_file inspections_test.yaml show_temporal_blocks
</pre>
</div>

<p>
Creating experiment object
Experiment loaded
Generating temporal blocks image
Image stored in:
/code/inspections_test.png
</p>


<div class="figure">
<p><img src="./src/inspections_test.png" alt="inspections_test.png" />
</p>
</div>
</div>
</div>


<div id="outline-container-orgcc2352b" class="outline-3">
<h3 id="orgcc2352b"><span class="section-number-3">7.4</span> The <code>Experiment</code> object</h3>
<div class="outline-text-3" id="text-7-4">
<p>
Everything revolves around the <code>experiment</code> object. You can validate
an <code>experiment</code> as follows:
</p>

<div class="org-src-container">
<pre class="src src-sh">./tutorial.sh triage --config_file /code/inspections_test.yaml validate
</pre>
</div>

<p>
Creating experiment object
Experiment loaded
Validating experiment's configuration
</p>

<p>
If you are ready for run it, you could start your experiment with:
</p>

<div class="org-src-container">
<pre class="src src-sh">./tutorial.sh triage --config_file /code/inspections_test.yaml run
</pre>
</div>


<p>
TODO: What is the meaning of the average on collate?
</p>
</div>
</div>
</div>

<div id="outline-container-org0867a49" class="outline-2">
<h2 id="org0867a49"><span class="section-number-2">8</span> Appendix: For the impatient</h2>
<div class="outline-text-2" id="text-8">
<p>
If you want to skip all the cleansing and transformation you can
execute the following:
</p>

<div class="org-src-container">
<pre class="src src-sh">     curl <span style="color: #008000;">"https://data.cityofchicago.org/api/views/4ijn-s7e5/rows.csv?accessType=DOWNLOAD"</span> &gt; data/inspections.csv

     psql ${<span style="color: #BA36A5;">FOOD_DB_URL</span>} -c <span style="color: #008000;">"\copy raw.inspections FROM '/data/inspections.csv' WITH HEADER CSV"</span>

     psql ${<span style="color: #BA36A5;">FOOD_DB_URL</span>} &lt; /sql/create_cleaned_inspections_table.sql

     psql ${<span style="color: #BA36A5;">FOOD_DB_URL</span>} &lt; /sql/create_violations_table.sql

     psql ${<span style="color: #BA36A5;">FOOD_DB_URL</span>} &lt; /sql/create_semantic_tables.sql
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org">CREATE SCHEMA
DROP TABLE
SELECT 164178
DROP TABLE
SELECT 618060
CREATE SCHEMA
DROP TABLE
SELECT 34812
CREATE INDEX
CREATE INDEX
CREATE INDEX
CREATE INDEX
CREATE INDEX
CREATE INDEX
CREATE INDEX
DROP TABLE
SELECT 141721
CREATE INDEX
CREATE INDEX
CREATE INDEX
CREATE INDEX
CREATE INDEX
CREATE INDEX
CREATE INDEX
CREATE INDEX
CREATE INDEX
CREATE INDEX
</pre>
</div>


<p>
If everything works, you should end with two new schemas: <code>cleaned</code> and <code>semantic</code>.
</p>

<p>
You could check that (from <code>psql</code>) With
</p>
<div class="org-src-container">
<pre class="src src-sql">\dn
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">List of schemas</th>
<th scope="col" class="org-left">&#xa0;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Name</td>
<td class="org-left">Owner</td>
</tr>

<tr>
<td class="org-left">cleaned</td>
<td class="org-left">food_user</td>
</tr>

<tr>
<td class="org-left">postgis</td>
<td class="org-left">food_user</td>
</tr>

<tr>
<td class="org-left">public</td>
<td class="org-left">postgres</td>
</tr>

<tr>
<td class="org-left">raw</td>
<td class="org-left">food_user</td>
</tr>

<tr>
<td class="org-left">semantic</td>
<td class="org-left">food_user</td>
</tr>
</tbody>
</table>

<p>
If you want to do a little of EDA go to <a href="data_exploration.html">Knowing your data</a> or if you
are really impatient go straight  to <a href="triage_intro.html">Introduction to triage</a>. 
</p>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1">1</a></sup> <div class="footpara"><p class="footpara">
This dataset  has been   used in several examples around the
web (e.g. <a href="https://chicago.github.io/food-inspections-evaluation/">here</a>,  <a href="https://youtu.be/lyDLAutA88s">here</a> or <a href="https://youtu.be/1dKonIT-Yak">here</a>) 
</p></div></div>

<div class="footdef"><sup><a id="fn.2" class="footnum" href="#fnr.2">2</a></sup> <div class="footpara"><p class="footpara">
Examples of this type of problems are: <a href="http://dsapp.uchicago.edu/projects/environment/">Predictive Enforcement
of Hazardous Waste Regulations</a> , <a href="http://dsapp.uchicago.edu/projects/health/lead-prevention/">Targeting Proactive Inspections for Lead Hazards</a>
</p></div></div>

<div class="footdef"><sup><a id="fn.3" class="footnum" href="#fnr.3">3</a></sup> <div class="footpara"><p class="footpara">
In DSaPP we frequently work with partners in problems of this
kind for example: <a href="http://dsapp.uchicago.edu/projects/education/">Increasing High School Graduation Rates: Early
Warnings and Predictive Systems</a>, <a href="http://dsapp.uchicago.edu/projects/public-safety/police-eis/">Building Data-Driven Early
Intervention Systems for Police Officers</a>, <a href="http://dsapp.uchicago.edu/projects/criminal-justice/data-driven-justice-initiative/">Data-Driven Justice
Initiative: Identifying Frequent Users of Multiple 
Public Systems for More Effective Early Assistance</a> 
</p></div></div>

<div class="footdef"><sup><a id="fn.4" class="footnum" href="#fnr.4">4</a></sup> <div class="footpara"><p class="footpara">
See the definitions below
</p></div></div>

<div class="footdef"><sup><a id="fn.5" class="footnum" href="#fnr.5">5</a></sup> <div class="footpara"><p class="footpara">
Reproducible, reportable, scalable, flexible, etc.
</p></div></div>

<div class="footdef"><sup><a id="fn.6" class="footnum" href="#fnr.6">6</a></sup> <div class="footpara"><p class="footpara">
And other things through this tutorial, like the execution of
the model training, etc.
</p></div></div>

<div class="footdef"><sup><a id="fn.7" class="footnum" href="#fnr.7">7</a></sup> <div class="footpara"><p class="footpara">
If you have already installed a postgresql client you could use <code>psql -h 0.0.0.0 -p 5434 -d food -U food_user</code> instead, and not use the <code>bastion</code> container.
</p></div></div>

<div class="footdef"><sup><a id="fn.8" class="footnum" href="#fnr.8">8</a></sup> <div class="footpara"><p class="footpara">
You'll probably get a different number the data is updated every day.
</p></div></div>

<div class="footdef"><sup><a id="fn.9" class="footnum" href="#fnr.9">9</a></sup> <div class="footpara"><p class="footpara">
<i>ibid</i>
</p></div></div>

<div class="footdef"><sup><a id="fn.10" class="footnum" href="#fnr.10">10</a></sup> <div class="footpara"><p class="footpara">
If you are connected to the database, you could just type <code>select count(*) from raw.inspections</code>
</p></div></div>

<div class="footdef"><sup><a id="fn.11" class="footnum" href="#fnr.11">11</a></sup> <div class="footpara"><p class="footpara">
You could check that using the command <code>head</code> on <code>/data/inspections.csv</code>
</p></div></div>

<div class="footdef"><sup><a id="fn.12" class="footnum" href="#fnr.12">12</a></sup> <div class="footpara"><p class="footpara">
It will make your life easier and most of the Machine Learning
algorithms only accept data in matrix form (i.e. one big table)
</p></div></div>

<div class="footdef"><sup><a id="fn.13" class="footnum" href="#fnr.13">13</a></sup> <div class="footpara"><p class="footpara">
Verbatim from the datasource documentation
</p></div></div>

<div class="footdef"><sup><a id="fn.14" class="footnum" href="#fnr.14">14</a></sup> <div class="footpara"><p class="footpara">
This problem is related to the process of <i>deduplication</i> and there will be another tutorial 
for that that uses anothe DSaPP tool: <code>pgdedup</code>.
</p></div></div>

<div class="footdef"><sup><a id="fn.15" class="footnum" href="#fnr.15">15</a></sup> <div class="footpara"><p class="footpara">
It is the <i>Chicago</i> Food Inspections dataset
</p></div></div>

<div class="footdef"><sup><a id="fn.16" class="footnum" href="#fnr.16">16</a></sup> <div class="footpara"><p class="footpara">
We will store the <code>Point</code> as a <code>geography</code> object, in this way
all the spatial operation (like calculating the distances between two
facilities) will return answers in meters instead of degrees See for
example <a href="http://workshops.boundlessgeo.com/postgis-intro/geography.html">this.</a>
</p></div></div>

<div class="footdef"><sup><a id="fn.17" class="footnum" href="#fnr.17">17</a></sup> <div class="footpara"><p class="footpara">
As a real geographical object <a href="https://postgis.net/docs/ST_MakePoint.html">check the PostGIS documentation</a>
</p></div></div>

<div class="footdef"><sup><a id="fn.18" class="footnum" href="#fnr.18">18</a></sup> <div class="footpara"><p class="footpara">
If you want to have a deep explanation about why is this good
check <a href="http://coussej.github.io/2016/01/14/Replacing-EAV-with-JSONB-in-PostgreSQL/">this blog post</a>
</p></div></div>

<div class="footdef"><sup><a id="fn.19" class="footnum" href="#fnr.19">19</a></sup> <div class="footpara"><p class="footpara">
As a general rule I hate to add the suffix <code>_id</code>, I would
rather prefer to name them as <code>event</code> and <code>entity</code> instead of
<code>event_id</code> and <code>entity_id</code>. But <code>triage</code> named those columns in that
way and for that we are stuck with that nomenclature.
</p></div></div>

<div class="footdef"><sup><a id="fn.20" class="footnum" href="#fnr.20">20</a></sup> <div class="footpara"><p class="footpara">
This will simplify the creation of <i>features</i> for our machine learning models.
</p></div></div>

<div class="footdef"><sup><a id="fn.21" class="footnum" href="#fnr.21">21</a></sup> <div class="footpara"><p class="footpara">
We could consider different states, for example: we can use the column
<code>risk</code> as an state. Another possibility is define a new state called
<code>failed</code> that indicates if the facility failed in the last time it was inspected. 
</p></div></div>


</div>
</div></div>
</body>
</html>
