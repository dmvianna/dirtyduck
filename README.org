#+TITLE: Dirty duck: A triage's guided tour
#+AUTHOR: Center of Data Science for Public Policy
#+EMAIL: adolfo@uchicago.edu
#+STARTUP: showeverything
#+STARTUP: nohideblocks
#+PROPERTY: header-args:sql :engine postgresql
#+PROPERTY: header-args:sql+ :dbhost 0.0.0.0
#+PROPERTY: header-args:sql+ :dbport 5434
#+PROPERTY: header-args:sql+ :dbuser food_user
#+PROPERTY: header-args:sql+ :dbpassword some_password
#+PROPERTY: header-args:sql+ :database food
#+PROPERTY: header-args:shell     :results drawer
#+PROPERTY: header-args:ipython   :session food_inspections


* TODOs [0%]

- [ ] Add an introduction
- [ ] Define the entities for both "projects" (*EIS* and *Inspection prioritization*)
- [ ] Define the outcomes for each "project" (*EIS* and *Inspection
  prioritization*)
- [ ] Add some exploration using =sql=
- [ ] Add some visualizations using =python=
- [ ] Explain the concept of a Machine Learning project
- [ ] Explain the concept of Temporal Cross-validation and why it is
  important
- [ ] Explain a little bit of =timechop=
- [ ] SQL for transforming the data in *EIS*
- [ ] Define one or two features for *EIS*
- [ ] Define one or two features for *Inspection prioritization*
- [ ] SQL for transforming the data in *Inspection prioritization*
- [ ] Explain a little bit of =collate=
- [ ] Run one experiment for *EIS*
- [ ] Run one experiment for *Inspection prioritization*
- [ ] Show the results in =tyra=


* Intro

The [[https://data.cityofchicago.org/Health-Human-Services/Food-Inspections/4ijn-s7e5][Chicago's Food Inspections data set]] is well know, and it has been
used in several examples around the web (e.g. [fn:1], [fn:2])




* What do you need for this tutorial?

[[http://www.docker.com][Docker]] and [[https://docs.docker.com/compose/][Docker Compose]] installed. That's it.
Use the links for installing instructions.

* Description of the problem to solve

Actually, We want to solve two problems: an /Early intervention system/ (*EIS*)
and a /Inspection prioritization/.


We will use the /same/ data set, first, we will be the restaurant's
owner, and we want to know: /Will my restaurant be inspected in the/
/next X period of time?/ Where $X$ could be 1 month, 1 week, 1 year,
etc.

Knowing the answer to this question, allows you (as the restaurant's
owner) to be prepared and take the pertinent actions.


The second scenario, is the following:  you work for the Chicago's
government, and you try
to prioritize your resources (i.e. your inspection workforce), since
they are limited. So, you will use the data (the same data set,
remember) for answering the next
question: /Which X restaurants (facilities) are likely to violate some rule in the
following Y period of time?/  In this case maybe you are interested not
in all the violations but in the more grave.

* Infrastructure

Besides data, in most of the data science projects you will need some
other tools, for example a place to store the data (a database
management system), a way
for putting your model to work (an API) and a interface for looking
the performace of your trained models (for this tutorial we are proposing [[https://github.com/dssg/tyra][tyra]])

We are proving a little script for managing all the infrastructure in
a (hopefully) transparent way.

Before creating the infrastructure, change the `your_password`s of the file
`infrastructure/food_db/.env_example`

#+BEGIN_SRC shell :tangle infrastructure/env_example
POSTGRES_DB=food
POSTGRES_HOST=0.0.0.0
POSTGRES_USER=food_user
POSTGRES_DB=food
POSTGRES_PORT=5434
POSTGRES_PASSWORD=your_password

UID=1000
GID=1000
#+END_SRC

And change the name of the file to `.env`. Next run the following command

#+BEGIN_SRC shell
./manage.sh
#+END_SRC

#+RESULTS:
:RESULTS:
Usage: ./manage.sh {start|stop|build|rebuild|run|logs|status}
:END:



We need to create the infrastructure so, =start= it

#+BEGIN_SRC shell
./manage.sh start
#+END_SRC

#+RESULTS:
:RESULTS:
:END:



This will take some minutes the first time.

You can check that everything is running smoothly with =status=

#+BEGIN_SRC shell
./manage.sh status
#+END_SRC

#+RESULTS:
:RESULTS:
        Name                       Command              State                           Ports
----------------------------------------------------------------------------------------------------------------------
food_db                 docker-entrypoint.sh postgres   Up      0.0.0.0:5434->5432/tcp
tutorial_api            python app.py                   Up      0.0.0.0:5000->5000/tcp
tutorial_reverseproxy   nginx -g daemon off;            Up      80/tcp, 0.0.0.0:8081->8081/tcp, 0.0.0.0:8090->8090/tcp
tutorial_tyra           python run_webapp.py            Up      0.0.0.0:5001->5001/tcp
:END:


You can type in your browser [[http://0.0.0.0:5001]] and you will see the
login page from *Tyra*.


Login to the docker container using

#+BEGIN_EXAMPLE shel
./manage.sh bastion
#+END_EXAMPLE

You will see something like:

#+BEGIN_EXAMPLE shell
I have no name!@485373fb3c64:/$
#+END_EXAMPLE

Now the database is running, its named =food_db=, the single table in
there named =inspections=

Let's check the =schema= of =inspections= table, first, type the next
command to connect to the database

#+BEGIN_EXAMPLE shell
psql ${FOOD_DB_URL}
#+END_EXAMPLE

and then, type the following command:

#+BEGIN_SRC sql
\dS+ inspections
#+END_SRC

#+RESULTS:
| Table "public.inspections" |                   |           |          |              |             |
|----------------------------+-------------------+-----------+----------+--------------+-------------|
| Column                     | Type              | Modifiers | Storage  | Stats target | Description |
| inspection                 | character varying | not null  | extended |              |             |
| dba_name                    | character varying |           | extended |              |             |
| aka_name                    | character varying |           | extended |              |             |
| license_num                 | numeric           |           | main     |              |             |
| facility_type               | character varying |           | extended |              |             |
| risk                       | character varying |           | extended |              |             |
| address                    | character varying |           | extended |              |             |
| city                       | character varying |           | extended |              |             |
| state                      | character varying |           | extended |              |             |
| zip                        | character varying |           | extended |              |             |
| date                       | date              |           | plain    |              |             |
| type                       | character varying |           | extended |              |             |
| results                    | character varying |           | extended |              |             |
| violations                 | character varying |           | extended |              |             |
| latitude                   | numeric           |           | main     |              |             |
| longitude                  | numeric           |           | main     |              |             |
| location                   | character varying |           | extended |              |             |

Now, you can disconnect from the database typing =\q=

* Data

** Downloading

#+BEGIN_SRC shell
  curl "https://data.cityofchicago.org/api/views/4ijn-s7e5/rows.csv?accessType=DOWNLOAD" > data/inspections.csv
#+END_SRC

#+RESULTS:
:RESULTS:
:END:

#+BEGIN_SRC shell :dir data
  wc -l inspections.csv
#+END_SRC

#+RESULTS:
:RESULTS:
377168 inspections.csv
:END:

Ok, the data is now in =/data=, we can check how many rows the dataset contains

** Uploading to our database
Assuming that you are already inside =bastion=, run the following


#+BEGIN_SRC sh :dir /docker:root@tutorial_bastion:/ :results raw drawer
psql ${FOOD_DB_URL} -c 'select count(*) from inspections'
#+END_SRC

#+RESULTS:
:RESULTS:
 count
-------
     0
(1 row)

:END:

(If you are connected to the database, you could just type =select count(*) from inspections=

#+RESULTS:
:RESULTS:
 count
-------
     0
(1 row)

:END:



#+BEGIN_SRC sh :dir /docker:root@tutorial_bastion:/ :results raw drawer
ls -lh /data
#+END_SRC

#+RESULTS:
:RESULTS:
total 176M
-rw-rw-r-- 1 1000 1000 176M Aug 19 14:16 inspections.csv
:END:

#+BEGIN_SRC sh :dir /docker:root@tutorial_bastion:/
psql ${FOOD_DB_URL} -c "\copy inspections FROM '/data/inspections.csv' WITH HEADER CSV"
#+END_SRC

#+RESULTS:
: COPY 153465

#+BEGIN_SRC sh :dir /docker:root@tutorial_bastion:/ :results org drawer
psql ${FOOD_DB_URL} -c 'select * from inspections limit 1'
#+END_SRC

#+RESULTS:
:RESULTS:
 inspection |    dba_name     |    aka_name     | license_num | facility_type |      risk       |          address          |  city   | state |  zip  |    date    |  type   | results |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            violations                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |      latitude      |     longitude      |                 location
------------+-----------------+-----------------+-------------+---------------+-----------------+---------------------------+---------+-------+-------+------------+---------+---------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------+--------------------+------------------------------------------
 2078651    | D AND Y GROCERY | D AND Y GROCERY |     1477137 | Grocery Store | Risk 2 (Medium) | 8200 S COTTAGE GROVE AVE  | CHICAGO | IL    | 60619 | 2017-08-18 | Canvass | Fail    | 12. HAND WASHING FACILITIES: WITH SOAP AND SANITARY HAND DRYING DEVICES, CONVENIENT AND ACCESSIBLE TO FOOD PREP AREA - Comments: INADEQUATE TOILET FACILITIES ON SITE. INOPERABLE TOILET ON SITE, UNABLE TO USE/OPERATE PROPERLY. NO SOAP OR SANITARY HAND DRYING DEVICE AT EXPOSED HANDSINK IN PREP AREA. INSTD TO PROVIDE AT ALL TIMES. STAFF TOILET ROOM NOT CLEAN, CAT FECES AND CAT LITTER ON FLOOR, SOILED TOILET PAPER ON PILE ON STAFF TOILET ROOM FLOOR. EXTREME FOUL SMELL IN STAFF TOILET ROOM. VIOLATION 7-38-030 CRITICAL. INSTD TO MAINTAIN CLEAN TOILET ROOM AND OPERABLE TOILET FACILITIES. | 41. PREMISES MAINTAINED FREE OF LITTER, UNNECESSARY ARTICLES, CLEANING  EQUIPMENT PROPERLY STORED - Comments: MUST ORGANIZE AND MAINTAIN THE STORAGE AREA BY THE FURNACE IN THE REAR PREP AREA, ORGANIZE BEHIND FRONT COUNTER. ORGANIZE WALK-IN COOLER USED FOR STORAGE OF SODA POP.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +| 41.745704140078026 | -87.60522820363809 | (41.745704140078026, -87.60522820363809)
            |                 |                 |             |               |                 |                           |         |       |       |            |         |         |  | 34. FLOORS: CONSTRUCTED PER CODE, CLEANED, GOOD REPAIR, COVING INSTALLED, DUST-LESS CLEANING METHODS USED - Comments: CLEAN FLOORS UNDER AROUND AND BEHIND SHELVES, COUNTERS AND , FRONT COUNTER AREA, PREP AREA AND INSIDE OF THE WALK-IN COOLER. | 33. FOOD AND NON-FOOD CONTACT EQUIPMENT UTENSILS CLEAN, FREE OF ABRASIVE DETERGENTS - Comments: OBSERVED THE STORAGE SHELVES NOT CLEAN IN DRY STORAGE AREA, AND IN REACH IN COOLERS, INSTRUCTED TO CLEAN. ALSO CLEAN AND SANITZE CHEESE CONTAINER FRONT PREP AREA. | 32. FOOD AND NON-FOOD CONTACT SURFACES PROPERLY DESIGNED, CONSTRUCTED AND MAINTAINED - Comments: OBSERVED INNER DOOR OF THE SODA MACHINE CRACKED GLASS, INSTRUCTED TO REPLACE. | 38. VENTILATION: ROOMS AND EQUIPMENT VENTED AS REQUIRED: PLUMBING: INSTALLED AND MAINTAINED - Comments: TOILET ROOM VENTILATION IN POOR REPAIR. INSTD TO REPAIR. | 35. WALLS, CEILINGS, ATTACHED EQUIPMENT CONSTRUCTED PER CODE: GOOD REPAIR, SURFACES CLEAN AND DUST-LESS CLEANING METHODS - Comments: WALLS AND CEILING IN STAFF TOILET ROOM IN POOR REPAIR, GAPS AND HOLES. INSTD TO REPAIR SAME. CEILING ON PREMISES ABOVE FRONT DISPLAY  IN POOR REPAIR, PEELING PAINT, UNEVEN SURFACE. INSTD TO REPAIR. | 22. DISH MACHINES: PROVIDED WITH ACCURATE THERMOMETERS, CHEMICAL TEST KITS AND SUITABLE GAUGE COCK - Comments: NO CHEMICAL TEST KIT ON SITE FOR SANITIZER AT 3-COMPARTMENT SINK. INSTD TO PROVIDE SAME. VIOLATION 7-38-030 CRITICAL.  | 3. POTENTIALLY HAZARDOUS FOOD MEETS TEMPERATURE REQUIREMENT DURING STORAGE, PREPARATION DISPLAY AND SERVICE - Comments: POTENTIALLY HAZARDOUS FOOD AT IMPROPER TEMPERATURE. COOKED GROUND BEEF AT 90.8F IN HOT HOLDING UNIT. VIOLATION 7-38-005A CRITICAL. PRODUCT VOLUNTARILY DISPOSED OF AND DENATURED AT THIS TIME. APPROX 5LBS. $20 VALUE. VIOLATIONS 7-38-005A CRITICAL. | 13. NO EVIDENCE OF RODENT OR INSECT INFESTATION, NO BIRDS, TURTLES OR OTHER ANIMALS - Comments: LIVE CAT ON SITE, WALKING IN AISLES. VIOLATION 7-38-020 CRITICAL. LIVE ANIMALS ON SITE ARE PROHIBITED. | 18. NO EVIDENCE OF RODENT OR INSECT OUTER OPENINGS PROTECTED/RODENT PROOFED, A WRITTEN LOG SHALL BE MAINTAINED AVAILABLE TO THE INSPECTORS - Comments: FRONT DOOR NOT RODENT PROOF, APPROX 1/2 INCH GAP AT TOP OF DOOR. INSTD TO RODENT PROOF DOOR AND HAVE TIGHT FITTING. LIVE ROACH IN STAFF TOILET ROOM. INSTD TO REMOVE ROACH, CLEAN AND SANITIZE AFFECTED AREAS. VIOLATION 7-38-020 SERIOUS. |                    |                    |
(1 row)

:END:

You could see the meaning of each column [[https://data.cityofchicago.org/api/assets/BAD5301B-681A-4202-9D25-51B2CAE672FF?download=true][here]].


#+BEGIN_QUOTE
Risk category of facility: Each establishment is categorized as to its risk of adversely
affecting the public’s health, with 1 being the highest and 3 the lowest. The frequency of
inspection is tied to this risk, with risk 1 establishments inspected most frequently and
risk 3 least frequently.
#+END_QUOTE


#+BEGIN_QUOTE
Inspection type: An inspection can be one of the following types: canvass, the most
common type of inspection performed at a frequency relative to the risk of the
establishment; consultation, when the inspection is  done at the request of the owner
prior to the opening of the establishment; complaint, when  the inspection is done in
response to a complaint against the establishment; license, when the inspection is done
as a requirement for the establishment to receive its license to operate; suspect food
poisoning, when the inspection is done in response to one or more persons claiming to
have gotten ill as a result of eating at the establishment (a specific type of complaint-
based inspection); task-force inspection, when an inspection of a bar or tavern is done.
Re-inspections can occur for most types of these inspections and are indicated as such
#+END_QUOTE

#+BEGIN_QUOTE
Results: An inspection can pass, pass with conditions or fail. Establishments receiving a
‘pass’ were found to have no critical or serious violations (violation number 1-14 and 15-
29, respectively). Establishments receiving a ‘pass  with conditions’ were found to have
critical or serious violations, but these were corrected during the inspection.
Establishments receiving a ‘fail’ were found to have critical or serious violations that
were not correctable during the inspection. An establishment receiving a ‘fail’ does not
necessarily mean the establishment’s licensed is suspended. Establishments found to
be out of business or not located are indicated as such.
#+END_QUOTE

#+BEGIN_QUOTE
Violations: An establishment can receive one or more of 45 distinct violations (violation
numbers 1-44 and 70). For each violation number listed for a given establishment, the
requirement the establishment must meet in order for it to NOT receive a violation is
noted, followed by a specific description of the findings that caused the violation to be
issued.
#+END_QUOTE

** Transforming the data

For tackling a Machine Learning problem you need to identify the
*entities* of your problem domain, and if your problem involves time,
how those entities change over time.

In this tutorial, we have two different goals: (1) an *EIS* and
(2) *prioritize inspections*, the entity in which we are interested in
both cases is the  ...

The *outcome* is what differ between those two projects. For *EIS* the
outcome is *inspected*, for *Inspections*, the outcome is *violation found*.

** Some data exploration

*TODO* We could add explanations about the fact that most of the
analysis stops in this step

*NOTE:* We will be using =SQL= for the exploration of the data, the
following pages: functions to [[https://www.postgresql.org/docs/current/static/functions-string.html][manipulate strings]]
and functions for [[https://www.postgresql.org/docs/current/static/functions-datetime.html][manipulate dates and time]]
will be handy, keep them close!


Let's see the data and try to see how it needs to be transformed.

Remember that the data that we have is one inspection per row.
We will check the result of the inspections:

 #+BEGIN_SRC sql :results table drawer
   select
   results, count(*) as total_number
   from
   inspections
   group by
   results
   order by total_number desc;

 #+END_SRC

 #+RESULTS:
 :RESULTS:
 | results              | total_number |
 |----------------------+-------------|
 | Pass                 |       90310 |
 | Fail                 |       29770 |
 | Pass w/ Conditions   |       14507 |
 | Out of Business      |       13773 |
 | No Entry             |        4240 |
 | Not Ready            |         805 |
 | Business Not Located |          60 |
 :END:

We will map =Fail=, =Not Ready=, =No Entry= to a =True= (i.e. a violation was
discovered), we will remove =Out of Business= and =Business Not Located=
from the database, and all the other options (=Pass w/Condition= and
=Pass)=  will become =False= (i.e. no violation was discovered).




We also, could ask some interesting questions such as:


/What are the top 30 restaurants with more inspections?/

#+BEGIN_SRC sql :results table drawer
  select
  dba_name, count(*) as total_inspections
  from inspections
  group by dba_name
  order by total_inspections desc
  limit 30;
#+END_SRC

#+RESULTS:
:RESULTS:
| dba_name                        | total_inspections |
|--------------------------------+------------------|
| SUBWAY                         |             2140 |
| DUNKIN DONUTS                  |             1089 |
| MCDONALD'S                     |              475 |
| 7-ELEVEN                       |              373 |
| MCDONALDS                      |              278 |
| CHIPOTLE MEXICAN GRILL         |              256 |
| POTBELLY SANDWICH WORKS LLC    |              219 |
| CORNER BAKERY CAFE             |              192 |
| POTBELLY SANDWICH WORKS        |              184 |
| SPORTSERVICE SOLDIER FIELD     |              176 |
| DUNKIN DONUTS/BASKIN ROBBINS   |              172 |
| DOMINO'S PIZZA                 |              169 |
| AU BON PAIN                    |              161 |
| SUBWAY SANDWICHES              |              159 |
| FRESHII                        |              157 |
| HAROLD'S CHICKEN SHACK         |              155 |
| WHOLE FOODS MARKET             |              155 |
| KFC                            |              146 |
| Subway                         |              144 |
| SEE THRU CHINESE KITCHEN       |              129 |
| SHARKS FISH & CHICKEN          |              128 |
| J & J FISH                     |              117 |
| MC DONALD'S                    |              117 |
| PIZZA HUT                      |              116 |
| DUNKIN DONUTS / BASKIN ROBBINS |              106 |
| JIMMY JOHNS                    |              105 |
| PAPA JOHN'S PIZZA              |              105 |
| CITGO                          |              102 |
| STARBUCKS                      |              102 |
| ILLINOIS SPORTSERVICE INC      |              100 |
:END:


As we will see through all this tutorial, /data is always messy/, to
begin with we have several different spellings (e.g. =SUBWAY= and
=Subway=, =MCDONALDS= and =MC DONALD'S=, =DUNKIN DONUTS/BASKIN ROBBINS= and
=DUNKIN DONUTS / BASKIN ROBBINS=, etc)

We could try a very simple cleaning for example, convert all the
names to uppercase, remove the trailing spaces, remove the apostrophe
"='"= and remove the spaces around "=/=". The problem with this approach
is that we will be fixing the names that we just saw, but there are
several other nuances down that list. Another approach is use [[https://www.postgresql.org/docs/current/static/fuzzystrmatch.html][soundex]],
but that will create a lot of mismatches. The real workaround is apply
some /machine learning/ to /deduplicate/ the entities [fn:3].  We wont
follow that path here.


If we go back to the columns of the table, maybe there is another way
to solve this: we could try with the column =license_num=  (assume that one
license represents one establishment) and the column =address= (assume that one restaurant is
in one place).


#+BEGIN_SRC sql :results table drawer
  select
  count(distinct dba_name) as total_names,
  count(distinct license_num) as total_licenses,
  count(distinct address) as total_addresses
  from inspections
#+END_SRC

#+RESULTS:
:RESULTS:
| total_names | total_licenses | total_addresses |
|------------+---------------+----------------|
|      24646 |         32780 |          17002 |
:END:

This doesn't look promising...


Let's check those hypothesis

/What are the top 5 locations with more inspections?/

#+BEGIN_SRC sql :results table drawer
  select
  address, count(*) as total_inspections
  from inspections
  group by address
  order by total_inspections desc
  limit 5;
#+END_SRC

#+RESULTS:
:RESULTS:
| address           | total_inspections |
|-------------------+------------------|
| 11601 W TOUHY AVE |             1873 |
| 5700 S CICERO AVE |              379 |
| 500 W MADISON ST  |              346 |
| 324 N LEAVITT ST  |              335 |
| 100 W RANDOLPH ST |              255 |
:END:

The /location hypothesis/ also has problems, in particular could be *more*
than one establishment per location (the first row is *O'Hare International Airport*)

So, our last hope is the /license number/

We could get, even more information if we check /How many of those inspections result in a 'Fail'/?

/What are the top 5 licenses with more inspections?/

#+BEGIN_SRC sql :results table drawer
  select
  license_num, count(*) as total_inspections
  from inspections
  group by license_num
  order by total_inspections desc
  limit 5;
#+END_SRC

#+RESULTS:
:RESULTS:
| license_num | total_inspections |
|------------+------------------|
|          0 |              436 |
|    1354323 |              198 |
|      14616 |              172 |
|    1574001 |               79 |
|    1974745 |               58 |
:END:


Even this columns has some problems, let's investigate a little about
the =license_num= = =0=.


#+BEGIN_SRC sql :results table drawer
    select
    facility_type, count(*) as total_inspections
    from inspections
    where license_num=0
    group by  facility_type
    order by total_inspections desc
#+END_SRC

#+RESULTS:
:RESULTS:
| facility_type                | total_inspections |
|-----------------------------+------------------|
| Restaurant                  |               95 |
| Special Event               |               72 |
| [NULL]                      |               45 |
| Shelter                     |               31 |
| Navy Pier Kiosk             |               30 |
| CHURCH                      |               24 |
| Grocery Store               |               16 |
| CHURCH KITCHEN              |               12 |
| PRIVATE SCHOOL              |               11 |
| CHURCH/SPECIAL EVENTS       |               10 |
| Long Term Care              |                9 |
| Church                      |                8 |
| AFTER SCHOOL PROGRAM        |                8 |
| Catering                    |                6 |
| Mobile Food Dispenser       |                5 |
| Illegal Vendor              |                3 |
| SOCIAL CLUB                 |                3 |
| School                      |                3 |
| HERBAL LIFE SHOP            |                3 |
| NON -PROFIT                 |                3 |
| NOT FOR PROFIT              |                2 |
| FOOD PANTRY/CHURCH          |                2 |
| Hospital                    |                2 |
| CHURCH/SPECIAL EVENT        |                2 |
| RESTAURANT/GROCERY          |                2 |
| BOYS AND GIRLS CLUB         |                2 |
| Social Club                 |                2 |
| SOUP KITCHEN                |                2 |
| Bakery                      |                2 |
| SUMMER FEEDING              |                2 |
| SUMMER FEEDING PREP AREA    |                2 |
| religious                   |                1 |
| FOOD PANTRY                 |                1 |
| RESTAURANT AND LIQUOR       |                1 |
| WAREHOUSE                   |                1 |
| RETAIL                      |                1 |
| Food Pantry                 |                1 |
| Wholesale                   |                1 |
| Daycare (2 - 6 Years)       |                1 |
| FARMER'S MARKET             |                1 |
| KIDS CAFE                   |                1 |
| CHICAGO PARK DISTRICT       |                1 |
| NEWSSTAND                   |                1 |
| NON-FOR PROFIT BASEMENT KIT |                1 |
| incubator                   |                1 |
| UNLICENSED FACILITY         |                1 |
| NP-KIOSK                    |                1 |
| AFTER SCHOOL CARE           |                1 |
:END:

Most of these are related to /special events/, /churchs/, /festivals/
etc. We could research deeply the =restaurants= which have =license_num= =
=0=, but we will skip that for the moment.


Finally, we can conclude that, except for some details, =license_num= is
the way to go, for the identification of the establishments.


#+BEGIN_SRC sql :results table drawer
  select
  license_num, dba_name, address, count(*) as total_inspections
  from inspections
  group by license_num, dba_name, address
  order by count(*)  desc
  limit 5;
#+END_SRC

#+RESULTS:
:RESULTS:
| license_num | dba_name                           | address                 | total_inspections |
|------------+-----------------------------------+-------------------------+------------------|
|    1354323 | SPORTSERVICE SOLDIER FIELD        | 1410 S MUSEUM CAMPUS DR |              176 |
|      14616 | ILLINOIS SPORTSERVICE INC         | 333 W 35TH ST           |               99 |
|    1574001 | LEVY RESTAURANTS AT WRIGLEY FIELD | 1060 W ADDISON ST       |               68 |
|    1974745 | THE UNITED CENTER                 | 1901 W MADISON ST       |               47 |
|    1490035 | MCDONALD'S                        | 6900 S LAFAYETTE AVE    |               45 |
:END:


Other interesting questions to ask are:


/Which is the spatial distribution of inspections?/


#+BEGIN_SRC sql :results table drawer
    select
    zip, count(*) as total_inspections
    from inspections
    group by zip
    order by total_inspections desc;
#+END_SRC

#+RESULTS:
:RESULTS:
|    zip | total_inspections |
|--------+------------------|
|  60614 |             5593 |
|  60647 |             5500 |
|  60657 |             5136 |
|  60611 |             4905 |
|  60622 |             4843 |
|  60618 |             4768 |
|  60608 |             4552 |
|  60625 |             4280 |
|  60639 |             3979 |
|  60640 |             3866 |
|  60623 |             3782 |
|  60632 |             3739 |
|  60607 |             3736 |
|  60616 |             3613 |
|  60609 |             3430 |
|  60654 |             3278 |
|  60659 |             3278 |
|  60613 |             3266 |
|  60619 |             3225 |
|  60634 |             3075 |
|  60610 |             3035 |
|  60617 |             3013 |
|  60641 |             2970 |
|  60629 |             2957 |
|  60620 |             2822 |
|  60628 |             2813 |
|  60601 |             2625 |
|  60606 |             2550 |
|  60605 |             2427 |
|  60612 |             2404 |
|  60626 |             2374 |
|  60651 |             2316 |
|  60660 |             2217 |
|  60643 |             2118 |
|  60630 |             2065 |
|  60661 |             2062 |
|  60636 |             2034 |
|  60644 |             1968 |
|  60638 |             1961 |
|  60649 |             1923 |
|  60637 |             1899 |
|  60666 |             1899 |
|  60615 |             1797 |
|  60624 |             1726 |
|  60642 |             1701 |
|  60603 |             1506 |
|  60652 |             1366 |
|  60621 |             1356 |
|  60653 |             1346 |
|  60646 |             1147 |
|  60631 |             1146 |
|  60645 |             1124 |
|  60602 |             1122 |
|  60604 |             1051 |
|  60707 |              893 |
|  60655 |              649 |
|  60656 |              623 |
|  60633 |              282 |
|  60827 |              104 |
| [NULL] |               98 |
|  60193 |               18 |
|  60153 |               15 |
|  60007 |               12 |
|  60201 |                6 |
|  60804 |                6 |
|  60126 |                5 |
|  60482 |                5 |
|  60077 |                5 |
|  60302 |                4 |
|  60409 |                4 |
|  60501 |                4 |
|  60429 |                3 |
|  60076 |                3 |
|  60714 |                3 |
|  60803 |                3 |
|  60176 |                3 |
|  60107 |                2 |
|  60406 |                2 |
|  60015 |                2 |
|  60540 |                2 |
|  60411 |                2 |
|  60627 |                2 |
|  60402 |                2 |
|  60461 |                2 |
|  60044 |                1 |
|  60047 |                1 |
|  60018 |                1 |
|  60155 |                1 |
|  60453 |                1 |
|  60477 |                1 |
|  60202 |                1 |
|  60706 |                1 |
|  60440 |                1 |
|  60559 |                1 |
|  60423 |                1 |
|  60108 |                1 |
|  60805 |                1 |
|  60148 |                1 |
|  60022 |                1 |
|  60458 |                1 |
|  60478 |                1 |
:END:

/Which is the temporal distribution of the inspections?/

#+BEGIN_SRC sql :results table drawer
  select
  date_trunc('month', date) as year_month,
  count(*) as total_inspections
  from inspections
  group by year_month
  order by year_month desc;
#+END_SRC

#+RESULTS:
:RESULTS:
| year_month              | total_inspections |
|------------------------+------------------|
| 2017-08-01 00:00:00+00 |              418 |
| 2017-07-01 00:00:00+00 |              846 |
| 2017-06-01 00:00:00+00 |             1523 |
| 2017-05-01 00:00:00+00 |             1703 |
| 2017-04-01 00:00:00+00 |             1677 |
| 2017-03-01 00:00:00+00 |             2074 |
| 2017-02-01 00:00:00+00 |             1559 |
| 2017-01-01 00:00:00+00 |             1762 |
| 2016-12-01 00:00:00+00 |             1621 |
| 2016-11-01 00:00:00+00 |             1776 |
| 2016-10-01 00:00:00+00 |             1955 |
| 2016-09-01 00:00:00+00 |             2304 |
| 2016-08-01 00:00:00+00 |             2198 |
| 2016-07-01 00:00:00+00 |             1571 |
| 2016-06-01 00:00:00+00 |             2220 |
| 2016-05-01 00:00:00+00 |             2082 |
| 2016-04-01 00:00:00+00 |             1926 |
| 2016-03-01 00:00:00+00 |             2173 |
| 2016-02-01 00:00:00+00 |             1440 |
| 2016-01-01 00:00:00+00 |             1551 |
| 2015-12-01 00:00:00+00 |             1693 |
| 2015-11-01 00:00:00+00 |             1776 |
| 2015-10-01 00:00:00+00 |             2090 |
| 2015-09-01 00:00:00+00 |             2105 |
| 2015-08-01 00:00:00+00 |             1840 |
| 2015-07-01 00:00:00+00 |             1642 |
| 2015-06-01 00:00:00+00 |             1805 |
| 2015-05-01 00:00:00+00 |             1658 |
| 2015-04-01 00:00:00+00 |             1601 |
| 2015-03-01 00:00:00+00 |             1714 |
| 2015-02-01 00:00:00+00 |             1390 |
| 2015-01-01 00:00:00+00 |             1598 |
| 2014-12-01 00:00:00+00 |             1898 |
| 2014-11-01 00:00:00+00 |             1557 |
| 2014-10-01 00:00:00+00 |             2085 |
| 2014-09-01 00:00:00+00 |             2134 |
| 2014-08-01 00:00:00+00 |             2030 |
| 2014-07-01 00:00:00+00 |             1744 |
| 2014-06-01 00:00:00+00 |             1838 |
| 2014-05-01 00:00:00+00 |             1951 |
| 2014-04-01 00:00:00+00 |             1861 |
| 2014-03-01 00:00:00+00 |             1630 |
| 2014-02-01 00:00:00+00 |             1470 |
| 2014-01-01 00:00:00+00 |             1342 |
| 2013-12-01 00:00:00+00 |             1459 |
| 2013-11-01 00:00:00+00 |             1705 |
| 2013-10-01 00:00:00+00 |             2143 |
| 2013-09-01 00:00:00+00 |             2168 |
| 2013-08-01 00:00:00+00 |             1806 |
| 2013-07-01 00:00:00+00 |             1546 |
| 2013-06-01 00:00:00+00 |             1614 |
| 2013-05-01 00:00:00+00 |             1940 |
| 2013-04-01 00:00:00+00 |             1798 |
| 2013-03-01 00:00:00+00 |             1616 |
| 2013-02-01 00:00:00+00 |             1464 |
| 2013-01-01 00:00:00+00 |             1691 |
| 2012-12-01 00:00:00+00 |             1304 |
| 2012-11-01 00:00:00+00 |             1635 |
| 2012-10-01 00:00:00+00 |             1687 |
| 2012-09-01 00:00:00+00 |             1678 |
| 2012-08-01 00:00:00+00 |             1774 |
| 2012-07-01 00:00:00+00 |             1500 |
| 2012-06-01 00:00:00+00 |             1596 |
| 2012-05-01 00:00:00+00 |             1941 |
| 2012-04-01 00:00:00+00 |             1444 |
| 2012-03-01 00:00:00+00 |             1475 |
| 2012-02-01 00:00:00+00 |             1341 |
| 2012-01-01 00:00:00+00 |             1491 |
| 2011-12-01 00:00:00+00 |             1349 |
| 2011-11-01 00:00:00+00 |             1651 |
| 2011-10-01 00:00:00+00 |             1590 |
| 2011-09-01 00:00:00+00 |             1568 |
| 2011-08-01 00:00:00+00 |             1624 |
| 2011-07-01 00:00:00+00 |             1407 |
| 2011-06-01 00:00:00+00 |             1798 |
| 2011-05-01 00:00:00+00 |             1768 |
| 2011-04-01 00:00:00+00 |             1512 |
| 2011-03-01 00:00:00+00 |             1792 |
| 2011-02-01 00:00:00+00 |             1350 |
| 2011-01-01 00:00:00+00 |             1341 |
| 2010-12-01 00:00:00+00 |             1278 |
| 2010-11-01 00:00:00+00 |             1293 |
| 2010-10-01 00:00:00+00 |             1814 |
| 2010-09-01 00:00:00+00 |             1788 |
| 2010-08-01 00:00:00+00 |             1667 |
| 2010-07-01 00:00:00+00 |             1324 |
| 2010-06-01 00:00:00+00 |             1764 |
| 2010-05-01 00:00:00+00 |             1542 |
| 2010-04-01 00:00:00+00 |             1440 |
| 2010-03-01 00:00:00+00 |             1480 |
| 2010-02-01 00:00:00+00 |             1398 |
| 2010-01-01 00:00:00+00 |             1280 |
:END:

The number of inspections per month, are very stable.


We could also explore the =violations= column:

#+BEGIN_SRC sql :results table drawer
  select violations
  from inspections
  limit 10
#+END_SRC

#+RESULTS:
:RESULTS:
| violations                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                                                                                                                                                                                                                                                                                                                                                         |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                                                                                                                                          |                                                                                                                                                                                                                                                                                                                                            |                                                                                                                                                                                                                                                                                                                                                                                                                  |                                                                                                                                                                                                                                                                                                                                                                               |                                                                                                                                                                                                                                                                                                                                                                          |                                                                                                                                                                                                                                                                                                                                                                                                   |                                                                                                                                                                                                       |                                                                                                                                                                                                                                     |                                                                                                                                                                                                             |                                                                                                                                                                                                               |
|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 12. HAND WASHING FACILITIES: WITH SOAP AND SANITARY HAND DRYING DEVICES, CONVENIENT AND ACCESSIBLE TO FOOD PREP AREA - Comments: INADEQUATE TOILET FACILITIES ON SITE. INOPERABLE TOILET ON SITE, UNABLE TO USE/OPERATE PROPERLY. NO SOAP OR SANITARY HAND DRYING DEVICE AT EXPOSED HANDSINK IN PREP AREA. INSTD TO PROVIDE AT ALL TIMES. STAFF TOILET ROOM NOT CLEAN, CAT FECES AND CAT LITTER ON FLOOR, SOILED TOILET PAPER ON PILE ON STAFF TOILET ROOM FLOOR. EXTREME FOUL SMELL IN STAFF TOILET ROOM. VIOLATION 7-38-030 CRITICAL. INSTD TO MAINTAIN CLEAN TOILET ROOM AND OPERABLE TOILET FACILITIES. | 41. PREMISES MAINTAINED FREE OF LITTER, UNNECESSARY ARTICLES, CLEANING  EQUIPMENT PROPERLY STORED - Comments: MUST ORGANIZE AND MAINTAIN THE STORAGE AREA BY THE FURNACE IN THE REAR PREP AREA, ORGANIZE BEHIND FRONT COUNTER. ORGANIZE WALK-IN COOLER USED FOR STORAGE OF SODA POP.                                                                                                                                                                                                                                                                                                                       |                                                                                                                                                                                                                                                                                                                                                         |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                                                                                                                                          |                                                                                                                                                                                                                                                                                                                                            |                                                                                                                                                                                                                                                                                                                                                                                                                  |                                                                                                                                                                                                                                                                                                                                                                               |                                                                                                                                                                                                                                                                                                                                                                          |                                                                                                                                                                                                                                                                                                                                                                                                   |                                                                                                                                                                                                       |                                                                                                                                                                                                                                     |                                                                                                                                                                                                             |                                                                                                                                                                                                               |
|                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | 34. FLOORS: CONSTRUCTED PER CODE, CLEANED, GOOD REPAIR, COVING INSTALLED, DUST-LESS CLEANING METHODS USED - Comments: CLEAN FLOORS UNDER AROUND AND BEHIND SHELVES, COUNTERS AND , FRONT COUNTER AREA, PREP AREA AND INSIDE OF THE WALK-IN COOLER.                                                                                                                                                                                                                                                                                                                                                         | 33. FOOD AND NON-FOOD CONTACT EQUIPMENT UTENSILS CLEAN, FREE OF ABRASIVE DETERGENTS - Comments: OBSERVED THE STORAGE SHELVES NOT CLEAN IN DRY STORAGE AREA, AND IN REACH IN COOLERS, INSTRUCTED TO CLEAN. ALSO CLEAN AND SANITZE CHEESE CONTAINER FRONT PREP AREA.                                                                                      | 32. FOOD AND NON-FOOD CONTACT SURFACES PROPERLY DESIGNED, CONSTRUCTED AND MAINTAINED - Comments: OBSERVED INNER DOOR OF THE SODA MACHINE CRACKED GLASS, INSTRUCTED TO REPLACE.                                                                                                                                                                                                                                                                                                                                                     | 38. VENTILATION: ROOMS AND EQUIPMENT VENTED AS REQUIRED: PLUMBING: INSTALLED AND MAINTAINED - Comments: TOILET ROOM VENTILATION IN POOR REPAIR. INSTD TO REPAIR.                                                         | 35. WALLS, CEILINGS, ATTACHED EQUIPMENT CONSTRUCTED PER CODE: GOOD REPAIR, SURFACES CLEAN AND DUST-LESS CLEANING METHODS - Comments: WALLS AND CEILING IN STAFF TOILET ROOM IN POOR REPAIR, GAPS AND HOLES. INSTD TO REPAIR SAME. CEILING ON PREMISES ABOVE FRONT DISPLAY  IN POOR REPAIR, PEELING PAINT, UNEVEN SURFACE. INSTD TO REPAIR. | 22. DISH MACHINES: PROVIDED WITH ACCURATE THERMOMETERS, CHEMICAL TEST KITS AND SUITABLE GAUGE COCK - Comments: NO CHEMICAL TEST KIT ON SITE FOR SANITIZER AT 3-COMPARTMENT SINK. INSTD TO PROVIDE SAME. VIOLATION 7-38-030 CRITICAL.                                                                                                                                                                             | 3. POTENTIALLY HAZARDOUS FOOD MEETS TEMPERATURE REQUIREMENT DURING STORAGE, PREPARATION DISPLAY AND SERVICE - Comments: POTENTIALLY HAZARDOUS FOOD AT IMPROPER TEMPERATURE. COOKED GROUND BEEF AT 90.8F IN HOT HOLDING UNIT. VIOLATION 7-38-005A CRITICAL. PRODUCT VOLUNTARILY DISPOSED OF AND DENATURED AT THIS TIME. APPROX 5LBS. $20 VALUE. VIOLATIONS 7-38-005A CRITICAL. | 13. NO EVIDENCE OF RODENT OR INSECT INFESTATION, NO BIRDS, TURTLES OR OTHER ANIMALS - Comments: LIVE CAT ON SITE, WALKING IN AISLES. VIOLATION 7-38-020 CRITICAL. LIVE ANIMALS ON SITE ARE PROHIBITED.                                                                                                                                                                   | 18. NO EVIDENCE OF RODENT OR INSECT OUTER OPENINGS PROTECTED/RODENT PROOFED, A WRITTEN LOG SHALL BE MAINTAINED AVAILABLE TO THE INSPECTORS - Comments: FRONT DOOR NOT RODENT PROOF, APPROX 1/2 INCH GAP AT TOP OF DOOR. INSTD TO RODENT PROOF DOOR AND HAVE TIGHT FITTING. LIVE ROACH IN STAFF TOILET ROOM. INSTD TO REMOVE ROACH, CLEAN AND SANITIZE AFFECTED AREAS. VIOLATION 7-38-020 SERIOUS. |                                                                                                                                                                                                       |                                                                                                                                                                                                                                     |                                                                                                                                                                                                             |                                                                                                                                                                                                               |
| 16. FOOD PROTECTED DURING STORAGE, PREPARATION, DISPLAY, SERVICE AND TRANSPORTATION - Comments: FOOD NOT PROTECTED DURING STORAGE, FLY STRIPS WITH DEAD FLIES OVER FOOD PREP/MEAT PREP AREA. INSTD TO USE PROPER PEST CONTROL MEASURES. VIOLATION 7-38-005A SERIOUS                                                                                                                                                                                                                                                                                                                                         | 18. NO EVIDENCE OF RODENT OR INSECT OUTER OPENINGS PROTECTED/RODENT PROOFED, A WRITTEN LOG SHALL BE MAINTAINED AVAILABLE TO THE INSPECTORS - Comments: OVER 10 LIVE HOUSE FLIES AND 25 LIVE FRUIT FLIES NOTED IN MEAT PREP AREA. MICE DROPPINGS (OVER 100) NOTED ON THE FLOOR AND SHELVES IN REAR STORAGE AREAS, BASEMENT FLOOR, AND DISPLAY SHELVES. MUST REMOVE ALL FLIES, DROPPINGS, CLEAN AND SANITIZE ALL AFFECTED AREAS. CONTACT PEST CONTROL FOR SERVICE. FRONT DOOR NOT RODENT PROOF, APPROX 1/2 INCH GAP AT DOORS. INSTD TO RODENT PROOF SAME AND HAVE TIGHT FITTING. VIOLATION 7-38-020 SERIOUS. | 19. OUTSIDE GARBAGE WASTE GREASE AND STORAGE AREA; CLEAN, RODENT PROOF, ALL CONTAINERS COVERED - Comments: OUTSIDE GARBAGE AREA NOT MAINTAINED. EXTERIOR OF GREASE INTERCEPTOR ENRUSTED WITH GREASE. MUST CLEAN AND MAINTAIN. VIOLATION 7-38-020 SERIOUS.                                                                                               | 1. SOURCE SOUND CONDITION, NO SPOILAGE, FOODS PROPERLY LABELED, SHELLFISH TAGS IN PLACE - Comments: UNWHOLESOME, SPOILED  RAW MEAT PRODUCTS NOTED IN WALK IN COOLER, BEING OFFERED FOR SALE. LARGE SOLID BLOCK OF VARIETY OF MEATS (BEEF, PORK, CHICKEN CLUMPED TOGETHER) WITH FOUL SMELL,  BLACK, GREEN, AND GRAY IN COLOR. ALSO NOTED LIVE FLIES ON GROUND BEEF IN MEAT PREP AREA  WITH FOUL SMELL AND BROWN IN COLOR. VIOLATION 7-38-005B CRITICAL. APPROX 100LBS $500 VALUE. ALL PRODUCT DISCARDED AND DENATURED AT THIS TIME. | 17. POTENTIALLY HAZARDOUS FOOD PROPERLY THAWED - Comments: IMPROPER THAWING OF CHICKEN NOTED. CHICKEN IN STANDING WATER IN BASIN OF 3-COMPARTMENT SINK. INSTD ON PROPER THAWING TECHNIQUES. VIOLATION 7-38-005A SERIOUS. | 12. HAND WASHING FACILITIES: WITH SOAP AND SANITARY HAND DRYING DEVICES, CONVENIENT AND ACCESSIBLE TO FOOD PREP AREA - Comments: NO SOAP NOTED AT EXPOSED HANDSINK IN MEAT PREP AREA. MUST PROVIDE AT ALL TIMES. VIOLATION 7-38-030 CRITICAL.                                                                                              | 3. POTENTIALLY HAZARDOUS FOOD MEETS TEMPERATURE REQUIREMENT DURING STORAGE, PREPARATION DISPLAY AND SERVICE - Comments: THE FOLLOWING POTENTIALLY HAZARDOUS FOODS AT IMPROPER TEMPERATURES ON COUNTERTOP: GROUND SAUSAGE AT 60.8F, RAW CHICKEN AT 49.2F. ALL PRODUCT DISPOSED OF AND DENATURED AT THIS TIME. VIOLATION 7-38-005A CRITICAL. APPROX 30LBS, $100 VALUE.                                             | 13. NO EVIDENCE OF RODENT OR INSECT INFESTATION, NO BIRDS, TURTLES OR OTHER ANIMALS - Comments: 2 LIVE KITTENS NOTED IN BASEMENT. LIVE ANIMALS ARE PROHIBITED ON SITE. VIOLATION 7-38-020 CRITICAL.                                                                                                                                                                           | 33. FOOD AND NON-FOOD CONTACT EQUIPMENT UTENSILS CLEAN, FREE OF ABRASIVE DETERGENTS - Comments: ALL FOOD AND NON FOOD CONTACT EQUIPMENT NOT CLEAN, EXCESSIVE DEBRIS: INTERIOR/EXTERIOR OF ALL COOLERS/FREEZERS, MICROWAVE, OVEN, FRYERS, STORAGE SHELVES, MEAT DISPLAY CASE, PREP TABLES, MEAT SAW, MEAT GRINDER, BASINS OF ALL SINKS. INSTD TO CLEAN AND MAINTAIN SAME. | 32. FOOD AND NON-FOOD CONTACT SURFACES PROPERLY DESIGNED, CONSTRUCTED AND MAINTAINED - Comments: WALK IN FREEZER ENCRUSTED WITH ICE THROUGH OUT. WALK IN COOLER CONDENSOR LINE IN POOR REPAIR, LEAKING. INSTD TO REPAIR SAME. CUTTING BOARDS PITTED, WITH DEEP, DARK GROOVES, WORN BEYOND REPAIR. INSTD TO REPLACE AND MAINTAIN CUTTING BOARDS.                                                   | 34. FLOORS: CONSTRUCTED PER CODE, CLEANED, GOOD REPAIR, COVING INSTALLED, DUST-LESS CLEANING METHODS USED - Comments: FLOORS THROUGH OUT NOT CLEAN, DEBRIS. INSTD TO CLEAN AND MAINTAIN AT ALL TIMES, | 35. WALLS, CEILINGS, ATTACHED EQUIPMENT CONSTRUCTED PER CODE: GOOD REPAIR, SURFACES CLEAN AND DUST-LESS CLEANING METHODS - Comments: WALLS AND LIGHTSHIELDS THROUGH OUT NOT CLEAN, DEBRIS, DEAD FLIES. INSTD TO CLEAN AND MAINTAIN. | 41. PREMISES MAINTAINED FREE OF LITTER, UNNECESSARY ARTICLES, CLEANING  EQUIPMENT PROPERLY STORED - Comments: EXTEME CLUTTER IN ALL STORAGE AREAS AND BASEMENT. INSTD TO REMOVE CLUTTER AND ORGANIZE AREAS. | 22. DISH MACHINES: PROVIDED WITH ACCURATE THERMOMETERS, CHEMICAL TEST KITS AND SUITABLE GAUGE COCK - Comments: NO CHEMICAL TEST KIT ON SITE FOR SANITIZER FOR 3-COMPARTMENT SINK. VIOLATION 7-38-030 SERIOUS. |
| 33. FOOD AND NON-FOOD CONTACT EQUIPMENT UTENSILS CLEAN, FREE OF ABRASIVE DETERGENTS - Comments: INTERIOR OF WALK IN COOLER NOT CLEAN OF DEBRIS. MUST CLEAN/MAINTAIN. ALSO LOWER DISPLAY SHELVES NOT CLEAN OF DEBRIS. MUST CLEAN/MAINTAIN.                                                                                                                                                                                                                                                                                                                                                                   | 42. APPROPRIATE METHOD OF HANDLING OF FOOD (ICE) HAIR RESTRAINTS AND CLEAN APPAREL WORN - Comments:  EMPLOYEES NOT WEARING  HAIR RESTRAINT IN FOOD PREP AREA.MUST PROVIDE.                                                                                                                                                                                                                                                                                                                                                                                                                                 | 45. FOOD HANDLER REQUIREMENTS MET - Comments: NO PROOF OF THE NEW FOOD HANDLERS TRAINING FOR EMPLOYEES. MUST PROVIDE FOR EMPLOYEES.                                                                                                                                                                                                                     | 40. REFRIGERATION AND METAL STEM THERMOMETERS PROVIDED AND CONSPICUOUS - Comments: NO METAL STEM THERMOMETER FOR EMPLOYEES AND MISSING THERMOMETER INSIDE REACH IN COOLER BEHIND COUNTER. MUST PROVIDE.                                                                                                                                                                                                                                                                                                                            |                                                                                                                                                                                                                          |                                                                                                                                                                                                                                                                                                                                            |                                                                                                                                                                                                                                                                                                                                                                                                                  |                                                                                                                                                                                                                                                                                                                                                                               |                                                                                                                                                                                                                                                                                                                                                                          |                                                                                                                                                                                                                                                                                                                                                                                                   |                                                                                                                                                                                                       |                                                                                                                                                                                                                                     |                                                                                                                                                                                                             |                                                                                                                                                                                                               |
| 41. PREMISES MAINTAINED FREE OF LITTER, UNNECESSARY ARTICLES, CLEANING  EQUIPMENT PROPERLY STORED - Comments: INSTRUCTED MANAGER TO ORGANIZE EXCESSIVE CLUTTER IN THE REAR STORAGE AREA TO PREVENT HARBORAGE.                                                                                                                                                                                                                                                                                                                                                                                               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                                                                                                                                                                                                                                                                                                                                                         |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                                                                                                                                          |                                                                                                                                                                                                                                                                                                                                            |                                                                                                                                                                                                                                                                                                                                                                                                                  |                                                                                                                                                                                                                                                                                                                                                                               |                                                                                                                                                                                                                                                                                                                                                                          |                                                                                                                                                                                                                                                                                                                                                                                                   |                                                                                                                                                                                                       |                                                                                                                                                                                                                                     |                                                                                                                                                                                                             |                                                                                                                                                                                                               |
| 24. DISH WASHING FACILITIES: PROPERLY DESIGNED, CONSTRUCTED, MAINTAINED, INSTALLED, LOCATED AND OPERATED - Comments: ALL COFFEE BREWING AND FROZEN DRINK MAKER/DISPENSER EQUIPMENT HAS BEEN REMOVED. BUSINESS SELLING ONLY PRE-PACKAGED BEVERAGES ONLY. NO THREE COMPARTMENT SINK REQUIRED AT THIS TIME.                                                                                                                                                                                                                                                                                                    |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                                                                                                                                                                                                                                                                                                                                                         |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                                                                                                                                          |                                                                                                                                                                                                                                                                                                                                            |                                                                                                                                                                                                                                                                                                                                                                                                                  |                                                                                                                                                                                                                                                                                                                                                                               |                                                                                                                                                                                                                                                                                                                                                                          |                                                                                                                                                                                                                                                                                                                                                                                                   |                                                                                                                                                                                                       |                                                                                                                                                                                                                                     |                                                                                                                                                                                                             |                                                                                                                                                                                                               |
| [NULL]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                                                                                                                                                                                                                                                                                                                                                         |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                                                                                                                                          |                                                                                                                                                                                                                                                                                                                                            |                                                                                                                                                                                                                                                                                                                                                                                                                  |                                                                                                                                                                                                                                                                                                                                                                               |                                                                                                                                                                                                                                                                                                                                                                          |                                                                                                                                                                                                                                                                                                                                                                                                   |                                                                                                                                                                                                       |                                                                                                                                                                                                                                     |                                                                                                                                                                                                             |                                                                                                                                                                                                               |
| 2. FACILITIES TO MAINTAIN PROPER TEMPERATURE - Comments: COOLER AT PROPER TEMPERATURE.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | 9. WATER SOURCE: SAFE, HOT & COLD UNDER CITY PRESSURE - Comments: RUNNING HOT WATER AT ALL SINKS.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | 11. ADEQUATE NUMBER, CONVENIENT, ACCESSIBLE, DESIGNED, AND MAINTAINED - Comments: EXPOSED HAND SINK INSTALLED AT DISHWASHING AREAS.                                                                                                                                                                                                                     | 18. NO EVIDENCE OF RODENT OR INSECT OUTER OPENINGS PROTECTED/RODENT PROOFED, A WRITTEN LOG SHALL BE MAINTAINED AVAILABLE TO THE INSPECTORS - Comments: EXTERIOR DOORS RODENT PROOFED.                                                                                                                                                                                                                                                                                                                                              | 24. DISH WASHING FACILITIES: PROPERLY DESIGNED, CONSTRUCTED, MAINTAINED, INSTALLED, LOCATED AND OPERATED - Comments: 3 COMPARTMENT SINK INSTALLED.(PLUMBING REPAIRED).                                                   | 34. FLOORS: CONSTRUCTED PER CODE, CLEANED, GOOD REPAIR, COVING INSTALLED, DUST-LESS CLEANING METHODS USED - Comments: Observed untreated concrete flooring in lower level, dry storage. Open seams in dining room floor. Instructed operator to seal and maintain floors, to ensure surface is smooth and easily cleanable.                | 35. WALLS, CEILINGS, ATTACHED EQUIPMENT CONSTRUCTED PER CODE: GOOD REPAIR, SURFACES CLEAN AND DUST-LESS CLEANING METHODS - Comments:  Observed unfinished ceiling and exposed waste plumbing pipes in the following areas: men and women washroom, liquor storage room and basement dry storage areas. Instructed operator to install a drop or finished ceiling and encase expose plumping pipes in said areas. | 38. VENTILATION: ROOMS AND EQUIPMENT VENTED AS REQUIRED: PLUMBING: INSTALLED AND MAINTAINED - Comments: CORRECTED.                                                                                                                                                                                                                                                            |                                                                                                                                                                                                                                                                                                                                                                          |                                                                                                                                                                                                                                                                                                                                                                                                   |                                                                                                                                                                                                       |                                                                                                                                                                                                                                     |                                                                                                                                                                                                             |                                                                                                                                                                                                               |
| 34. FLOORS: CONSTRUCTED PER CODE, CLEANED, GOOD REPAIR, COVING INSTALLED, DUST-LESS CLEANING METHODS USED - Comments: FOUND A SMALL AMOUNT OF STANDING WATER ON THE FLOOR OF THE WALK-IN COOLER IN THE MEAT PREP AREA; REMOVE STANDING WATER.                                                                                                                                                                                                                                                                                                                                                               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                                                                                                                                                                                                                                                                                                                                                         |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                                                                                                                                          |                                                                                                                                                                                                                                                                                                                                            |                                                                                                                                                                                                                                                                                                                                                                                                                  |                                                                                                                                                                                                                                                                                                                                                                               |                                                                                                                                                                                                                                                                                                                                                                          |                                                                                                                                                                                                                                                                                                                                                                                                   |                                                                                                                                                                                                       |                                                                                                                                                                                                                                     |                                                                                                                                                                                                             |                                                                                                                                                                                                               |
| THE FLOORS NEED CLEANING UNDER VARIOUS STORAGE SHELVES ON THE SELLING FLOOR; CLEAN FLOORS WHERE NEEDED.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                                                                                                                                                                                                                                                                                                                                                         |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                                                                                                                                          |                                                                                                                                                                                                                                                                                                                                            |                                                                                                                                                                                                                                                                                                                                                                                                                  |                                                                                                                                                                                                                                                                                                                                                                               |                                                                                                                                                                                                                                                                                                                                                                          |                                                                                                                                                                                                                                                                                                                                                                                                   |                                                                                                                                                                                                       |                                                                                                                                                                                                                                     |                                                                                                                                                                                                             |                                                                                                                                                                                                               |
| 18. NO EVIDENCE OF RODENT OR INSECT OUTER OPENINGS PROTECTED/RODENT PROOFED, A WRITTEN LOG SHALL BE MAINTAINED AVAILABLE TO THE INSPECTORS - Comments: OBSERVED OUTER OPENINGS NOT RODENT PROOFED: THE SERVICE WINDOW DOES NOT CONTAIN SCREENS TO RODENT PROOF TRUCK WHILE IN BETWEEN SERVING CUSTOMERS. MANAGER INSTRUCTED TO SEAL TRUCK AND SERVICE WINDOW BY INSTALLING SLIDING SCREEN WINDOWS. SERIOUS VIOLATION 7-38-020                                                                                                                                                                               | 40. REFRIGERATION AND METAL STEM THERMOMETERS PROVIDED AND CONSPICUOUS - Comments: MUST PROVIDE METAL STEMMED THERMOMETER TO USE ON THE TRUCK WITH DAILY CALIBRATIONS.                                                                                                                                                                                                                                                                                                                                                                                                                                     | 12. HAND WASHING FACILITIES: WITH SOAP AND SANITARY HAND DRYING DEVICES, CONVENIENT AND ACCESSIBLE TO FOOD PREP AREA - Comments: NO HAND SOAP AND PAPER TOWELS PROVIDED AT THE HAND SINK LOCATED ON THE TRUCK. MUST PROVIDE PROPER HAND SOAP AND PAPER TOWELS WITH HOT/COLD RUNNING WATER UNDER CITY PRESSURE AT ALL TIMES. CRITICAL VIOLATION 7-38-030 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                                                                                                                                          |                                                                                                                                                                                                                                                                                                                                            |                                                                                                                                                                                                                                                                                                                                                                                                                  |                                                                                                                                                                                                                                                                                                                                                                               |                                                                                                                                                                                                                                                                                                                                                                          |                                                                                                                                                                                                                                                                                                                                                                                                   |                                                                                                                                                                                                       |                                                                                                                                                                                                                                     |                                                                                                                                                                                                             |                                                                                                                                                                                                               |
| 16. FOOD PROTECTED DURING STORAGE, PREPARATION, DISPLAY, SERVICE AND TRANSPORTATION - Comments: CORRECTED                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | 37. TOILET ROOM DOORS SELF CLOSING: DRESSING ROOMS WITH LOCKERS PROVIDED: COMPLETE SEPARATION FROM LIVING/SLEEPING QUARTERS - Comments: CORRECTED                                                                                                                                                                                                                                                                                                                                                                                                                                                          | 32. FOOD AND NON-FOOD CONTACT SURFACES PROPERLY DESIGNED, CONSTRUCTED AND MAINTAINED - Comments: CORRECTED                                                                                                                                                                                                                                              |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                                                                                                                                          |                                                                                                                                                                                                                                                                                                                                            |                                                                                                                                                                                                                                                                                                                                                                                                                  |                                                                                                                                                                                                                                                                                                                                                                               |                                                                                                                                                                                                                                                                                                                                                                          |                                                                                                                                                                                                                                                                                                                                                                                                   |                                                                                                                                                                                                       |                                                                                                                                                                                                                                     |                                                                                                                                                                                                             |                                                                                                                                                                                                               |
:END:


We could note that this column is structured in the following form:
- If there are several violations reported, those violations will be separated by ='|'=
- Every violation begins with a code and  a description
- Every violation could have *comments*, those comments appear after the
  string =- Comments:=

#+BEGIN_SRC sql :results table drawer
  select
  --inspection,
  --violations,
   btrim(split_part(s.token,'- Comments:', 1)) as violation, count(*)
  --split_part(s.token,'- Comments:', 2) as comments
  from inspections as t, unnest(string_to_array(violations, '|')) s(token)
  group by violation
  order by violation asc

#+END_SRC

#+RESULTS:
:RESULTS:
| violation                                                                                                                                  | count |
|--------------------------------------------------------------------------------------------------------------------------------------------+-------|
| 10. SEWAGE AND WASTE WATER DISPOSAL, NO BACK SIPHONAGE, CROSS  CONNECTION AND/OR BACK FLOW                                                 |  1233 |
| 11. ADEQUATE NUMBER, CONVENIENT, ACCESSIBLE, DESIGNED, AND MAINTAINED                                                                      |  4786 |
| 12. HAND WASHING FACILITIES: WITH SOAP AND SANITARY HAND DRYING DEVICES, CONVENIENT AND ACCESSIBLE TO FOOD PREP AREA                       |  3256 |
| 13. NO EVIDENCE OF RODENT OR INSECT INFESTATION, NO BIRDS, TURTLES OR OTHER ANIMALS                                                        |   831 |
| 14. PREVIOUS SERIOUS VIOLATION CORRECTED, 7-42-090                                                                                         |  1895 |
| 15. UNWRAPPED AND POTENTIALLY HAZARDOUS FOOD NOT RE-SERVED                                                                                 |     4 |
| 16. FOOD PROTECTED DURING STORAGE, PREPARATION, DISPLAY, SERVICE AND TRANSPORTATION                                                        |  6701 |
| 17. POTENTIALLY HAZARDOUS FOOD PROPERLY THAWED                                                                                             |   112 |
| 18. NO EVIDENCE OF RODENT OR INSECT OUTER OPENINGS PROTECTED/RODENT PROOFED, A WRITTEN LOG SHALL BE MAINTAINED AVAILABLE TO THE INSPECTORS | 28092 |
| 19. OUTSIDE GARBAGE WASTE GREASE AND STORAGE AREA; CLEAN, RODENT PROOF, ALL CONTAINERS COVERED                                             |  6787 |
| 1. SOURCE SOUND CONDITION, NO SPOILAGE, FOODS PROPERLY LABELED, SHELLFISH TAGS IN PLACE                                                    |   655 |
| 20. INSIDE CONTAINERS OR RECEPTACLES: ADEQUATE NUMBER, PROPERLY COVERED AND INSECT/RODENT PROOF                                            |   180 |
| 21. * CERTIFIED FOOD MANAGER ON SITE WHEN POTENTIALLY HAZARDOUS FOODS ARE  PREPARED AND SERVED                                             | 10537 |
| 22. DISH MACHINES: PROVIDED WITH ACCURATE THERMOMETERS, CHEMICAL TEST KITS AND SUITABLE GAUGE COCK                                         |  1487 |
| 23. DISHES AND UTENSILS FLUSHED, SCRAPED, SOAKED                                                                                           |     3 |
| 24. DISH WASHING FACILITIES: PROPERLY DESIGNED, CONSTRUCTED, MAINTAINED, INSTALLED, LOCATED AND OPERATED                                   |  5228 |
| 25. TOXIC ITEMS PROPERLY STORED, LABELED AND USED                                                                                          |   234 |
| 26. ADEQUATE NUMBER, CONVENIENT, ACCESSIBLE, PROPERLY DESIGNED AND INSTALLED                                                               |  2370 |
| 27. TOILET ROOMS ENCLOSED CLEAN, PROVIDED WITH HAND CLEANSER, SANITARY HAND DRYING DEVICES AND PROPER WASTE RECEPTACLES                    |   554 |
| 28. * INSPECTION REPORT SUMMARY DISPLAYED AND VISIBLE TO ALL CUSTOMERS                                                                     |  1349 |
| 29. PREVIOUS MINOR VIOLATION(S) CORRECTED 7-42-090                                                                                         |  9427 |
| 2. FACILITIES TO MAINTAIN PROPER TEMPERATURE                                                                                               |  7565 |
| 30. FOOD IN ORIGINAL CONTAINER, PROPERLY LABELED: CUSTOMER ADVISORY POSTED AS NEEDED                                                       | 16505 |
| 31. CLEAN MULTI-USE UTENSILS AND SINGLE SERVICE ARTICLES PROPERLY STORED: NO REUSE OF SINGLE SERVICE ARTICLES                              | 10550 |
| 32. FOOD AND NON-FOOD CONTACT SURFACES PROPERLY DESIGNED, CONSTRUCTED AND MAINTAINED                                                       | 55775 |
| 33. FOOD AND NON-FOOD CONTACT EQUIPMENT UTENSILS CLEAN, FREE OF ABRASIVE DETERGENTS                                                        | 65865 |
| 34. FLOORS: CONSTRUCTED PER CODE, CLEANED, GOOD REPAIR, COVING INSTALLED, DUST-LESS CLEANING METHODS USED                                  | 74572 |
| 35. WALLS, CEILINGS, ATTACHED EQUIPMENT CONSTRUCTED PER CODE: GOOD REPAIR, SURFACES CLEAN AND DUST-LESS CLEANING METHODS                   | 66183 |
| 36. LIGHTING: REQUIRED MINIMUM FOOT-CANDLES OF LIGHT PROVIDED, FIXTURES SHIELDED                                                           | 27344 |
| 37. TOILET ROOM DOORS SELF CLOSING: DRESSING ROOMS WITH LOCKERS PROVIDED: COMPLETE SEPARATION FROM LIVING/SLEEPING QUARTERS                |  8166 |
| 38. VENTILATION: ROOMS AND EQUIPMENT VENTED AS REQUIRED: PLUMBING: INSTALLED AND MAINTAINED                                                | 56502 |
| 39. LINEN: CLEAN AND SOILED PROPERLY STORED                                                                                                |   695 |
| 3. POTENTIALLY HAZARDOUS FOOD MEETS TEMPERATURE REQUIREMENT DURING STORAGE, PREPARATION DISPLAY AND SERVICE                                |  8058 |
| 40. REFRIGERATION AND METAL STEM THERMOMETERS PROVIDED AND CONSPICUOUS                                                                     | 16805 |
| 41. PREMISES MAINTAINED FREE OF LITTER, UNNECESSARY ARTICLES, CLEANING  EQUIPMENT PROPERLY STORED                                          | 35790 |
| 42. APPROPRIATE METHOD OF HANDLING OF FOOD (ICE) HAIR RESTRAINTS AND CLEAN APPAREL WORN                                                    |  6913 |
| 43. FOOD (ICE) DISPENSING UTENSILS, WASH CLOTHS PROPERLY STORED                                                                            |  8667 |
| 44. ONLY AUTHORIZED PERSONNEL IN THE FOOD-PREP AREA                                                                                        |   437 |
| 45. FOOD HANDLER REQUIREMENTS MET                                                                                                          |  6700 |
| 4. SOURCE OF CROSS CONTAMINATION CONTROLLED I.E. CUTTING BOARDS, FOOD  HANDLERS, UTENSILS, ETC                                             |   602 |
| 5. PERSONNEL WITH INFECTIONS RESTRICTED: NO OPEN SORES, WOUNDS, ETC                                                                        |    15 |
| 6. HANDS WASHED AND CLEANED, GOOD HYGIENIC PRACTICES; NO BARE HAND CONTACT WITH READY-TO-EAT FOODS.                                        |  1573 |
| 70. NO SMOKING REGULATIONS                                                                                                                 |   785 |
| 7. WASH AND RINSE WATER: CLEAN AND PROPER TEMPERATURE                                                                                      |   160 |
| 8. SANITIZING RINSE FOR EQUIPMENT AND UTENSILS:  CLEAN, PROPER TEMPERATURE, CONCENTRATION, EXPOSURE TIME                                   |  2974 |
| 9. WATER SOURCE: SAFE, HOT & COLD UNDER CITY PRESSURE                                                                                      |  2464 |
:END:

** Transforming the data

We will create a new schema ...

We will add the following columns
- month
- quarter
- day of week
- weekend
- number of violations (maybe number of violations per type?)





*NOTE*: You could also split between, /major violation found/ and /minor violation found/,
but we will keep this simple for the moment.

 #+BEGIN_SRC sql :tangle ./src/create_violations_table.sql
   drop table if exists violations;

   create table violations as
          select inspection::int  as entity_id,
                 date as outcome_date,
                 zip,
                 risk,
                 type as inspection_type,
                 facility_type,
                 license_num::varchar as license,
                 dba_name as business_name,
                 aka_name as aka,
                 results,
                 case
                      when left(results, 4) = 'Pass' then FALSE
                      else TRUE
                 end as outcome,
                 (regexp_matches(violation[1],'^(\d+)\.'))[1]::varchar as violation_type ,
                 violation[1] as violation_description,
                 violation[2] as violation_comment
          from
                        (
          select
                 inspection,
                 date, zip, risk, facility_type, dba_name, aka_name, results, license_num, type,
                 regexp_split_to_array(regexp_split_to_table(violations, '\| '),'- Comments') as violation
           from inspections
           where lower(results) !~ '.*business*.'
          ) b;
 #+END_SRC

 Now we will create a =violations= table, for this we will use the

 #+BEGIN_SRC sh :dir /docker:root@tutorial_bastion:/ :results org drawer
   psql ${FOOD_DB_URL} < /code/create_violations_table.sql
 #+END_SRC

 #+RESULTS:
 :RESULTS:
 DROP TABLE
 SELECT 562853
 :END:

 #+BEGIN_SRC sh :dir /docker:root@tutorial_bastion:/ :results org drawer
   psql ${FOOD_DB_URL} -c 'select count(*) from violations'
 #+END_SRC

 #+RESULTS:
 :RESULTS:
  count
 --------
  562853
 (1 row)

 :END:


 #+BEGIN_SRC sh :dir /docker:root@tutorial_bastion:/ :results org drawer
   psql ${FOOD_DB_URL} -c 'select * from violations limit 5'
 #+END_SRC

 #+RESULTS:
 :RESULTS:
  entity_id | outcome_date |  zip  |      risk       |    inspection_type    | facility_type | license |   business_name    |        aka         | results | outcome | violation_type |                                                            violation_description                                                            |                                                                           violation_comment
 -----------+--------------+-------+-----------------+-----------------------+---------------+---------+--------------------+--------------------+---------+---------+----------------+---------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------
    2071410 | 2017-07-25   | 60605 | Risk 1 (High)   | License Re-Inspection | Restaurant    | 2517129 | BULL DOG ALE HOUSE | BULL DOG ALE HOUSE | Pass    | f       | 8              | 8. SANITIZING RINSE FOR EQUIPMENT AND UTENSILS:  CLEAN, PROPER TEMPERATURE, CONCENTRATION, EXPOSURE TIME                                    | : ABATED. DISH MACHINES SANITIZES AT 100PPM OF CHLORINE.
    2071410 | 2017-07-25   | 60605 | Risk 1 (High)   | License Re-Inspection | Restaurant    | 2517129 | BULL DOG ALE HOUSE | BULL DOG ALE HOUSE | Pass    | f       | 9              | 9. WATER SOURCE: SAFE, HOT & COLD UNDER CITY PRESSURE                                                                                       | : ABATED. HOT WATER WAS PROVIDED.
    2071410 | 2017-07-25   | 60605 | Risk 1 (High)   | License Re-Inspection | Restaurant    | 2517129 | BULL DOG ALE HOUSE | BULL DOG ALE HOUSE | Pass    | f       | 18             | 18. NO EVIDENCE OF RODENT OR INSECT OUTER OPENINGS PROTECTED/RODENT PROOFED, A WRITTEN LOG SHALL BE MAINTAINED AVAILABLE TO THE INSPECTORS  | : ABATED. DOOR IS RODENT/INSECT PROOFED.
    2071412 | 2017-07-25   | 60640 | Risk 2 (Medium) | License               | Grocery Store | 2542856 | WILSON GROCERY     | WILSON GROCERY     | Pass    | f       | 32             | 32. FOOD AND NON-FOOD CONTACT SURFACES PROPERLY DESIGNED, CONSTRUCTED AND MAINTAINED                                                        | : MUST NOT USE TAPE AS A MEANS OF REPAIR ON THE EXTERIOR OF THE MEAT DISPLAY COOLER.
    2071412 | 2017-07-25   | 60640 | Risk 2 (Medium) | License               | Grocery Store | 2542856 | WILSON GROCERY     | WILSON GROCERY     | Pass    | f       | 34             | 34. FLOORS: CONSTRUCTED PER CODE, CLEANED, GOOD REPAIR, COVING INSTALLED, DUST-LESS CLEANING METHODS USED                                   | : FLOOR UNDER THE KITCHEN THREE COMPARTMENT SINK GREASE TRAP WITH EXCESSIVE GREASE. FLOOR OF THE WALK-IN COOLER WITH DIRT AND FOOD SPILLAGE. MUST CLEAN AND MAINTAIN.
 (5 rows)

 :END:

 Ok, everything seems correct. =:)=


* Using triage (finally)

With the data sitting in our database, we can start our analysis.

** The experiment concept

** Cross temporal validation and Timechop

/We need to add some images here/


** The =inspections-training.yaml= file
:PROPERTIES:
:header-args:yaml: :tangle ./src/inspections-training.yaml
:END:

This is the unique point of entry for using =triage=, basically in this
file, you will specify,  how you want to do the temporal
cross-validation, how to generate the labels, how to generate the
features, which models you want to run, and finally,  which are the
metrics you are interested.

You can check the final configuration in =./src/inspections-training.yaml=

Let's go by piece by piece


*** Experiment metadata

#+BEGIN_SRC yaml
# EXPERIMENT METADATA
# model_comment (optional) will end up in the model_comment column of the
# models table for each model created in this experiment
model_comment: 'test'
#+END_SRC

*** Time splitting

For this section we will need get some info about the time span of our
data,


#+BEGIN_SRC sql
select
min(date)::date as modeling_start_time,
max(date)::date as modeling_end_time
from inspections;
#+END_SRC

#+RESULTS:
| modeling_start_time | modeling_end_time |
|-------------------+-----------------|
|        2010-01-04 |      2017-07-25 |



#+BEGIN_SRC yaml
# TIME SPLITTING
# The time window to look at, and how to divide the window into
# train/test splits
temporal_config:
    beginning_of_time: '2010-01-04' # earliest date included in features
    modeling_start_time: '2016-01-04' # earliest date in any model
    modeling_end_time: '2017-07-25' # all dates in any model are < this date
    update_window: '3month' # how frequently to retrain models
    train_example_frequency: '1month' # time between rows for same entity in train matrix
    test_example_frequency: '1month' # time between rows for same entity in test matrix
    train_durations: ['6month'] # length of time included in a train matrix
    test_durations: ['1month'] # length of time included in a test matrix
    train_label_windows: ['1month'] # time period across which outcomes are labeled in train matrices
    test_label_windows: ['1month'] # time period across which outcomes are labeled in test matrices
#+END_SRC

*** Label generation

#+BEGIN_SRC yaml
# LABEL GENERATION
# Information needed to generate labels
#
# An events table is expected, with the columns:
#   entity_id - an identifier for which the labels are applied to
#   outcome_date - The date at which some outcome was known
#   outcome - A boolean outcome
# These are used to generate appropriate labels for each train/test split
events_table: 'violations'
#+END_SRC

*** Feature generation

#+BEGIN_SRC yaml
  # FEATURE GENERATION
  # The aggregate features to generate for each train/test split
  #
  # Implemented by wrapping collate: https://github.com/dssg/collate
  # Most terminology here is taken directly from collate
  #
  # Each entry describes a collate.SpacetimeAggregation object, and the
  # arguments needed to create it. Generally, each of these entries controls
  # the features from one source table, though in the case of multiple groups
  # may result in multiple output tables
  feature_aggregations:
      -
          # prefix given to the resultant tables
          prefix: 'violation_type'
          # from_obj is usually a source table but can be an expression, such as
          # a join (ie 'cool_stuff join other_stuff using (stuff_id)')
          from_obj: 'violations'
          # The date column to use for specifying which records to include
          # in temporal features. It is important that the column used specifies
          # the date at which the event is known about, which may be different
          # from the date the event happened.
          knowledge_date_column: 'outcome_date'

          # aggregates and categoricals define the actual features created. So
          # at least one is required
          #
          # Aggregates of numerical columns. Each quantity is a number of some
          # sort, and the list of metrics are applied to each quantity
          # aggregates:
          #     -
          #         quantity: 'homeless::INT'
          #         metrics:
          #             - 'count'
          #             - 'sum'
          #
          # Categorical features. The column given can be of any type, but the
          # choices must comparable to that type for equality within SQL
          # The result will be one feature for each choice/metric combination
          categoricals:
              -
                  column: 'violation_type'
                  choice_query: 'select distinct violation_type from violations'
                  metrics:
                      - 'count'
          # The time intervals over which to aggregate features
          intervals:
              - '1 week'
          # A list of different columns to separately group by
          groups:
              - 'entity_id'   ## This is the ID of the entity
#+END_SRC

*** Feature grouping

#+BEGIN_SRC yaml
  # FEATURE GROUPING
  # define how to group features and generate combinations
  # feature_group_definition allows you to create groups/subset of your features
  # by different criteria.
  # for instance, 'tables' allows you to send a list of collate feature tables
  # 'prefix' allows you to specify a list of feature name prefixes
  feature_group_definition:
      tables: ['violation_type_entity_id']

  # strategies for generating combinations of groups
  # available: all, leave-one-out, leave-one-in
  feature_group_strategies: ['all']
#+END_SRC

*** Model grouping

#+BEGIN_SRC yaml
  # MODEL GROUPING
  # Model groups are aimed at defining models which are equivalent across time splits.
  # By default, the classifier module name, hyperparameters, and feature names are used.
  #
  # model_group_keys defines a list of *additional* matrix metadata keys that
  # should be considered when creating a model group
  model_group_keys: []
  #    - 'train_duration'
  #    - 'train_label_window'
  #    - 'train_example_frequency'
#+END_SRC

*** Grid configuration
#+BEGIN_SRC yaml
  # GRID CONFIGURATION
  # The classifier/hyperparameter combinations that should be trained
  #
  # Each top-level key should be a class name, importable from triage. sklearn is
  # available, and if you have another classifier package you would like available,
  # contribute it to requirements.txt
  #
  # Each lower-level key is a hyperparameter name for the given classifier, and
  # each value is a list of potential values. All possible combinations of
  # classifiers and hyperparameters are trained.
  grid_config:
      'sklearn.ensemble.RandomForestClassifier':
          max_features: ['sqrt']
          criterion: ['gini', 'entropy']
          n_estimators: [100, 1000, 5000]
          min_samples_split: [10, 20, 50, 100]
          max_depth: [10, 20, 50, 100]
#+END_SRC

*** Model scoring

#+BEGIN_SRC yaml
# MODEL SCORING
# How each trained model is scored
#
# Each entry in 'metric_groups' needs a list of one of the metrics defined in
# triage.scoring.ModelScorer.available_metrics (contributions welcome!)
# Depending on the metric, either thresholds or parameters
#
# Parameters specify any hyperparameters needed. For most metrics,
# which are simply wrappers of sklearn functions, these
# are passed directly to sklearn.
#
# Thresholds are more specific: The list is subset and only the
# top percentile or top n entities are scored
#
# sort_seed, if passed, will seed the random number generator for each model's
# metric creation phase. This affects how entities with the same probabilities
# are sorted
scoring:
    metric_groups:
        -
            metrics: ['precision@', 'recall@', 'fpr@']
            thresholds:
                percentiles: [1.0, 2.0, 5.0, 10.0, 25.0]
                top_n: [25, 75, 150, 300, 500, 1000, 1500]

#+END_SRC


#+BEGIN_SRC ipython :tangle ./src/run.py
  import sqlalchemy
  import yaml

  from catwalk.storage import FSModelStorageEngine
  from triage.experiments import SingleThreadedExperiment

  with open('inspections-training.yaml') as f:
      experiment_config = yaml.load(f)

  experiment = SingleThreadedExperiment(
      config=experiment_config,
      db_engine=sqlalchemy.create_engine('postgresql://food_user:goli0808@food_db:5432/food'),
      model_storage_class=FSModelStorageEngine,
      project_path='./triage-generated'
  )

  experiment.run()
#+END_SRC


#+BEGIN_SRC sh :dir /docker:root@tutorial_bastion:/code :results org drawer
  python run.py
#+END_SRC

#+RESULTS:
:RESULTS:
:END:


* Looking the results at Tyra


* What's next?


- Add the shape file
  https://data.cityofchicago.org/api/geospatial/gdcf-axmw?method=export&format=Shapefile
- Text analysis?
- Routing based on the inspection list?
- Add more data sources?

* Appendix: What are all those files?

* Appendix: Getting help

* Additional DBs

- [[https://data.cityofchicago.org/Community-Economic-Development/Business-Licenses/r5kz-chrr][Business Licenses]]
- Food Inspections
- [[https://data.cityofchicago.org/Public-Safety/Crimes-2001-to-present/ijzp-q8t2][Crime]]
- Garbage Cart Complaints
- [[https://data.cityofchicago.org/Service-Requests/311-Service-Requests-Sanitation-Code-Complaints/me59-5fac][Sanitation Complaints]]
- Weather
- Sanitarian Information


* Questions

- How do I control the logging? I just want to see the info messages,
  not all

- How to interpret the table "event"?

- How to use additional tables?

- Could you draw an example of the temporal setting?

* Footnotes

[fn:3] This problem is
related to the process of /deduplication/ and there is another tutorial
for that that uses anothe DSaPP tool: =pgdedup=.

[fn:1] [[https://youtu.be/lyDLAutA88s][David Beazley | Keynote: Built in Super Heroes]]

[fn:2] [[https://youtu.be/1dKonIT-Yak][Nicole Donnelly | Forecasting critical food violations at restaurants using open data]]




* Temp stuff


Before doing that, let's check how many different =dba_name= we have.

#+BEGIN_SRC sql :results table drawer
  select
  count(distinct dba_name) as different_names
  from inspections;
#+END_SRC

#+RESULTS:
:RESULTS:
| different_names |
|----------------|
|          24646 |
:END:

#+BEGIN_SRC sql :results table drawer
  select
   dba_name,
   btrim(upper(regexp_replace(replace(dba_name, '''', ''), '[^a-zA-Z0-9 ]', '', 'g'))) as cleaned_name
  from inspections
  limit 30
#+END_SRC

#+RESULTS:
:RESULTS:
| dba_name                                      | cleaned_name                                 |
|----------------------------------------------+---------------------------------------------|
| D AND Y GROCERY                              | D AND Y GROCERY                             |
| ONE STOP FOOD MARKET                         | ONE STOP FOOD MARKET                        |
| CITGO                                        | CITGO                                       |
| KHAN DOLLAR STATION                          | KHAN DOLLAR STATION                         |
| FOSTER & BROADWAY BP/AUTOTECH                | FOSTER  BROADWAY BPAUTOTECH                 |
| Rizzo's Bar & Inn                            | RIZZOS BAR  INN                             |
| Rizzo's Bar & Inn                            | RIZZOS BAR  INN                             |
| SAVE-A-LOT #882                              | SAVEALOT 882                                |
| MEDITERRANEAN EXPRESS                        | MEDITERRANEAN EXPRESS                       |
| SWEET FREAKS                                 | SWEET FREAKS                                |
| MINGHIN CUISINE KITCHEN                      | MINGHIN CUISINE KITCHEN                     |
| HAPPY GROCERY & DOLLAR                       | HAPPY GROCERY  DOLLAR                       |
| ARDEN RESTAURANT                             | ARDEN RESTAURANT                            |
| TBD                                          | TBD                                         |
| MAGGIE GYROS & CHICKEN                       | MAGGIE GYROS  CHICKEN                       |
| WOLCOTT TAP                                  | WOLCOTT TAP                                 |
| WOLCOTT TAP                                  | WOLCOTT TAP                                 |
| 3JJJ'S BETTER TASTE JAMAICAN JERK RESTAURANT | 3JJJS BETTER TASTE JAMAICAN JERK RESTAURANT |
| THE HARDING TAVERN                           | THE HARDING TAVERN                          |
| ZACATACOS, II. INC                           | ZACATACOS II INC                            |
| ONESTI PIZZERIA INC                          | ONESTI PIZZERIA INC                         |
| 3JJJ'S BETTER TASTE JAMAICAN JERK RESTAURANT | 3JJJS BETTER TASTE JAMAICAN JERK RESTAURANT |
| NORMAN'S                                     | NORMANS                                     |
| MCCB                                         | MCCB                                        |
| CHECKERS DRIVE-IN RESTAURANTS, INC           | CHECKERS DRIVEIN RESTAURANTS INC            |
| Rizzo's Bar & Inn                            | RIZZOS BAR  INN                             |
| GRILL 87                                     | GRILL 87                                    |
| KFC                                          | KFC                                         |
| PACO'S TACOS 2                               | PACOS TACOS 2                               |
| MARTINI CLUB                                 | MARTINI CLUB                                |
:END:
