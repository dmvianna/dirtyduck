#+TITLE: Dirty duck: A triage's guided tour
#+AUTHOR: Center of Data Science for Public Policy
#+EMAIL: adolfo@uchicago.edu
#+STARTUP: showeverything
#+STARTUP: nohideblocks
#+PROPERTY: header-args:sql :engine postgresql
#+PROPERTY: header-args:sql+ :dbhost 0.0.0.0
#+PROPERTY: header-args:sql+ :dbport 5434
#+PROPERTY: header-args:sql+ :dbuser food_user
#+PROPERTY: header-args:sql+ :dbpassword some_password
#+PROPERTY: header-args:sql+ :database food
#+PROPERTY: header-args:sql+ :results table drawer
#+PROPERTY: header-args:shell     :results drawer
#+PROPERTY: header-args:ipython   :session food_inspections


* TODOs [6%]

  - [ ] Add an introduction
  - [ ] Define the entities for both "projects" (*EIS* and *Inspection prioritization*)
  - [ ] Define the outcomes for each "project" (*EIS* and *Inspection
    prioritization*)
  - [X] Add some exploration using =sql=
  - [ ] Add some visualizations using =python=
  - [ ] Explain the concept of a Machine Learning project
  - [ ] Explain the concept of Temporal Cross-validation and why it is
    important
  - [ ] Explain a little bit of =timechop=
  - [ ] SQL for transforming the data in *EIS*
  - [ ] Define one or two features for *EIS*
  - [ ] Define one or two features for *Inspection prioritization*
  - [ ] SQL for transforming the data in *Inspection prioritization*
  - [ ] Explain a little bit of =collate=
  - [ ] Run one experiment for *EIS*
  - [ ] Run one experiment for *Inspection prioritization*
  - [ ] Show the results in =tyra=


* Intro

  The [[https://data.cityofchicago.org/Health-Human-Services/Food-Inspections/4ijn-s7e5][Chicago's Food Inspections data set]] is well know, and it has been
  used in several examples around the web (e.g. [fn:4],  [fn:1], [fn:2])



* Description of the problem to solve

  Actually, We want to solve two problems: an /Early intervention system/ (*EIS*)
  and a /Inspection prioritization/.


  We will use the /same/ data set, first, we will be the restaurant's
  owner, and we want to know: /Will my restaurant be inspected in the/
  /next X period of time?/ Where $X$ could be 1 month, 1 week, 1 year,
  etc.

  Knowing the answer to this question, allows you (as the restaurant's
  owner) to be prepared and take the pertinent actions.


  The second scenario, is the following:  you work for the Chicago's
  government, and you try
  to prioritize your resources (i.e. your inspection workforce), since
  they are limited. So, you will use the data (the same data set,
  remember) for answering the next
  question: /Which X restaurants (facilities) are likely to violate some rule in the
  following Y period of time?/  In this case maybe you are interested not
  in all the violations but in the more grave.

  There are other questions that help to define the goal:

  - From Rayid's notes:

  /What are you inspecting?/ (people, places, other)
  /How far do you want to predict?/ (e.g. 1 mo, 6mo, 12 mo, etc)
  /How often do you want to update the list?/ (e.g. 1 mo, 6mo, 12 mo, etc)
  /What do you want to optimize for?/ (e.g. efficiency, long term
  compliance, novelty)

  One of the trickiest part of the inspection prioritization problem is
  that the data gives you $P(V|I)$ i.e. the probability of finding a
  violation given that (or conditioned to) an inspection occurred, but
  the thing that is interesting is $P(V)$ the probability of a violation
  ...

  - /Write more about using bayes theorem/

  - /Write more about how this problem is related to send police to areas with crime and how this perpetuate some discrimination/


* What do you need for this tutorial?

  [[http://www.docker.com][Docker]] and [[https://docs.docker.com/compose/][Docker Compose]] installed. That's it.
  Use the links for installing instructions.



* Infrastructure

  Besides data, in most of the data science projects you will need some
  other tools, for example a place to store the data (a database
  management system), a way
  for putting your model to work (an API) and a interface for looking
  the performace of your trained models (for this tutorial we are proposing [[https://github.com/dssg/tyra][tyra]])

  We are proving a little script for managing all the infrastructure in
  a (hopefully) transparent way.

  Before creating the infrastructure, change the string =your_password=
  for something else in the file
  =infrastructure/food_db/.env_example=

  #+BEGIN_SRC shell :tangle infrastructure/env_example
    POSTGRES_DB=food
    POSTGRES_HOST=0.0.0.0
    POSTGRES_USER=food_user
    POSTGRES_DB=food
    POSTGRES_PORT=5434
    POSTGRES_PASSWORD=your_password

    UID=1000
    GID=1000
  #+END_SRC

  And change the name of the file to =.env=.

  Also, adjust the =tyra= credentials file (We will explain what is =tyra=
  later). That file is located inside the folder =infrastructure/tyra/example_users.json=

  #+BEGIN_SRC shell :tangle infrastructure/tyra/example_users.json
    {
        "tyra_user":
        {
            "pw": "tutorial"
        }
    }
  #+END_SRC

  Change =tyra@example.com= for whatever you want (it will be your
  username), and change =topmodels= too (it will be the password).

  Next run the following command

  #+BEGIN_SRC shell
    ./manage.sh
  #+END_SRC

  #+RESULTS:
  :RESULTS:
  Usage: ./manage.sh {start|stop|build|rebuild|run|logs|status}
  :END:



  We need to create the infrastructure so, =start= it

  #+BEGIN_SRC shell
    ./manage.sh start
  #+END_SRC

  #+RESULTS:
  :RESULTS:
  :END:



  This will take some minutes the first time.

  You can check that everything is running smoothly with =status=

  #+BEGIN_SRC shell
    ./manage.sh status
  #+END_SRC

  #+RESULTS:
  :RESULTS:
  Name                       Command              State                           Ports
  ----------------------------------------------------------------------------------------------------------------------
  food_db                 docker-entrypoint.sh postgres   Up      0.0.0.0:5434->5432/tcp
  tutorial_api            python app.py                   Up      0.0.0.0:5000->5000/tcp
  tutorial_reverseproxy   nginx -g daemon off;            Up      80/tcp, 0.0.0.0:8081->8081/tcp, 0.0.0.0:8090->8090/tcp
  tutorial_tyra           python run_webapp.py            Up      0.0.0.0:5001->5001/tcp
  :END:


  You can type in your browser [[http://0.0.0.0:5001]] and you will see the
  login page from *Tyra*.


  Login to the docker container using

  #+BEGIN_EXAMPLE shel
  ./manage.sh bastion
  #+END_EXAMPLE

  You will see something like:

  #+BEGIN_EXAMPLE shell
  I have no name!@485373fb3c64:/$
  #+END_EXAMPLE

  Now the database is running, its named =food_db=, the single table in
  there named =inspections=

  Let's check the =schema= of =inspections= table, first, type the next
  command to connect to the database

  #+BEGIN_EXAMPLE shell
  psql ${FOOD_DB_URL}
  #+END_EXAMPLE

  and then, type the following command:

  #+BEGIN_SRC sql
    \dS+ inspections
  #+END_SRC

  #+RESULTS:
  | Table "public.inspections" |                   |           |          |              |             |
  |----------------------------+-------------------+-----------+----------+--------------+-------------|
  | Column                     | Type              | Modifiers | Storage  | Stats target | Description |
  | inspection                 | character varying | not null  | extended |              |             |
  | dba_name                    | character varying |           | extended |              |             |
  | aka_name                    | character varying |           | extended |              |             |
  | license_num                 | numeric           |           | main     |              |             |
  | facility_type               | character varying |           | extended |              |             |
  | risk                       | character varying |           | extended |              |             |
  | address                    | character varying |           | extended |              |             |
  | city                       | character varying |           | extended |              |             |
  | state                      | character varying |           | extended |              |             |
  | zip                        | character varying |           | extended |              |             |
  | date                       | date              |           | plain    |              |             |
  | type                       | character varying |           | extended |              |             |
  | results                    | character varying |           | extended |              |             |
  | violations                 | character varying |           | extended |              |             |
  | latitude                   | numeric           |           | main     |              |             |
  | longitude                  | numeric           |           | main     |              |             |
  | location                   | character varying |           | extended |              |             |

  Now, you can disconnect from the database typing =\q=

* Data

** Downloading

   #+BEGIN_SRC shell
     curl "https://data.cityofchicago.org/api/views/4ijn-s7e5/rows.csv?accessType=DOWNLOAD" > data/inspections.csv
   #+END_SRC

   #+RESULTS:
   :RESULTS:
   :END:

   #+BEGIN_SRC shell :dir data
     wc -l inspections.csv
   #+END_SRC

   #+RESULTS:
   :RESULTS:
   377168 inspections.csv
   :END:

   Ok, the data is now in =/data=, we can check how many rows the dataset contains

** Uploading to our database
   Assuming that you are already inside =bastion=, run the following


   #+BEGIN_SRC sh :dir /docker:root@tutorial_bastion:/ :results raw drawer
     psql ${FOOD_DB_URL} -c 'select count(*) from inspections'
   #+END_SRC

   #+RESULTS:
   :RESULTS:
   count
   -------
   0
   (1 row)

   :END:

   (If you are connected to the database, you could just type =select count(*) from inspections=

   #+RESULTS:
   :RESULTS:
   count
   -------
   0
   (1 row)

   :END:



   #+BEGIN_SRC sh :dir /docker:root@tutorial_bastion:/ :results raw drawer
     ls -lh /data
   #+END_SRC

   #+RESULTS:
   :RESULTS:
   total 176M
   -rw-rw-r-- 1 1000 1000 176M Aug 19 14:16 inspections.csv
   :END:

   #+BEGIN_SRC sh :dir /docker:root@tutorial_bastion:/
     psql ${FOOD_DB_URL} -c "\copy inspections FROM '/data/inspections.csv' WITH HEADER CSV"
   #+END_SRC

   #+RESULTS:
   : COPY 153465

   #+BEGIN_SRC sh :dir /docker:root@tutorial_bastion:/ :results org drawer
     psql ${FOOD_DB_URL} -c 'select * from inspections limit 1'
   #+END_SRC

   #+RESULTS:
   :RESULTS:
   inspection |    dba_name     |    aka_name     | license_num | facility_type |      risk       |          address          |  city   | state |  zip  |    date    |  type   | results |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            violations                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |      latitude      |     longitude      |                 location
   ------------+-----------------+-----------------+-------------+---------------+-----------------+---------------------------+---------+-------+-------+------------+---------+---------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------+--------------------+------------------------------------------
   2078651    | D AND Y GROCERY | D AND Y GROCERY |     1477137 | Grocery Store | Risk 2 (Medium) | 8200 S COTTAGE GROVE AVE  | CHICAGO | IL    | 60619 | 2017-08-18 | Canvass | Fail    | 12. HAND WASHING FACILITIES: WITH SOAP AND SANITARY HAND DRYING DEVICES, CONVENIENT AND ACCESSIBLE TO FOOD PREP AREA - Comments: INADEQUATE TOILET FACILITIES ON SITE. INOPERABLE TOILET ON SITE, UNABLE TO USE/OPERATE PROPERLY. NO SOAP OR SANITARY HAND DRYING DEVICE AT EXPOSED HANDSINK IN PREP AREA. INSTD TO PROVIDE AT ALL TIMES. STAFF TOILET ROOM NOT CLEAN, CAT FECES AND CAT LITTER ON FLOOR, SOILED TOILET PAPER ON PILE ON STAFF TOILET ROOM FLOOR. EXTREME FOUL SMELL IN STAFF TOILET ROOM. VIOLATION 7-38-030 CRITICAL. INSTD TO MAINTAIN CLEAN TOILET ROOM AND OPERABLE TOILET FACILITIES. | 41. PREMISES MAINTAINED FREE OF LITTER, UNNECESSARY ARTICLES, CLEANING  EQUIPMENT PROPERLY STORED - Comments: MUST ORGANIZE AND MAINTAIN THE STORAGE AREA BY THE FURNACE IN THE REAR PREP AREA, ORGANIZE BEHIND FRONT COUNTER. ORGANIZE WALK-IN COOLER USED FOR STORAGE OF SODA POP.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +| 41.745704140078026 | -87.60522820363809 | (41.745704140078026, -87.60522820363809)
   |                 |                 |             |               |                 |                           |         |       |       |            |         |         |  | 34. FLOORS: CONSTRUCTED PER CODE, CLEANED, GOOD REPAIR, COVING INSTALLED, DUST-LESS CLEANING METHODS USED - Comments: CLEAN FLOORS UNDER AROUND AND BEHIND SHELVES, COUNTERS AND , FRONT COUNTER AREA, PREP AREA AND INSIDE OF THE WALK-IN COOLER. | 33. FOOD AND NON-FOOD CONTACT EQUIPMENT UTENSILS CLEAN, FREE OF ABRASIVE DETERGENTS - Comments: OBSERVED THE STORAGE SHELVES NOT CLEAN IN DRY STORAGE AREA, AND IN REACH IN COOLERS, INSTRUCTED TO CLEAN. ALSO CLEAN AND SANITZE CHEESE CONTAINER FRONT PREP AREA. | 32. FOOD AND NON-FOOD CONTACT SURFACES PROPERLY DESIGNED, CONSTRUCTED AND MAINTAINED - Comments: OBSERVED INNER DOOR OF THE SODA MACHINE CRACKED GLASS, INSTRUCTED TO REPLACE. | 38. VENTILATION: ROOMS AND EQUIPMENT VENTED AS REQUIRED: PLUMBING: INSTALLED AND MAINTAINED - Comments: TOILET ROOM VENTILATION IN POOR REPAIR. INSTD TO REPAIR. | 35. WALLS, CEILINGS, ATTACHED EQUIPMENT CONSTRUCTED PER CODE: GOOD REPAIR, SURFACES CLEAN AND DUST-LESS CLEANING METHODS - Comments: WALLS AND CEILING IN STAFF TOILET ROOM IN POOR REPAIR, GAPS AND HOLES. INSTD TO REPAIR SAME. CEILING ON PREMISES ABOVE FRONT DISPLAY  IN POOR REPAIR, PEELING PAINT, UNEVEN SURFACE. INSTD TO REPAIR. | 22. DISH MACHINES: PROVIDED WITH ACCURATE THERMOMETERS, CHEMICAL TEST KITS AND SUITABLE GAUGE COCK - Comments: NO CHEMICAL TEST KIT ON SITE FOR SANITIZER AT 3-COMPARTMENT SINK. INSTD TO PROVIDE SAME. VIOLATION 7-38-030 CRITICAL.  | 3. POTENTIALLY HAZARDOUS FOOD MEETS TEMPERATURE REQUIREMENT DURING STORAGE, PREPARATION DISPLAY AND SERVICE - Comments: POTENTIALLY HAZARDOUS FOOD AT IMPROPER TEMPERATURE. COOKED GROUND BEEF AT 90.8F IN HOT HOLDING UNIT. VIOLATION 7-38-005A CRITICAL. PRODUCT VOLUNTARILY DISPOSED OF AND DENATURED AT THIS TIME. APPROX 5LBS. $20 VALUE. VIOLATIONS 7-38-005A CRITICAL. | 13. NO EVIDENCE OF RODENT OR INSECT INFESTATION, NO BIRDS, TURTLES OR OTHER ANIMALS - Comments: LIVE CAT ON SITE, WALKING IN AISLES. VIOLATION 7-38-020 CRITICAL. LIVE ANIMALS ON SITE ARE PROHIBITED. | 18. NO EVIDENCE OF RODENT OR INSECT OUTER OPENINGS PROTECTED/RODENT PROOFED, A WRITTEN LOG SHALL BE MAINTAINED AVAILABLE TO THE INSPECTORS - Comments: FRONT DOOR NOT RODENT PROOF, APPROX 1/2 INCH GAP AT TOP OF DOOR. INSTD TO RODENT PROOF DOOR AND HAVE TIGHT FITTING. LIVE ROACH IN STAFF TOILET ROOM. INSTD TO REMOVE ROACH, CLEAN AND SANITIZE AFFECTED AREAS. VIOLATION 7-38-020 SERIOUS. |                    |                    |
   (1 row)

   :END:

   You could see the meaning of each column [[https://data.cityofchicago.org/api/assets/BAD5301B-681A-4202-9D25-51B2CAE672FF?download=true][here]].


   #+BEGIN_QUOTE
   Risk category of facility: Each establishment is categorized as to its risk of adversely
   affecting the public’s health, with 1 being the highest and 3 the lowest. The frequency of
   inspection is tied to this risk, with risk 1 establishments inspected most frequently and
   risk 3 least frequently.
   #+END_QUOTE


   #+BEGIN_QUOTE
   Inspection type: An inspection can be one of the following types: canvass, the most
   common type of inspection performed at a frequency relative to the risk of the
   establishment; consultation, when the inspection is  done at the request of the owner
   prior to the opening of the establishment; complaint, when  the inspection is done in
   response to a complaint against the establishment; license, when the inspection is done
   as a requirement for the establishment to receive its license to operate; suspect food
   poisoning, when the inspection is done in response to one or more persons claiming to
   have gotten ill as a result of eating at the establishment (a specific type of complaint-
   based inspection); task-force inspection, when an inspection of a bar or tavern is done.
   Re-inspections can occur for most types of these inspections and are indicated as such
   #+END_QUOTE

   #+BEGIN_QUOTE
   Results: An inspection can pass, pass with conditions or fail. Establishments receiving a
   ‘pass’ were found to have no critical or serious violations (violation number 1-14 and 15-
   29, respectively). Establishments receiving a ‘pass  with conditions’ were found to have
   critical or serious violations, but these were corrected during the inspection.
   Establishments receiving a ‘fail’ were found to have critical or serious violations that
   were not correctable during the inspection. An establishment receiving a ‘fail’ does not
   necessarily mean the establishment’s licensed is suspended. Establishments found to
   be out of business or not located are indicated as such.
   #+END_QUOTE

   #+BEGIN_QUOTE
   Violations: An establishment can receive one or more of 45 distinct violations (violation
   numbers 1-44 and 70). For each violation number listed for a given establishment, the
   requirement the establishment must meet in order for it to NOT receive a violation is
   noted, followed by a specific description of the findings that caused the violation to be
   issued.
   #+END_QUOTE

** Transforming the data

   For tackling a Machine Learning problem you need to identify the
   *entities* of your problem domain, and if your problem involves time,
   how those entities change over time.

   In this tutorial, we have two different goals: (1) an *EIS* and
   (2) *prioritize inspections*, the entity in which we are interested in
   both cases is the  ...

   The *outcome* is what differ between those two projects. For *EIS* the
   outcome is *inspected*, for *Inspections*, the outcome is *violation found*.

   One of the golden rules -that will make your life easier- is:

   /You can't change your original data/

   The reason for this is, if you make some mistake, or if you want to
   try a different thing you will always can go back to the beginning and
   start over.

   Let's see the data and try to see how it needs to be transformed.

   Remember that the data that we have is one inspection per row.

   We will check the result of the inspections:

   #+BEGIN_SRC sql :results table drawer
     select
     results, count(*) as total_number
     from
     inspections
     group by
     results
     order by total_number desc;

   #+END_SRC

   #+RESULTS:
   :RESULTS:
   | results              | total_number |
   |----------------------+-------------|
   | Pass                 |       90310 |
   | Fail                 |       29770 |
   | Pass w/ Conditions   |       14507 |
   | Out of Business      |       13773 |
   | No Entry             |        4240 |
   | Not Ready            |         805 |
   | Business Not Located |          60 |
   :END:

   We will remove =Not Ready=, =No Entry=, =Out of Business= and =Business Not Located=
   from the data, and We will only keep all the other options (=Fail=, =Pass w/Condition= and
   =Pass)=.

   We will add the following columns in =cleaned.inspections=
   - year
   - month
   - day of week
   - is_weekend
   - week_of_year
   - quarter

   We will remove superfluous spaces and will transform the test to
   uppercase, also, we will clean =risk= and we will convert =location= to a
   real =Point=.

   We will drop the columns =state=, =latitude=, =longitude=, since these are
   redundant.

   We will create a new =schema=

   #+BEGIN_SRC sql
     create schema if not exists cleaned;
   #+END_SRC

   #+RESULTS:

   #+BEGIN_SRC sql :results table drawer :tangle ./src/create_cleaned_inspections_table.sql
     drop table if exists cleaned.inspections cascade;

     create table cleaned.inspections as (
     select
     inspection,
     btrim(results) as results,
     license_num,
     dba_name as facility,
     aka_name as facility_aka,
     facility_type,
     substring(risk from '\((.+)\)') as risk,
     address,
     zip as zip_code,
     btrim(upper(city)) as city,
     btrim(upper(type)) as type,
     date,
     extract(year from date) as year,
     extract(month from date) as month,
     extract(isodow from date) as day_of_week, -- Monday: 1 ... Sunday: 7
     case
     when extract(isodow from date) in (6,7) then TRUE
     else FALSE
     end as is_weekend,
     extract(week from date) as week_of_year,
     extract(quarter from date) as quarter,
     ST_SetSRID(ST_MakePoint(longitude, latitude),4326) as location
     from inspections
     where results in ('Fail', 'Pass', 'Pass w/ Conditions') and license_num is not null
     )
   #+END_SRC

   #+RESULTS:


   You could execute this code using (if you are not connected to the database):

   #+BEGIN_SRC sh :dir /docker:root@tutorial_bastion:/ :results org drawer
     psql ${FOOD_DB_URL} < /code/create_cleaned_inspections_table.sql
   #+END_SRC

   Or, if you are connected to the database

   #+BEGIN_EXAMPLE sql
   \i /code/create_cleaned_inspections_table.sql
   #+END_EXAMPLE


   #+BEGIN_SRC sql :results table
     select count(inspection) from cleaned.inspections;
   #+END_SRC

   #+RESULTS:
   :RESULTS:
   |  count |
   |--------|
   | 134573 |
   :END:


   Let's look closer the column =violations=:

   #+BEGIN_SRC sql :results table drawer
     select violations
     from inspections
     limit 5
   #+END_SRC

   #+RESULTS:
   :RESULTS:
   | violations                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                                                                                                                                                                                                                                                                    |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                                                                                                                                          |                                                                                                                                                                                                                                                                                                                                            |                                                                                                                                                                                                                                                                                                                                                                      |                                                                                                                                                                                                                                                                                                                                                                               |                                                                                                                                                                                                                                                                                                                                                                          |                                                                                                                                                                                                                                                                                                                                                                                                   |                                                                                                                                                                                                       |                                                                                                                                                                                                                                     |                                                                                                                                                                                                             |                                                                                                                                                                                                               |
   |-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
   | 12. HAND WASHING FACILITIES: WITH SOAP AND SANITARY HAND DRYING DEVICES, CONVENIENT AND ACCESSIBLE TO FOOD PREP AREA - Comments: INADEQUATE TOILET FACILITIES ON SITE. INOPERABLE TOILET ON SITE, UNABLE TO USE/OPERATE PROPERLY. NO SOAP OR SANITARY HAND DRYING DEVICE AT EXPOSED HANDSINK IN PREP AREA. INSTD TO PROVIDE AT ALL TIMES. STAFF TOILET ROOM NOT CLEAN, CAT FECES AND CAT LITTER ON FLOOR, SOILED TOILET PAPER ON PILE ON STAFF TOILET ROOM FLOOR. EXTREME FOUL SMELL IN STAFF TOILET ROOM. VIOLATION 7-38-030 CRITICAL. INSTD TO MAINTAIN CLEAN TOILET ROOM AND OPERABLE TOILET FACILITIES. | 41. PREMISES MAINTAINED FREE OF LITTER, UNNECESSARY ARTICLES, CLEANING  EQUIPMENT PROPERLY STORED - Comments: MUST ORGANIZE AND MAINTAIN THE STORAGE AREA BY THE FURNACE IN THE REAR PREP AREA, ORGANIZE BEHIND FRONT COUNTER. ORGANIZE WALK-IN COOLER USED FOR STORAGE OF SODA POP.                                                                                                                                                                                                                                                                                                                       |                                                                                                                                                                                                                                                                    |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                                                                                                                                          |                                                                                                                                                                                                                                                                                                                                            |                                                                                                                                                                                                                                                                                                                                                                      |                                                                                                                                                                                                                                                                                                                                                                               |                                                                                                                                                                                                                                                                                                                                                                          |                                                                                                                                                                                                                                                                                                                                                                                                   |                                                                                                                                                                                                       |                                                                                                                                                                                                                                     |                                                                                                                                                                                                             |                                                                                                                                                                                                               |
   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | 34. FLOORS: CONSTRUCTED PER CODE, CLEANED, GOOD REPAIR, COVING INSTALLED, DUST-LESS CLEANING METHODS USED - Comments: CLEAN FLOORS UNDER AROUND AND BEHIND SHELVES, COUNTERS AND , FRONT COUNTER AREA, PREP AREA AND INSIDE OF THE WALK-IN COOLER.                                                                                                                                                                                                                                                                                                                                                         | 33. FOOD AND NON-FOOD CONTACT EQUIPMENT UTENSILS CLEAN, FREE OF ABRASIVE DETERGENTS - Comments: OBSERVED THE STORAGE SHELVES NOT CLEAN IN DRY STORAGE AREA, AND IN REACH IN COOLERS, INSTRUCTED TO CLEAN. ALSO CLEAN AND SANITZE CHEESE CONTAINER FRONT PREP AREA. | 32. FOOD AND NON-FOOD CONTACT SURFACES PROPERLY DESIGNED, CONSTRUCTED AND MAINTAINED - Comments: OBSERVED INNER DOOR OF THE SODA MACHINE CRACKED GLASS, INSTRUCTED TO REPLACE.                                                                                                                                                                                                                                                                                                                                                     | 38. VENTILATION: ROOMS AND EQUIPMENT VENTED AS REQUIRED: PLUMBING: INSTALLED AND MAINTAINED - Comments: TOILET ROOM VENTILATION IN POOR REPAIR. INSTD TO REPAIR.                                                         | 35. WALLS, CEILINGS, ATTACHED EQUIPMENT CONSTRUCTED PER CODE: GOOD REPAIR, SURFACES CLEAN AND DUST-LESS CLEANING METHODS - Comments: WALLS AND CEILING IN STAFF TOILET ROOM IN POOR REPAIR, GAPS AND HOLES. INSTD TO REPAIR SAME. CEILING ON PREMISES ABOVE FRONT DISPLAY  IN POOR REPAIR, PEELING PAINT, UNEVEN SURFACE. INSTD TO REPAIR. | 22. DISH MACHINES: PROVIDED WITH ACCURATE THERMOMETERS, CHEMICAL TEST KITS AND SUITABLE GAUGE COCK - Comments: NO CHEMICAL TEST KIT ON SITE FOR SANITIZER AT 3-COMPARTMENT SINK. INSTD TO PROVIDE SAME. VIOLATION 7-38-030 CRITICAL.                                                                                                                                 | 3. POTENTIALLY HAZARDOUS FOOD MEETS TEMPERATURE REQUIREMENT DURING STORAGE, PREPARATION DISPLAY AND SERVICE - Comments: POTENTIALLY HAZARDOUS FOOD AT IMPROPER TEMPERATURE. COOKED GROUND BEEF AT 90.8F IN HOT HOLDING UNIT. VIOLATION 7-38-005A CRITICAL. PRODUCT VOLUNTARILY DISPOSED OF AND DENATURED AT THIS TIME. APPROX 5LBS. $20 VALUE. VIOLATIONS 7-38-005A CRITICAL. | 13. NO EVIDENCE OF RODENT OR INSECT INFESTATION, NO BIRDS, TURTLES OR OTHER ANIMALS - Comments: LIVE CAT ON SITE, WALKING IN AISLES. VIOLATION 7-38-020 CRITICAL. LIVE ANIMALS ON SITE ARE PROHIBITED.                                                                                                                                                                   | 18. NO EVIDENCE OF RODENT OR INSECT OUTER OPENINGS PROTECTED/RODENT PROOFED, A WRITTEN LOG SHALL BE MAINTAINED AVAILABLE TO THE INSPECTORS - Comments: FRONT DOOR NOT RODENT PROOF, APPROX 1/2 INCH GAP AT TOP OF DOOR. INSTD TO RODENT PROOF DOOR AND HAVE TIGHT FITTING. LIVE ROACH IN STAFF TOILET ROOM. INSTD TO REMOVE ROACH, CLEAN AND SANITIZE AFFECTED AREAS. VIOLATION 7-38-020 SERIOUS. |                                                                                                                                                                                                       |                                                                                                                                                                                                                                     |                                                                                                                                                                                                             |                                                                                                                                                                                                               |
   | 16. FOOD PROTECTED DURING STORAGE, PREPARATION, DISPLAY, SERVICE AND TRANSPORTATION - Comments: FOOD NOT PROTECTED DURING STORAGE, FLY STRIPS WITH DEAD FLIES OVER FOOD PREP/MEAT PREP AREA. INSTD TO USE PROPER PEST CONTROL MEASURES. VIOLATION 7-38-005A SERIOUS                                                                                                                                                                                                                                                                                                                                         | 18. NO EVIDENCE OF RODENT OR INSECT OUTER OPENINGS PROTECTED/RODENT PROOFED, A WRITTEN LOG SHALL BE MAINTAINED AVAILABLE TO THE INSPECTORS - Comments: OVER 10 LIVE HOUSE FLIES AND 25 LIVE FRUIT FLIES NOTED IN MEAT PREP AREA. MICE DROPPINGS (OVER 100) NOTED ON THE FLOOR AND SHELVES IN REAR STORAGE AREAS, BASEMENT FLOOR, AND DISPLAY SHELVES. MUST REMOVE ALL FLIES, DROPPINGS, CLEAN AND SANITIZE ALL AFFECTED AREAS. CONTACT PEST CONTROL FOR SERVICE. FRONT DOOR NOT RODENT PROOF, APPROX 1/2 INCH GAP AT DOORS. INSTD TO RODENT PROOF SAME AND HAVE TIGHT FITTING. VIOLATION 7-38-020 SERIOUS. | 19. OUTSIDE GARBAGE WASTE GREASE AND STORAGE AREA; CLEAN, RODENT PROOF, ALL CONTAINERS COVERED - Comments: OUTSIDE GARBAGE AREA NOT MAINTAINED. EXTERIOR OF GREASE INTERCEPTOR ENRUSTED WITH GREASE. MUST CLEAN AND MAINTAIN. VIOLATION 7-38-020 SERIOUS.          | 1. SOURCE SOUND CONDITION, NO SPOILAGE, FOODS PROPERLY LABELED, SHELLFISH TAGS IN PLACE - Comments: UNWHOLESOME, SPOILED  RAW MEAT PRODUCTS NOTED IN WALK IN COOLER, BEING OFFERED FOR SALE. LARGE SOLID BLOCK OF VARIETY OF MEATS (BEEF, PORK, CHICKEN CLUMPED TOGETHER) WITH FOUL SMELL,  BLACK, GREEN, AND GRAY IN COLOR. ALSO NOTED LIVE FLIES ON GROUND BEEF IN MEAT PREP AREA  WITH FOUL SMELL AND BROWN IN COLOR. VIOLATION 7-38-005B CRITICAL. APPROX 100LBS $500 VALUE. ALL PRODUCT DISCARDED AND DENATURED AT THIS TIME. | 17. POTENTIALLY HAZARDOUS FOOD PROPERLY THAWED - Comments: IMPROPER THAWING OF CHICKEN NOTED. CHICKEN IN STANDING WATER IN BASIN OF 3-COMPARTMENT SINK. INSTD ON PROPER THAWING TECHNIQUES. VIOLATION 7-38-005A SERIOUS. | 12. HAND WASHING FACILITIES: WITH SOAP AND SANITARY HAND DRYING DEVICES, CONVENIENT AND ACCESSIBLE TO FOOD PREP AREA - Comments: NO SOAP NOTED AT EXPOSED HANDSINK IN MEAT PREP AREA. MUST PROVIDE AT ALL TIMES. VIOLATION 7-38-030 CRITICAL.                                                                                              | 3. POTENTIALLY HAZARDOUS FOOD MEETS TEMPERATURE REQUIREMENT DURING STORAGE, PREPARATION DISPLAY AND SERVICE - Comments: THE FOLLOWING POTENTIALLY HAZARDOUS FOODS AT IMPROPER TEMPERATURES ON COUNTERTOP: GROUND SAUSAGE AT 60.8F, RAW CHICKEN AT 49.2F. ALL PRODUCT DISPOSED OF AND DENATURED AT THIS TIME. VIOLATION 7-38-005A CRITICAL. APPROX 30LBS, $100 VALUE. | 13. NO EVIDENCE OF RODENT OR INSECT INFESTATION, NO BIRDS, TURTLES OR OTHER ANIMALS - Comments: 2 LIVE KITTENS NOTED IN BASEMENT. LIVE ANIMALS ARE PROHIBITED ON SITE. VIOLATION 7-38-020 CRITICAL.                                                                                                                                                                           | 33. FOOD AND NON-FOOD CONTACT EQUIPMENT UTENSILS CLEAN, FREE OF ABRASIVE DETERGENTS - Comments: ALL FOOD AND NON FOOD CONTACT EQUIPMENT NOT CLEAN, EXCESSIVE DEBRIS: INTERIOR/EXTERIOR OF ALL COOLERS/FREEZERS, MICROWAVE, OVEN, FRYERS, STORAGE SHELVES, MEAT DISPLAY CASE, PREP TABLES, MEAT SAW, MEAT GRINDER, BASINS OF ALL SINKS. INSTD TO CLEAN AND MAINTAIN SAME. | 32. FOOD AND NON-FOOD CONTACT SURFACES PROPERLY DESIGNED, CONSTRUCTED AND MAINTAINED - Comments: WALK IN FREEZER ENCRUSTED WITH ICE THROUGH OUT. WALK IN COOLER CONDENSOR LINE IN POOR REPAIR, LEAKING. INSTD TO REPAIR SAME. CUTTING BOARDS PITTED, WITH DEEP, DARK GROOVES, WORN BEYOND REPAIR. INSTD TO REPLACE AND MAINTAIN CUTTING BOARDS.                                                   | 34. FLOORS: CONSTRUCTED PER CODE, CLEANED, GOOD REPAIR, COVING INSTALLED, DUST-LESS CLEANING METHODS USED - Comments: FLOORS THROUGH OUT NOT CLEAN, DEBRIS. INSTD TO CLEAN AND MAINTAIN AT ALL TIMES, | 35. WALLS, CEILINGS, ATTACHED EQUIPMENT CONSTRUCTED PER CODE: GOOD REPAIR, SURFACES CLEAN AND DUST-LESS CLEANING METHODS - Comments: WALLS AND LIGHTSHIELDS THROUGH OUT NOT CLEAN, DEBRIS, DEAD FLIES. INSTD TO CLEAN AND MAINTAIN. | 41. PREMISES MAINTAINED FREE OF LITTER, UNNECESSARY ARTICLES, CLEANING  EQUIPMENT PROPERLY STORED - Comments: EXTEME CLUTTER IN ALL STORAGE AREAS AND BASEMENT. INSTD TO REMOVE CLUTTER AND ORGANIZE AREAS. | 22. DISH MACHINES: PROVIDED WITH ACCURATE THERMOMETERS, CHEMICAL TEST KITS AND SUITABLE GAUGE COCK - Comments: NO CHEMICAL TEST KIT ON SITE FOR SANITIZER FOR 3-COMPARTMENT SINK. VIOLATION 7-38-030 SERIOUS. |
   | 33. FOOD AND NON-FOOD CONTACT EQUIPMENT UTENSILS CLEAN, FREE OF ABRASIVE DETERGENTS - Comments: INTERIOR OF WALK IN COOLER NOT CLEAN OF DEBRIS. MUST CLEAN/MAINTAIN. ALSO LOWER DISPLAY SHELVES NOT CLEAN OF DEBRIS. MUST CLEAN/MAINTAIN.                                                                                                                                                                                                                                                                                                                                                                   | 42. APPROPRIATE METHOD OF HANDLING OF FOOD (ICE) HAIR RESTRAINTS AND CLEAN APPAREL WORN - Comments:  EMPLOYEES NOT WEARING  HAIR RESTRAINT IN FOOD PREP AREA.MUST PROVIDE.                                                                                                                                                                                                                                                                                                                                                                                                                                 | 45. FOOD HANDLER REQUIREMENTS MET - Comments: NO PROOF OF THE NEW FOOD HANDLERS TRAINING FOR EMPLOYEES. MUST PROVIDE FOR EMPLOYEES.                                                                                                                                | 40. REFRIGERATION AND METAL STEM THERMOMETERS PROVIDED AND CONSPICUOUS - Comments: NO METAL STEM THERMOMETER FOR EMPLOYEES AND MISSING THERMOMETER INSIDE REACH IN COOLER BEHIND COUNTER. MUST PROVIDE.                                                                                                                                                                                                                                                                                                                            |                                                                                                                                                                                                                          |                                                                                                                                                                                                                                                                                                                                            |                                                                                                                                                                                                                                                                                                                                                                      |                                                                                                                                                                                                                                                                                                                                                                               |                                                                                                                                                                                                                                                                                                                                                                          |                                                                                                                                                                                                                                                                                                                                                                                                   |                                                                                                                                                                                                       |                                                                                                                                                                                                                                     |                                                                                                                                                                                                             |                                                                                                                                                                                                               |
   | 41. PREMISES MAINTAINED FREE OF LITTER, UNNECESSARY ARTICLES, CLEANING  EQUIPMENT PROPERLY STORED - Comments: INSTRUCTED MANAGER TO ORGANIZE EXCESSIVE CLUTTER IN THE REAR STORAGE AREA TO PREVENT HARBORAGE.                                                                                                                                                                                                                                                                                                                                                                                               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                                                                                                                                                                                                                                                                    |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                                                                                                                                          |                                                                                                                                                                                                                                                                                                                                            |                                                                                                                                                                                                                                                                                                                                                                      |                                                                                                                                                                                                                                                                                                                                                                               |                                                                                                                                                                                                                                                                                                                                                                          |                                                                                                                                                                                                                                                                                                                                                                                                   |                                                                                                                                                                                                       |                                                                                                                                                                                                                                     |                                                                                                                                                                                                             |                                                                                                                                                                                                               |
   | 24. DISH WASHING FACILITIES: PROPERLY DESIGNED, CONSTRUCTED, MAINTAINED, INSTALLED, LOCATED AND OPERATED - Comments: ALL COFFEE BREWING AND FROZEN DRINK MAKER/DISPENSER EQUIPMENT HAS BEEN REMOVED. BUSINESS SELLING ONLY PRE-PACKAGED BEVERAGES ONLY. NO THREE COMPARTMENT SINK REQUIRED AT THIS TIME.                                                                                                                                                                                                                                                                                                    |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                                                                                                                                                                                                                                                                    |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                                                                                                                                          |                                                                                                                                                                                                                                                                                                                                            |                                                                                                                                                                                                                                                                                                                                                                      |                                                                                                                                                                                                                                                                                                                                                                               |                                                                                                                                                                                                                                                                                                                                                                          |                                                                                                                                                                                                                                                                                                                                                                                                   |                                                                                                                                                                                                       |                                                                                                                                                                                                                                     |                                                                                                                                                                                                             |                                                                                                                                                                                                               |
   :END:


   Note that this column is structured in the following form:

   - If there are several violations reported, those violations will be separated by ='|'=
   - Every violation begins with a code and  a description
   - Every violation could have *comments*, those comments appear after the
     string =- Comments:=



   We will take that observations in account and create a newtable called =cleaned.violations= to store

   - inspection
   - violation_code
   - violation_description
   - violation_comments

   #+BEGIN_SRC sql :results table drawer :tangle ./src/create_violations_table.sql
     drop table if exists cleaned.violations cascade;

     create table cleaned.violations as (
     select
     inspection,
     license_num as entity_id, -- This is a requirement of triage
     date as knowledge_date,
     btrim(tuple[1]) as violation_code,
     btrim(tuple[2]) as violation_description,
     btrim(tuple[3]) as violation_comment from
     (
     select
     inspection,
     license_num,
     date,
     regexp_split_to_array(
     regexp_split_to_table(coalesce(violations, '.- Comments:'), '\|'),   -- We don't want to loose inspections
     '\.|- Comments:') as tuple
     from inspections
     where results in ('Fail', 'Pass', 'Pass w/ Conditions') and license_num is not null
     ) as t
     )
   #+END_SRC

   #+RESULTS:

   #+BEGIN_SRC sql
     select count(distinct inspection) from cleaned.violations;
   #+END_SRC

   #+RESULTS:
   :RESULTS:
   |  count |
   |--------|
   | 134573 |
   :END:


   Note that this table contains less rows, since some rows in
   =inspections= contain =null= values in the column =violations= (So, if you
   later want to do a =join= between the tables =cleaned.inspections= and
   =cleaned.violations= you will need to do a =left join=).


** Some data exploration

   *TODO* We could add explanations about the fact that most of the
   analysis stops in this step

   *NOTE:* We will be using =SQL= for the exploration of the data, the
   following pages: functions to [[https://www.postgresql.org/docs/current/static/functions-string.html][manipulate strings]]
   and functions for [[https://www.postgresql.org/docs/current/static/functions-datetime.html][manipulate dates and time]]
   will be handy, keep them close!



   We also, could ask some interesting questions such as:


   /What are the top 30 restaurants with more inspections?/

   #+BEGIN_SRC sql :results table drawer
     select
     facility,
     count(*) as total_inspections,
     coalesce(
     sum(
     case
     when results = 'Fail' then 1
     else 0
     end),0) as total_failures
     from cleaned.inspections
     group by facility
     order by total_inspections desc
     limit 30;
   #+END_SRC

   #+RESULTS:
   :RESULTS:
   | facility                       | total_inspections | total_failures |
   |--------------------------------+------------------+---------------|
   | SUBWAY                         |             2000 |           259 |
   | DUNKIN DONUTS                  |             1039 |           168 |
   | MCDONALD'S                     |              455 |           100 |
   | 7-ELEVEN                       |              325 |            53 |
   | MCDONALDS                      |              263 |            47 |
   | CHIPOTLE MEXICAN GRILL         |              255 |            37 |
   | POTBELLY SANDWICH WORKS LLC    |              217 |            41 |
   | CORNER BAKERY CAFE             |              189 |            20 |
   | POTBELLY SANDWICH WORKS        |              184 |            27 |
   | DUNKIN DONUTS/BASKIN ROBBINS   |              166 |            28 |
   | DOMINO'S PIZZA                 |              154 |            28 |
   | WHOLE FOODS MARKET             |              153 |            22 |
   | AU BON PAIN                    |              153 |            26 |
   | SUBWAY SANDWICHES              |              149 |            20 |
   | FRESHII                        |              149 |            24 |
   | HAROLD'S CHICKEN SHACK         |              142 |            40 |
   | Subway                         |              136 |            25 |
   | KFC                            |              131 |            27 |
   | SEE THRU CHINESE KITCHEN       |              125 |            21 |
   | SPORTSERVICE SOLDIER FIELD     |              119 |             1 |
   | MC DONALD'S                    |              112 |            15 |
   | SHARKS FISH & CHICKEN          |              112 |            23 |
   | J & J FISH                     |              106 |            20 |
   | JIMMY JOHNS                    |              104 |            25 |
   | DUNKIN DONUTS / BASKIN ROBBINS |              104 |            23 |
   | PIZZA HUT                      |              100 |            21 |
   | ILLINOIS SPORTSERVICE INC      |              100 |            19 |
   | PAPA JOHN'S PIZZA              |               96 |            31 |
   | PROTEIN BAR                    |               95 |            14 |
   | STARBUCKS                      |               93 |            10 |
   :END:


   As we will see through all this tutorial, /data is always messy/, to
   begin with we have several different spellings (e.g. =SUBWAY= and
   =Subway=, =MCDONALDS= and =MC DONALD'S=, =DUNKIN DONUTS/BASKIN ROBBINS= and
   =DUNKIN DONUTS / BASKIN ROBBINS=, etc)

   We could try a very simple cleaning for example, convert all the
   names to uppercase, remove the trailing spaces, remove the apostrophe
   "='"= and remove the spaces around "=/=". The problem with this approach
   is that we will be fixing the names that we just saw, but there are
   several other nuances down that list. Another approach is use [[https://www.postgresql.org/docs/current/static/fuzzystrmatch.html][soundex]],
   but that will create a lot of mismatches. The real workaround is apply
   some /machine learning/ to /deduplicate/ the entities [fn:3].  We wont
   follow that path here.


   If we go back to the columns of the table, maybe there is another way
   to solve this: we could try with the column =license_num=  (assume that one
   license represents one establishment) and the column =address= (assume that one restaurant is
   in one place).


   #+BEGIN_SRC sql :results table drawer
     select
     count(distinct facility) as total_facilities,
     count(distinct license_num) as total_licenses,
     count(distinct address) as total_addresses
     from cleaned.inspections
   #+END_SRC

   #+RESULTS:
   :RESULTS:
   | total_facilities | total_licenses | total_addresses |
   |-----------------+---------------+----------------|
   |           20930 |         28054 |          15845 |
   :END:

   This doesn't look promising...


   Let's check those hypothesis

   /What are the top 5 locations with more inspections?/

   #+BEGIN_SRC sql :results table drawer
     select
     address, count(*) as total_inspections,
     coalesce(
     sum(
     case
     when results = 'Fail' then 1
     else 0
     end),0) as total_failures
     from cleaned.inspections
     group by address
     order by total_inspections desc
     limit 5;
   #+END_SRC

   #+RESULTS:
   :RESULTS:
   | address           | total_inspections | total_failures |
   |-------------------+------------------+---------------|
   | 11601 W TOUHY AVE |             1764 |           243 |
   | 5700 S CICERO AVE |              356 |            54 |
   | 500 W MADISON ST  |              317 |            65 |
   | 324 N LEAVITT ST  |              282 |            78 |
   | 333 W 35TH ST     |              237 |            33 |
   :END:

   The /location hypothesis/ also has problems, in particular could be *more*
   than one establishment per location (the first row is *O'Hare International Airport*)

   So, our last hope is the /license number/

   We could get, even more information if we check /How many of those inspections result in a 'Fail'/?

   /What are the top 5 licenses with more inspections?/

   #+BEGIN_SRC sql :results table drawer
     select
     license_num, count(*) as total_inspections,
     coalesce(
     sum(
     case
     when results = 'Fail' then 1
     else 0
     end),0) as total_failures
     from cleaned.inspections
     group by license_num
     order by total_inspections desc
     limit 5;
   #+END_SRC

   #+RESULTS:
   :RESULTS:
   | license_num | total_inspections | total_failures |
   |------------+------------------+---------------|
   |          0 |              377 |           116 |
   |      14616 |              172 |            30 |
   |    1354323 |              130 |             1 |
   |    1574001 |               78 |             4 |
   |    1974745 |               57 |             3 |
   :END:


   Even this columns has some problems, let's investigate a little about
   the =license_num= = =0=.

   #+BEGIN_SRC sql :results table drawer
     select
     facility_type, count(*) as total_inspections,
     coalesce(
     sum(
     case
     when results = 'Fail' then 1
     else 0
     end),0) as total_failures
     from cleaned.inspections
     where license_num=0
     group by  facility_type
     order by total_inspections desc
   #+END_SRC

   #+RESULTS:
   :RESULTS:
   | facility_type                | total_inspections | total_failures |
   |-----------------------------+------------------+---------------|
   | Restaurant                  |               73 |            40 |
   | Special Event               |               68 |            10 |
   | Shelter                     |               30 |             6 |
   | Navy Pier Kiosk             |               29 |             4 |
   | CHURCH                      |               24 |             3 |
   | [NULL]                      |               24 |            10 |
   | Grocery Store               |               15 |             7 |
   | CHURCH KITCHEN              |               12 |             5 |
   | PRIVATE SCHOOL              |               10 |             1 |
   | CHURCH/SPECIAL EVENTS       |               10 |             2 |
   | Church                      |                8 |             1 |
   | Long Term Care              |                8 |             1 |
   | AFTER SCHOOL PROGRAM        |                8 |             1 |
   | Catering                    |                6 |             3 |
   | Mobile Food Dispenser       |                5 |             2 |
   | Illegal Vendor              |                3 |             3 |
   | School                      |                3 |             0 |
   | NOT FOR PROFIT              |                2 |             2 |
   | BOYS AND GIRLS CLUB         |                2 |             0 |
   | CHURCH/SPECIAL EVENT        |                2 |             0 |
   | FOOD PANTRY/CHURCH          |                2 |             0 |
   | HERBAL LIFE SHOP            |                2 |             1 |
   | Hospital                    |                2 |             0 |
   | NON -PROFIT                 |                2 |             0 |
   | Social Club                 |                2 |             2 |
   | SOUP KITCHEN                |                2 |             1 |
   | SUMMER FEEDING              |                2 |             0 |
   | SUMMER FEEDING PREP AREA    |                2 |             1 |
   | AFTER SCHOOL CARE           |                1 |             0 |
   | NP-KIOSK                    |                1 |             0 |
   | FOOD PANTRY                 |                1 |             0 |
   | religious                   |                1 |             1 |
   | Food Pantry                 |                1 |             0 |
   | RESTAURANT/GROCERY          |                1 |             1 |
   | RETAIL                      |                1 |             1 |
   | FARMER'S MARKET             |                1 |             1 |
   | Daycare (2 - 6 Years)       |                1 |             0 |
   | UNLICENSED FACILITY         |                1 |             1 |
   | SOCIAL CLUB                 |                1 |             1 |
   | WAREHOUSE                   |                1 |             0 |
   | CHICAGO PARK DISTRICT       |                1 |             0 |
   | Wholesale                   |                1 |             1 |
   | KIDS CAFE                   |                1 |             1 |
   | incubator                   |                1 |             0 |
   | NEWSSTAND                   |                1 |             1 |
   | NON-FOR PROFIT BASEMENT KIT |                1 |             0 |
   | Bakery                      |                1 |             1 |
   :END:

   Most of these are related to /special events/, /churchs/, /festivals/
   etc. We could research deeply the =restaurants= which have =license_num= =
   =0=, but we will skip that for the moment.


   Finally, we can conclude that, except for some details, =license_num= is
   the way to go, for the identification of the establishments.


   #+BEGIN_SRC sql :results table drawer
     select
     license_num, facility, address,
     count(*) as total_inspections,
     coalesce(
     sum(
     case
     when results = 'Fail' then 1
     else 0
     end),0) as total_failures
     from cleaned.inspections
     group by license_num, facility, address
     order by count(*)  desc
     limit 5;
   #+END_SRC

   #+RESULTS:
   :RESULTS:
   | license_num | facility                          | address                 | total_inspections | total_failures |
   |------------+-----------------------------------+-------------------------+------------------+---------------|
   |    1354323 | SPORTSERVICE SOLDIER FIELD        | 1410 S MUSEUM CAMPUS DR |              119 |             1 |
   |      14616 | ILLINOIS SPORTSERVICE INC         | 333 W 35TH ST           |               99 |            19 |
   |    1574001 | LEVY RESTAURANTS AT WRIGLEY FIELD | 1060 W ADDISON ST       |               68 |             1 |
   |    1974745 | THE UNITED CENTER                 | 1901 W MADISON ST       |               46 |             0 |
   |    1490035 | MCDONALD'S                        | 6900 S LAFAYETTE AVE    |               45 |             6 |
   :END:


   Other interesting questions to ask are:


   /Which is the spatial distribution of inspections?/


   #+BEGIN_SRC sql :results table drawer
     select
     zip_code,
     count(*) as total_inspections,
     coalesce(
     sum(
     case
     when results = 'Fail' then 1
     else 0
     end),0) as total_failures
     from cleaned.inspections
     group by zip_code
     order by total_inspections desc;
   #+END_SRC

   #+RESULTS:
   :RESULTS:
   | zip_code | total_inspections | total_failures |
   |---------+------------------+---------------|
   |   60614 |             4823 |          1154 |
   |   60647 |             4587 |          1006 |
   |   60611 |             4541 |           776 |
   |   60657 |             4373 |          1012 |
   |   60622 |             4278 |          1109 |
   |   60618 |             3988 |           704 |
   |   60608 |             3907 |           942 |
   |   60625 |             3512 |           808 |
   |   60639 |             3454 |           828 |
   |   60607 |             3414 |           741 |
   |   60640 |             3386 |           889 |
   |   60632 |             3358 |           764 |
   |   60616 |             3286 |           759 |
   |   60623 |             3260 |           831 |
   |   60609 |             2998 |           661 |
   |   60654 |             2990 |           502 |
   |   60613 |             2810 |           558 |
   |   60619 |             2765 |           828 |
   |   60659 |             2756 |           698 |
   |   60617 |             2715 |           578 |
   |   60610 |             2660 |           577 |
   |   60634 |             2651 |           466 |
   |   60641 |             2539 |           483 |
   |   60629 |             2530 |           472 |
   |   60620 |             2498 |           626 |
   |   60628 |             2462 |           684 |
   |   60601 |             2425 |           343 |
   |   60606 |             2336 |           323 |
   |   60605 |             2140 |           345 |
   |   60612 |             2109 |           466 |
   |   60626 |             2069 |           529 |
   |   60651 |             1973 |           586 |
   |   60660 |             1955 |           461 |
   |   60643 |             1917 |           415 |
   |   60661 |             1900 |           335 |
   |   60630 |             1847 |           380 |
   |   60638 |             1788 |           271 |
   |   60666 |             1787 |           248 |
   |   60644 |             1739 |           491 |
   |   60637 |             1718 |           512 |
   |   60636 |             1715 |           496 |
   |   60649 |             1692 |           432 |
   |   60615 |             1675 |           512 |
   |   60642 |             1507 |           353 |
   |   60624 |             1475 |           382 |
   |   60603 |             1377 |           203 |
   |   60653 |             1223 |           320 |
   |   60652 |             1202 |           188 |
   |   60621 |             1152 |           273 |
   |   60602 |             1044 |           170 |
   |   60646 |             1022 |           180 |
   |   60631 |             1017 |           218 |
   |   60645 |              948 |           254 |
   |   60604 |              938 |           131 |
   |   60707 |              714 |           154 |
   |   60656 |              564 |           118 |
   |   60655 |              551 |            90 |
   |   60633 |              233 |            62 |
   |   60827 |               97 |            21 |
   |  [NULL] |               77 |            24 |
   |   60193 |               14 |             3 |
   |   60153 |               13 |             3 |
   |   60007 |               12 |             3 |
   |   60804 |                6 |             1 |
   |   60482 |                5 |             4 |
   |   60126 |                5 |             1 |
   |   60077 |                4 |             1 |
   |   60201 |                4 |             3 |
   |   60409 |                4 |             1 |
   |   60302 |                4 |             0 |
   |   60501 |                4 |             3 |
   |   60429 |                3 |             1 |
   |   60176 |                3 |             0 |
   |   60803 |                3 |             1 |
   |   60714 |                3 |             0 |
   |   60076 |                2 |             1 |
   |   60540 |                2 |             0 |
   |   60461 |                2 |             0 |
   |   60107 |                2 |             0 |
   |   60411 |                2 |             0 |
   |   60406 |                2 |             0 |
   |   60015 |                2 |             0 |
   |   60402 |                2 |             1 |
   |   60018 |                1 |             0 |
   |   60478 |                1 |             0 |
   |   60805 |                1 |             1 |
   |   60022 |                1 |             0 |
   |   60706 |                1 |             0 |
   |   60202 |                1 |             0 |
   |   60627 |                1 |             0 |
   |   60423 |                1 |             0 |
   |   60477 |                1 |             0 |
   |   60047 |                1 |             0 |
   |   60155 |                1 |             0 |
   |   60044 |                1 |             0 |
   |   60440 |                1 |             0 |
   |   60108 |                1 |             0 |
   |   60458 |                1 |             0 |
   |   60148 |                1 |             0 |
   |   60453 |                1 |             0 |
   :END:

   /Which is the temporal distribution of the inspections?/

   #+BEGIN_SRC sql :results table drawer
     select
     year, month,
     count(*) as total_inspections,
     coalesce(
     sum(
     case
     when results = 'Fail' then 1
     else 0
     end
     ),0) as total_failures
     from cleaned.inspections
     group by year, month
     order by year asc, month asc;
   #+END_SRC

   #+RESULTS:
   :RESULTS:
   | year | month | total_inspections | total_failures |
   |------+-------+------------------+---------------|
   | 2010 |     1 |             1279 |           330 |
   | 2010 |     2 |             1398 |           342 |
   | 2010 |     3 |             1478 |           350 |
   | 2010 |     4 |             1439 |           401 |
   | 2010 |     5 |             1541 |           389 |
   | 2010 |     6 |             1754 |           455 |
   | 2010 |     7 |             1276 |           367 |
   | 2010 |     8 |             1541 |           407 |
   | 2010 |     9 |             1640 |           427 |
   | 2010 |    10 |             1649 |           437 |
   | 2010 |    11 |             1201 |           308 |
   | 2010 |    12 |             1186 |           291 |
   | 2011 |     1 |             1260 |           288 |
   | 2011 |     2 |             1272 |           255 |
   | 2011 |     3 |             1693 |           380 |
   | 2011 |     4 |             1421 |           345 |
   | 2011 |     5 |             1645 |           362 |
   | 2011 |     6 |             1681 |           419 |
   | 2011 |     7 |             1311 |           346 |
   | 2011 |     8 |             1548 |           442 |
   | 2011 |     9 |             1481 |           417 |
   | 2011 |    10 |             1494 |           397 |
   | 2011 |    11 |             1552 |           396 |
   | 2011 |    12 |             1228 |           310 |
   | 2012 |     1 |             1290 |           302 |
   | 2012 |     2 |             1166 |           260 |
   | 2012 |     3 |             1341 |           303 |
   | 2012 |     4 |             1288 |           301 |
   | 2012 |     5 |             1683 |           382 |
   | 2012 |     6 |             1375 |           312 |
   | 2012 |     7 |             1228 |           310 |
   | 2012 |     8 |             1451 |           364 |
   | 2012 |     9 |             1406 |           324 |
   | 2012 |    10 |             1421 |           322 |
   | 2012 |    11 |             1347 |           274 |
   | 2012 |    12 |             1022 |           188 |
   | 2013 |     1 |             1426 |           261 |
   | 2013 |     2 |             1281 |           260 |
   | 2013 |     3 |             1407 |           269 |
   | 2013 |     4 |             1542 |           288 |
   | 2013 |     5 |             1692 |           331 |
   | 2013 |     6 |             1336 |           271 |
   | 2013 |     7 |             1307 |           274 |
   | 2013 |     8 |             1440 |           297 |
   | 2013 |     9 |             1628 |           375 |
   | 2013 |    10 |             1596 |           287 |
   | 2013 |    11 |             1265 |           235 |
   | 2013 |    12 |             1147 |           201 |
   | 2014 |     1 |             1228 |           231 |
   | 2014 |     2 |             1285 |           262 |
   | 2014 |     3 |             1464 |           258 |
   | 2014 |     4 |             1675 |           325 |
   | 2014 |     5 |             1707 |           336 |
   | 2014 |     6 |             1635 |           331 |
   | 2014 |     7 |             1522 |           345 |
   | 2014 |     8 |             1756 |           379 |
   | 2014 |     9 |             1761 |           380 |
   | 2014 |    10 |             1843 |           371 |
   | 2014 |    11 |             1353 |           278 |
   | 2014 |    12 |             1392 |           223 |
   | 2015 |     1 |             1429 |           301 |
   | 2015 |     2 |             1229 |           267 |
   | 2015 |     3 |             1525 |           330 |
   | 2015 |     4 |             1426 |           285 |
   | 2015 |     5 |             1455 |           292 |
   | 2015 |     6 |             1600 |           303 |
   | 2015 |     7 |             1400 |           295 |
   | 2015 |     8 |             1580 |           336 |
   | 2015 |     9 |             1676 |           322 |
   | 2015 |    10 |             1755 |           344 |
   | 2015 |    11 |             1479 |           280 |
   | 2015 |    12 |             1338 |           252 |
   | 2016 |     1 |             1411 |           298 |
   | 2016 |     2 |             1297 |           307 |
   | 2016 |     3 |             1944 |           402 |
   | 2016 |     4 |             1711 |           372 |
   | 2016 |     5 |             1780 |           379 |
   | 2016 |     6 |             1950 |           438 |
   | 2016 |     7 |             1373 |           309 |
   | 2016 |     8 |             1868 |           435 |
   | 2016 |     9 |             1914 |           420 |
   | 2016 |    10 |             1695 |           369 |
   | 2016 |    11 |             1537 |           319 |
   | 2016 |    12 |             1380 |           250 |
   | 2017 |     1 |             1560 |           325 |
   | 2017 |     2 |             1398 |           321 |
   | 2017 |     3 |             1835 |           412 |
   | 2017 |     4 |             1445 |           349 |
   | 2017 |     5 |             1476 |           321 |
   | 2017 |     6 |             1352 |           274 |
   | 2017 |     7 |              733 |           192 |
   | 2017 |     8 |              362 |           100 |
   :END:

   The number of inspections per month, is stable.

   #+BEGIN_SRC sql :results table drawer
     select
     violation_code,
     violation_description,
     count(*) as total
     from cleaned.violations
     group by violation_code, violation_description
     order by total desc
   #+END_SRC

   #+RESULTS:
   :RESULTS:
   | violation_code | violation_description                                                                                                                   | total |
   |---------------+----------------------------------------------------------------------------------------------------------------------------------------+-------|
   |            34 | FLOORS: CONSTRUCTED PER CODE, CLEANED, GOOD REPAIR, COVING INSTALLED, DUST-LESS CLEANING METHODS USED                                  | 74374 |
   |            35 | WALLS, CEILINGS, ATTACHED EQUIPMENT CONSTRUCTED PER CODE: GOOD REPAIR, SURFACES CLEAN AND DUST-LESS CLEANING METHODS                   | 66004 |
   |            33 | FOOD AND NON-FOOD CONTACT EQUIPMENT UTENSILS CLEAN, FREE OF ABRASIVE DETERGENTS                                                        | 65672 |
   |            38 | VENTILATION: ROOMS AND EQUIPMENT VENTED AS REQUIRED: PLUMBING: INSTALLED AND MAINTAINED                                                | 56340 |
   |            32 | FOOD AND NON-FOOD CONTACT SURFACES PROPERLY DESIGNED, CONSTRUCTED AND MAINTAINED                                                       | 55625 |
   |            41 | PREMISES MAINTAINED FREE OF LITTER, UNNECESSARY ARTICLES, CLEANING  EQUIPMENT PROPERLY STORED                                          | 35665 |
   |            18 | NO EVIDENCE OF RODENT OR INSECT OUTER OPENINGS PROTECTED/RODENT PROOFED, A WRITTEN LOG SHALL BE MAINTAINED AVAILABLE TO THE INSPECTORS | 27965 |
   |            36 | LIGHTING: REQUIRED MINIMUM FOOT-CANDLES OF LIGHT PROVIDED, FIXTURES SHIELDED                                                           | 27262 |
   |            40 | REFRIGERATION AND METAL STEM THERMOMETERS PROVIDED AND CONSPICUOUS                                                                     | 16759 |
   |            30 | FOOD IN ORIGINAL CONTAINER, PROPERLY LABELED: CUSTOMER ADVISORY POSTED AS NEEDED                                                       | 16468 |
   |            31 | CLEAN MULTI-USE UTENSILS AND SINGLE SERVICE ARTICLES PROPERLY STORED: NO REUSE OF SINGLE SERVICE ARTICLES                              | 10516 |
   |            21 | * CERTIFIED FOOD MANAGER ON SITE WHEN POTENTIALLY HAZARDOUS FOODS ARE  PREPARED AND SERVED                                             | 10492 |
   |            29 | PREVIOUS MINOR VIOLATION(S) CORRECTED 7-42-090                                                                                         |  9365 |
   |            43 | FOOD (ICE) DISPENSING UTENSILS, WASH CLOTHS PROPERLY STORED                                                                            |  8647 |
   |            37 | TOILET ROOM DOORS SELF CLOSING: DRESSING ROOMS WITH LOCKERS PROVIDED: COMPLETE SEPARATION FROM LIVING/SLEEPING QUARTERS                |  8138 |
   |             3 | POTENTIALLY HAZARDOUS FOOD MEETS TEMPERATURE REQUIREMENT DURING STORAGE, PREPARATION DISPLAY AND SERVICE                               |  8057 |
   |             2 | FACILITIES TO MAINTAIN PROPER TEMPERATURE                                                                                              |  7556 |
   |            42 | APPROPRIATE METHOD OF HANDLING OF FOOD (ICE) HAIR RESTRAINTS AND CLEAN APPAREL WORN                                                    |  6895 |
   |            19 | OUTSIDE GARBAGE WASTE GREASE AND STORAGE AREA; CLEAN, RODENT PROOF, ALL CONTAINERS COVERED                                             |  6751 |
   |            16 | FOOD PROTECTED DURING STORAGE, PREPARATION, DISPLAY, SERVICE AND TRANSPORTATION                                                        |  6682 |
   |            45 | FOOD HANDLER REQUIREMENTS MET                                                                                                          |  6662 |
   |            24 | DISH WASHING FACILITIES: PROPERLY DESIGNED, CONSTRUCTED, MAINTAINED, INSTALLED, LOCATED AND OPERATED                                   |  5202 |
   |            11 | ADEQUATE NUMBER, CONVENIENT, ACCESSIBLE, DESIGNED, AND MAINTAINED                                                                      |  4761 |
   |            12 | HAND WASHING FACILITIES: WITH SOAP AND SANITARY HAND DRYING DEVICES, CONVENIENT AND ACCESSIBLE TO FOOD PREP AREA                       |  3247 |
   |             8 | SANITIZING RINSE FOR EQUIPMENT AND UTENSILS:  CLEAN, PROPER TEMPERATURE, CONCENTRATION, EXPOSURE TIME                                  |  2973 |
   |             9 | WATER SOURCE: SAFE, HOT & COLD UNDER CITY PRESSURE                                                                                     |  2454 |
   |            26 | ADEQUATE NUMBER, CONVENIENT, ACCESSIBLE, PROPERLY DESIGNED AND INSTALLED                                                               |  2366 |
   |            14 | PREVIOUS SERIOUS VIOLATION CORRECTED, 7-42-090                                                                                         |  1891 |
   |             6 | HANDS WASHED AND CLEANED, GOOD HYGIENIC PRACTICES; NO BARE HAND CONTACT WITH READY-TO-EAT FOODS                                        |  1573 |
   |            22 | DISH MACHINES: PROVIDED WITH ACCURATE THERMOMETERS, CHEMICAL TEST KITS AND SUITABLE GAUGE COCK                                         |  1473 |
   |            28 | * INSPECTION REPORT SUMMARY DISPLAYED AND VISIBLE TO ALL CUSTOMERS                                                                     |  1345 |
   |            10 | SEWAGE AND WASTE WATER DISPOSAL, NO BACK SIPHONAGE, CROSS  CONNECTION AND/OR BACK FLOW                                                 |  1228 |
   |            13 | NO EVIDENCE OF RODENT OR INSECT INFESTATION, NO BIRDS, TURTLES OR OTHER ANIMALS                                                        |   829 |
   |            70 | NO SMOKING REGULATIONS                                                                                                                 |   781 |
   |            39 | LINEN: CLEAN AND SOILED PROPERLY STORED                                                                                                |   693 |
   |             1 | SOURCE SOUND CONDITION, NO SPOILAGE, FOODS PROPERLY LABELED, SHELLFISH TAGS IN PLACE                                                   |   655 |
   |             4 | SOURCE OF CROSS CONTAMINATION CONTROLLED I                                                                                             |   602 |
   |            27 | TOILET ROOMS ENCLOSED CLEAN, PROVIDED WITH HAND CLEANSER, SANITARY HAND DRYING DEVICES AND PROPER WASTE RECEPTACLES                    |   554 |
   |            44 | ONLY AUTHORIZED PERSONNEL IN THE FOOD-PREP AREA                                                                                        |   434 |
   |            25 | TOXIC ITEMS PROPERLY STORED, LABELED AND USED                                                                                          |   233 |
   |            20 | INSIDE CONTAINERS OR RECEPTACLES: ADEQUATE NUMBER, PROPERLY COVERED AND INSECT/RODENT PROOF                                            |   180 |
   |             7 | WASH AND RINSE WATER: CLEAN AND PROPER TEMPERATURE                                                                                     |   159 |
   |            17 | POTENTIALLY HAZARDOUS FOOD PROPERLY THAWED                                                                                             |   112 |
   |             5 | PERSONNEL WITH INFECTIONS RESTRICTED: NO OPEN SORES, WOUNDS, ETC                                                                       |    15 |
   |            15 | UNWRAPPED AND POTENTIALLY HAZARDOUS FOOD NOT RE-SERVED                                                                                 |     4 |
   |            23 | DISHES AND UTENSILS FLUSHED, SCRAPED, SOAKED                                                                                           |     3 |
   :END:

   This looks weird, the top most "violation" is not an actual
   violation. We will repeat the query, we will group by the =results=

   #+BEGIN_SRC sql :results table drawer

     with inspections_violations as (
     select
     i.inspection, i.results,
     v.violation_code
     from cleaned.inspections as i inner join cleaned.violations as v
     using(inspection)
     )


     select violation_code, results,
     --grouping(violation_code, results),
     count(violation_code)
     from inspections_violations
     group by rollup(violation_code, results)
   #+END_SRC

   #+RESULTS:
   :RESULTS:
   | violation_code | results            |  count |
   |---------------+--------------------+--------|
   |             1 | Fail               |    328 |
   |             1 | Pass               |     57 |
   |             1 | Pass w/ Conditions |    270 |
   |             1 | [NULL]             |    655 |
   |            10 | Fail               |    719 |
   |            10 | Pass               |    352 |
   |            10 | Pass w/ Conditions |    157 |
   |            10 | [NULL]             |   1228 |
   |            11 | Fail               |   2567 |
   |            11 | Pass               |   1539 |
   |            11 | Pass w/ Conditions |    655 |
   |            11 | [NULL]             |   4761 |
   |            12 | Fail               |   1719 |
   |            12 | Pass               |    590 |
   |            12 | Pass w/ Conditions |    938 |
   |            12 | [NULL]             |   3247 |
   |            13 | Fail               |    539 |
   |            13 | Pass               |    258 |
   |            13 | Pass w/ Conditions |     32 |
   |            13 | [NULL]             |    829 |
   |            14 | Fail               |    736 |
   |            14 | Pass               |    513 |
   |            14 | Pass w/ Conditions |    642 |
   |            14 | [NULL]             |   1891 |
   |            15 | Pass               |      3 |
   |            15 | Pass w/ Conditions |      1 |
   |            15 | [NULL]             |      4 |
   |            16 | Fail               |   3188 |
   |            16 | Pass               |   2128 |
   |            16 | Pass w/ Conditions |   1366 |
   |            16 | [NULL]             |   6682 |
   |            17 | Fail               |     52 |
   |            17 | Pass               |      5 |
   |            17 | Pass w/ Conditions |     55 |
   |            17 | [NULL]             |    112 |
   |            18 | Fail               |  15180 |
   |            18 | Pass               |  11851 |
   |            18 | Pass w/ Conditions |    934 |
   |            18 | [NULL]             |  27965 |
   |            19 | Fail               |   3602 |
   |            19 | Pass               |   2676 |
   |            19 | Pass w/ Conditions |    473 |
   |            19 | [NULL]             |   6751 |
   |             2 | Fail               |   3349 |
   |             2 | Pass               |   1746 |
   |             2 | Pass w/ Conditions |   2461 |
   |             2 | [NULL]             |   7556 |
   |            20 | Fail               |    105 |
   |            20 | Pass               |     64 |
   |            20 | Pass w/ Conditions |     11 |
   |            20 | [NULL]             |    180 |
   |            21 | Fail               |   3730 |
   |            21 | Pass               |   2055 |
   |            21 | Pass w/ Conditions |   4707 |
   |            21 | [NULL]             |  10492 |
   |            22 | Fail               |    775 |
   |            22 | Pass               |    590 |
   |            22 | Pass w/ Conditions |    108 |
   |            22 | [NULL]             |   1473 |
   |            23 | Fail               |      2 |
   |            23 | Pass               |      1 |
   |            23 | [NULL]             |      3 |
   |            24 | Fail               |   2838 |
   |            24 | Pass               |   2091 |
   |            24 | Pass w/ Conditions |    273 |
   |            24 | [NULL]             |   5202 |
   |            25 | Fail               |    118 |
   |            25 | Pass               |     59 |
   |            25 | Pass w/ Conditions |     56 |
   |            25 | [NULL]             |    233 |
   |            26 | Fail               |   1287 |
   |            26 | Pass               |    933 |
   |            26 | Pass w/ Conditions |    146 |
   |            26 | [NULL]             |   2366 |
   |            27 | Fail               |    271 |
   |            27 | Pass               |    184 |
   |            27 | Pass w/ Conditions |     99 |
   |            27 | [NULL]             |    554 |
   |            28 | Fail               |    544 |
   |            28 | Pass               |    108 |
   |            28 | Pass w/ Conditions |    693 |
   |            28 | [NULL]             |   1345 |
   |            29 | Fail               |   4903 |
   |            29 | Pass               |   3803 |
   |            29 | Pass w/ Conditions |    659 |
   |            29 | [NULL]             |   9365 |
   |             3 | Fail               |   3158 |
   |             3 | Pass               |    228 |
   |             3 | Pass w/ Conditions |   4671 |
   |             3 | [NULL]             |   8057 |
   |            30 | Fail               |   3728 |
   |            30 | Pass               |  10336 |
   |            30 | Pass w/ Conditions |   2404 |
   |            30 | [NULL]             |  16468 |
   |            31 | Fail               |   2472 |
   |            31 | Pass               |   6475 |
   |            31 | Pass w/ Conditions |   1569 |
   |            31 | [NULL]             |  10516 |
   |            32 | Fail               |  13770 |
   |            32 | Pass               |  35137 |
   |            32 | Pass w/ Conditions |   6718 |
   |            32 | [NULL]             |  55625 |
   |            33 | Fail               |  15052 |
   |            33 | Pass               |  42749 |
   |            33 | Pass w/ Conditions |   7871 |
   |            33 | [NULL]             |  65672 |
   |            34 | Fail               |  17713 |
   |            34 | Pass               |  48297 |
   |            34 | Pass w/ Conditions |   8364 |
   |            34 | [NULL]             |  74374 |
   |            35 | Fail               |  16583 |
   |            35 | Pass               |  42261 |
   |            35 | Pass w/ Conditions |   7160 |
   |            35 | [NULL]             |  66004 |
   |            36 | Fail               |   7232 |
   |            36 | Pass               |  17103 |
   |            36 | Pass w/ Conditions |   2927 |
   |            36 | [NULL]             |  27262 |
   |            37 | Fail               |   2587 |
   |            37 | Pass               |   4799 |
   |            37 | Pass w/ Conditions |    752 |
   |            37 | [NULL]             |   8138 |
   |            38 | Fail               |  14351 |
   |            38 | Pass               |  35876 |
   |            38 | Pass w/ Conditions |   6113 |
   |            38 | [NULL]             |  56340 |
   |            39 | Fail               |    205 |
   |            39 | Pass               |    411 |
   |            39 | Pass w/ Conditions |     77 |
   |            39 | [NULL]             |    693 |
   |             4 | Fail               |    241 |
   |             4 | Pass               |     97 |
   |             4 | Pass w/ Conditions |    264 |
   |             4 | [NULL]             |    602 |
   |            40 | Fail               |   4423 |
   |            40 | Pass               |  10133 |
   |            40 | Pass w/ Conditions |   2203 |
   |            40 | [NULL]             |  16759 |
   |            41 | Fail               |   9844 |
   |            41 | Pass               |  21939 |
   |            41 | Pass w/ Conditions |   3882 |
   |            41 | [NULL]             |  35665 |
   |            42 | Fail               |   1552 |
   |            42 | Pass               |   4028 |
   |            42 | Pass w/ Conditions |   1315 |
   |            42 | [NULL]             |   6895 |
   |            43 | Fail               |   2026 |
   |            43 | Pass               |   5155 |
   |            43 | Pass w/ Conditions |   1466 |
   |            43 | [NULL]             |   8647 |
   |            44 | Fail               |    126 |
   |            44 | Pass               |    244 |
   |            44 | Pass w/ Conditions |     64 |
   |            44 | [NULL]             |    434 |
   |            45 | Fail               |   1556 |
   |            45 | Pass               |   4012 |
   |            45 | Pass w/ Conditions |   1094 |
   |            45 | [NULL]             |   6662 |
   |             5 | Fail               |      9 |
   |             5 | Pass w/ Conditions |      6 |
   |             5 | [NULL]             |     15 |
   |             6 | Fail               |    669 |
   |             6 | Pass               |     49 |
   |             6 | Pass w/ Conditions |    855 |
   |             6 | [NULL]             |   1573 |
   |             7 | Fail               |     76 |
   |             7 | Pass               |     32 |
   |             7 | Pass w/ Conditions |     51 |
   |             7 | [NULL]             |    159 |
   |            70 | Fail               |    412 |
   |            70 | Pass               |    188 |
   |            70 | Pass w/ Conditions |    181 |
   |            70 | [NULL]             |    781 |
   |             8 | Fail               |   1231 |
   |             8 | Pass               |    573 |
   |             8 | Pass w/ Conditions |   1169 |
   |             8 | [NULL]             |   2973 |
   |             9 | Fail               |   1356 |
   |             9 | Pass               |    809 |
   |             9 | Pass w/ Conditions |    289 |
   |             9 | [NULL]             |   2454 |
   |        [NULL] | [NULL]             | 565662 |
   :END:


   *NOTE*: You could also split between, /major violation found/ and /minor violation found/,
   but we will keep this simple for the moment.



   /How often change the risk in a facility?/

   #+BEGIN_SRC sql
     select
     license_num, risk || '->' || previous_risk, count(*)
     from
     (
     select date, license_num,risk, lag(risk) over w as previous_risk
     from cleaned.inspections
     window w as (partition by license_num order by date asc)
     ) as t
     where (risk <>  previous_risk) and license_num != '0'
     group by license_num, risk || '->' || previous_risk
     order by  count(*) desc, license_num
     limit 10
   #+END_SRC

   #+RESULTS:
   | license_num | ?column?     | count |
   |------------+--------------+-------|
   |    1574001 | High->Medium |     9 |
   |      20481 | Medium->High |     8 |
   |      20481 | High->Medium |     8 |
   |    1574001 | Medium->High |     8 |
   |      14616 | Medium->Low  |     7 |
   |      14616 | Low->Medium  |     7 |
   |      51011 | High->Medium |     7 |
   |      23041 | Medium->High |     6 |
   |      23041 | High->Medium |     6 |
   |      23051 | Medium->High |     6 |




* Using triage (finally)

  With the data sitting in our database, we can start our analysis.

  [[https://github.com/dssg/triage][Triage]] make the followings assumptions:


  At the end, =triage= will create the following in your database:

  - A =features= schema
  - A =results= schema
  - A table named =labels= in =public= schema

  And it will create, several files that contains the matrices for
  training your model


** The experiment concept

   Typically, a in a supervised learning problem you need to do the
   following:

   - Get some /labeled/ data
   - Prepare the data
   - Set some questions
   - Set the metric
   - Set the baseline
   - Adjust the /labels/ to the question
   - Generate features
   - Train several models using cross-validation
   - Chose the best model (using the metric)
   - Put that model "in production"

** Cross temporal validation and Timechop

   /We need to add some images here/


** The =inspections-training.yaml= file
   :PROPERTIES:
   :header-args:yaml: :tangle ./src/inspections-training.yaml
   :END:

   This is the unique point of entry for using =triage=, basically in this
   file, you will specify,  how you want to do the temporal
   cross-validation, how to generate the labels, how to generate the
   features, which models you want to run, and finally,  which are the
   metrics you are interested.

   You can check the final configuration in =./src/inspections-training.yaml=

   Let's go by piece by piece



   First, =triage= needs a special table at this moment, we call this table =inspections_events=


   #+BEGIN_SRC sql
     create or replace view inspections_events
     as
     select
     license_num as entity_id,
     date as outcome_date,
     case
     when results = 'Fail' then True
     else False
     end
     as outcome
     from cleaned.inspections
   #+END_SRC

   #+RESULTS:


*** Experiment metadata

    #+BEGIN_SRC yaml
      model_comment: 'inspections'
    #+END_SRC

*** Time splitting

    For this section we will need get some info about the time span of our
    data,

    #+BEGIN_SRC sql
      select
      min(date) as modeling_start_time,
      max(date) as modeling_end_time
      from cleaned.inspections;
    #+END_SRC

    #+RESULTS:
    | modeling_start_time | modeling_end_time |
    |-------------------+-----------------|
    |        2010-01-04 |      2017-08-18 |



    #+BEGIN_SRC yaml
        temporal_config:
          beginning_of_time: '2010-01-04' # earliest date included in features
          modeling_start_time: '2014-01-01' # earliest date in any model
          modeling_end_time: '2017-01-01' # all dates in any model are < this date

          update_window: '3 month' # how frequently to retrain models

          train_example_frequency: '1 d' # time between rows for same entity in train matrix
          train_durations: ['1 y'] # length of time included in a train matrix
          train_label_windows: ['1 month'] # time period across which outcomes are labeled in train matrices

          test_example_frequency: '1 d' # time between rows for same entity in test matrix
          test_durations: ['1 d'] # length of time included in a test matrix
          test_label_windows: ['3 month'] # time period across which outcomes are labeled in test matrices
    #+END_SRC


    We will refer the reader to the image in section [[Cross temporal validation and Timechop]]

    *QUESTION:* How do we specify here: /...in the next X months/?

*** Label generation

    #+BEGIN_SRC yaml
      events_table: 'inspections_events'
    #+END_SRC

*** Feature generation

    We could create the following features:

    Spatial (=zip_code=, /nearby/,  ) and temporal ( /last/ X =week= s
    =month= s)

    - inspections types to the facility, to the facility type
    - violation codes in the facility, to related facilities

    - =count=, =avg=, max

    - etc.

    #+BEGIN_SRC yaml
      feature_aggregations:
        -
          # prefix given to the resultant tables
          prefix: 'violations'
          from_obj: 'cleaned.violations'
          knowledge_date_column: 'knowledge_date'

          categoricals:
            -
              column: 'violation_code'
              choice_query: 'select distinct violation_code from cleaned.violations'
              metrics:
                - 'count'

          intervals:
            - '1 y'

          groups:
            - 'entity_id'


    #+END_SRC

*** Feature grouping

    #+BEGIN_SRC yaml
      feature_group_strategies: ['all']
    #+END_SRC


*** Grid configuration
    #+BEGIN_SRC yaml
      model_group_keys: []

      grid_config:
        'sklearn.tree.DecisionTreeClassifier':
          criterion: ['gini']
          max_depth: [3]
          min_samples_split: [10]
    #+END_SRC

*** Model scoring

    #+BEGIN_SRC yaml
        scoring:
          metric_groups:
            -
              metrics: ['precision@', 'recall@', 'fpr@']
              thresholds:
                percentiles: [1.0, 2.0, 5.0, 10.0, 25.0]
                top_n: [25, 75, 150, 300, 500, 1000, 1500]

    #+END_SRC

*** Running the experiment

    #+BEGIN_SRC ipython :tangle ./src/run.py
      import os
      import sqlalchemy
      import yaml

      from catwalk.storage import FSModelStorageEngine
      from triage.experiments import SingleThreadedExperiment

      food_db = os.environ.get('FOOD_DB_URL')

      print(food_db)

      with open('inspections-training.yaml') as f:
          experiment_config = yaml.load(f)

      experiment = SingleThreadedExperiment(
          config=experiment_config,
          db_engine=sqlalchemy.create_engine(food_db),
          model_storage_class=FSModelStorageEngine,
          project_path='./triage-generated'
      )

      experiment.run()
    #+END_SRC


    #+BEGIN_SRC sh :dir /docker:root@tutorial_bastion:/code :results org drawer
      python run.py
    #+END_SRC

    #+RESULTS:
    :RESULTS:
    :END:


** The =eis-training.yaml= file
   :PROPERTIES:
   :header-args:yaml: :tangle ./src/eis-training.yaml
   :END:




* Looking the results at Tyra

  *TODO:* /Add some images/

* What's next?

  - Add the shape file
    https://data.cityofchicago.org/api/geospatial/gdcf-axmw?method=export&format=Shapefile
  - Text analysis?
  - Run =pgdedup=
  - Routing based on the inspection list?
  - Add more data sources?

* Appendix: What are all those files?

* Appendix: Getting help

* Additional DBs

  - [[https://data.cityofchicago.org/Community-Economic-Development/Business-Licenses/r5kz-chrr][Business Licenses]]
  - Food Inspections
  - [[https://data.cityofchicago.org/Public-Safety/Crimes-2001-to-present/ijzp-q8t2][Crime]]
  - Garbage Cart Complaints
  - [[https://data.cityofchicago.org/Service-Requests/311-Service-Requests-Sanitation-Code-Complaints/me59-5fac][Sanitation Complaints]]
  - Weather
  - Sanitarian Information


* Footnotes

[fn:4] [[https://chicago.github.io/food-inspections-evaluation/][Food Inspection Forecasting - Optimizing Inspections with Analytics]]

[fn:3] This problem is
related to the process of /deduplication/ and there is another tutorial
for that that uses anothe DSaPP tool: =pgdedup=.

[fn:1] [[https://youtu.be/lyDLAutA88s][David Beazley | Keynote: Built in Super Heroes]]

[fn:2] [[https://youtu.be/1dKonIT-Yak][Nicole Donnelly | Forecasting critical food violations at restaurants using open data]]




* Temp stuff


  Before doing that, let's check how many different =dba_name= we have.

  #+BEGIN_SRC sql :results table drawer
    select
    count(distinct dba_name) as different_names
    from inspections;
  #+END_SRC

  #+RESULTS:
  :RESULTS:
  | different_names |
  |----------------|
  |          24646 |
  :END:

  #+BEGIN_SRC sql :results table drawer
    select
    dba_name,
    btrim(upper(regexp_replace(replace(dba_name, '''', ''), '[^a-zA-Z0-9 ]', '', 'g'))) as cleaned_name
    from inspections
    limit 30
  #+END_SRC

  #+RESULTS:
  :RESULTS:
  | dba_name                                      | cleaned_name                                 |
  |----------------------------------------------+---------------------------------------------|
  | D AND Y GROCERY                              | D AND Y GROCERY                             |
  | ONE STOP FOOD MARKET                         | ONE STOP FOOD MARKET                        |
  | CITGO                                        | CITGO                                       |
  | KHAN DOLLAR STATION                          | KHAN DOLLAR STATION                         |
  | FOSTER & BROADWAY BP/AUTOTECH                | FOSTER  BROADWAY BPAUTOTECH                 |
  | Rizzo's Bar & Inn                            | RIZZOS BAR  INN                             |
  | Rizzo's Bar & Inn                            | RIZZOS BAR  INN                             |
  | SAVE-A-LOT #882                              | SAVEALOT 882                                |
  | MEDITERRANEAN EXPRESS                        | MEDITERRANEAN EXPRESS                       |
  | SWEET FREAKS                                 | SWEET FREAKS                                |
  | MINGHIN CUISINE KITCHEN                      | MINGHIN CUISINE KITCHEN                     |
  | HAPPY GROCERY & DOLLAR                       | HAPPY GROCERY  DOLLAR                       |
  | ARDEN RESTAURANT                             | ARDEN RESTAURANT                            |
  | TBD                                          | TBD                                         |
  | MAGGIE GYROS & CHICKEN                       | MAGGIE GYROS  CHICKEN                       |
  | WOLCOTT TAP                                  | WOLCOTT TAP                                 |
  | WOLCOTT TAP                                  | WOLCOTT TAP                                 |
  | 3JJJ'S BETTER TASTE JAMAICAN JERK RESTAURANT | 3JJJS BETTER TASTE JAMAICAN JERK RESTAURANT |
  | THE HARDING TAVERN                           | THE HARDING TAVERN                          |
  | ZACATACOS, II. INC                           | ZACATACOS II INC                            |
  | ONESTI PIZZERIA INC                          | ONESTI PIZZERIA INC                         |
  | 3JJJ'S BETTER TASTE JAMAICAN JERK RESTAURANT | 3JJJS BETTER TASTE JAMAICAN JERK RESTAURANT |
  | NORMAN'S                                     | NORMANS                                     |
  | MCCB                                         | MCCB                                        |
  | CHECKERS DRIVE-IN RESTAURANTS, INC           | CHECKERS DRIVEIN RESTAURANTS INC            |
  | Rizzo's Bar & Inn                            | RIZZOS BAR  INN                             |
  | GRILL 87                                     | GRILL 87                                    |
  | KFC                                          | KFC                                         |
  | PACO'S TACOS 2                               | PACOS TACOS 2                               |
  | MARTINI CLUB                                 | MARTINI CLUB                                |
  :END:
